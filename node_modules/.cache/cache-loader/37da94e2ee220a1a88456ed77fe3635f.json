{"remainingRequest":"/Users/chemingqiang/Desktop/Blog/node_modules/thread-loader/dist/cjs.js!/Users/chemingqiang/Desktop/Blog/node_modules/babel-loader/lib/index.js!/Users/chemingqiang/Desktop/Blog/node_modules/vue/dist/vue.runtime.esm.js","dependencies":[{"path":"/Users/chemingqiang/Desktop/Blog/node_modules/vue/dist/vue.runtime.esm.js","mtime":499162500000},{"path":"/Users/chemingqiang/Desktop/Blog/babel.config.js","mtime":1647066144493},{"path":"/Users/chemingqiang/Desktop/Blog/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/chemingqiang/Desktop/Blog/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/chemingqiang/Desktop/Blog/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:ZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsgcmV0dXJuIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA/IGZ1bmN0aW9uIChvYmopIHsgcmV0dXJuIHR5cGVvZiBvYmo7IH0gOiBmdW5jdGlvbiAob2JqKSB7IHJldHVybiBvYmogJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfSwgX3R5cGVvZihvYmopOyB9CgppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYub2JqZWN0LmZyZWV6ZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5vYmplY3QudG8tc3RyaW5nLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LmFycmF5LnNsaWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LmFycmF5LmlzLWFycmF5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LmRhdGUudG8tc3RyaW5nLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LnJlZ2V4cC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYub2JqZWN0LmNyZWF0ZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5yZWdleHAuc3BsaXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuYXJyYXkuaW5kZXgtb2YuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYucmVnZXhwLnJlcGxhY2UuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuZnVuY3Rpb24uYmluZC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5hcnJheS5ldmVyeS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5vYmplY3Qua2V5cy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5vYmplY3QuZGVmaW5lLXByb3BlcnR5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LnJlZ2V4cC5jb25zdHJ1Y3Rvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5yZWdleHAubWF0Y2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuc3ltYm9sLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LnJlZmxlY3Qub3duLWtleXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuc2V0LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2LnN0cmluZy5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5hcnJheS5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20uaXRlcmFibGUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuZnVuY3Rpb24ubmFtZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5hcnJheS5tYXAuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuYXJyYXkuc29ydC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5vYmplY3QuZGVmaW5lLXByb3BlcnRpZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuYXJyYXkuZm9yLWVhY2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYub2JqZWN0LmdldC1vd24tcHJvcGVydHktbmFtZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYub2JqZWN0LmlzLWV4dGVuc2libGUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYub2JqZWN0LmdldC1vd24tcHJvcGVydHktZGVzY3JpcHRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5hcnJheS5zb21lLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2Lm51bWJlci5jb25zdHJ1Y3Rvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzNi5wcm9taXNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXM2Lm9iamVjdC5pcy1mcm96ZW4uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuZGF0ZS5ub3cuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuc3RyaW5nLnRyaW0uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lczYuYXJyYXkuZmlsdGVyLmpzIjsKCi8qIQogKiBWdWUuanMgdjIuNi4xNAogKiAoYykgMjAxNC0yMDIxIEV2YW4gWW91CiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICovCgovKiAgKi8KdmFyIGVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSh7fSk7IC8vIFRoZXNlIGhlbHBlcnMgcHJvZHVjZSBiZXR0ZXIgVk0gY29kZSBpbiBKUyBlbmdpbmVzIGR1ZSB0byB0aGVpcgovLyBleHBsaWNpdG5lc3MgYW5kIGZ1bmN0aW9uIGlubGluaW5nLgoKZnVuY3Rpb24gaXNVbmRlZih2KSB7CiAgcmV0dXJuIHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsOwp9CgpmdW5jdGlvbiBpc0RlZih2KSB7CiAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc1RydWUodikgewogIHJldHVybiB2ID09PSB0cnVlOwp9CgpmdW5jdGlvbiBpc0ZhbHNlKHYpIHsKICByZXR1cm4gdiA9PT0gZmFsc2U7Cn0KLyoqCiAqIENoZWNrIGlmIHZhbHVlIGlzIHByaW1pdGl2ZS4KICovCgoKZnVuY3Rpb24gaXNQcmltaXRpdmUodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8IC8vICRmbG93LWRpc2FibGUtbGluZQogIF90eXBlb2YodmFsdWUpID09PSAnc3ltYm9sJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKfQovKioKICogUXVpY2sgb2JqZWN0IGNoZWNrIC0gdGhpcyBpcyBwcmltYXJpbHkgdXNlZCB0byB0ZWxsCiAqIE9iamVjdHMgZnJvbSBwcmltaXRpdmUgdmFsdWVzIHdoZW4gd2Uga25vdyB0aGUgdmFsdWUKICogaXMgYSBKU09OLWNvbXBsaWFudCB0eXBlLgogKi8KCgpmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICByZXR1cm4gb2JqICE9PSBudWxsICYmIF90eXBlb2Yob2JqKSA9PT0gJ29iamVjdCc7Cn0KLyoqCiAqIEdldCB0aGUgcmF3IHR5cGUgc3RyaW5nIG9mIGEgdmFsdWUsIGUuZy4sIFtvYmplY3QgT2JqZWN0XS4KICovCgoKdmFyIF90b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgpmdW5jdGlvbiB0b1Jhd1R5cGUodmFsdWUpIHsKICByZXR1cm4gX3RvU3RyaW5nLmNhbGwodmFsdWUpLnNsaWNlKDgsIC0xKTsKfQovKioKICogU3RyaWN0IG9iamVjdCB0eXBlIGNoZWNrLiBPbmx5IHJldHVybnMgdHJ1ZQogKiBmb3IgcGxhaW4gSmF2YVNjcmlwdCBvYmplY3RzLgogKi8KCgpmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBPYmplY3RdJzsKfQoKZnVuY3Rpb24gaXNSZWdFeHAodikgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2KSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7Cn0KLyoqCiAqIENoZWNrIGlmIHZhbCBpcyBhIHZhbGlkIGFycmF5IGluZGV4LgogKi8KCgpmdW5jdGlvbiBpc1ZhbGlkQXJyYXlJbmRleCh2YWwpIHsKICB2YXIgbiA9IHBhcnNlRmxvYXQoU3RyaW5nKHZhbCkpOwogIHJldHVybiBuID49IDAgJiYgTWF0aC5mbG9vcihuKSA9PT0gbiAmJiBpc0Zpbml0ZSh2YWwpOwp9CgpmdW5jdGlvbiBpc1Byb21pc2UodmFsKSB7CiAgcmV0dXJuIGlzRGVmKHZhbCkgJiYgdHlwZW9mIHZhbC50aGVuID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiB2YWxbImNhdGNoIl0gPT09ICdmdW5jdGlvbic7Cn0KLyoqCiAqIENvbnZlcnQgYSB2YWx1ZSB0byBhIHN0cmluZyB0aGF0IGlzIGFjdHVhbGx5IHJlbmRlcmVkLgogKi8KCgpmdW5jdGlvbiB0b1N0cmluZyh2YWwpIHsKICByZXR1cm4gdmFsID09IG51bGwgPyAnJyA6IEFycmF5LmlzQXJyYXkodmFsKSB8fCBpc1BsYWluT2JqZWN0KHZhbCkgJiYgdmFsLnRvU3RyaW5nID09PSBfdG9TdHJpbmcgPyBKU09OLnN0cmluZ2lmeSh2YWwsIG51bGwsIDIpIDogU3RyaW5nKHZhbCk7Cn0KLyoqCiAqIENvbnZlcnQgYW4gaW5wdXQgdmFsdWUgdG8gYSBudW1iZXIgZm9yIHBlcnNpc3RlbmNlLgogKiBJZiB0aGUgY29udmVyc2lvbiBmYWlscywgcmV0dXJuIG9yaWdpbmFsIHN0cmluZy4KICovCgoKZnVuY3Rpb24gdG9OdW1iZXIodmFsKSB7CiAgdmFyIG4gPSBwYXJzZUZsb2F0KHZhbCk7CiAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbjsKfQovKioKICogTWFrZSBhIG1hcCBhbmQgcmV0dXJuIGEgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGEga2V5CiAqIGlzIGluIHRoYXQgbWFwLgogKi8KCgpmdW5jdGlvbiBtYWtlTWFwKHN0ciwgZXhwZWN0c0xvd2VyQ2FzZSkgewogIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHZhciBsaXN0ID0gc3RyLnNwbGl0KCcsJyk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgbWFwW2xpc3RbaV1dID0gdHJ1ZTsKICB9CgogIHJldHVybiBleHBlY3RzTG93ZXJDYXNlID8gZnVuY3Rpb24gKHZhbCkgewogICAgcmV0dXJuIG1hcFt2YWwudG9Mb3dlckNhc2UoKV07CiAgfSA6IGZ1bmN0aW9uICh2YWwpIHsKICAgIHJldHVybiBtYXBbdmFsXTsKICB9Owp9Ci8qKgogKiBDaGVjayBpZiBhIHRhZyBpcyBhIGJ1aWx0LWluIHRhZy4KICovCgoKdmFyIGlzQnVpbHRJblRhZyA9IG1ha2VNYXAoJ3Nsb3QsY29tcG9uZW50JywgdHJ1ZSk7Ci8qKgogKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUuCiAqLwoKdmFyIGlzUmVzZXJ2ZWRBdHRyaWJ1dGUgPSBtYWtlTWFwKCdrZXkscmVmLHNsb3Qsc2xvdC1zY29wZSxpcycpOwovKioKICogUmVtb3ZlIGFuIGl0ZW0gZnJvbSBhbiBhcnJheS4KICovCgpmdW5jdGlvbiByZW1vdmUoYXJyLCBpdGVtKSB7CiAgaWYgKGFyci5sZW5ndGgpIHsKICAgIHZhciBpbmRleCA9IGFyci5pbmRleE9mKGl0ZW0pOwoKICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgIHJldHVybiBhcnIuc3BsaWNlKGluZGV4LCAxKTsKICAgIH0KICB9Cn0KLyoqCiAqIENoZWNrIHdoZXRoZXIgYW4gb2JqZWN0IGhhcyB0aGUgcHJvcGVydHkuCiAqLwoKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgpmdW5jdGlvbiBoYXNPd24ob2JqLCBrZXkpIHsKICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7Cn0KLyoqCiAqIENyZWF0ZSBhIGNhY2hlZCB2ZXJzaW9uIG9mIGEgcHVyZSBmdW5jdGlvbi4KICovCgoKZnVuY3Rpb24gY2FjaGVkKGZuKSB7CiAgdmFyIGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICByZXR1cm4gZnVuY3Rpb24gY2FjaGVkRm4oc3RyKSB7CiAgICB2YXIgaGl0ID0gY2FjaGVbc3RyXTsKICAgIHJldHVybiBoaXQgfHwgKGNhY2hlW3N0cl0gPSBmbihzdHIpKTsKICB9Owp9Ci8qKgogKiBDYW1lbGl6ZSBhIGh5cGhlbi1kZWxpbWl0ZWQgc3RyaW5nLgogKi8KCgp2YXIgY2FtZWxpemVSRSA9IC8tKFx3KS9nOwp2YXIgY2FtZWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCBmdW5jdGlvbiAoXywgYykgewogICAgcmV0dXJuIGMgPyBjLnRvVXBwZXJDYXNlKCkgOiAnJzsKICB9KTsKfSk7Ci8qKgogKiBDYXBpdGFsaXplIGEgc3RyaW5nLgogKi8KCnZhciBjYXBpdGFsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwp9KTsKLyoqCiAqIEh5cGhlbmF0ZSBhIGNhbWVsQ2FzZSBzdHJpbmcuCiAqLwoKdmFyIGh5cGhlbmF0ZVJFID0gL1xCKFtBLVpdKS9nOwp2YXIgaHlwaGVuYXRlID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoaHlwaGVuYXRlUkUsICctJDEnKS50b0xvd2VyQ2FzZSgpOwp9KTsKLyoqCiAqIFNpbXBsZSBiaW5kIHBvbHlmaWxsIGZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3Qgc3VwcG9ydCBpdCwKICogZS5nLiwgUGhhbnRvbUpTIDEueC4gVGVjaG5pY2FsbHksIHdlIGRvbid0IG5lZWQgdGhpcyBhbnltb3JlCiAqIHNpbmNlIG5hdGl2ZSBiaW5kIGlzIG5vdyBwZXJmb3JtYW50IGVub3VnaCBpbiBtb3N0IGJyb3dzZXJzLgogKiBCdXQgcmVtb3ZpbmcgaXQgd291bGQgbWVhbiBicmVha2luZyBjb2RlIHRoYXQgd2FzIGFibGUgdG8gcnVuIGluCiAqIFBoYW50b21KUyAxLngsIHNvIHRoaXMgbXVzdCBiZSBrZXB0IGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgogKi8KCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgpmdW5jdGlvbiBwb2x5ZmlsbEJpbmQoZm4sIGN0eCkgewogIGZ1bmN0aW9uIGJvdW5kRm4oYSkgewogICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgcmV0dXJuIGwgPyBsID4gMSA/IGZuLmFwcGx5KGN0eCwgYXJndW1lbnRzKSA6IGZuLmNhbGwoY3R4LCBhKSA6IGZuLmNhbGwoY3R4KTsKICB9CgogIGJvdW5kRm4uX2xlbmd0aCA9IGZuLmxlbmd0aDsKICByZXR1cm4gYm91bmRGbjsKfQoKZnVuY3Rpb24gbmF0aXZlQmluZChmbiwgY3R4KSB7CiAgcmV0dXJuIGZuLmJpbmQoY3R4KTsKfQoKdmFyIGJpbmQgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA/IG5hdGl2ZUJpbmQgOiBwb2x5ZmlsbEJpbmQ7Ci8qKgogKiBDb252ZXJ0IGFuIEFycmF5LWxpa2Ugb2JqZWN0IHRvIGEgcmVhbCBBcnJheS4KICovCgpmdW5jdGlvbiB0b0FycmF5KGxpc3QsIHN0YXJ0KSB7CiAgc3RhcnQgPSBzdGFydCB8fCAwOwogIHZhciBpID0gbGlzdC5sZW5ndGggLSBzdGFydDsKICB2YXIgcmV0ID0gbmV3IEFycmF5KGkpOwoKICB3aGlsZSAoaS0tKSB7CiAgICByZXRbaV0gPSBsaXN0W2kgKyBzdGFydF07CiAgfQoKICByZXR1cm4gcmV0Owp9Ci8qKgogKiBNaXggcHJvcGVydGllcyBpbnRvIHRhcmdldCBvYmplY3QuCiAqLwoKCmZ1bmN0aW9uIGV4dGVuZCh0bywgX2Zyb20pIHsKICBmb3IgKHZhciBrZXkgaW4gX2Zyb20pIHsKICAgIHRvW2tleV0gPSBfZnJvbVtrZXldOwogIH0KCiAgcmV0dXJuIHRvOwp9Ci8qKgogKiBNZXJnZSBhbiBBcnJheSBvZiBPYmplY3RzIGludG8gYSBzaW5nbGUgT2JqZWN0LgogKi8KCgpmdW5jdGlvbiB0b09iamVjdChhcnIpIHsKICB2YXIgcmVzID0ge307CgogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoYXJyW2ldKSB7CiAgICAgIGV4dGVuZChyZXMsIGFycltpXSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovCgovKioKICogUGVyZm9ybSBubyBvcGVyYXRpb24uCiAqIFN0dWJiaW5nIGFyZ3MgdG8gbWFrZSBGbG93IGhhcHB5IHdpdGhvdXQgbGVhdmluZyB1c2VsZXNzIHRyYW5zcGlsZWQgY29kZQogKiB3aXRoIC4uLnJlc3QgKGh0dHBzOi8vZmxvdy5vcmcvYmxvZy8yMDE3LzA1LzA3L1N0cmljdC1GdW5jdGlvbi1DYWxsLUFyaXR5LykuCiAqLwoKCmZ1bmN0aW9uIG5vb3AoYSwgYiwgYykge30KLyoqCiAqIEFsd2F5cyByZXR1cm4gZmFsc2UuCiAqLwoKCnZhciBubyA9IGZ1bmN0aW9uIG5vKGEsIGIsIGMpIHsKICByZXR1cm4gZmFsc2U7Cn07Ci8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi8KCi8qKgogKiBSZXR1cm4gdGhlIHNhbWUgdmFsdWUuCiAqLwoKCnZhciBpZGVudGl0eSA9IGZ1bmN0aW9uIGlkZW50aXR5KF8pIHsKICByZXR1cm4gXzsKfTsKLyoqCiAqIENoZWNrIGlmIHR3byB2YWx1ZXMgYXJlIGxvb3NlbHkgZXF1YWwgLSB0aGF0IGlzLAogKiBpZiB0aGV5IGFyZSBwbGFpbiBvYmplY3RzLCBkbyB0aGV5IGhhdmUgdGhlIHNhbWUgc2hhcGU/CiAqLwoKCmZ1bmN0aW9uIGxvb3NlRXF1YWwoYSwgYikgewogIGlmIChhID09PSBiKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHZhciBpc09iamVjdEEgPSBpc09iamVjdChhKTsKICB2YXIgaXNPYmplY3RCID0gaXNPYmplY3QoYik7CgogIGlmIChpc09iamVjdEEgJiYgaXNPYmplY3RCKSB7CiAgICB0cnkgewogICAgICB2YXIgaXNBcnJheUEgPSBBcnJheS5pc0FycmF5KGEpOwogICAgICB2YXIgaXNBcnJheUIgPSBBcnJheS5pc0FycmF5KGIpOwoKICAgICAgaWYgKGlzQXJyYXlBICYmIGlzQXJyYXlCKSB7CiAgICAgICAgcmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aCAmJiBhLmV2ZXJ5KGZ1bmN0aW9uIChlLCBpKSB7CiAgICAgICAgICByZXR1cm4gbG9vc2VFcXVhbChlLCBiW2ldKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChhIGluc3RhbmNlb2YgRGF0ZSAmJiBiIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldHVybiBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCk7CiAgICAgIH0gZWxzZSBpZiAoIWlzQXJyYXlBICYmICFpc0FycmF5QikgewogICAgICAgIHZhciBrZXlzQSA9IE9iamVjdC5rZXlzKGEpOwogICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKGIpOwogICAgICAgIHJldHVybiBrZXlzQS5sZW5ndGggPT09IGtleXNCLmxlbmd0aCAmJiBrZXlzQS5ldmVyeShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICByZXR1cm4gbG9vc2VFcXVhbChhW2tleV0sIGJba2V5XSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0gZWxzZSBpZiAoIWlzT2JqZWN0QSAmJiAhaXNPYmplY3RCKSB7CiAgICByZXR1cm4gU3RyaW5nKGEpID09PSBTdHJpbmcoYik7CiAgfSBlbHNlIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KLyoqCiAqIFJldHVybiB0aGUgZmlyc3QgaW5kZXggYXQgd2hpY2ggYSBsb29zZWx5IGVxdWFsIHZhbHVlIGNhbiBiZQogKiBmb3VuZCBpbiB0aGUgYXJyYXkgKGlmIHZhbHVlIGlzIGEgcGxhaW4gb2JqZWN0LCB0aGUgYXJyYXkgbXVzdAogKiBjb250YWluIGFuIG9iamVjdCBvZiB0aGUgc2FtZSBzaGFwZSksIG9yIC0xIGlmIGl0IGlzIG5vdCBwcmVzZW50LgogKi8KCgpmdW5jdGlvbiBsb29zZUluZGV4T2YoYXJyLCB2YWwpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgaWYgKGxvb3NlRXF1YWwoYXJyW2ldLCB2YWwpKSB7CiAgICAgIHJldHVybiBpOwogICAgfQogIH0KCiAgcmV0dXJuIC0xOwp9Ci8qKgogKiBFbnN1cmUgYSBmdW5jdGlvbiBpcyBjYWxsZWQgb25seSBvbmNlLgogKi8KCgpmdW5jdGlvbiBvbmNlKGZuKSB7CiAgdmFyIGNhbGxlZCA9IGZhbHNlOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNhbGxlZCkgewogICAgICBjYWxsZWQgPSB0cnVlOwogICAgICBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH07Cn0KCnZhciBTU1JfQVRUUiA9ICdkYXRhLXNlcnZlci1yZW5kZXJlZCc7CnZhciBBU1NFVF9UWVBFUyA9IFsnY29tcG9uZW50JywgJ2RpcmVjdGl2ZScsICdmaWx0ZXInXTsKdmFyIExJRkVDWUNMRV9IT09LUyA9IFsnYmVmb3JlQ3JlYXRlJywgJ2NyZWF0ZWQnLCAnYmVmb3JlTW91bnQnLCAnbW91bnRlZCcsICdiZWZvcmVVcGRhdGUnLCAndXBkYXRlZCcsICdiZWZvcmVEZXN0cm95JywgJ2Rlc3Ryb3llZCcsICdhY3RpdmF0ZWQnLCAnZGVhY3RpdmF0ZWQnLCAnZXJyb3JDYXB0dXJlZCcsICdzZXJ2ZXJQcmVmZXRjaCddOwovKiAgKi8KCnZhciBjb25maWcgPSB7CiAgLyoqCiAgICogT3B0aW9uIG1lcmdlIHN0cmF0ZWdpZXMgKHVzZWQgaW4gY29yZS91dGlsL29wdGlvbnMpCiAgICovCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAoKICAvKioKICAgKiBXaGV0aGVyIHRvIHN1cHByZXNzIHdhcm5pbmdzLgogICAqLwogIHNpbGVudDogZmFsc2UsCgogIC8qKgogICAqIFNob3cgcHJvZHVjdGlvbiBtb2RlIHRpcCBtZXNzYWdlIG9uIGJvb3Q/CiAgICovCiAgcHJvZHVjdGlvblRpcDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJywKCiAgLyoqCiAgICogV2hldGhlciB0byBlbmFibGUgZGV2dG9vbHMKICAgKi8KICBkZXZ0b29sczogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJywKCiAgLyoqCiAgICogV2hldGhlciB0byByZWNvcmQgcGVyZgogICAqLwogIHBlcmZvcm1hbmNlOiBmYWxzZSwKCiAgLyoqCiAgICogRXJyb3IgaGFuZGxlciBmb3Igd2F0Y2hlciBlcnJvcnMKICAgKi8KICBlcnJvckhhbmRsZXI6IG51bGwsCgogIC8qKgogICAqIFdhcm4gaGFuZGxlciBmb3Igd2F0Y2hlciB3YXJucwogICAqLwogIHdhcm5IYW5kbGVyOiBudWxsLAoKICAvKioKICAgKiBJZ25vcmUgY2VydGFpbiBjdXN0b20gZWxlbWVudHMKICAgKi8KICBpZ25vcmVkRWxlbWVudHM6IFtdLAoKICAvKioKICAgKiBDdXN0b20gdXNlciBrZXkgYWxpYXNlcyBmb3Igdi1vbgogICAqLwogIC8vICRmbG93LWRpc2FibGUtbGluZQogIGtleUNvZGVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAoKICAvKioKICAgKiBDaGVjayBpZiBhIHRhZyBpcyByZXNlcnZlZCBzbyB0aGF0IGl0IGNhbm5vdCBiZSByZWdpc3RlcmVkIGFzIGEKICAgKiBjb21wb25lbnQuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICovCiAgaXNSZXNlcnZlZFRhZzogbm8sCgogIC8qKgogICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBpcyByZXNlcnZlZCBzbyB0aGF0IGl0IGNhbm5vdCBiZSB1c2VkIGFzIGEgY29tcG9uZW50CiAgICogcHJvcC4gVGhpcyBpcyBwbGF0Zm9ybS1kZXBlbmRlbnQgYW5kIG1heSBiZSBvdmVyd3JpdHRlbi4KICAgKi8KICBpc1Jlc2VydmVkQXR0cjogbm8sCgogIC8qKgogICAqIENoZWNrIGlmIGEgdGFnIGlzIGFuIHVua25vd24gZWxlbWVudC4KICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuCiAgICovCiAgaXNVbmtub3duRWxlbWVudDogbm8sCgogIC8qKgogICAqIEdldCB0aGUgbmFtZXNwYWNlIG9mIGFuIGVsZW1lbnQKICAgKi8KICBnZXRUYWdOYW1lc3BhY2U6IG5vb3AsCgogIC8qKgogICAqIFBhcnNlIHRoZSByZWFsIHRhZyBuYW1lIGZvciB0aGUgc3BlY2lmaWMgcGxhdGZvcm0uCiAgICovCiAgcGFyc2VQbGF0Zm9ybVRhZ05hbWU6IGlkZW50aXR5LAoKICAvKioKICAgKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgbXVzdCBiZSBib3VuZCB1c2luZyBwcm9wZXJ0eSwgZS5nLiB2YWx1ZQogICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgKi8KICBtdXN0VXNlUHJvcDogbm8sCgogIC8qKgogICAqIFBlcmZvcm0gdXBkYXRlcyBhc3luY2hyb25vdXNseS4gSW50ZW5kZWQgdG8gYmUgdXNlZCBieSBWdWUgVGVzdCBVdGlscwogICAqIFRoaXMgd2lsbCBzaWduaWZpY2FudGx5IHJlZHVjZSBwZXJmb3JtYW5jZSBpZiBzZXQgdG8gZmFsc2UuCiAgICovCiAgYXN5bmM6IHRydWUsCgogIC8qKgogICAqIEV4cG9zZWQgZm9yIGxlZ2FjeSByZWFzb25zCiAgICovCiAgX2xpZmVjeWNsZUhvb2tzOiBMSUZFQ1lDTEVfSE9PS1MKfTsKLyogICovCgovKioKICogdW5pY29kZSBsZXR0ZXJzIHVzZWQgZm9yIHBhcnNpbmcgaHRtbCB0YWdzLCBjb21wb25lbnQgbmFtZXMgYW5kIHByb3BlcnR5IHBhdGhzLgogKiB1c2luZyBodHRwczovL3d3dy53My5vcmcvVFIvaHRtbDUzL3NlbWFudGljcy1zY3JpcHRpbmcuaHRtbCNwb3RlbnRpYWxjdXN0b21lbGVtZW50bmFtZQogKiBza2lwcGluZyBcdTEwMDAwLVx1RUZGRkYgZHVlIHRvIGl0IGZyZWV6aW5nIHVwIFBoYW50b21KUwogKi8KCnZhciB1bmljb2RlUmVnRXhwID0gL2EtekEtWlx1MDBCN1x1MDBDMC1cdTAwRDZcdTAwRDgtXHUwMEY2XHUwMEY4LVx1MDM3RFx1MDM3Ri1cdTFGRkZcdTIwMEMtXHUyMDBEXHUyMDNGLVx1MjA0MFx1MjA3MC1cdTIxOEZcdTJDMDAtXHUyRkVGXHUzMDAxLVx1RDdGRlx1RjkwMC1cdUZEQ0ZcdUZERjAtXHVGRkZELzsKLyoqCiAqIENoZWNrIGlmIGEgc3RyaW5nIHN0YXJ0cyB3aXRoICQgb3IgXwogKi8KCmZ1bmN0aW9uIGlzUmVzZXJ2ZWQoc3RyKSB7CiAgdmFyIGMgPSAoc3RyICsgJycpLmNoYXJDb2RlQXQoMCk7CiAgcmV0dXJuIGMgPT09IDB4MjQgfHwgYyA9PT0gMHg1RjsKfQovKioKICogRGVmaW5lIGEgcHJvcGVydHkuCiAqLwoKCmZ1bmN0aW9uIGRlZihvYmosIGtleSwgdmFsLCBlbnVtZXJhYmxlKSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICB2YWx1ZTogdmFsLAogICAgZW51bWVyYWJsZTogISFlbnVtZXJhYmxlLAogICAgd3JpdGFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKfQovKioKICogUGFyc2Ugc2ltcGxlIHBhdGguCiAqLwoKCnZhciBiYWlsUkUgPSBuZXcgUmVnRXhwKCJbXiIgKyB1bmljb2RlUmVnRXhwLnNvdXJjZSArICIuJF9cXGRdIik7CgpmdW5jdGlvbiBwYXJzZVBhdGgocGF0aCkgewogIGlmIChiYWlsUkUudGVzdChwYXRoKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLicpOwogIHJldHVybiBmdW5jdGlvbiAob2JqKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlZ21lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICghb2JqKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBvYmogPSBvYmpbc2VnbWVudHNbaV1dOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfTsKfQovKiAgKi8KLy8gY2FuIHdlIHVzZSBfX3Byb3RvX18/CgoKdmFyIGhhc1Byb3RvID0gKCdfX3Byb3RvX18nIGluIHt9KTsgLy8gQnJvd3NlciBlbnZpcm9ubWVudCBzbmlmZmluZwoKdmFyIGluQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnOwp2YXIgaW5XZWV4ID0gdHlwZW9mIFdYRW52aXJvbm1lbnQgIT09ICd1bmRlZmluZWQnICYmICEhV1hFbnZpcm9ubWVudC5wbGF0Zm9ybTsKdmFyIHdlZXhQbGF0Zm9ybSA9IGluV2VleCAmJiBXWEVudmlyb25tZW50LnBsYXRmb3JtLnRvTG93ZXJDYXNlKCk7CnZhciBVQSA9IGluQnJvd3NlciAmJiB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwp2YXIgaXNJRSA9IFVBICYmIC9tc2llfHRyaWRlbnQvLnRlc3QoVUEpOwp2YXIgaXNJRTkgPSBVQSAmJiBVQS5pbmRleE9mKCdtc2llIDkuMCcpID4gMDsKdmFyIGlzRWRnZSA9IFVBICYmIFVBLmluZGV4T2YoJ2VkZ2UvJykgPiAwOwp2YXIgaXNBbmRyb2lkID0gVUEgJiYgVUEuaW5kZXhPZignYW5kcm9pZCcpID4gMCB8fCB3ZWV4UGxhdGZvcm0gPT09ICdhbmRyb2lkJzsKdmFyIGlzSU9TID0gVUEgJiYgL2lwaG9uZXxpcGFkfGlwb2R8aW9zLy50ZXN0KFVBKSB8fCB3ZWV4UGxhdGZvcm0gPT09ICdpb3MnOwp2YXIgaXNDaHJvbWUgPSBVQSAmJiAvY2hyb21lXC9cZCsvLnRlc3QoVUEpICYmICFpc0VkZ2U7CnZhciBpc1BoYW50b21KUyA9IFVBICYmIC9waGFudG9tanMvLnRlc3QoVUEpOwp2YXIgaXNGRiA9IFVBICYmIFVBLm1hdGNoKC9maXJlZm94XC8oXGQrKS8pOyAvLyBGaXJlZm94IGhhcyBhICJ3YXRjaCIgZnVuY3Rpb24gb24gT2JqZWN0LnByb3RvdHlwZS4uLgoKdmFyIG5hdGl2ZVdhdGNoID0ge30ud2F0Y2g7CnZhciBzdXBwb3J0c1Bhc3NpdmUgPSBmYWxzZTsKCmlmIChpbkJyb3dzZXIpIHsKICB0cnkgewogICAgdmFyIG9wdHMgPSB7fTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvcHRzLCAncGFzc2l2ZScsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICBzdXBwb3J0c1Bhc3NpdmUgPSB0cnVlOwogICAgICB9CiAgICB9KTsgLy8gaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zsb3cvaXNzdWVzLzI4NQoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0ZXN0LXBhc3NpdmUnLCBudWxsLCBvcHRzKTsKICB9IGNhdGNoIChlKSB7fQp9IC8vIHRoaXMgbmVlZHMgdG8gYmUgbGF6eS1ldmFsZWQgYmVjYXVzZSB2dWUgbWF5IGJlIHJlcXVpcmVkIGJlZm9yZQovLyB2dWUtc2VydmVyLXJlbmRlcmVyIGNhbiBzZXQgVlVFX0VOVgoKCnZhciBfaXNTZXJ2ZXI7Cgp2YXIgaXNTZXJ2ZXJSZW5kZXJpbmcgPSBmdW5jdGlvbiBpc1NlcnZlclJlbmRlcmluZygpIHsKICBpZiAoX2lzU2VydmVyID09PSB1bmRlZmluZWQpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFpbkJyb3dzZXIgJiYgIWluV2VleCAmJiB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgewogICAgICAvLyBkZXRlY3QgcHJlc2VuY2Ugb2YgdnVlLXNlcnZlci1yZW5kZXJlciBhbmQgYXZvaWQKICAgICAgLy8gV2VicGFjayBzaGltbWluZyB0aGUgcHJvY2VzcwogICAgICBfaXNTZXJ2ZXIgPSBnbG9iYWxbJ3Byb2Nlc3MnXSAmJiBnbG9iYWxbJ3Byb2Nlc3MnXS5lbnYuVlVFX0VOViA9PT0gJ3NlcnZlcic7CiAgICB9IGVsc2UgewogICAgICBfaXNTZXJ2ZXIgPSBmYWxzZTsKICAgIH0KICB9CgogIHJldHVybiBfaXNTZXJ2ZXI7Cn07IC8vIGRldGVjdCBkZXZ0b29scwoKCnZhciBkZXZ0b29scyA9IGluQnJvd3NlciAmJiB3aW5kb3cuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCmZ1bmN0aW9uIGlzTmF0aXZlKEN0b3IpIHsKICByZXR1cm4gdHlwZW9mIEN0b3IgPT09ICdmdW5jdGlvbicgJiYgL25hdGl2ZSBjb2RlLy50ZXN0KEN0b3IudG9TdHJpbmcoKSk7Cn0KCnZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTeW1ib2wpICYmIHR5cGVvZiBSZWZsZWN0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShSZWZsZWN0Lm93bktleXMpOwoKdmFyIF9TZXQ7Ci8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwovLyAkZmxvdy1kaXNhYmxlLWxpbmUKCgppZiAodHlwZW9mIFNldCAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoU2V0KSkgewogIC8vIHVzZSBuYXRpdmUgU2V0IHdoZW4gYXZhaWxhYmxlLgogIF9TZXQgPSBTZXQ7Cn0gZWxzZSB7CiAgLy8gYSBub24tc3RhbmRhcmQgU2V0IHBvbHlmaWxsIHRoYXQgb25seSB3b3JrcyB3aXRoIHByaW1pdGl2ZSBrZXlzLgogIF9TZXQgPSAvKkBfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gU2V0KCkgewogICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CgogICAgU2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLnNldFtrZXldID09PSB0cnVlOwogICAgfTsKCiAgICBTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChrZXkpIHsKICAgICAgdGhpcy5zZXRba2V5XSA9IHRydWU7CiAgICB9OwoKICAgIFNldC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgdGhpcy5zZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfTsKCiAgICByZXR1cm4gU2V0OwogIH0oKTsKfQovKiAgKi8KCgp2YXIgd2FybiA9IG5vb3A7CnZhciB0aXAgPSBub29wOwp2YXIgZ2VuZXJhdGVDb21wb25lbnRUcmFjZSA9IG5vb3A7IC8vIHdvcmsgYXJvdW5kIGZsb3cgY2hlY2sKCnZhciBmb3JtYXRDb21wb25lbnROYW1lID0gbm9vcDsKCmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgdmFyIGhhc0NvbnNvbGUgPSB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCc7CiAgdmFyIGNsYXNzaWZ5UkUgPSAvKD86XnxbLV9dKShcdykvZzsKCiAgdmFyIGNsYXNzaWZ5ID0gZnVuY3Rpb24gY2xhc3NpZnkoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoY2xhc3NpZnlSRSwgZnVuY3Rpb24gKGMpIHsKICAgICAgcmV0dXJuIGMudG9VcHBlckNhc2UoKTsKICAgIH0pLnJlcGxhY2UoL1stX10vZywgJycpOwogIH07CgogIHdhcm4gPSBmdW5jdGlvbiB3YXJuKG1zZywgdm0pIHsKICAgIHZhciB0cmFjZSA9IHZtID8gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgOiAnJzsKCiAgICBpZiAoY29uZmlnLndhcm5IYW5kbGVyKSB7CiAgICAgIGNvbmZpZy53YXJuSGFuZGxlci5jYWxsKG51bGwsIG1zZywgdm0sIHRyYWNlKTsKICAgIH0gZWxzZSBpZiAoaGFzQ29uc29sZSAmJiAhY29uZmlnLnNpbGVudCkgewogICAgICBjb25zb2xlLmVycm9yKCJbVnVlIHdhcm5dOiAiICsgbXNnICsgdHJhY2UpOwogICAgfQogIH07CgogIHRpcCA9IGZ1bmN0aW9uIHRpcChtc2csIHZtKSB7CiAgICBpZiAoaGFzQ29uc29sZSAmJiAhY29uZmlnLnNpbGVudCkgewogICAgICBjb25zb2xlLndhcm4oIltWdWUgdGlwXTogIiArIG1zZyArICh2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJycpKTsKICAgIH0KICB9OwoKICBmb3JtYXRDb21wb25lbnROYW1lID0gZnVuY3Rpb24gZm9ybWF0Q29tcG9uZW50TmFtZSh2bSwgaW5jbHVkZUZpbGUpIHsKICAgIGlmICh2bS4kcm9vdCA9PT0gdm0pIHsKICAgICAgcmV0dXJuICc8Um9vdD4nOwogICAgfQoKICAgIHZhciBvcHRpb25zID0gdHlwZW9mIHZtID09PSAnZnVuY3Rpb24nICYmIHZtLmNpZCAhPSBudWxsID8gdm0ub3B0aW9ucyA6IHZtLl9pc1Z1ZSA/IHZtLiRvcHRpb25zIHx8IHZtLmNvbnN0cnVjdG9yLm9wdGlvbnMgOiB2bTsKICAgIHZhciBuYW1lID0gb3B0aW9ucy5uYW1lIHx8IG9wdGlvbnMuX2NvbXBvbmVudFRhZzsKICAgIHZhciBmaWxlID0gb3B0aW9ucy5fX2ZpbGU7CgogICAgaWYgKCFuYW1lICYmIGZpbGUpIHsKICAgICAgdmFyIG1hdGNoID0gZmlsZS5tYXRjaCgvKFteL1xcXSspXC52dWUkLyk7CiAgICAgIG5hbWUgPSBtYXRjaCAmJiBtYXRjaFsxXTsKICAgIH0KCiAgICByZXR1cm4gKG5hbWUgPyAiPCIgKyBjbGFzc2lmeShuYW1lKSArICI+IiA6ICI8QW5vbnltb3VzPiIpICsgKGZpbGUgJiYgaW5jbHVkZUZpbGUgIT09IGZhbHNlID8gIiBhdCAiICsgZmlsZSA6ICcnKTsKICB9OwoKICB2YXIgcmVwZWF0ID0gZnVuY3Rpb24gcmVwZWF0KHN0ciwgbikgewogICAgdmFyIHJlcyA9ICcnOwoKICAgIHdoaWxlIChuKSB7CiAgICAgIGlmIChuICUgMiA9PT0gMSkgewogICAgICAgIHJlcyArPSBzdHI7CiAgICAgIH0KCiAgICAgIGlmIChuID4gMSkgewogICAgICAgIHN0ciArPSBzdHI7CiAgICAgIH0KCiAgICAgIG4gPj49IDE7CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9OwoKICBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gZnVuY3Rpb24gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgewogICAgaWYgKHZtLl9pc1Z1ZSAmJiB2bS4kcGFyZW50KSB7CiAgICAgIHZhciB0cmVlID0gW107CiAgICAgIHZhciBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPSAwOwoKICAgICAgd2hpbGUgKHZtKSB7CiAgICAgICAgaWYgKHRyZWUubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIGxhc3QgPSB0cmVlW3RyZWUubGVuZ3RoIC0gMV07CgogICAgICAgICAgaWYgKGxhc3QuY29uc3RydWN0b3IgPT09IHZtLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSsrOwogICAgICAgICAgICB2bSA9IHZtLiRwYXJlbnQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPiAwKSB7CiAgICAgICAgICAgIHRyZWVbdHJlZS5sZW5ndGggLSAxXSA9IFtsYXN0LCBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2VdOwogICAgICAgICAgICBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdHJlZS5wdXNoKHZtKTsKICAgICAgICB2bSA9IHZtLiRwYXJlbnQ7CiAgICAgIH0KCiAgICAgIHJldHVybiAnXG5cbmZvdW5kIGluXG5cbicgKyB0cmVlLm1hcChmdW5jdGlvbiAodm0sIGkpIHsKICAgICAgICByZXR1cm4gIiIgKyAoaSA9PT0gMCA/ICctLS0+ICcgOiByZXBlYXQoJyAnLCA1ICsgaSAqIDIpKSArIChBcnJheS5pc0FycmF5KHZtKSA/IGZvcm1hdENvbXBvbmVudE5hbWUodm1bMF0pICsgIi4uLiAoIiArIHZtWzFdICsgIiByZWN1cnNpdmUgY2FsbHMpIiA6IGZvcm1hdENvbXBvbmVudE5hbWUodm0pKTsKICAgICAgfSkuam9pbignXG4nKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAiXG5cbihmb3VuZCBpbiAiICsgZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkgKyAiKSI7CiAgICB9CiAgfTsKfQovKiAgKi8KCgp2YXIgdWlkID0gMDsKLyoqCiAqIEEgZGVwIGlzIGFuIG9ic2VydmFibGUgdGhhdCBjYW4gaGF2ZSBtdWx0aXBsZQogKiBkaXJlY3RpdmVzIHN1YnNjcmliaW5nIHRvIGl0LgogKi8KCnZhciBEZXAgPSBmdW5jdGlvbiBEZXAoKSB7CiAgdGhpcy5pZCA9IHVpZCsrOwogIHRoaXMuc3VicyA9IFtdOwp9OwoKRGVwLnByb3RvdHlwZS5hZGRTdWIgPSBmdW5jdGlvbiBhZGRTdWIoc3ViKSB7CiAgdGhpcy5zdWJzLnB1c2goc3ViKTsKfTsKCkRlcC5wcm90b3R5cGUucmVtb3ZlU3ViID0gZnVuY3Rpb24gcmVtb3ZlU3ViKHN1YikgewogIHJlbW92ZSh0aGlzLnN1YnMsIHN1Yik7Cn07CgpEZXAucHJvdG90eXBlLmRlcGVuZCA9IGZ1bmN0aW9uIGRlcGVuZCgpIHsKICBpZiAoRGVwLnRhcmdldCkgewogICAgRGVwLnRhcmdldC5hZGREZXAodGhpcyk7CiAgfQp9OwoKRGVwLnByb3RvdHlwZS5ub3RpZnkgPSBmdW5jdGlvbiBub3RpZnkoKSB7CiAgLy8gc3RhYmlsaXplIHRoZSBzdWJzY3JpYmVyIGxpc3QgZmlyc3QKICB2YXIgc3VicyA9IHRoaXMuc3Vicy5zbGljZSgpOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhY29uZmlnLmFzeW5jKSB7CiAgICAvLyBzdWJzIGFyZW4ndCBzb3J0ZWQgaW4gc2NoZWR1bGVyIGlmIG5vdCBydW5uaW5nIGFzeW5jCiAgICAvLyB3ZSBuZWVkIHRvIHNvcnQgdGhlbSBub3cgdG8gbWFrZSBzdXJlIHRoZXkgZmlyZSBpbiBjb3JyZWN0CiAgICAvLyBvcmRlcgogICAgc3Vicy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmlkIC0gYi5pZDsKICAgIH0pOwogIH0KCiAgZm9yICh2YXIgaSA9IDAsIGwgPSBzdWJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgc3Vic1tpXS51cGRhdGUoKTsKICB9Cn07IC8vIFRoZSBjdXJyZW50IHRhcmdldCB3YXRjaGVyIGJlaW5nIGV2YWx1YXRlZC4KLy8gVGhpcyBpcyBnbG9iYWxseSB1bmlxdWUgYmVjYXVzZSBvbmx5IG9uZSB3YXRjaGVyCi8vIGNhbiBiZSBldmFsdWF0ZWQgYXQgYSB0aW1lLgoKCkRlcC50YXJnZXQgPSBudWxsOwp2YXIgdGFyZ2V0U3RhY2sgPSBbXTsKCmZ1bmN0aW9uIHB1c2hUYXJnZXQodGFyZ2V0KSB7CiAgdGFyZ2V0U3RhY2sucHVzaCh0YXJnZXQpOwogIERlcC50YXJnZXQgPSB0YXJnZXQ7Cn0KCmZ1bmN0aW9uIHBvcFRhcmdldCgpIHsKICB0YXJnZXRTdGFjay5wb3AoKTsKICBEZXAudGFyZ2V0ID0gdGFyZ2V0U3RhY2tbdGFyZ2V0U3RhY2subGVuZ3RoIC0gMV07Cn0KLyogICovCgoKdmFyIFZOb2RlID0gZnVuY3Rpb24gVk5vZGUodGFnLCBkYXRhLCBjaGlsZHJlbiwgdGV4dCwgZWxtLCBjb250ZXh0LCBjb21wb25lbnRPcHRpb25zLCBhc3luY0ZhY3RvcnkpIHsKICB0aGlzLnRhZyA9IHRhZzsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICB0aGlzLnRleHQgPSB0ZXh0OwogIHRoaXMuZWxtID0gZWxtOwogIHRoaXMubnMgPSB1bmRlZmluZWQ7CiAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICB0aGlzLmZuQ29udGV4dCA9IHVuZGVmaW5lZDsKICB0aGlzLmZuT3B0aW9ucyA9IHVuZGVmaW5lZDsKICB0aGlzLmZuU2NvcGVJZCA9IHVuZGVmaW5lZDsKICB0aGlzLmtleSA9IGRhdGEgJiYgZGF0YS5rZXk7CiAgdGhpcy5jb21wb25lbnRPcHRpb25zID0gY29tcG9uZW50T3B0aW9uczsKICB0aGlzLmNvbXBvbmVudEluc3RhbmNlID0gdW5kZWZpbmVkOwogIHRoaXMucGFyZW50ID0gdW5kZWZpbmVkOwogIHRoaXMucmF3ID0gZmFsc2U7CiAgdGhpcy5pc1N0YXRpYyA9IGZhbHNlOwogIHRoaXMuaXNSb290SW5zZXJ0ID0gdHJ1ZTsKICB0aGlzLmlzQ29tbWVudCA9IGZhbHNlOwogIHRoaXMuaXNDbG9uZWQgPSBmYWxzZTsKICB0aGlzLmlzT25jZSA9IGZhbHNlOwogIHRoaXMuYXN5bmNGYWN0b3J5ID0gYXN5bmNGYWN0b3J5OwogIHRoaXMuYXN5bmNNZXRhID0gdW5kZWZpbmVkOwogIHRoaXMuaXNBc3luY1BsYWNlaG9sZGVyID0gZmFsc2U7Cn07Cgp2YXIgcHJvdG90eXBlQWNjZXNzb3JzID0gewogIGNoaWxkOiB7CiAgICBjb25maWd1cmFibGU6IHRydWUKICB9Cn07IC8vIERFUFJFQ0FURUQ6IGFsaWFzIGZvciBjb21wb25lbnRJbnN0YW5jZSBmb3IgYmFja3dhcmRzIGNvbXBhdC4KCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgpwcm90b3R5cGVBY2Nlc3NvcnMuY2hpbGQuZ2V0ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLmNvbXBvbmVudEluc3RhbmNlOwp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoVk5vZGUucHJvdG90eXBlLCBwcm90b3R5cGVBY2Nlc3NvcnMpOwoKdmFyIGNyZWF0ZUVtcHR5Vk5vZGUgPSBmdW5jdGlvbiBjcmVhdGVFbXB0eVZOb2RlKHRleHQpIHsKICBpZiAodGV4dCA9PT0gdm9pZCAwKSB0ZXh0ID0gJyc7CiAgdmFyIG5vZGUgPSBuZXcgVk5vZGUoKTsKICBub2RlLnRleHQgPSB0ZXh0OwogIG5vZGUuaXNDb21tZW50ID0gdHJ1ZTsKICByZXR1cm4gbm9kZTsKfTsKCmZ1bmN0aW9uIGNyZWF0ZVRleHRWTm9kZSh2YWwpIHsKICByZXR1cm4gbmV3IFZOb2RlKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIFN0cmluZyh2YWwpKTsKfSAvLyBvcHRpbWl6ZWQgc2hhbGxvdyBjbG9uZQovLyB1c2VkIGZvciBzdGF0aWMgbm9kZXMgYW5kIHNsb3Qgbm9kZXMgYmVjYXVzZSB0aGV5IG1heSBiZSByZXVzZWQgYWNyb3NzCi8vIG11bHRpcGxlIHJlbmRlcnMsIGNsb25pbmcgdGhlbSBhdm9pZHMgZXJyb3JzIHdoZW4gRE9NIG1hbmlwdWxhdGlvbnMgcmVseQovLyBvbiB0aGVpciBlbG0gcmVmZXJlbmNlLgoKCmZ1bmN0aW9uIGNsb25lVk5vZGUodm5vZGUpIHsKICB2YXIgY2xvbmVkID0gbmV3IFZOb2RlKHZub2RlLnRhZywgdm5vZGUuZGF0YSwgLy8gIzc5NzUKICAvLyBjbG9uZSBjaGlsZHJlbiBhcnJheSB0byBhdm9pZCBtdXRhdGluZyBvcmlnaW5hbCBpbiBjYXNlIG9mIGNsb25pbmcKICAvLyBhIGNoaWxkLgogIHZub2RlLmNoaWxkcmVuICYmIHZub2RlLmNoaWxkcmVuLnNsaWNlKCksIHZub2RlLnRleHQsIHZub2RlLmVsbSwgdm5vZGUuY29udGV4dCwgdm5vZGUuY29tcG9uZW50T3B0aW9ucywgdm5vZGUuYXN5bmNGYWN0b3J5KTsKICBjbG9uZWQubnMgPSB2bm9kZS5uczsKICBjbG9uZWQuaXNTdGF0aWMgPSB2bm9kZS5pc1N0YXRpYzsKICBjbG9uZWQua2V5ID0gdm5vZGUua2V5OwogIGNsb25lZC5pc0NvbW1lbnQgPSB2bm9kZS5pc0NvbW1lbnQ7CiAgY2xvbmVkLmZuQ29udGV4dCA9IHZub2RlLmZuQ29udGV4dDsKICBjbG9uZWQuZm5PcHRpb25zID0gdm5vZGUuZm5PcHRpb25zOwogIGNsb25lZC5mblNjb3BlSWQgPSB2bm9kZS5mblNjb3BlSWQ7CiAgY2xvbmVkLmFzeW5jTWV0YSA9IHZub2RlLmFzeW5jTWV0YTsKICBjbG9uZWQuaXNDbG9uZWQgPSB0cnVlOwogIHJldHVybiBjbG9uZWQ7Cn0KLyoKICogbm90IHR5cGUgY2hlY2tpbmcgdGhpcyBmaWxlIGJlY2F1c2UgZmxvdyBkb2Vzbid0IHBsYXkgd2VsbCB3aXRoCiAqIGR5bmFtaWNhbGx5IGFjY2Vzc2luZyBtZXRob2RzIG9uIEFycmF5IHByb3RvdHlwZQogKi8KCgp2YXIgYXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZTsKdmFyIGFycmF5TWV0aG9kcyA9IE9iamVjdC5jcmVhdGUoYXJyYXlQcm90byk7CnZhciBtZXRob2RzVG9QYXRjaCA9IFsncHVzaCcsICdwb3AnLCAnc2hpZnQnLCAndW5zaGlmdCcsICdzcGxpY2UnLCAnc29ydCcsICdyZXZlcnNlJ107Ci8qKgogKiBJbnRlcmNlcHQgbXV0YXRpbmcgbWV0aG9kcyBhbmQgZW1pdCBldmVudHMKICovCgptZXRob2RzVG9QYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAvLyBjYWNoZSBvcmlnaW5hbCBtZXRob2QKICB2YXIgb3JpZ2luYWwgPSBhcnJheVByb3RvW21ldGhvZF07CiAgZGVmKGFycmF5TWV0aG9kcywgbWV0aG9kLCBmdW5jdGlvbiBtdXRhdG9yKCkgewogICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwoKICAgIHdoaWxlIChsZW4tLSkgewogICAgICBhcmdzW2xlbl0gPSBhcmd1bWVudHNbbGVuXTsKICAgIH0KCiAgICB2YXIgcmVzdWx0ID0gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncyk7CiAgICB2YXIgb2IgPSB0aGlzLl9fb2JfXzsKICAgIHZhciBpbnNlcnRlZDsKCiAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICBjYXNlICdwdXNoJzoKICAgICAgY2FzZSAndW5zaGlmdCc6CiAgICAgICAgaW5zZXJ0ZWQgPSBhcmdzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc3BsaWNlJzoKICAgICAgICBpbnNlcnRlZCA9IGFyZ3Muc2xpY2UoMik7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgaWYgKGluc2VydGVkKSB7CiAgICAgIG9iLm9ic2VydmVBcnJheShpbnNlcnRlZCk7CiAgICB9IC8vIG5vdGlmeSBjaGFuZ2UKCgogICAgb2IuZGVwLm5vdGlmeSgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9KTsKfSk7Ci8qICAqLwoKdmFyIGFycmF5S2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGFycmF5TWV0aG9kcyk7Ci8qKgogKiBJbiBzb21lIGNhc2VzIHdlIG1heSB3YW50IHRvIGRpc2FibGUgb2JzZXJ2YXRpb24gaW5zaWRlIGEgY29tcG9uZW50J3MKICogdXBkYXRlIGNvbXB1dGF0aW9uLgogKi8KCnZhciBzaG91bGRPYnNlcnZlID0gdHJ1ZTsKCmZ1bmN0aW9uIHRvZ2dsZU9ic2VydmluZyh2YWx1ZSkgewogIHNob3VsZE9ic2VydmUgPSB2YWx1ZTsKfQovKioKICogT2JzZXJ2ZXIgY2xhc3MgdGhhdCBpcyBhdHRhY2hlZCB0byBlYWNoIG9ic2VydmVkCiAqIG9iamVjdC4gT25jZSBhdHRhY2hlZCwgdGhlIG9ic2VydmVyIGNvbnZlcnRzIHRoZSB0YXJnZXQKICogb2JqZWN0J3MgcHJvcGVydHkga2V5cyBpbnRvIGdldHRlci9zZXR0ZXJzIHRoYXQKICogY29sbGVjdCBkZXBlbmRlbmNpZXMgYW5kIGRpc3BhdGNoIHVwZGF0ZXMuCiAqLwoKCnZhciBPYnNlcnZlciA9IGZ1bmN0aW9uIE9ic2VydmVyKHZhbHVlKSB7CiAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIHRoaXMuZGVwID0gbmV3IERlcCgpOwogIHRoaXMudm1Db3VudCA9IDA7CiAgZGVmKHZhbHVlLCAnX19vYl9fJywgdGhpcyk7CgogIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgaWYgKGhhc1Byb3RvKSB7CiAgICAgIHByb3RvQXVnbWVudCh2YWx1ZSwgYXJyYXlNZXRob2RzKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvcHlBdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMsIGFycmF5S2V5cyk7CiAgICB9CgogICAgdGhpcy5vYnNlcnZlQXJyYXkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB0aGlzLndhbGsodmFsdWUpOwogIH0KfTsKLyoqCiAqIFdhbGsgdGhyb3VnaCBhbGwgcHJvcGVydGllcyBhbmQgY29udmVydCB0aGVtIGludG8KICogZ2V0dGVyL3NldHRlcnMuIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGJlIGNhbGxlZCB3aGVuCiAqIHZhbHVlIHR5cGUgaXMgT2JqZWN0LgogKi8KCgpPYnNlcnZlci5wcm90b3R5cGUud2FsayA9IGZ1bmN0aW9uIHdhbGsob2JqKSB7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGRlZmluZVJlYWN0aXZlJCQxKG9iaiwga2V5c1tpXSk7CiAgfQp9OwovKioKICogT2JzZXJ2ZSBhIGxpc3Qgb2YgQXJyYXkgaXRlbXMuCiAqLwoKCk9ic2VydmVyLnByb3RvdHlwZS5vYnNlcnZlQXJyYXkgPSBmdW5jdGlvbiBvYnNlcnZlQXJyYXkoaXRlbXMpIHsKICBmb3IgKHZhciBpID0gMCwgbCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgb2JzZXJ2ZShpdGVtc1tpXSk7CiAgfQp9OyAvLyBoZWxwZXJzCgovKioKICogQXVnbWVudCBhIHRhcmdldCBPYmplY3Qgb3IgQXJyYXkgYnkgaW50ZXJjZXB0aW5nCiAqIHRoZSBwcm90b3R5cGUgY2hhaW4gdXNpbmcgX19wcm90b19fCiAqLwoKCmZ1bmN0aW9uIHByb3RvQXVnbWVudCh0YXJnZXQsIHNyYykgewogIC8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCiAgdGFyZ2V0Ll9fcHJvdG9fXyA9IHNyYzsKICAvKiBlc2xpbnQtZW5hYmxlIG5vLXByb3RvICovCn0KLyoqCiAqIEF1Z21lbnQgYSB0YXJnZXQgT2JqZWN0IG9yIEFycmF5IGJ5IGRlZmluaW5nCiAqIGhpZGRlbiBwcm9wZXJ0aWVzLgogKi8KCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKZnVuY3Rpb24gY29weUF1Z21lbnQodGFyZ2V0LCBzcmMsIGtleXMpIHsKICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgIGRlZih0YXJnZXQsIGtleSwgc3JjW2tleV0pOwogIH0KfQovKioKICogQXR0ZW1wdCB0byBjcmVhdGUgYW4gb2JzZXJ2ZXIgaW5zdGFuY2UgZm9yIGEgdmFsdWUsCiAqIHJldHVybnMgdGhlIG5ldyBvYnNlcnZlciBpZiBzdWNjZXNzZnVsbHkgb2JzZXJ2ZWQsCiAqIG9yIHRoZSBleGlzdGluZyBvYnNlcnZlciBpZiB0aGUgdmFsdWUgYWxyZWFkeSBoYXMgb25lLgogKi8KCgpmdW5jdGlvbiBvYnNlcnZlKHZhbHVlLCBhc1Jvb3REYXRhKSB7CiAgaWYgKCFpc09iamVjdCh2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG9iOwoKICBpZiAoaGFzT3duKHZhbHVlLCAnX19vYl9fJykgJiYgdmFsdWUuX19vYl9fIGluc3RhbmNlb2YgT2JzZXJ2ZXIpIHsKICAgIG9iID0gdmFsdWUuX19vYl9fOwogIH0gZWxzZSBpZiAoc2hvdWxkT2JzZXJ2ZSAmJiAhaXNTZXJ2ZXJSZW5kZXJpbmcoKSAmJiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgaXNQbGFpbk9iamVjdCh2YWx1ZSkpICYmIE9iamVjdC5pc0V4dGVuc2libGUodmFsdWUpICYmICF2YWx1ZS5faXNWdWUpIHsKICAgIG9iID0gbmV3IE9ic2VydmVyKHZhbHVlKTsKICB9CgogIGlmIChhc1Jvb3REYXRhICYmIG9iKSB7CiAgICBvYi52bUNvdW50Kys7CiAgfQoKICByZXR1cm4gb2I7Cn0KLyoqCiAqIERlZmluZSBhIHJlYWN0aXZlIHByb3BlcnR5IG9uIGFuIE9iamVjdC4KICovCgoKZnVuY3Rpb24gZGVmaW5lUmVhY3RpdmUkJDEob2JqLCBrZXksIHZhbCwgY3VzdG9tU2V0dGVyLCBzaGFsbG93KSB7CiAgdmFyIGRlcCA9IG5ldyBEZXAoKTsKICB2YXIgcHJvcGVydHkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKCiAgaWYgKHByb3BlcnR5ICYmIHByb3BlcnR5LmNvbmZpZ3VyYWJsZSA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKICB9IC8vIGNhdGVyIGZvciBwcmUtZGVmaW5lZCBnZXR0ZXIvc2V0dGVycwoKCiAgdmFyIGdldHRlciA9IHByb3BlcnR5ICYmIHByb3BlcnR5LmdldDsKICB2YXIgc2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuc2V0OwoKICBpZiAoKCFnZXR0ZXIgfHwgc2V0dGVyKSAmJiBhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICB2YWwgPSBvYmpba2V5XTsKICB9CgogIHZhciBjaGlsZE9iID0gIXNoYWxsb3cgJiYgb2JzZXJ2ZSh2YWwpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gcmVhY3RpdmVHZXR0ZXIoKSB7CiAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CgogICAgICBpZiAoRGVwLnRhcmdldCkgewogICAgICAgIGRlcC5kZXBlbmQoKTsKCiAgICAgICAgaWYgKGNoaWxkT2IpIHsKICAgICAgICAgIGNoaWxkT2IuZGVwLmRlcGVuZCgpOwoKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICBkZXBlbmRBcnJheSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbiByZWFjdGl2ZVNldHRlcihuZXdWYWwpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tc2VsZi1jb21wYXJlICovCgogICAgICBpZiAobmV3VmFsID09PSB2YWx1ZSB8fCBuZXdWYWwgIT09IG5ld1ZhbCAmJiB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1zZWxmLWNvbXBhcmUgKi8KCgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjdXN0b21TZXR0ZXIpIHsKICAgICAgICBjdXN0b21TZXR0ZXIoKTsKICAgICAgfSAvLyAjNzk4MTogZm9yIGFjY2Vzc29yIHByb3BlcnRpZXMgd2l0aG91dCBzZXR0ZXIKCgogICAgICBpZiAoZ2V0dGVyICYmICFzZXR0ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChzZXR0ZXIpIHsKICAgICAgICBzZXR0ZXIuY2FsbChvYmosIG5ld1ZhbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsID0gbmV3VmFsOwogICAgICB9CgogICAgICBjaGlsZE9iID0gIXNoYWxsb3cgJiYgb2JzZXJ2ZShuZXdWYWwpOwogICAgICBkZXAubm90aWZ5KCk7CiAgICB9CiAgfSk7Cn0KLyoqCiAqIFNldCBhIHByb3BlcnR5IG9uIGFuIG9iamVjdC4gQWRkcyB0aGUgbmV3IHByb3BlcnR5IGFuZAogKiB0cmlnZ2VycyBjaGFuZ2Ugbm90aWZpY2F0aW9uIGlmIHRoZSBwcm9wZXJ0eSBkb2Vzbid0CiAqIGFscmVhZHkgZXhpc3QuCiAqLwoKCmZ1bmN0aW9uIHNldCh0YXJnZXQsIGtleSwgdmFsKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgKGlzVW5kZWYodGFyZ2V0KSB8fCBpc1ByaW1pdGl2ZSh0YXJnZXQpKSkgewogICAgd2FybigiQ2Fubm90IHNldCByZWFjdGl2ZSBwcm9wZXJ0eSBvbiB1bmRlZmluZWQsIG51bGwsIG9yIHByaW1pdGl2ZSB2YWx1ZTogIiArIHRhcmdldCk7CiAgfQoKICBpZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIGlzVmFsaWRBcnJheUluZGV4KGtleSkpIHsKICAgIHRhcmdldC5sZW5ndGggPSBNYXRoLm1heCh0YXJnZXQubGVuZ3RoLCBrZXkpOwogICAgdGFyZ2V0LnNwbGljZShrZXksIDEsIHZhbCk7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgaWYgKGtleSBpbiB0YXJnZXQgJiYgIShrZXkgaW4gT2JqZWN0LnByb3RvdHlwZSkpIHsKICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgcmV0dXJuIHZhbDsKICB9CgogIHZhciBvYiA9IHRhcmdldC5fX29iX187CgogIGlmICh0YXJnZXQuX2lzVnVlIHx8IG9iICYmIG9iLnZtQ291bnQpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignQXZvaWQgYWRkaW5nIHJlYWN0aXZlIHByb3BlcnRpZXMgdG8gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArICdhdCBydW50aW1lIC0gZGVjbGFyZSBpdCB1cGZyb250IGluIHRoZSBkYXRhIG9wdGlvbi4nKTsKICAgIHJldHVybiB2YWw7CiAgfQoKICBpZiAoIW9iKSB7CiAgICB0YXJnZXRba2V5XSA9IHZhbDsKICAgIHJldHVybiB2YWw7CiAgfQoKICBkZWZpbmVSZWFjdGl2ZSQkMShvYi52YWx1ZSwga2V5LCB2YWwpOwogIG9iLmRlcC5ub3RpZnkoKTsKICByZXR1cm4gdmFsOwp9Ci8qKgogKiBEZWxldGUgYSBwcm9wZXJ0eSBhbmQgdHJpZ2dlciBjaGFuZ2UgaWYgbmVjZXNzYXJ5LgogKi8KCgpmdW5jdGlvbiBkZWwodGFyZ2V0LCBrZXkpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3QgZGVsZXRlIHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiICsgdGFyZ2V0KTsKICB9CgogIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgdGFyZ2V0LnNwbGljZShrZXksIDEpOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIG9iID0gdGFyZ2V0Ll9fb2JfXzsKCiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBkZWxldGluZyBwcm9wZXJ0aWVzIG9uIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKyAnLSBqdXN0IHNldCBpdCB0byBudWxsLicpOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKCFoYXNPd24odGFyZ2V0LCBrZXkpKSB7CiAgICByZXR1cm47CiAgfQoKICBkZWxldGUgdGFyZ2V0W2tleV07CgogIGlmICghb2IpIHsKICAgIHJldHVybjsKICB9CgogIG9iLmRlcC5ub3RpZnkoKTsKfQovKioKICogQ29sbGVjdCBkZXBlbmRlbmNpZXMgb24gYXJyYXkgZWxlbWVudHMgd2hlbiB0aGUgYXJyYXkgaXMgdG91Y2hlZCwgc2luY2UKICogd2UgY2Fubm90IGludGVyY2VwdCBhcnJheSBlbGVtZW50IGFjY2VzcyBsaWtlIHByb3BlcnR5IGdldHRlcnMuCiAqLwoKCmZ1bmN0aW9uIGRlcGVuZEFycmF5KHZhbHVlKSB7CiAgZm9yICh2YXIgZSA9IHZvaWQgMCwgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGUgPSB2YWx1ZVtpXTsKICAgIGUgJiYgZS5fX29iX18gJiYgZS5fX29iX18uZGVwLmRlcGVuZCgpOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGUpKSB7CiAgICAgIGRlcGVuZEFycmF5KGUpOwogICAgfQogIH0KfQovKiAgKi8KCi8qKgogKiBPcHRpb24gb3ZlcndyaXRpbmcgc3RyYXRlZ2llcyBhcmUgZnVuY3Rpb25zIHRoYXQgaGFuZGxlCiAqIGhvdyB0byBtZXJnZSBhIHBhcmVudCBvcHRpb24gdmFsdWUgYW5kIGEgY2hpbGQgb3B0aW9uCiAqIHZhbHVlIGludG8gdGhlIGZpbmFsIHZhbHVlLgogKi8KCgp2YXIgc3RyYXRzID0gY29uZmlnLm9wdGlvbk1lcmdlU3RyYXRlZ2llczsKLyoqCiAqIE9wdGlvbnMgd2l0aCByZXN0cmljdGlvbnMKICovCgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHN0cmF0cy5lbCA9IHN0cmF0cy5wcm9wc0RhdGEgPSBmdW5jdGlvbiAocGFyZW50LCBjaGlsZCwgdm0sIGtleSkgewogICAgaWYgKCF2bSkgewogICAgICB3YXJuKCJvcHRpb24gXCIiICsga2V5ICsgIlwiIGNhbiBvbmx5IGJlIHVzZWQgZHVyaW5nIGluc3RhbmNlICIgKyAnY3JlYXRpb24gd2l0aCB0aGUgYG5ld2Aga2V5d29yZC4nKTsKICAgIH0KCiAgICByZXR1cm4gZGVmYXVsdFN0cmF0KHBhcmVudCwgY2hpbGQpOwogIH07Cn0KLyoqCiAqIEhlbHBlciB0aGF0IHJlY3Vyc2l2ZWx5IG1lcmdlcyB0d28gZGF0YSBvYmplY3RzIHRvZ2V0aGVyLgogKi8KCgpmdW5jdGlvbiBtZXJnZURhdGEodG8sIGZyb20pIHsKICBpZiAoIWZyb20pIHsKICAgIHJldHVybiB0bzsKICB9CgogIHZhciBrZXksIHRvVmFsLCBmcm9tVmFsOwogIHZhciBrZXlzID0gaGFzU3ltYm9sID8gUmVmbGVjdC5vd25LZXlzKGZyb20pIDogT2JqZWN0LmtleXMoZnJvbSk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAga2V5ID0ga2V5c1tpXTsgLy8gaW4gY2FzZSB0aGUgb2JqZWN0IGlzIGFscmVhZHkgb2JzZXJ2ZWQuLi4KCiAgICBpZiAoa2V5ID09PSAnX19vYl9fJykgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICB0b1ZhbCA9IHRvW2tleV07CiAgICBmcm9tVmFsID0gZnJvbVtrZXldOwoKICAgIGlmICghaGFzT3duKHRvLCBrZXkpKSB7CiAgICAgIHNldCh0bywga2V5LCBmcm9tVmFsKTsKICAgIH0gZWxzZSBpZiAodG9WYWwgIT09IGZyb21WYWwgJiYgaXNQbGFpbk9iamVjdCh0b1ZhbCkgJiYgaXNQbGFpbk9iamVjdChmcm9tVmFsKSkgewogICAgICBtZXJnZURhdGEodG9WYWwsIGZyb21WYWwpOwogICAgfQogIH0KCiAgcmV0dXJuIHRvOwp9Ci8qKgogKiBEYXRhCiAqLwoKCmZ1bmN0aW9uIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pIHsKICBpZiAoIXZtKSB7CiAgICAvLyBpbiBhIFZ1ZS5leHRlbmQgbWVyZ2UsIGJvdGggc2hvdWxkIGJlIGZ1bmN0aW9ucwogICAgaWYgKCFjaGlsZFZhbCkgewogICAgICByZXR1cm4gcGFyZW50VmFsOwogICAgfQoKICAgIGlmICghcGFyZW50VmFsKSB7CiAgICAgIHJldHVybiBjaGlsZFZhbDsKICAgIH0gLy8gd2hlbiBwYXJlbnRWYWwgJiBjaGlsZFZhbCBhcmUgYm90aCBwcmVzZW50LAogICAgLy8gd2UgbmVlZCB0byByZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgICAvLyBtZXJnZWQgcmVzdWx0IG9mIGJvdGggZnVuY3Rpb25zLi4uIG5vIG5lZWQgdG8KICAgIC8vIGNoZWNrIGlmIHBhcmVudFZhbCBpcyBhIGZ1bmN0aW9uIGhlcmUgYmVjYXVzZQogICAgLy8gaXQgaGFzIHRvIGJlIGEgZnVuY3Rpb24gdG8gcGFzcyBwcmV2aW91cyBtZXJnZXMuCgoKICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWREYXRhRm4oKSB7CiAgICAgIHJldHVybiBtZXJnZURhdGEodHlwZW9mIGNoaWxkVmFsID09PSAnZnVuY3Rpb24nID8gY2hpbGRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IGNoaWxkVmFsLCB0eXBlb2YgcGFyZW50VmFsID09PSAnZnVuY3Rpb24nID8gcGFyZW50VmFsLmNhbGwodGhpcywgdGhpcykgOiBwYXJlbnRWYWwpOwogICAgfTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZ1bmN0aW9uIG1lcmdlZEluc3RhbmNlRGF0YUZuKCkgewogICAgICAvLyBpbnN0YW5jZSBtZXJnZQogICAgICB2YXIgaW5zdGFuY2VEYXRhID0gdHlwZW9mIGNoaWxkVmFsID09PSAnZnVuY3Rpb24nID8gY2hpbGRWYWwuY2FsbCh2bSwgdm0pIDogY2hpbGRWYWw7CiAgICAgIHZhciBkZWZhdWx0RGF0YSA9IHR5cGVvZiBwYXJlbnRWYWwgPT09ICdmdW5jdGlvbicgPyBwYXJlbnRWYWwuY2FsbCh2bSwgdm0pIDogcGFyZW50VmFsOwoKICAgICAgaWYgKGluc3RhbmNlRGF0YSkgewogICAgICAgIHJldHVybiBtZXJnZURhdGEoaW5zdGFuY2VEYXRhLCBkZWZhdWx0RGF0YSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHREYXRhOwogICAgICB9CiAgICB9OwogIH0KfQoKc3RyYXRzLmRhdGEgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pIHsKICBpZiAoIXZtKSB7CiAgICBpZiAoY2hpbGRWYWwgJiYgdHlwZW9mIGNoaWxkVmFsICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignVGhlICJkYXRhIiBvcHRpb24gc2hvdWxkIGJlIGEgZnVuY3Rpb24gJyArICd0aGF0IHJldHVybnMgYSBwZXItaW5zdGFuY2UgdmFsdWUgaW4gY29tcG9uZW50ICcgKyAnZGVmaW5pdGlvbnMuJywgdm0pOwogICAgICByZXR1cm4gcGFyZW50VmFsOwogICAgfQoKICAgIHJldHVybiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwpOwogIH0KCiAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0pOwp9OwovKioKICogSG9va3MgYW5kIHByb3BzIGFyZSBtZXJnZWQgYXMgYXJyYXlzLgogKi8KCgpmdW5jdGlvbiBtZXJnZUhvb2socGFyZW50VmFsLCBjaGlsZFZhbCkgewogIHZhciByZXMgPSBjaGlsZFZhbCA/IHBhcmVudFZhbCA/IHBhcmVudFZhbC5jb25jYXQoY2hpbGRWYWwpIDogQXJyYXkuaXNBcnJheShjaGlsZFZhbCkgPyBjaGlsZFZhbCA6IFtjaGlsZFZhbF0gOiBwYXJlbnRWYWw7CiAgcmV0dXJuIHJlcyA/IGRlZHVwZUhvb2tzKHJlcykgOiByZXM7Cn0KCmZ1bmN0aW9uIGRlZHVwZUhvb2tzKGhvb2tzKSB7CiAgdmFyIHJlcyA9IFtdOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAocmVzLmluZGV4T2YoaG9va3NbaV0pID09PSAtMSkgewogICAgICByZXMucHVzaChob29rc1tpXSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9CgpMSUZFQ1lDTEVfSE9PS1MuZm9yRWFjaChmdW5jdGlvbiAoaG9vaykgewogIHN0cmF0c1tob29rXSA9IG1lcmdlSG9vazsKfSk7Ci8qKgogKiBBc3NldHMKICoKICogV2hlbiBhIHZtIGlzIHByZXNlbnQgKGluc3RhbmNlIGNyZWF0aW9uKSwgd2UgbmVlZCB0byBkbwogKiBhIHRocmVlLXdheSBtZXJnZSBiZXR3ZWVuIGNvbnN0cnVjdG9yIG9wdGlvbnMsIGluc3RhbmNlCiAqIG9wdGlvbnMgYW5kIHBhcmVudCBvcHRpb25zLgogKi8KCmZ1bmN0aW9uIG1lcmdlQXNzZXRzKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShwYXJlbnRWYWwgfHwgbnVsbCk7CgogIGlmIChjaGlsZFZhbCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICAgIHJldHVybiBleHRlbmQocmVzLCBjaGlsZFZhbCk7CiAgfSBlbHNlIHsKICAgIHJldHVybiByZXM7CiAgfQp9CgpBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgc3RyYXRzW3R5cGUgKyAncyddID0gbWVyZ2VBc3NldHM7Cn0pOwovKioKICogV2F0Y2hlcnMuCiAqCiAqIFdhdGNoZXJzIGhhc2hlcyBzaG91bGQgbm90IG92ZXJ3cml0ZSBvbmUKICogYW5vdGhlciwgc28gd2UgbWVyZ2UgdGhlbSBhcyBhcnJheXMuCiAqLwoKc3RyYXRzLndhdGNoID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICAvLyB3b3JrIGFyb3VuZCBGaXJlZm94J3MgT2JqZWN0LnByb3RvdHlwZS53YXRjaC4uLgogIGlmIChwYXJlbnRWYWwgPT09IG5hdGl2ZVdhdGNoKSB7CiAgICBwYXJlbnRWYWwgPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAoY2hpbGRWYWwgPT09IG5hdGl2ZVdhdGNoKSB7CiAgICBjaGlsZFZhbCA9IHVuZGVmaW5lZDsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoIWNoaWxkVmFsKSB7CiAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShwYXJlbnRWYWwgfHwgbnVsbCk7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgfQoKICBpZiAoIXBhcmVudFZhbCkgewogICAgcmV0dXJuIGNoaWxkVmFsOwogIH0KCiAgdmFyIHJldCA9IHt9OwogIGV4dGVuZChyZXQsIHBhcmVudFZhbCk7CgogIGZvciAodmFyIGtleSQxIGluIGNoaWxkVmFsKSB7CiAgICB2YXIgcGFyZW50ID0gcmV0W2tleSQxXTsKICAgIHZhciBjaGlsZCA9IGNoaWxkVmFsW2tleSQxXTsKCiAgICBpZiAocGFyZW50ICYmICFBcnJheS5pc0FycmF5KHBhcmVudCkpIHsKICAgICAgcGFyZW50ID0gW3BhcmVudF07CiAgICB9CgogICAgcmV0W2tleSQxXSA9IHBhcmVudCA/IHBhcmVudC5jb25jYXQoY2hpbGQpIDogQXJyYXkuaXNBcnJheShjaGlsZCkgPyBjaGlsZCA6IFtjaGlsZF07CiAgfQoKICByZXR1cm4gcmV0Owp9OwovKioKICogT3RoZXIgb2JqZWN0IGhhc2hlcy4KICovCgoKc3RyYXRzLnByb3BzID0gc3RyYXRzLm1ldGhvZHMgPSBzdHJhdHMuaW5qZWN0ID0gc3RyYXRzLmNvbXB1dGVkID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtLCBrZXkpIHsKICBpZiAoY2hpbGRWYWwgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgfQoKICBpZiAoIXBhcmVudFZhbCkgewogICAgcmV0dXJuIGNoaWxkVmFsOwogIH0KCiAgdmFyIHJldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKCiAgaWYgKGNoaWxkVmFsKSB7CiAgICBleHRlbmQocmV0LCBjaGlsZFZhbCk7CiAgfQoKICByZXR1cm4gcmV0Owp9OwoKc3RyYXRzLnByb3ZpZGUgPSBtZXJnZURhdGFPckZuOwovKioKICogRGVmYXVsdCBzdHJhdGVneS4KICovCgp2YXIgZGVmYXVsdFN0cmF0ID0gZnVuY3Rpb24gZGVmYXVsdFN0cmF0KHBhcmVudFZhbCwgY2hpbGRWYWwpIHsKICByZXR1cm4gY2hpbGRWYWwgPT09IHVuZGVmaW5lZCA/IHBhcmVudFZhbCA6IGNoaWxkVmFsOwp9OwovKioKICogVmFsaWRhdGUgY29tcG9uZW50IG5hbWVzCiAqLwoKCmZ1bmN0aW9uIGNoZWNrQ29tcG9uZW50cyhvcHRpb25zKSB7CiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMuY29tcG9uZW50cykgewogICAgdmFsaWRhdGVDb21wb25lbnROYW1lKGtleSk7CiAgfQp9CgpmdW5jdGlvbiB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSkgewogIGlmICghbmV3IFJlZ0V4cCgiXlthLXpBLVpdW1xcLVxcLjAtOV8iICsgdW5pY29kZVJlZ0V4cC5zb3VyY2UgKyAiXSokIikudGVzdChuYW1lKSkgewogICAgd2FybignSW52YWxpZCBjb21wb25lbnQgbmFtZTogIicgKyBuYW1lICsgJyIuIENvbXBvbmVudCBuYW1lcyAnICsgJ3Nob3VsZCBjb25mb3JtIHRvIHZhbGlkIGN1c3RvbSBlbGVtZW50IG5hbWUgaW4gaHRtbDUgc3BlY2lmaWNhdGlvbi4nKTsKICB9CgogIGlmIChpc0J1aWx0SW5UYWcobmFtZSkgfHwgY29uZmlnLmlzUmVzZXJ2ZWRUYWcobmFtZSkpIHsKICAgIHdhcm4oJ0RvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgJyArICdpZDogJyArIG5hbWUpOwogIH0KfQovKioKICogRW5zdXJlIGFsbCBwcm9wcyBvcHRpb24gc3ludGF4IGFyZSBub3JtYWxpemVkIGludG8gdGhlCiAqIE9iamVjdC1iYXNlZCBmb3JtYXQuCiAqLwoKCmZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzKG9wdGlvbnMsIHZtKSB7CiAgdmFyIHByb3BzID0gb3B0aW9ucy5wcm9wczsKCiAgaWYgKCFwcm9wcykgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHJlcyA9IHt9OwogIHZhciBpLCB2YWwsIG5hbWU7CgogIGlmIChBcnJheS5pc0FycmF5KHByb3BzKSkgewogICAgaSA9IHByb3BzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHZhbCA9IHByb3BzW2ldOwoKICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgbmFtZSA9IGNhbWVsaXplKHZhbCk7CiAgICAgICAgcmVzW25hbWVdID0gewogICAgICAgICAgdHlwZTogbnVsbAogICAgICAgIH07CiAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHdhcm4oJ3Byb3BzIG11c3QgYmUgc3RyaW5ncyB3aGVuIHVzaW5nIGFycmF5IHN5bnRheC4nKTsKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChwcm9wcykpIHsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICB2YWwgPSBwcm9wc1trZXldOwogICAgICBuYW1lID0gY2FtZWxpemUoa2V5KTsKICAgICAgcmVzW25hbWVdID0gaXNQbGFpbk9iamVjdCh2YWwpID8gdmFsIDogewogICAgICAgIHR5cGU6IHZhbAogICAgICB9OwogICAgfQogIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwicHJvcHNcIjogZXhwZWN0ZWQgYW4gQXJyYXkgb3IgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIiArIHRvUmF3VHlwZShwcm9wcykgKyAiLiIsIHZtKTsKICB9CgogIG9wdGlvbnMucHJvcHMgPSByZXM7Cn0KLyoqCiAqIE5vcm1hbGl6ZSBhbGwgaW5qZWN0aW9ucyBpbnRvIE9iamVjdC1iYXNlZCBmb3JtYXQKICovCgoKZnVuY3Rpb24gbm9ybWFsaXplSW5qZWN0KG9wdGlvbnMsIHZtKSB7CiAgdmFyIGluamVjdCA9IG9wdGlvbnMuaW5qZWN0OwoKICBpZiAoIWluamVjdCkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG5vcm1hbGl6ZWQgPSBvcHRpb25zLmluamVjdCA9IHt9OwoKICBpZiAoQXJyYXkuaXNBcnJheShpbmplY3QpKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluamVjdC5sZW5ndGg7IGkrKykgewogICAgICBub3JtYWxpemVkW2luamVjdFtpXV0gPSB7CiAgICAgICAgZnJvbTogaW5qZWN0W2ldCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KGluamVjdCkpIHsKICAgIGZvciAodmFyIGtleSBpbiBpbmplY3QpIHsKICAgICAgdmFyIHZhbCA9IGluamVjdFtrZXldOwogICAgICBub3JtYWxpemVkW2tleV0gPSBpc1BsYWluT2JqZWN0KHZhbCkgPyBleHRlbmQoewogICAgICAgIGZyb206IGtleQogICAgICB9LCB2YWwpIDogewogICAgICAgIGZyb206IHZhbAogICAgICB9OwogICAgfQogIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwiaW5qZWN0XCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArICJidXQgZ290ICIgKyB0b1Jhd1R5cGUoaW5qZWN0KSArICIuIiwgdm0pOwogIH0KfQovKioKICogTm9ybWFsaXplIHJhdyBmdW5jdGlvbiBkaXJlY3RpdmVzIGludG8gb2JqZWN0IGZvcm1hdC4KICovCgoKZnVuY3Rpb24gbm9ybWFsaXplRGlyZWN0aXZlcyhvcHRpb25zKSB7CiAgdmFyIGRpcnMgPSBvcHRpb25zLmRpcmVjdGl2ZXM7CgogIGlmIChkaXJzKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gZGlycykgewogICAgICB2YXIgZGVmJCQxID0gZGlyc1trZXldOwoKICAgICAgaWYgKHR5cGVvZiBkZWYkJDEgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBkaXJzW2tleV0gPSB7CiAgICAgICAgICBiaW5kOiBkZWYkJDEsCiAgICAgICAgICB1cGRhdGU6IGRlZiQkMQogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFzc2VydE9iamVjdFR5cGUobmFtZSwgdmFsdWUsIHZtKSB7CiAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwiIiArIG5hbWUgKyAiXCI6IGV4cGVjdGVkIGFuIE9iamVjdCwgIiArICJidXQgZ290ICIgKyB0b1Jhd1R5cGUodmFsdWUpICsgIi4iLCB2bSk7CiAgfQp9Ci8qKgogKiBNZXJnZSB0d28gb3B0aW9uIG9iamVjdHMgaW50byBhIG5ldyBvbmUuCiAqIENvcmUgdXRpbGl0eSB1c2VkIGluIGJvdGggaW5zdGFudGlhdGlvbiBhbmQgaW5oZXJpdGFuY2UuCiAqLwoKCmZ1bmN0aW9uIG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkLCB2bSkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjaGVja0NvbXBvbmVudHMoY2hpbGQpOwogIH0KCiAgaWYgKHR5cGVvZiBjaGlsZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2hpbGQgPSBjaGlsZC5vcHRpb25zOwogIH0KCiAgbm9ybWFsaXplUHJvcHMoY2hpbGQsIHZtKTsKICBub3JtYWxpemVJbmplY3QoY2hpbGQsIHZtKTsKICBub3JtYWxpemVEaXJlY3RpdmVzKGNoaWxkKTsgLy8gQXBwbHkgZXh0ZW5kcyBhbmQgbWl4aW5zIG9uIHRoZSBjaGlsZCBvcHRpb25zLAogIC8vIGJ1dCBvbmx5IGlmIGl0IGlzIGEgcmF3IG9wdGlvbnMgb2JqZWN0IHRoYXQgaXNuJ3QKICAvLyB0aGUgcmVzdWx0IG9mIGFub3RoZXIgbWVyZ2VPcHRpb25zIGNhbGwuCiAgLy8gT25seSBtZXJnZWQgb3B0aW9ucyBoYXMgdGhlIF9iYXNlIHByb3BlcnR5LgoKICBpZiAoIWNoaWxkLl9iYXNlKSB7CiAgICBpZiAoY2hpbGRbImV4dGVuZHMiXSkgewogICAgICBwYXJlbnQgPSBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZFsiZXh0ZW5kcyJdLCB2bSk7CiAgICB9CgogICAgaWYgKGNoaWxkLm1peGlucykgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkLm1peGlucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBwYXJlbnQgPSBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZC5taXhpbnNbaV0sIHZtKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIG9wdGlvbnMgPSB7fTsKICB2YXIga2V5OwoKICBmb3IgKGtleSBpbiBwYXJlbnQpIHsKICAgIG1lcmdlRmllbGQoa2V5KTsKICB9CgogIGZvciAoa2V5IGluIGNoaWxkKSB7CiAgICBpZiAoIWhhc093bihwYXJlbnQsIGtleSkpIHsKICAgICAgbWVyZ2VGaWVsZChrZXkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbWVyZ2VGaWVsZChrZXkpIHsKICAgIHZhciBzdHJhdCA9IHN0cmF0c1trZXldIHx8IGRlZmF1bHRTdHJhdDsKICAgIG9wdGlvbnNba2V5XSA9IHN0cmF0KHBhcmVudFtrZXldLCBjaGlsZFtrZXldLCB2bSwga2V5KTsKICB9CgogIHJldHVybiBvcHRpb25zOwp9Ci8qKgogKiBSZXNvbHZlIGFuIGFzc2V0LgogKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgYmVjYXVzZSBjaGlsZCBpbnN0YW5jZXMgbmVlZCBhY2Nlc3MKICogdG8gYXNzZXRzIGRlZmluZWQgaW4gaXRzIGFuY2VzdG9yIGNoYWluLgogKi8KCgpmdW5jdGlvbiByZXNvbHZlQXNzZXQob3B0aW9ucywgdHlwZSwgaWQsIHdhcm5NaXNzaW5nKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBhc3NldHMgPSBvcHRpb25zW3R5cGVdOyAvLyBjaGVjayBsb2NhbCByZWdpc3RyYXRpb24gdmFyaWF0aW9ucyBmaXJzdAoKICBpZiAoaGFzT3duKGFzc2V0cywgaWQpKSB7CiAgICByZXR1cm4gYXNzZXRzW2lkXTsKICB9CgogIHZhciBjYW1lbGl6ZWRJZCA9IGNhbWVsaXplKGlkKTsKCiAgaWYgKGhhc093bihhc3NldHMsIGNhbWVsaXplZElkKSkgewogICAgcmV0dXJuIGFzc2V0c1tjYW1lbGl6ZWRJZF07CiAgfQoKICB2YXIgUGFzY2FsQ2FzZUlkID0gY2FwaXRhbGl6ZShjYW1lbGl6ZWRJZCk7CgogIGlmIChoYXNPd24oYXNzZXRzLCBQYXNjYWxDYXNlSWQpKSB7CiAgICByZXR1cm4gYXNzZXRzW1Bhc2NhbENhc2VJZF07CiAgfSAvLyBmYWxsYmFjayB0byBwcm90b3R5cGUgY2hhaW4KCgogIHZhciByZXMgPSBhc3NldHNbaWRdIHx8IGFzc2V0c1tjYW1lbGl6ZWRJZF0gfHwgYXNzZXRzW1Bhc2NhbENhc2VJZF07CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm5NaXNzaW5nICYmICFyZXMpIHsKICAgIHdhcm4oJ0ZhaWxlZCB0byByZXNvbHZlICcgKyB0eXBlLnNsaWNlKDAsIC0xKSArICc6ICcgKyBpZCwgb3B0aW9ucyk7CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKSB7CiAgdmFyIHByb3AgPSBwcm9wT3B0aW9uc1trZXldOwogIHZhciBhYnNlbnQgPSAhaGFzT3duKHByb3BzRGF0YSwga2V5KTsKICB2YXIgdmFsdWUgPSBwcm9wc0RhdGFba2V5XTsgLy8gYm9vbGVhbiBjYXN0aW5nCgogIHZhciBib29sZWFuSW5kZXggPSBnZXRUeXBlSW5kZXgoQm9vbGVhbiwgcHJvcC50eXBlKTsKCiAgaWYgKGJvb2xlYW5JbmRleCA+IC0xKSB7CiAgICBpZiAoYWJzZW50ICYmICFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICB2YWx1ZSA9IGZhbHNlOwogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSB7CiAgICAgIC8vIG9ubHkgY2FzdCBlbXB0eSBzdHJpbmcgLyBzYW1lIG5hbWUgdG8gYm9vbGVhbiBpZgogICAgICAvLyBib29sZWFuIGhhcyBoaWdoZXIgcHJpb3JpdHkKICAgICAgdmFyIHN0cmluZ0luZGV4ID0gZ2V0VHlwZUluZGV4KFN0cmluZywgcHJvcC50eXBlKTsKCiAgICAgIGlmIChzdHJpbmdJbmRleCA8IDAgfHwgYm9vbGVhbkluZGV4IDwgc3RyaW5nSW5kZXgpIHsKICAgICAgICB2YWx1ZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9IC8vIGNoZWNrIGRlZmF1bHQgdmFsdWUKCgogIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICB2YWx1ZSA9IGdldFByb3BEZWZhdWx0VmFsdWUodm0sIHByb3AsIGtleSk7IC8vIHNpbmNlIHRoZSBkZWZhdWx0IHZhbHVlIGlzIGEgZnJlc2ggY29weSwKICAgIC8vIG1ha2Ugc3VyZSB0byBvYnNlcnZlIGl0LgoKICAgIHZhciBwcmV2U2hvdWxkT2JzZXJ2ZSA9IHNob3VsZE9ic2VydmU7CiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgICBvYnNlcnZlKHZhbHVlKTsKICAgIHRvZ2dsZU9ic2VydmluZyhwcmV2U2hvdWxkT2JzZXJ2ZSk7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAvLyBza2lwIHZhbGlkYXRpb24gZm9yIHdlZXggcmVjeWNsZS1saXN0IGNoaWxkIGNvbXBvbmVudCBwcm9wcwogICFmYWxzZSkgewogICAgYXNzZXJ0UHJvcChwcm9wLCBrZXksIHZhbHVlLCB2bSwgYWJzZW50KTsKICB9CgogIHJldHVybiB2YWx1ZTsKfQovKioKICogR2V0IHRoZSBkZWZhdWx0IHZhbHVlIG9mIGEgcHJvcC4KICovCgoKZnVuY3Rpb24gZ2V0UHJvcERlZmF1bHRWYWx1ZSh2bSwgcHJvcCwga2V5KSB7CiAgLy8gbm8gZGVmYXVsdCwgcmV0dXJuIHVuZGVmaW5lZAogIGlmICghaGFzT3duKHByb3AsICdkZWZhdWx0JykpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfQoKICB2YXIgZGVmID0gcHJvcFsiZGVmYXVsdCJdOyAvLyB3YXJuIGFnYWluc3Qgbm9uLWZhY3RvcnkgZGVmYXVsdHMgZm9yIE9iamVjdCAmIEFycmF5CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzT2JqZWN0KGRlZikpIHsKICAgIHdhcm4oJ0ludmFsaWQgZGVmYXVsdCB2YWx1ZSBmb3IgcHJvcCAiJyArIGtleSArICciOiAnICsgJ1Byb3BzIHdpdGggdHlwZSBPYmplY3QvQXJyYXkgbXVzdCB1c2UgYSBmYWN0b3J5IGZ1bmN0aW9uICcgKyAndG8gcmV0dXJuIHRoZSBkZWZhdWx0IHZhbHVlLicsIHZtKTsKICB9IC8vIHRoZSByYXcgcHJvcCB2YWx1ZSB3YXMgYWxzbyB1bmRlZmluZWQgZnJvbSBwcmV2aW91cyByZW5kZXIsCiAgLy8gcmV0dXJuIHByZXZpb3VzIGRlZmF1bHQgdmFsdWUgdG8gYXZvaWQgdW5uZWNlc3Nhcnkgd2F0Y2hlciB0cmlnZ2VyCgoKICBpZiAodm0gJiYgdm0uJG9wdGlvbnMucHJvcHNEYXRhICYmIHZtLiRvcHRpb25zLnByb3BzRGF0YVtrZXldID09PSB1bmRlZmluZWQgJiYgdm0uX3Byb3BzW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIHZtLl9wcm9wc1trZXldOwogIH0gLy8gY2FsbCBmYWN0b3J5IGZ1bmN0aW9uIGZvciBub24tRnVuY3Rpb24gdHlwZXMKICAvLyBhIHZhbHVlIGlzIEZ1bmN0aW9uIGlmIGl0cyBwcm90b3R5cGUgaXMgZnVuY3Rpb24gZXZlbiBhY3Jvc3MgZGlmZmVyZW50IGV4ZWN1dGlvbiBjb250ZXh0CgoKICByZXR1cm4gdHlwZW9mIGRlZiA9PT0gJ2Z1bmN0aW9uJyAmJiBnZXRUeXBlKHByb3AudHlwZSkgIT09ICdGdW5jdGlvbicgPyBkZWYuY2FsbCh2bSkgOiBkZWY7Cn0KLyoqCiAqIEFzc2VydCB3aGV0aGVyIGEgcHJvcCBpcyB2YWxpZC4KICovCgoKZnVuY3Rpb24gYXNzZXJ0UHJvcChwcm9wLCBuYW1lLCB2YWx1ZSwgdm0sIGFic2VudCkgewogIGlmIChwcm9wLnJlcXVpcmVkICYmIGFic2VudCkgewogICAgd2FybignTWlzc2luZyByZXF1aXJlZCBwcm9wOiAiJyArIG5hbWUgKyAnIicsIHZtKTsKICAgIHJldHVybjsKICB9CgogIGlmICh2YWx1ZSA9PSBudWxsICYmICFwcm9wLnJlcXVpcmVkKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdHlwZSA9IHByb3AudHlwZTsKICB2YXIgdmFsaWQgPSAhdHlwZSB8fCB0eXBlID09PSB0cnVlOwogIHZhciBleHBlY3RlZFR5cGVzID0gW107CgogIGlmICh0eXBlKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkodHlwZSkpIHsKICAgICAgdHlwZSA9IFt0eXBlXTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHR5cGUubGVuZ3RoICYmICF2YWxpZDsgaSsrKSB7CiAgICAgIHZhciBhc3NlcnRlZFR5cGUgPSBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlW2ldLCB2bSk7CiAgICAgIGV4cGVjdGVkVHlwZXMucHVzaChhc3NlcnRlZFR5cGUuZXhwZWN0ZWRUeXBlIHx8ICcnKTsKICAgICAgdmFsaWQgPSBhc3NlcnRlZFR5cGUudmFsaWQ7CiAgICB9CiAgfQoKICB2YXIgaGF2ZUV4cGVjdGVkVHlwZXMgPSBleHBlY3RlZFR5cGVzLnNvbWUoZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiB0OwogIH0pOwoKICBpZiAoIXZhbGlkICYmIGhhdmVFeHBlY3RlZFR5cGVzKSB7CiAgICB3YXJuKGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcyksIHZtKTsKICAgIHJldHVybjsKICB9CgogIHZhciB2YWxpZGF0b3IgPSBwcm9wLnZhbGlkYXRvcjsKCiAgaWYgKHZhbGlkYXRvcikgewogICAgaWYgKCF2YWxpZGF0b3IodmFsdWUpKSB7CiAgICAgIHdhcm4oJ0ludmFsaWQgcHJvcDogY3VzdG9tIHZhbGlkYXRvciBjaGVjayBmYWlsZWQgZm9yIHByb3AgIicgKyBuYW1lICsgJyIuJywgdm0pOwogICAgfQogIH0KfQoKdmFyIHNpbXBsZUNoZWNrUkUgPSAvXihTdHJpbmd8TnVtYmVyfEJvb2xlYW58RnVuY3Rpb258U3ltYm9sfEJpZ0ludCkkLzsKCmZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUsIHZtKSB7CiAgdmFyIHZhbGlkOwogIHZhciBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwoKICBpZiAoc2ltcGxlQ2hlY2tSRS50ZXN0KGV4cGVjdGVkVHlwZSkpIHsKICAgIHZhciB0ID0gX3R5cGVvZih2YWx1ZSk7CgogICAgdmFsaWQgPSB0ID09PSBleHBlY3RlZFR5cGUudG9Mb3dlckNhc2UoKTsgLy8gZm9yIHByaW1pdGl2ZSB3cmFwcGVyIG9iamVjdHMKCiAgICBpZiAoIXZhbGlkICYmIHQgPT09ICdvYmplY3QnKSB7CiAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnT2JqZWN0JykgewogICAgdmFsaWQgPSBpc1BsYWluT2JqZWN0KHZhbHVlKTsKICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gJ0FycmF5JykgewogICAgdmFsaWQgPSBBcnJheS5pc0FycmF5KHZhbHVlKTsKICB9IGVsc2UgewogICAgdHJ5IHsKICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHdhcm4oJ0ludmFsaWQgcHJvcCB0eXBlOiAiJyArIFN0cmluZyh0eXBlKSArICciIGlzIG5vdCBhIGNvbnN0cnVjdG9yJywgdm0pOwogICAgICB2YWxpZCA9IGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIHsKICAgIHZhbGlkOiB2YWxpZCwKICAgIGV4cGVjdGVkVHlwZTogZXhwZWN0ZWRUeXBlCiAgfTsKfQoKdmFyIGZ1bmN0aW9uVHlwZUNoZWNrUkUgPSAvXlxzKmZ1bmN0aW9uIChcdyspLzsKLyoqCiAqIFVzZSBmdW5jdGlvbiBzdHJpbmcgbmFtZSB0byBjaGVjayBidWlsdC1pbiB0eXBlcywKICogYmVjYXVzZSBhIHNpbXBsZSBlcXVhbGl0eSBjaGVjayB3aWxsIGZhaWwgd2hlbiBydW5uaW5nCiAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4KICovCgpmdW5jdGlvbiBnZXRUeXBlKGZuKSB7CiAgdmFyIG1hdGNoID0gZm4gJiYgZm4udG9TdHJpbmcoKS5tYXRjaChmdW5jdGlvblR5cGVDaGVja1JFKTsKICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwp9CgpmdW5jdGlvbiBpc1NhbWVUeXBlKGEsIGIpIHsKICByZXR1cm4gZ2V0VHlwZShhKSA9PT0gZ2V0VHlwZShiKTsKfQoKZnVuY3Rpb24gZ2V0VHlwZUluZGV4KHR5cGUsIGV4cGVjdGVkVHlwZXMpIHsKICBpZiAoIUFycmF5LmlzQXJyYXkoZXhwZWN0ZWRUeXBlcykpIHsKICAgIHJldHVybiBpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXMsIHR5cGUpID8gMCA6IC0xOwogIH0KCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGV4cGVjdGVkVHlwZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgIGlmIChpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXNbaV0sIHR5cGUpKSB7CiAgICAgIHJldHVybiBpOwogICAgfQogIH0KCiAgcmV0dXJuIC0xOwp9CgpmdW5jdGlvbiBnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpIHsKICB2YXIgbWVzc2FnZSA9ICJJbnZhbGlkIHByb3A6IHR5cGUgY2hlY2sgZmFpbGVkIGZvciBwcm9wIFwiIiArIG5hbWUgKyAiXCIuIiArICIgRXhwZWN0ZWQgIiArIGV4cGVjdGVkVHlwZXMubWFwKGNhcGl0YWxpemUpLmpvaW4oJywgJyk7CiAgdmFyIGV4cGVjdGVkVHlwZSA9IGV4cGVjdGVkVHlwZXNbMF07CiAgdmFyIHJlY2VpdmVkVHlwZSA9IHRvUmF3VHlwZSh2YWx1ZSk7IC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSBleHBlY3RlZCB2YWx1ZQoKICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYgaXNFeHBsaWNhYmxlKGV4cGVjdGVkVHlwZSkgJiYgaXNFeHBsaWNhYmxlKF90eXBlb2YodmFsdWUpKSAmJiAhaXNCb29sZWFuKGV4cGVjdGVkVHlwZSwgcmVjZWl2ZWRUeXBlKSkgewogICAgbWVzc2FnZSArPSAiIHdpdGggdmFsdWUgIiArIHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgfQoKICBtZXNzYWdlICs9ICIsIGdvdCAiICsgcmVjZWl2ZWRUeXBlICsgIiAiOyAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgcmVjZWl2ZWQgdmFsdWUKCiAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICBtZXNzYWdlICs9ICJ3aXRoIHZhbHVlICIgKyBzdHlsZVZhbHVlKHZhbHVlLCByZWNlaXZlZFR5cGUpICsgIi4iOwogIH0KCiAgcmV0dXJuIG1lc3NhZ2U7Cn0KCmZ1bmN0aW9uIHN0eWxlVmFsdWUodmFsdWUsIHR5cGUpIHsKICBpZiAodHlwZSA9PT0gJ1N0cmluZycpIHsKICAgIHJldHVybiAiXCIiICsgdmFsdWUgKyAiXCIiOwogIH0gZWxzZSBpZiAodHlwZSA9PT0gJ051bWJlcicpIHsKICAgIHJldHVybiAiIiArIE51bWJlcih2YWx1ZSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAiIiArIHZhbHVlOwogIH0KfQoKdmFyIEVYUExJQ0FCTEVfVFlQRVMgPSBbJ3N0cmluZycsICdudW1iZXInLCAnYm9vbGVhbiddOwoKZnVuY3Rpb24gaXNFeHBsaWNhYmxlKHZhbHVlKSB7CiAgcmV0dXJuIEVYUExJQ0FCTEVfVFlQRVMuc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIHZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW07CiAgfSk7Cn0KCmZ1bmN0aW9uIGlzQm9vbGVhbigpIHsKICB2YXIgYXJncyA9IFtdLAogICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwoKICB3aGlsZSAobGVuLS0pIHsKICAgIGFyZ3NbbGVuXSA9IGFyZ3VtZW50c1tsZW5dOwogIH0KCiAgcmV0dXJuIGFyZ3Muc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGVsZW0udG9Mb3dlckNhc2UoKSA9PT0gJ2Jvb2xlYW4nOwogIH0pOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pIHsKICAvLyBEZWFjdGl2YXRlIGRlcHMgdHJhY2tpbmcgd2hpbGUgcHJvY2Vzc2luZyBlcnJvciBoYW5kbGVyIHRvIGF2b2lkIHBvc3NpYmxlIGluZmluaXRlIHJlbmRlcmluZy4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWV4L2lzc3Vlcy8xNTA1CiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgaWYgKHZtKSB7CiAgICAgIHZhciBjdXIgPSB2bTsKCiAgICAgIHdoaWxlIChjdXIgPSBjdXIuJHBhcmVudCkgewogICAgICAgIHZhciBob29rcyA9IGN1ci4kb3B0aW9ucy5lcnJvckNhcHR1cmVkOwoKICAgICAgICBpZiAoaG9va3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZSA9IGhvb2tzW2ldLmNhbGwoY3VyLCBlcnIsIHZtLCBpbmZvKSA9PT0gZmFsc2U7CgogICAgICAgICAgICAgIGlmIChjYXB0dXJlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBnbG9iYWxIYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKTsKICB9IGZpbmFsbHkgewogICAgcG9wVGFyZ2V0KCk7CiAgfQp9CgpmdW5jdGlvbiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhoYW5kbGVyLCBjb250ZXh0LCBhcmdzLCB2bSwgaW5mbykgewogIHZhciByZXM7CgogIHRyeSB7CiAgICByZXMgPSBhcmdzID8gaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKSA6IGhhbmRsZXIuY2FsbChjb250ZXh0KTsKCiAgICBpZiAocmVzICYmICFyZXMuX2lzVnVlICYmIGlzUHJvbWlzZShyZXMpICYmICFyZXMuX2hhbmRsZWQpIHsKICAgICAgcmVzWyJjYXRjaCJdKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKGUsIHZtLCBpbmZvICsgIiAoUHJvbWlzZS9hc3luYykiKTsKICAgICAgfSk7IC8vIGlzc3VlICM5NTExCiAgICAgIC8vIGF2b2lkIGNhdGNoIHRyaWdnZXJpbmcgbXVsdGlwbGUgdGltZXMgd2hlbiBuZXN0ZWQgY2FsbHMKCiAgICAgIHJlcy5faGFuZGxlZCA9IHRydWU7CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8pOwogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gY29uZmlnLmVycm9ySGFuZGxlci5jYWxsKG51bGwsIGVyciwgdm0sIGluZm8pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAvLyBpZiB0aGUgdXNlciBpbnRlbnRpb25hbGx5IHRocm93cyB0aGUgb3JpZ2luYWwgZXJyb3IgaW4gdGhlIGhhbmRsZXIsCiAgICAgIC8vIGRvIG5vdCBsb2cgaXQgdHdpY2UKICAgICAgaWYgKGUgIT09IGVycikgewogICAgICAgIGxvZ0Vycm9yKGUsIG51bGwsICdjb25maWcuZXJyb3JIYW5kbGVyJyk7CiAgICAgIH0KICAgIH0KICB9CgogIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pOwp9CgpmdW5jdGlvbiBsb2dFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkVycm9yIGluICIgKyBpbmZvICsgIjogXCIiICsgZXJyLnRvU3RyaW5nKCkgKyAiXCIiLCB2bSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoKGluQnJvd3NlciB8fCBpbldlZXgpICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9Ci8qICAqLwoKCnZhciBpc1VzaW5nTWljcm9UYXNrID0gZmFsc2U7CnZhciBjYWxsYmFja3MgPSBbXTsKdmFyIHBlbmRpbmcgPSBmYWxzZTsKCmZ1bmN0aW9uIGZsdXNoQ2FsbGJhY2tzKCkgewogIHBlbmRpbmcgPSBmYWxzZTsKICB2YXIgY29waWVzID0gY2FsbGJhY2tzLnNsaWNlKDApOwogIGNhbGxiYWNrcy5sZW5ndGggPSAwOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvcGllcy5sZW5ndGg7IGkrKykgewogICAgY29waWVzW2ldKCk7CiAgfQp9IC8vIEhlcmUgd2UgaGF2ZSBhc3luYyBkZWZlcnJpbmcgd3JhcHBlcnMgdXNpbmcgbWljcm90YXNrcy4KLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KLy8gSG93ZXZlciwgaXQgaGFzIHN1YnRsZSBwcm9ibGVtcyB3aGVuIHN0YXRlIGlzIGNoYW5nZWQgcmlnaHQgYmVmb3JlIHJlcGFpbnQKLy8gKGUuZy4gIzY4MTMsIG91dC1pbiB0cmFuc2l0aW9ucykuCi8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwovLyB0aGF0IGNhbm5vdCBiZSBjaXJjdW12ZW50ZWQgKGUuZy4gIzcxMDksICM3MTUzLCAjNzU0NiwgIzc4MzQsICM4MTA5KS4KLy8gU28gd2Ugbm93IHVzZSBtaWNyb3Rhc2tzIGV2ZXJ5d2hlcmUsIGFnYWluLgovLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKLy8gd2hlcmUgbWljcm90YXNrcyBoYXZlIHRvbyBoaWdoIGEgcHJpb3JpdHkgYW5kIGZpcmUgaW4gYmV0d2VlbiBzdXBwb3NlZGx5Ci8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCwgd2hpY2ggaGF2ZSB3b3JrYXJvdW5kcykKLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCgoKdmFyIHRpbWVyRnVuYzsgLy8gVGhlIG5leHRUaWNrIGJlaGF2aW9yIGxldmVyYWdlcyB0aGUgbWljcm90YXNrIHF1ZXVlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQKLy8gdmlhIGVpdGhlciBuYXRpdmUgUHJvbWlzZS50aGVuIG9yIE11dGF0aW9uT2JzZXJ2ZXIuCi8vIE11dGF0aW9uT2JzZXJ2ZXIgaGFzIHdpZGVyIHN1cHBvcnQsIGhvd2V2ZXIgaXQgaXMgc2VyaW91c2x5IGJ1Z2dlZCBpbgovLyBVSVdlYlZpZXcgaW4gaU9TID49IDkuMy4zIHdoZW4gdHJpZ2dlcmVkIGluIHRvdWNoIGV2ZW50IGhhbmRsZXJzLiBJdAovLyBjb21wbGV0ZWx5IHN0b3BzIHdvcmtpbmcgYWZ0ZXIgdHJpZ2dlcmluZyBhIGZldyB0aW1lcy4uLiBzbywgaWYgbmF0aXZlCi8vIFByb21pc2UgaXMgYXZhaWxhYmxlLCB3ZSB3aWxsIHVzZSBpdDoKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0LCAkZmxvdy1kaXNhYmxlLWxpbmUgKi8KCmlmICh0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJvbWlzZSkpIHsKICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSgpOwoKICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBwLnRoZW4oZmx1c2hDYWxsYmFja3MpOyAvLyBJbiBwcm9ibGVtYXRpYyBVSVdlYlZpZXdzLCBQcm9taXNlLnRoZW4gZG9lc24ndCBjb21wbGV0ZWx5IGJyZWFrLCBidXQKICAgIC8vIGl0IGNhbiBnZXQgc3R1Y2sgaW4gYSB3ZWlyZCBzdGF0ZSB3aGVyZSBjYWxsYmFja3MgYXJlIHB1c2hlZCBpbnRvIHRoZQogICAgLy8gbWljcm90YXNrIHF1ZXVlIGJ1dCB0aGUgcXVldWUgaXNuJ3QgYmVpbmcgZmx1c2hlZCwgdW50aWwgdGhlIGJyb3dzZXIKICAgIC8vIG5lZWRzIHRvIGRvIHNvbWUgb3RoZXIgd29yaywgZS5nLiBoYW5kbGUgYSB0aW1lci4gVGhlcmVmb3JlIHdlIGNhbgogICAgLy8gImZvcmNlIiB0aGUgbWljcm90YXNrIHF1ZXVlIHRvIGJlIGZsdXNoZWQgYnkgYWRkaW5nIGFuIGVtcHR5IHRpbWVyLgoKICAgIGlmIChpc0lPUykgewogICAgICBzZXRUaW1lb3V0KG5vb3ApOwogICAgfQogIH07CgogIGlzVXNpbmdNaWNyb1Rhc2sgPSB0cnVlOwp9IGVsc2UgaWYgKCFpc0lFICYmIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyICE9PSAndW5kZWZpbmVkJyAmJiAoaXNOYXRpdmUoTXV0YXRpb25PYnNlcnZlcikgfHwgLy8gUGhhbnRvbUpTIGFuZCBpT1MgNy54Ck11dGF0aW9uT2JzZXJ2ZXIudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgTXV0YXRpb25PYnNlcnZlckNvbnN0cnVjdG9yXScpKSB7CiAgLy8gVXNlIE11dGF0aW9uT2JzZXJ2ZXIgd2hlcmUgbmF0aXZlIFByb21pc2UgaXMgbm90IGF2YWlsYWJsZSwKICAvLyBlLmcuIFBoYW50b21KUywgaU9TNywgQW5kcm9pZCA0LjQKICAvLyAoIzY0NjYgTXV0YXRpb25PYnNlcnZlciBpcyB1bnJlbGlhYmxlIGluIElFMTEpCiAgdmFyIGNvdW50ZXIgPSAxOwogIHZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZsdXNoQ2FsbGJhY2tzKTsKICB2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShTdHJpbmcoY291bnRlcikpOwogIG9ic2VydmVyLm9ic2VydmUodGV4dE5vZGUsIHsKICAgIGNoYXJhY3RlckRhdGE6IHRydWUKICB9KTsKCiAgdGltZXJGdW5jID0gZnVuY3Rpb24gdGltZXJGdW5jKCkgewogICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSAyOwogICAgdGV4dE5vZGUuZGF0YSA9IFN0cmluZyhjb3VudGVyKTsKICB9OwoKICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShzZXRJbW1lZGlhdGUpKSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0SW1tZWRpYXRlLgogIC8vIFRlY2huaWNhbGx5IGl0IGxldmVyYWdlcyB0aGUgKG1hY3JvKSB0YXNrIHF1ZXVlLAogIC8vIGJ1dCBpdCBpcyBzdGlsbCBhIGJldHRlciBjaG9pY2UgdGhhbiBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldEltbWVkaWF0ZShmbHVzaENhbGxiYWNrcyk7CiAgfTsKfSBlbHNlIHsKICAvLyBGYWxsYmFjayB0byBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldFRpbWVvdXQoZmx1c2hDYWxsYmFja3MsIDApOwogIH07Cn0KCmZ1bmN0aW9uIG5leHRUaWNrKGNiLCBjdHgpIHsKICB2YXIgX3Jlc29sdmU7CgogIGNhbGxiYWNrcy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgIGlmIChjYikgewogICAgICB0cnkgewogICAgICAgIGNiLmNhbGwoY3R4KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGhhbmRsZUVycm9yKGUsIGN0eCwgJ25leHRUaWNrJyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX3Jlc29sdmUpIHsKICAgICAgX3Jlc29sdmUoY3R4KTsKICAgIH0KICB9KTsKCiAgaWYgKCFwZW5kaW5nKSB7CiAgICBwZW5kaW5nID0gdHJ1ZTsKICAgIHRpbWVyRnVuYygpOwogIH0gLy8gJGZsb3ctZGlzYWJsZS1saW5lCgoKICBpZiAoIWNiICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIF9yZXNvbHZlID0gcmVzb2x2ZTsKICAgIH0pOwogIH0KfQovKiAgKi8KCi8qIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aCBQcm94eSAqLwoKCnZhciBpbml0UHJveHk7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBhbGxvd2VkR2xvYmFscyA9IG1ha2VNYXAoJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4sJyArICdwYXJzZUZsb2F0LHBhcnNlSW50LGRlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICsgJ01hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCxCaWdJbnQsJyArICdyZXF1aXJlJyAvLyBmb3IgV2VicGFjay9Ccm93c2VyaWZ5CiAgKTsKCiAgdmFyIHdhcm5Ob25QcmVzZW50ID0gZnVuY3Rpb24gd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpIHsKICAgIHdhcm4oIlByb3BlcnR5IG9yIG1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaXMgbm90IGRlZmluZWQgb24gdGhlIGluc3RhbmNlIGJ1dCAiICsgJ3JlZmVyZW5jZWQgZHVyaW5nIHJlbmRlci4gTWFrZSBzdXJlIHRoYXQgdGhpcyBwcm9wZXJ0eSBpcyByZWFjdGl2ZSwgJyArICdlaXRoZXIgaW4gdGhlIGRhdGEgb3B0aW9uLCBvciBmb3IgY2xhc3MtYmFzZWQgY29tcG9uZW50cywgYnkgJyArICdpbml0aWFsaXppbmcgdGhlIHByb3BlcnR5LiAnICsgJ1NlZTogaHR0cHM6Ly92dWVqcy5vcmcvdjIvZ3VpZGUvcmVhY3Rpdml0eS5odG1sI0RlY2xhcmluZy1SZWFjdGl2ZS1Qcm9wZXJ0aWVzLicsIHRhcmdldCk7CiAgfTsKCiAgdmFyIHdhcm5SZXNlcnZlZFByZWZpeCA9IGZ1bmN0aW9uIHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSkgewogICAgd2FybigiUHJvcGVydHkgXCIiICsga2V5ICsgIlwiIG11c3QgYmUgYWNjZXNzZWQgd2l0aCBcIiRkYXRhLiIgKyBrZXkgKyAiXCIgYmVjYXVzZSAiICsgJ3Byb3BlcnRpZXMgc3RhcnRpbmcgd2l0aCAiJCIgb3IgIl8iIGFyZSBub3QgcHJveGllZCBpbiB0aGUgVnVlIGluc3RhbmNlIHRvICcgKyAncHJldmVudCBjb25mbGljdHMgd2l0aCBWdWUgaW50ZXJuYWxzLiAnICsgJ1NlZTogaHR0cHM6Ly92dWVqcy5vcmcvdjIvYXBpLyNkYXRhJywgdGFyZ2V0KTsKICB9OwoKICB2YXIgaGFzUHJveHkgPSB0eXBlb2YgUHJveHkgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFByb3h5KTsKCiAgaWYgKGhhc1Byb3h5KSB7CiAgICB2YXIgaXNCdWlsdEluTW9kaWZpZXIgPSBtYWtlTWFwKCdzdG9wLHByZXZlbnQsc2VsZixjdHJsLHNoaWZ0LGFsdCxtZXRhLGV4YWN0Jyk7CiAgICBjb25maWcua2V5Q29kZXMgPSBuZXcgUHJveHkoY29uZmlnLmtleUNvZGVzLCB7CiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChpc0J1aWx0SW5Nb2RpZmllcihrZXkpKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBvdmVyd3JpdGluZyBidWlsdC1pbiBtb2RpZmllciBpbiBjb25maWcua2V5Q29kZXM6IC4iICsga2V5KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICB2YXIgaGFzSGFuZGxlciA9IHsKICAgIGhhczogZnVuY3Rpb24gaGFzKHRhcmdldCwga2V5KSB7CiAgICAgIHZhciBoYXMgPSAoa2V5IGluIHRhcmdldCk7CiAgICAgIHZhciBpc0FsbG93ZWQgPSBhbGxvd2VkR2xvYmFscyhrZXkpIHx8IHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleS5jaGFyQXQoMCkgPT09ICdfJyAmJiAhKGtleSBpbiB0YXJnZXQuJGRhdGEpOwoKICAgICAgaWYgKCFoYXMgJiYgIWlzQWxsb3dlZCkgewogICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0LiRkYXRhKSB7CiAgICAgICAgICB3YXJuUmVzZXJ2ZWRQcmVmaXgodGFyZ2V0LCBrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaGFzIHx8ICFpc0FsbG93ZWQ7CiAgICB9CiAgfTsKICB2YXIgZ2V0SGFuZGxlciA9IHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KHRhcmdldCwga2V5KSB7CiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiAhKGtleSBpbiB0YXJnZXQpKSB7CiAgICAgICAgaWYgKGtleSBpbiB0YXJnZXQuJGRhdGEpIHsKICAgICAgICAgIHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5Ob25QcmVzZW50KHRhcmdldCwga2V5KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXRba2V5XTsKICAgIH0KICB9OwoKICBpbml0UHJveHkgPSBmdW5jdGlvbiBpbml0UHJveHkodm0pIHsKICAgIGlmIChoYXNQcm94eSkgewogICAgICAvLyBkZXRlcm1pbmUgd2hpY2ggcHJveHkgaGFuZGxlciB0byB1c2UKICAgICAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICAgICAgdmFyIGhhbmRsZXJzID0gb3B0aW9ucy5yZW5kZXIgJiYgb3B0aW9ucy5yZW5kZXIuX3dpdGhTdHJpcHBlZCA/IGdldEhhbmRsZXIgOiBoYXNIYW5kbGVyOwogICAgICB2bS5fcmVuZGVyUHJveHkgPSBuZXcgUHJveHkodm0sIGhhbmRsZXJzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IHZtOwogICAgfQogIH07Cn0KLyogICovCgoKdmFyIHNlZW5PYmplY3RzID0gbmV3IF9TZXQoKTsKLyoqCiAqIFJlY3Vyc2l2ZWx5IHRyYXZlcnNlIGFuIG9iamVjdCB0byBldm9rZSBhbGwgY29udmVydGVkCiAqIGdldHRlcnMsIHNvIHRoYXQgZXZlcnkgbmVzdGVkIHByb3BlcnR5IGluc2lkZSB0aGUgb2JqZWN0CiAqIGlzIGNvbGxlY3RlZCBhcyBhICJkZWVwIiBkZXBlbmRlbmN5LgogKi8KCmZ1bmN0aW9uIHRyYXZlcnNlKHZhbCkgewogIF90cmF2ZXJzZSh2YWwsIHNlZW5PYmplY3RzKTsKCiAgc2Vlbk9iamVjdHMuY2xlYXIoKTsKfQoKZnVuY3Rpb24gX3RyYXZlcnNlKHZhbCwgc2VlbikgewogIHZhciBpLCBrZXlzOwogIHZhciBpc0EgPSBBcnJheS5pc0FycmF5KHZhbCk7CgogIGlmICghaXNBICYmICFpc09iamVjdCh2YWwpIHx8IE9iamVjdC5pc0Zyb3plbih2YWwpIHx8IHZhbCBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAodmFsLl9fb2JfXykgewogICAgdmFyIGRlcElkID0gdmFsLl9fb2JfXy5kZXAuaWQ7CgogICAgaWYgKHNlZW4uaGFzKGRlcElkKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgc2Vlbi5hZGQoZGVwSWQpOwogIH0KCiAgaWYgKGlzQSkgewogICAgaSA9IHZhbC5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICBfdHJhdmVyc2UodmFsW2ldLCBzZWVuKTsKICAgIH0KICB9IGVsc2UgewogICAga2V5cyA9IE9iamVjdC5rZXlzKHZhbCk7CiAgICBpID0ga2V5cy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICBfdHJhdmVyc2UodmFsW2tleXNbaV1dLCBzZWVuKTsKICAgIH0KICB9Cn0KCnZhciBtYXJrOwp2YXIgbWVhc3VyZTsKCmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgdmFyIHBlcmYgPSBpbkJyb3dzZXIgJiYgd2luZG93LnBlcmZvcm1hbmNlOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAocGVyZiAmJiBwZXJmLm1hcmsgJiYgcGVyZi5tZWFzdXJlICYmIHBlcmYuY2xlYXJNYXJrcyAmJiBwZXJmLmNsZWFyTWVhc3VyZXMpIHsKICAgIG1hcmsgPSBmdW5jdGlvbiBtYXJrKHRhZykgewogICAgICByZXR1cm4gcGVyZi5tYXJrKHRhZyk7CiAgICB9OwoKICAgIG1lYXN1cmUgPSBmdW5jdGlvbiBtZWFzdXJlKG5hbWUsIHN0YXJ0VGFnLCBlbmRUYWcpIHsKICAgICAgcGVyZi5tZWFzdXJlKG5hbWUsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgICBwZXJmLmNsZWFyTWFya3Moc3RhcnRUYWcpOwogICAgICBwZXJmLmNsZWFyTWFya3MoZW5kVGFnKTsgLy8gcGVyZi5jbGVhck1lYXN1cmVzKG5hbWUpCiAgICB9OwogIH0KfQovKiAgKi8KCgp2YXIgbm9ybWFsaXplRXZlbnQgPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICB2YXIgcGFzc2l2ZSA9IG5hbWUuY2hhckF0KDApID09PSAnJic7CiAgbmFtZSA9IHBhc3NpdmUgPyBuYW1lLnNsaWNlKDEpIDogbmFtZTsKICB2YXIgb25jZSQkMSA9IG5hbWUuY2hhckF0KDApID09PSAnfic7IC8vIFByZWZpeGVkIGxhc3QsIGNoZWNrZWQgZmlyc3QKCiAgbmFtZSA9IG9uY2UkJDEgPyBuYW1lLnNsaWNlKDEpIDogbmFtZTsKICB2YXIgY2FwdHVyZSA9IG5hbWUuY2hhckF0KDApID09PSAnISc7CiAgbmFtZSA9IGNhcHR1cmUgPyBuYW1lLnNsaWNlKDEpIDogbmFtZTsKICByZXR1cm4gewogICAgbmFtZTogbmFtZSwKICAgIG9uY2U6IG9uY2UkJDEsCiAgICBjYXB0dXJlOiBjYXB0dXJlLAogICAgcGFzc2l2ZTogcGFzc2l2ZQogIH07Cn0pOwoKZnVuY3Rpb24gY3JlYXRlRm5JbnZva2VyKGZucywgdm0pIHsKICBmdW5jdGlvbiBpbnZva2VyKCkgewogICAgdmFyIGFyZ3VtZW50cyQxID0gYXJndW1lbnRzOwogICAgdmFyIGZucyA9IGludm9rZXIuZm5zOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGZucykpIHsKICAgICAgdmFyIGNsb25lZCA9IGZucy5zbGljZSgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbG9uZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhjbG9uZWRbaV0sIG51bGwsIGFyZ3VtZW50cyQxLCB2bSwgInYtb24gaGFuZGxlciIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyByZXR1cm4gaGFuZGxlciByZXR1cm4gdmFsdWUgZm9yIHNpbmdsZSBoYW5kbGVycwogICAgICByZXR1cm4gaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoZm5zLCBudWxsLCBhcmd1bWVudHMsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICB9CiAgfQoKICBpbnZva2VyLmZucyA9IGZuczsKICByZXR1cm4gaW52b2tlcjsKfQoKZnVuY3Rpb24gdXBkYXRlTGlzdGVuZXJzKG9uLCBvbGRPbiwgYWRkLCByZW1vdmUkJDEsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bSkgewogIHZhciBuYW1lLCBkZWYkJDEsIGN1ciwgb2xkLCBldmVudDsKCiAgZm9yIChuYW1lIGluIG9uKSB7CiAgICBkZWYkJDEgPSBjdXIgPSBvbltuYW1lXTsKICAgIG9sZCA9IG9sZE9uW25hbWVdOwogICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKCiAgICBpZiAoaXNVbmRlZihjdXIpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiSW52YWxpZCBoYW5kbGVyIGZvciBldmVudCBcIiIgKyBldmVudC5uYW1lICsgIlwiOiBnb3QgIiArIFN0cmluZyhjdXIpLCB2bSk7CiAgICB9IGVsc2UgaWYgKGlzVW5kZWYob2xkKSkgewogICAgICBpZiAoaXNVbmRlZihjdXIuZm5zKSkgewogICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlRm5JbnZva2VyKGN1ciwgdm0pOwogICAgICB9CgogICAgICBpZiAoaXNUcnVlKGV2ZW50Lm9uY2UpKSB7CiAgICAgICAgY3VyID0gb25bbmFtZV0gPSBjcmVhdGVPbmNlSGFuZGxlcihldmVudC5uYW1lLCBjdXIsIGV2ZW50LmNhcHR1cmUpOwogICAgICB9CgogICAgICBhZGQoZXZlbnQubmFtZSwgY3VyLCBldmVudC5jYXB0dXJlLCBldmVudC5wYXNzaXZlLCBldmVudC5wYXJhbXMpOwogICAgfSBlbHNlIGlmIChjdXIgIT09IG9sZCkgewogICAgICBvbGQuZm5zID0gY3VyOwogICAgICBvbltuYW1lXSA9IG9sZDsKICAgIH0KICB9CgogIGZvciAobmFtZSBpbiBvbGRPbikgewogICAgaWYgKGlzVW5kZWYob25bbmFtZV0pKSB7CiAgICAgIGV2ZW50ID0gbm9ybWFsaXplRXZlbnQobmFtZSk7CiAgICAgIHJlbW92ZSQkMShldmVudC5uYW1lLCBvbGRPbltuYW1lXSwgZXZlbnQuY2FwdHVyZSk7CiAgICB9CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIG1lcmdlVk5vZGVIb29rKGRlZiwgaG9va0tleSwgaG9vaykgewogIGlmIChkZWYgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgZGVmID0gZGVmLmRhdGEuaG9vayB8fCAoZGVmLmRhdGEuaG9vayA9IHt9KTsKICB9CgogIHZhciBpbnZva2VyOwogIHZhciBvbGRIb29rID0gZGVmW2hvb2tLZXldOwoKICBmdW5jdGlvbiB3cmFwcGVkSG9vaygpIHsKICAgIGhvb2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsgLy8gaW1wb3J0YW50OiByZW1vdmUgbWVyZ2VkIGhvb2sgdG8gZW5zdXJlIGl0J3MgY2FsbGVkIG9ubHkgb25jZQogICAgLy8gYW5kIHByZXZlbnQgbWVtb3J5IGxlYWsKCiAgICByZW1vdmUoaW52b2tlci5mbnMsIHdyYXBwZWRIb29rKTsKICB9CgogIGlmIChpc1VuZGVmKG9sZEhvb2spKSB7CiAgICAvLyBubyBleGlzdGluZyBob29rCiAgICBpbnZva2VyID0gY3JlYXRlRm5JbnZva2VyKFt3cmFwcGVkSG9va10pOwogIH0gZWxzZSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChpc0RlZihvbGRIb29rLmZucykgJiYgaXNUcnVlKG9sZEhvb2subWVyZ2VkKSkgewogICAgICAvLyBhbHJlYWR5IGEgbWVyZ2VkIGludm9rZXIKICAgICAgaW52b2tlciA9IG9sZEhvb2s7CiAgICAgIGludm9rZXIuZm5zLnB1c2god3JhcHBlZEhvb2spOwogICAgfSBlbHNlIHsKICAgICAgLy8gZXhpc3RpbmcgcGxhaW4gaG9vawogICAgICBpbnZva2VyID0gY3JlYXRlRm5JbnZva2VyKFtvbGRIb29rLCB3cmFwcGVkSG9va10pOwogICAgfQogIH0KCiAgaW52b2tlci5tZXJnZWQgPSB0cnVlOwogIGRlZltob29rS2V5XSA9IGludm9rZXI7Cn0KLyogICovCgoKZnVuY3Rpb24gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YShkYXRhLCBDdG9yLCB0YWcpIHsKICAvLyB3ZSBhcmUgb25seSBleHRyYWN0aW5nIHJhdyB2YWx1ZXMgaGVyZS4KICAvLyB2YWxpZGF0aW9uIGFuZCBkZWZhdWx0IHZhbHVlcyBhcmUgaGFuZGxlZCBpbiB0aGUgY2hpbGQKICAvLyBjb21wb25lbnQgaXRzZWxmLgogIHZhciBwcm9wT3B0aW9ucyA9IEN0b3Iub3B0aW9ucy5wcm9wczsKCiAgaWYgKGlzVW5kZWYocHJvcE9wdGlvbnMpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgcmVzID0ge307CiAgdmFyIGF0dHJzID0gZGF0YS5hdHRyczsKICB2YXIgcHJvcHMgPSBkYXRhLnByb3BzOwoKICBpZiAoaXNEZWYoYXR0cnMpIHx8IGlzRGVmKHByb3BzKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BPcHRpb25zKSB7CiAgICAgIHZhciBhbHRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgdmFyIGtleUluTG93ZXJDYXNlID0ga2V5LnRvTG93ZXJDYXNlKCk7CgogICAgICAgIGlmIChrZXkgIT09IGtleUluTG93ZXJDYXNlICYmIGF0dHJzICYmIGhhc093bihhdHRycywga2V5SW5Mb3dlckNhc2UpKSB7CiAgICAgICAgICB0aXAoIlByb3AgXCIiICsga2V5SW5Mb3dlckNhc2UgKyAiXCIgaXMgcGFzc2VkIHRvIGNvbXBvbmVudCAiICsgZm9ybWF0Q29tcG9uZW50TmFtZSh0YWcgfHwgQ3RvcikgKyAiLCBidXQgdGhlIGRlY2xhcmVkIHByb3AgbmFtZSBpcyIgKyAiIFwiIiArIGtleSArICJcIi4gIiArICJOb3RlIHRoYXQgSFRNTCBhdHRyaWJ1dGVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlIGFuZCBjYW1lbENhc2VkICIgKyAicHJvcHMgbmVlZCB0byB1c2UgdGhlaXIga2ViYWItY2FzZSBlcXVpdmFsZW50cyB3aGVuIHVzaW5nIGluLURPTSAiICsgInRlbXBsYXRlcy4gWW91IHNob3VsZCBwcm9iYWJseSB1c2UgXCIiICsgYWx0S2V5ICsgIlwiIGluc3RlYWQgb2YgXCIiICsga2V5ICsgIlwiLiIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY2hlY2tQcm9wKHJlcywgcHJvcHMsIGtleSwgYWx0S2V5LCB0cnVlKSB8fCBjaGVja1Byb3AocmVzLCBhdHRycywga2V5LCBhbHRLZXksIGZhbHNlKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIGNoZWNrUHJvcChyZXMsIGhhc2gsIGtleSwgYWx0S2V5LCBwcmVzZXJ2ZSkgewogIGlmIChpc0RlZihoYXNoKSkgewogICAgaWYgKGhhc093bihoYXNoLCBrZXkpKSB7CiAgICAgIHJlc1trZXldID0gaGFzaFtrZXldOwoKICAgICAgaWYgKCFwcmVzZXJ2ZSkgewogICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChoYXNPd24oaGFzaCwgYWx0S2V5KSkgewogICAgICByZXNba2V5XSA9IGhhc2hbYWx0S2V5XTsKCiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICBkZWxldGUgaGFzaFthbHRLZXldOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CgogIHJldHVybiBmYWxzZTsKfQovKiAgKi8KLy8gVGhlIHRlbXBsYXRlIGNvbXBpbGVyIGF0dGVtcHRzIHRvIG1pbmltaXplIHRoZSBuZWVkIGZvciBub3JtYWxpemF0aW9uIGJ5Ci8vIHN0YXRpY2FsbHkgYW5hbHl6aW5nIHRoZSB0ZW1wbGF0ZSBhdCBjb21waWxlIHRpbWUuCi8vCi8vIEZvciBwbGFpbiBIVE1MIG1hcmt1cCwgbm9ybWFsaXphdGlvbiBjYW4gYmUgY29tcGxldGVseSBza2lwcGVkIGJlY2F1c2UgdGhlCi8vIGdlbmVyYXRlZCByZW5kZXIgZnVuY3Rpb24gaXMgZ3VhcmFudGVlZCB0byByZXR1cm4gQXJyYXk8Vk5vZGU+LiBUaGVyZSBhcmUKLy8gdHdvIGNhc2VzIHdoZXJlIGV4dHJhIG5vcm1hbGl6YXRpb24gaXMgbmVlZGVkOgovLyAxLiBXaGVuIHRoZSBjaGlsZHJlbiBjb250YWlucyBjb21wb25lbnRzIC0gYmVjYXVzZSBhIGZ1bmN0aW9uYWwgY29tcG9uZW50Ci8vIG1heSByZXR1cm4gYW4gQXJyYXkgaW5zdGVhZCBvZiBhIHNpbmdsZSByb290LiBJbiB0aGlzIGNhc2UsIGp1c3QgYSBzaW1wbGUKLy8gbm9ybWFsaXphdGlvbiBpcyBuZWVkZWQgLSBpZiBhbnkgY2hpbGQgaXMgYW4gQXJyYXksIHdlIGZsYXR0ZW4gdGhlIHdob2xlCi8vIHRoaW5nIHdpdGggQXJyYXkucHJvdG90eXBlLmNvbmNhdC4gSXQgaXMgZ3VhcmFudGVlZCB0byBiZSBvbmx5IDEtbGV2ZWwgZGVlcAovLyBiZWNhdXNlIGZ1bmN0aW9uYWwgY29tcG9uZW50cyBhbHJlYWR5IG5vcm1hbGl6ZSB0aGVpciBvd24gY2hpbGRyZW4uCgoKZnVuY3Rpb24gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbltpXSkpIHsKICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5jb25jYXQuYXBwbHkoW10sIGNoaWxkcmVuKTsKICAgIH0KICB9CgogIHJldHVybiBjaGlsZHJlbjsKfSAvLyAyLiBXaGVuIHRoZSBjaGlsZHJlbiBjb250YWlucyBjb25zdHJ1Y3RzIHRoYXQgYWx3YXlzIGdlbmVyYXRlZCBuZXN0ZWQgQXJyYXlzLAovLyBlLmcuIDx0ZW1wbGF0ZT4sIDxzbG90Piwgdi1mb3IsIG9yIHdoZW4gdGhlIGNoaWxkcmVuIGlzIHByb3ZpZGVkIGJ5IHVzZXIKLy8gd2l0aCBoYW5kLXdyaXR0ZW4gcmVuZGVyIGZ1bmN0aW9ucyAvIEpTWC4gSW4gc3VjaCBjYXNlcyBhIGZ1bGwgbm9ybWFsaXphdGlvbgovLyBpcyBuZWVkZWQgdG8gY2F0ZXIgdG8gYWxsIHBvc3NpYmxlIHR5cGVzIG9mIGNoaWxkcmVuIHZhbHVlcy4KCgpmdW5jdGlvbiBub3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbikgewogIHJldHVybiBpc1ByaW1pdGl2ZShjaGlsZHJlbikgPyBbY3JlYXRlVGV4dFZOb2RlKGNoaWxkcmVuKV0gOiBBcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oY2hpbGRyZW4pIDogdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICByZXR1cm4gaXNEZWYobm9kZSkgJiYgaXNEZWYobm9kZS50ZXh0KSAmJiBpc0ZhbHNlKG5vZGUuaXNDb21tZW50KTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbiwgbmVzdGVkSW5kZXgpIHsKICB2YXIgcmVzID0gW107CiAgdmFyIGksIGMsIGxhc3RJbmRleCwgbGFzdDsKCiAgZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICBjID0gY2hpbGRyZW5baV07CgogICAgaWYgKGlzVW5kZWYoYykgfHwgdHlwZW9mIGMgPT09ICdib29sZWFuJykgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICBsYXN0SW5kZXggPSByZXMubGVuZ3RoIC0gMTsKICAgIGxhc3QgPSByZXNbbGFzdEluZGV4XTsgLy8gIG5lc3RlZAoKICAgIGlmIChBcnJheS5pc0FycmF5KGMpKSB7CiAgICAgIGlmIChjLmxlbmd0aCA+IDApIHsKICAgICAgICBjID0gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjLCAobmVzdGVkSW5kZXggfHwgJycpICsgIl8iICsgaSk7IC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKCiAgICAgICAgaWYgKGlzVGV4dE5vZGUoY1swXSkgJiYgaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgY1swXS50ZXh0KTsKICAgICAgICAgIGMuc2hpZnQoKTsKICAgICAgICB9CgogICAgICAgIHJlcy5wdXNoLmFwcGx5KHJlcywgYyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUoYykpIHsKICAgICAgaWYgKGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgLy8gdGhpcyBpcyBuZWNlc3NhcnkgZm9yIFNTUiBoeWRyYXRpb24gYmVjYXVzZSB0ZXh0IG5vZGVzIGFyZQogICAgICAgIC8vIGVzc2VudGlhbGx5IG1lcmdlZCB3aGVuIHJlbmRlcmVkIHRvIEhUTUwgc3RyaW5ncwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMpOwogICAgICB9IGVsc2UgaWYgKGMgIT09ICcnKSB7CiAgICAgICAgLy8gY29udmVydCBwcmltaXRpdmUgdG8gdm5vZGUKICAgICAgICByZXMucHVzaChjcmVhdGVUZXh0Vk5vZGUoYykpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoaXNUZXh0Tm9kZShjKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMudGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGVmYXVsdCBrZXkgZm9yIG5lc3RlZCBhcnJheSBjaGlsZHJlbiAobGlrZWx5IGdlbmVyYXRlZCBieSB2LWZvcikKICAgICAgICBpZiAoaXNUcnVlKGNoaWxkcmVuLl9pc1ZMaXN0KSAmJiBpc0RlZihjLnRhZykgJiYgaXNVbmRlZihjLmtleSkgJiYgaXNEZWYobmVzdGVkSW5kZXgpKSB7CiAgICAgICAgICBjLmtleSA9ICJfX3ZsaXN0IiArIG5lc3RlZEluZGV4ICsgIl8iICsgaSArICJfXyI7CiAgICAgICAgfQoKICAgICAgICByZXMucHVzaChjKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0UHJvdmlkZSh2bSkgewogIHZhciBwcm92aWRlID0gdm0uJG9wdGlvbnMucHJvdmlkZTsKCiAgaWYgKHByb3ZpZGUpIHsKICAgIHZtLl9wcm92aWRlZCA9IHR5cGVvZiBwcm92aWRlID09PSAnZnVuY3Rpb24nID8gcHJvdmlkZS5jYWxsKHZtKSA6IHByb3ZpZGU7CiAgfQp9CgpmdW5jdGlvbiBpbml0SW5qZWN0aW9ucyh2bSkgewogIHZhciByZXN1bHQgPSByZXNvbHZlSW5qZWN0KHZtLiRvcHRpb25zLmluamVjdCwgdm0pOwoKICBpZiAocmVzdWx0KSB7CiAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgT2JqZWN0LmtleXMocmVzdWx0KS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwga2V5LCByZXN1bHRba2V5XSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgd2FybigiQXZvaWQgbXV0YXRpbmcgYW4gaW5qZWN0ZWQgdmFsdWUgZGlyZWN0bHkgc2luY2UgdGhlIGNoYW5nZXMgd2lsbCBiZSAiICsgIm92ZXJ3cml0dGVuIHdoZW5ldmVyIHRoZSBwcm92aWRlZCBjb21wb25lbnQgcmUtcmVuZGVycy4gIiArICJpbmplY3Rpb24gYmVpbmcgbXV0YXRlZDogXCIiICsga2V5ICsgIlwiIiwgdm0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCBrZXksIHJlc3VsdFtrZXldKTsKICAgICAgfQogICAgfSk7CiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlSW5qZWN0KGluamVjdCwgdm0pIHsKICBpZiAoaW5qZWN0KSB7CiAgICAvLyBpbmplY3QgaXMgOmFueSBiZWNhdXNlIGZsb3cgaXMgbm90IHNtYXJ0IGVub3VnaCB0byBmaWd1cmUgb3V0IGNhY2hlZAogICAgdmFyIHJlc3VsdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB2YXIga2V5cyA9IGhhc1N5bWJvbCA/IFJlZmxlY3Qub3duS2V5cyhpbmplY3QpIDogT2JqZWN0LmtleXMoaW5qZWN0KTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07IC8vICM2NTc0IGluIGNhc2UgdGhlIGluamVjdCBvYmplY3QgaXMgb2JzZXJ2ZWQuLi4KCiAgICAgIGlmIChrZXkgPT09ICdfX29iX18nKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIHZhciBwcm92aWRlS2V5ID0gaW5qZWN0W2tleV0uZnJvbTsKICAgICAgdmFyIHNvdXJjZSA9IHZtOwoKICAgICAgd2hpbGUgKHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UuX3Byb3ZpZGVkICYmIGhhc093bihzb3VyY2UuX3Byb3ZpZGVkLCBwcm92aWRlS2V5KSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2UuX3Byb3ZpZGVkW3Byb3ZpZGVLZXldOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBzb3VyY2UgPSBzb3VyY2UuJHBhcmVudDsKICAgICAgfQoKICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICBpZiAoJ2RlZmF1bHQnIGluIGluamVjdFtrZXldKSB7CiAgICAgICAgICB2YXIgcHJvdmlkZURlZmF1bHQgPSBpbmplY3Rba2V5XVsiZGVmYXVsdCJdOwogICAgICAgICAgcmVzdWx0W2tleV0gPSB0eXBlb2YgcHJvdmlkZURlZmF1bHQgPT09ICdmdW5jdGlvbicgPyBwcm92aWRlRGVmYXVsdC5jYWxsKHZtKSA6IHByb3ZpZGVEZWZhdWx0OwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgd2FybigiSW5qZWN0aW9uIFwiIiArIGtleSArICJcIiBub3QgZm91bmQiLCB2bSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlc29sdmluZyByYXcgY2hpbGRyZW4gVk5vZGVzIGludG8gYSBzbG90IG9iamVjdC4KICovCgoKZnVuY3Rpb24gcmVzb2x2ZVNsb3RzKGNoaWxkcmVuLCBjb250ZXh0KSB7CiAgaWYgKCFjaGlsZHJlbiB8fCAhY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICByZXR1cm4ge307CiAgfQoKICB2YXIgc2xvdHMgPSB7fTsKCiAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgdmFyIGRhdGEgPSBjaGlsZC5kYXRhOyAvLyByZW1vdmUgc2xvdCBhdHRyaWJ1dGUgaWYgdGhlIG5vZGUgaXMgcmVzb2x2ZWQgYXMgYSBWdWUgc2xvdCBub2RlCgogICAgaWYgKGRhdGEgJiYgZGF0YS5hdHRycyAmJiBkYXRhLmF0dHJzLnNsb3QpIHsKICAgICAgZGVsZXRlIGRhdGEuYXR0cnMuc2xvdDsKICAgIH0gLy8gbmFtZWQgc2xvdHMgc2hvdWxkIG9ubHkgYmUgcmVzcGVjdGVkIGlmIHRoZSB2bm9kZSB3YXMgcmVuZGVyZWQgaW4gdGhlCiAgICAvLyBzYW1lIGNvbnRleHQuCgoKICAgIGlmICgoY2hpbGQuY29udGV4dCA9PT0gY29udGV4dCB8fCBjaGlsZC5mbkNvbnRleHQgPT09IGNvbnRleHQpICYmIGRhdGEgJiYgZGF0YS5zbG90ICE9IG51bGwpIHsKICAgICAgdmFyIG5hbWUgPSBkYXRhLnNsb3Q7CiAgICAgIHZhciBzbG90ID0gc2xvdHNbbmFtZV0gfHwgKHNsb3RzW25hbWVdID0gW10pOwoKICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgIHNsb3QucHVzaC5hcHBseShzbG90LCBjaGlsZC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2xvdC5wdXNoKGNoaWxkKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgKHNsb3RzWyJkZWZhdWx0Il0gfHwgKHNsb3RzWyJkZWZhdWx0Il0gPSBbXSkpLnB1c2goY2hpbGQpOwogICAgfQogIH0gLy8gaWdub3JlIHNsb3RzIHRoYXQgY29udGFpbnMgb25seSB3aGl0ZXNwYWNlCgoKICBmb3IgKHZhciBuYW1lJDEgaW4gc2xvdHMpIHsKICAgIGlmIChzbG90c1tuYW1lJDFdLmV2ZXJ5KGlzV2hpdGVzcGFjZSkpIHsKICAgICAgZGVsZXRlIHNsb3RzW25hbWUkMV07CiAgICB9CiAgfQoKICByZXR1cm4gc2xvdHM7Cn0KCmZ1bmN0aW9uIGlzV2hpdGVzcGFjZShub2RlKSB7CiAgcmV0dXJuIG5vZGUuaXNDb21tZW50ICYmICFub2RlLmFzeW5jRmFjdG9yeSB8fCBub2RlLnRleHQgPT09ICcgJzsKfQovKiAgKi8KCgpmdW5jdGlvbiBpc0FzeW5jUGxhY2Vob2xkZXIobm9kZSkgewogIHJldHVybiBub2RlLmlzQ29tbWVudCAmJiBub2RlLmFzeW5jRmFjdG9yeTsKfQovKiAgKi8KCgpmdW5jdGlvbiBub3JtYWxpemVTY29wZWRTbG90cyhzbG90cywgbm9ybWFsU2xvdHMsIHByZXZTbG90cykgewogIHZhciByZXM7CiAgdmFyIGhhc05vcm1hbFNsb3RzID0gT2JqZWN0LmtleXMobm9ybWFsU2xvdHMpLmxlbmd0aCA+IDA7CiAgdmFyIGlzU3RhYmxlID0gc2xvdHMgPyAhIXNsb3RzLiRzdGFibGUgOiAhaGFzTm9ybWFsU2xvdHM7CiAgdmFyIGtleSA9IHNsb3RzICYmIHNsb3RzLiRrZXk7CgogIGlmICghc2xvdHMpIHsKICAgIHJlcyA9IHt9OwogIH0gZWxzZSBpZiAoc2xvdHMuX25vcm1hbGl6ZWQpIHsKICAgIC8vIGZhc3QgcGF0aCAxOiBjaGlsZCBjb21wb25lbnQgcmUtcmVuZGVyIG9ubHksIHBhcmVudCBkaWQgbm90IGNoYW5nZQogICAgcmV0dXJuIHNsb3RzLl9ub3JtYWxpemVkOwogIH0gZWxzZSBpZiAoaXNTdGFibGUgJiYgcHJldlNsb3RzICYmIHByZXZTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYga2V5ID09PSBwcmV2U2xvdHMuJGtleSAmJiAhaGFzTm9ybWFsU2xvdHMgJiYgIXByZXZTbG90cy4kaGFzTm9ybWFsKSB7CiAgICAvLyBmYXN0IHBhdGggMjogc3RhYmxlIHNjb3BlZCBzbG90cyB3LyBubyBub3JtYWwgc2xvdHMgdG8gcHJveHksCiAgICAvLyBvbmx5IG5lZWQgdG8gbm9ybWFsaXplIG9uY2UKICAgIHJldHVybiBwcmV2U2xvdHM7CiAgfSBlbHNlIHsKICAgIHJlcyA9IHt9OwoKICAgIGZvciAodmFyIGtleSQxIGluIHNsb3RzKSB7CiAgICAgIGlmIChzbG90c1trZXkkMV0gJiYga2V5JDFbMF0gIT09ICckJykgewogICAgICAgIHJlc1trZXkkMV0gPSBub3JtYWxpemVTY29wZWRTbG90KG5vcm1hbFNsb3RzLCBrZXkkMSwgc2xvdHNba2V5JDFdKTsKICAgICAgfQogICAgfQogIH0gLy8gZXhwb3NlIG5vcm1hbCBzbG90cyBvbiBzY29wZWRTbG90cwoKCiAgZm9yICh2YXIga2V5JDIgaW4gbm9ybWFsU2xvdHMpIHsKICAgIGlmICghKGtleSQyIGluIHJlcykpIHsKICAgICAgcmVzW2tleSQyXSA9IHByb3h5Tm9ybWFsU2xvdChub3JtYWxTbG90cywga2V5JDIpOwogICAgfQogIH0gLy8gYXZvcmlheiBzZWVtcyB0byBtb2NrIGEgbm9uLWV4dGVuc2libGUgJHNjb3BlZFNsb3RzIG9iamVjdAogIC8vIGFuZCB3aGVuIHRoYXQgaXMgcGFzc2VkIGRvd24gdGhpcyB3b3VsZCBjYXVzZSBhbiBlcnJvcgoKCiAgaWYgKHNsb3RzICYmIE9iamVjdC5pc0V4dGVuc2libGUoc2xvdHMpKSB7CiAgICBzbG90cy5fbm9ybWFsaXplZCA9IHJlczsKICB9CgogIGRlZihyZXMsICckc3RhYmxlJywgaXNTdGFibGUpOwogIGRlZihyZXMsICcka2V5Jywga2V5KTsKICBkZWYocmVzLCAnJGhhc05vcm1hbCcsIGhhc05vcm1hbFNsb3RzKTsKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBub3JtYWxpemVTY29wZWRTbG90KG5vcm1hbFNsb3RzLCBrZXksIGZuKSB7CiAgdmFyIG5vcm1hbGl6ZWQgPSBmdW5jdGlvbiBub3JtYWxpemVkKCkgewogICAgdmFyIHJlcyA9IGFyZ3VtZW50cy5sZW5ndGggPyBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpIDogZm4oe30pOwogICAgcmVzID0gcmVzICYmIF90eXBlb2YocmVzKSA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkocmVzKSA/IFtyZXNdIC8vIHNpbmdsZSB2bm9kZQogICAgOiBub3JtYWxpemVDaGlsZHJlbihyZXMpOwogICAgdmFyIHZub2RlID0gcmVzICYmIHJlc1swXTsKICAgIHJldHVybiByZXMgJiYgKCF2bm9kZSB8fCByZXMubGVuZ3RoID09PSAxICYmIHZub2RlLmlzQ29tbWVudCAmJiAhaXNBc3luY1BsYWNlaG9sZGVyKHZub2RlKSAvLyAjOTY1OCwgIzEwMzkxCiAgICApID8gdW5kZWZpbmVkIDogcmVzOwogIH07IC8vIHRoaXMgaXMgYSBzbG90IHVzaW5nIHRoZSBuZXcgdi1zbG90IHN5bnRheCB3aXRob3V0IHNjb3BlLiBhbHRob3VnaCBpdCBpcwogIC8vIGNvbXBpbGVkIGFzIGEgc2NvcGVkIHNsb3QsIHJlbmRlciBmbiB1c2VycyB3b3VsZCBleHBlY3QgaXQgdG8gYmUgcHJlc2VudAogIC8vIG9uIHRoaXMuJHNsb3RzIGJlY2F1c2UgdGhlIHVzYWdlIGlzIHNlbWFudGljYWxseSBhIG5vcm1hbCBzbG90LgoKCiAgaWYgKGZuLnByb3h5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9ybWFsU2xvdHMsIGtleSwgewogICAgICBnZXQ6IG5vcm1hbGl6ZWQsCiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CiAgfQoKICByZXR1cm4gbm9ybWFsaXplZDsKfQoKZnVuY3Rpb24gcHJveHlOb3JtYWxTbG90KHNsb3RzLCBrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNsb3RzW2tleV07CiAgfTsKfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHYtZm9yIGxpc3RzLgogKi8KCgpmdW5jdGlvbiByZW5kZXJMaXN0KHZhbCwgcmVuZGVyKSB7CiAgdmFyIHJldCwgaSwgbCwga2V5cywga2V5OwoKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICByZXQgPSBuZXcgQXJyYXkodmFsLmxlbmd0aCk7CgogICAgZm9yIChpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcmV0W2ldID0gcmVuZGVyKHZhbFtpXSwgaSk7CiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgcmV0ID0gbmV3IEFycmF5KHZhbCk7CgogICAgZm9yIChpID0gMDsgaSA8IHZhbDsgaSsrKSB7CiAgICAgIHJldFtpXSA9IHJlbmRlcihpICsgMSwgaSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdCh2YWwpKSB7CiAgICBpZiAoaGFzU3ltYm9sICYmIHZhbFtTeW1ib2wuaXRlcmF0b3JdKSB7CiAgICAgIHJldCA9IFtdOwogICAgICB2YXIgaXRlcmF0b3IgPSB2YWxbU3ltYm9sLml0ZXJhdG9yXSgpOwogICAgICB2YXIgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwoKICAgICAgd2hpbGUgKCFyZXN1bHQuZG9uZSkgewogICAgICAgIHJldC5wdXNoKHJlbmRlcihyZXN1bHQudmFsdWUsIHJldC5sZW5ndGgpKTsKICAgICAgICByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICByZXQgPSBuZXcgQXJyYXkoa2V5cy5sZW5ndGgpOwoKICAgICAgZm9yIChpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICByZXRbaV0gPSByZW5kZXIodmFsW2tleV0sIGtleSwgaSk7CiAgICAgIH0KICAgIH0KICB9CgogIGlmICghaXNEZWYocmV0KSkgewogICAgcmV0ID0gW107CiAgfQoKICByZXQuX2lzVkxpc3QgPSB0cnVlOwogIHJldHVybiByZXQ7Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyA8c2xvdD4KICovCgoKZnVuY3Rpb24gcmVuZGVyU2xvdChuYW1lLCBmYWxsYmFja1JlbmRlciwgcHJvcHMsIGJpbmRPYmplY3QpIHsKICB2YXIgc2NvcGVkU2xvdEZuID0gdGhpcy4kc2NvcGVkU2xvdHNbbmFtZV07CiAgdmFyIG5vZGVzOwoKICBpZiAoc2NvcGVkU2xvdEZuKSB7CiAgICAvLyBzY29wZWQgc2xvdAogICAgcHJvcHMgPSBwcm9wcyB8fCB7fTsKCiAgICBpZiAoYmluZE9iamVjdCkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhaXNPYmplY3QoYmluZE9iamVjdCkpIHsKICAgICAgICB3YXJuKCdzbG90IHYtYmluZCB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0JywgdGhpcyk7CiAgICAgIH0KCiAgICAgIHByb3BzID0gZXh0ZW5kKGV4dGVuZCh7fSwgYmluZE9iamVjdCksIHByb3BzKTsKICAgIH0KCiAgICBub2RlcyA9IHNjb3BlZFNsb3RGbihwcm9wcykgfHwgKHR5cGVvZiBmYWxsYmFja1JlbmRlciA9PT0gJ2Z1bmN0aW9uJyA/IGZhbGxiYWNrUmVuZGVyKCkgOiBmYWxsYmFja1JlbmRlcik7CiAgfSBlbHNlIHsKICAgIG5vZGVzID0gdGhpcy4kc2xvdHNbbmFtZV0gfHwgKHR5cGVvZiBmYWxsYmFja1JlbmRlciA9PT0gJ2Z1bmN0aW9uJyA/IGZhbGxiYWNrUmVuZGVyKCkgOiBmYWxsYmFja1JlbmRlcik7CiAgfQoKICB2YXIgdGFyZ2V0ID0gcHJvcHMgJiYgcHJvcHMuc2xvdDsKCiAgaWYgKHRhcmdldCkgewogICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJywgewogICAgICBzbG90OiB0YXJnZXQKICAgIH0sIG5vZGVzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG5vZGVzOwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIGZpbHRlcnMKICovCgoKZnVuY3Rpb24gcmVzb2x2ZUZpbHRlcihpZCkgewogIHJldHVybiByZXNvbHZlQXNzZXQodGhpcy4kb3B0aW9ucywgJ2ZpbHRlcnMnLCBpZCwgdHJ1ZSkgfHwgaWRlbnRpdHk7Cn0KLyogICovCgoKZnVuY3Rpb24gaXNLZXlOb3RNYXRjaChleHBlY3QsIGFjdHVhbCkgewogIGlmIChBcnJheS5pc0FycmF5KGV4cGVjdCkpIHsKICAgIHJldHVybiBleHBlY3QuaW5kZXhPZihhY3R1YWwpID09PSAtMTsKICB9IGVsc2UgewogICAgcmV0dXJuIGV4cGVjdCAhPT0gYWN0dWFsOwogIH0KfQovKioKICogUnVudGltZSBoZWxwZXIgZm9yIGNoZWNraW5nIGtleUNvZGVzIGZyb20gY29uZmlnLgogKiBleHBvc2VkIGFzIFZ1ZS5wcm90b3R5cGUuX2sKICogcGFzc2luZyBpbiBldmVudEtleU5hbWUgYXMgbGFzdCBhcmd1bWVudCBzZXBhcmF0ZWx5IGZvciBiYWNrd2FyZHMgY29tcGF0CiAqLwoKCmZ1bmN0aW9uIGNoZWNrS2V5Q29kZXMoZXZlbnRLZXlDb2RlLCBrZXksIGJ1aWx0SW5LZXlDb2RlLCBldmVudEtleU5hbWUsIGJ1aWx0SW5LZXlOYW1lKSB7CiAgdmFyIG1hcHBlZEtleUNvZGUgPSBjb25maWcua2V5Q29kZXNba2V5XSB8fCBidWlsdEluS2V5Q29kZTsKCiAgaWYgKGJ1aWx0SW5LZXlOYW1lICYmIGV2ZW50S2V5TmFtZSAmJiAhY29uZmlnLmtleUNvZGVzW2tleV0pIHsKICAgIHJldHVybiBpc0tleU5vdE1hdGNoKGJ1aWx0SW5LZXlOYW1lLCBldmVudEtleU5hbWUpOwogIH0gZWxzZSBpZiAobWFwcGVkS2V5Q29kZSkgewogICAgcmV0dXJuIGlzS2V5Tm90TWF0Y2gobWFwcGVkS2V5Q29kZSwgZXZlbnRLZXlDb2RlKTsKICB9IGVsc2UgaWYgKGV2ZW50S2V5TmFtZSkgewogICAgcmV0dXJuIGh5cGhlbmF0ZShldmVudEtleU5hbWUpICE9PSBrZXk7CiAgfQoKICByZXR1cm4gZXZlbnRLZXlDb2RlID09PSB1bmRlZmluZWQ7Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIG1lcmdpbmcgdi1iaW5kPSJvYmplY3QiIGludG8gYSBWTm9kZSdzIGRhdGEuCiAqLwoKCmZ1bmN0aW9uIGJpbmRPYmplY3RQcm9wcyhkYXRhLCB0YWcsIHZhbHVlLCBhc1Byb3AsIGlzU3luYykgewogIGlmICh2YWx1ZSkgewogICAgaWYgKCFpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCd2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCBvciBBcnJheSB2YWx1ZScsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgdmFsdWUgPSB0b09iamVjdCh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIHZhciBoYXNoOwoKICAgICAgdmFyIGxvb3AgPSBmdW5jdGlvbiBsb29wKGtleSkgewogICAgICAgIGlmIChrZXkgPT09ICdjbGFzcycgfHwga2V5ID09PSAnc3R5bGUnIHx8IGlzUmVzZXJ2ZWRBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgICAgaGFzaCA9IGRhdGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB0eXBlID0gZGF0YS5hdHRycyAmJiBkYXRhLmF0dHJzLnR5cGU7CiAgICAgICAgICBoYXNoID0gYXNQcm9wIHx8IGNvbmZpZy5tdXN0VXNlUHJvcCh0YWcsIHR5cGUsIGtleSkgPyBkYXRhLmRvbVByb3BzIHx8IChkYXRhLmRvbVByb3BzID0ge30pIDogZGF0YS5hdHRycyB8fCAoZGF0YS5hdHRycyA9IHt9KTsKICAgICAgICB9CgogICAgICAgIHZhciBjYW1lbGl6ZWRLZXkgPSBjYW1lbGl6ZShrZXkpOwogICAgICAgIHZhciBoeXBoZW5hdGVkS2V5ID0gaHlwaGVuYXRlKGtleSk7CgogICAgICAgIGlmICghKGNhbWVsaXplZEtleSBpbiBoYXNoKSAmJiAhKGh5cGhlbmF0ZWRLZXkgaW4gaGFzaCkpIHsKICAgICAgICAgIGhhc2hba2V5XSA9IHZhbHVlW2tleV07CgogICAgICAgICAgaWYgKGlzU3luYykgewogICAgICAgICAgICB2YXIgb24gPSBkYXRhLm9uIHx8IChkYXRhLm9uID0ge30pOwoKICAgICAgICAgICAgb25bInVwZGF0ZToiICsga2V5XSA9IGZ1bmN0aW9uICgkZXZlbnQpIHsKICAgICAgICAgICAgICB2YWx1ZVtrZXldID0gJGV2ZW50OwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICAgIGxvb3Aoa2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGRhdGE7Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyBzdGF0aWMgdHJlZXMuCiAqLwoKCmZ1bmN0aW9uIHJlbmRlclN0YXRpYyhpbmRleCwgaXNJbkZvcikgewogIHZhciBjYWNoZWQgPSB0aGlzLl9zdGF0aWNUcmVlcyB8fCAodGhpcy5fc3RhdGljVHJlZXMgPSBbXSk7CiAgdmFyIHRyZWUgPSBjYWNoZWRbaW5kZXhdOyAvLyBpZiBoYXMgYWxyZWFkeS1yZW5kZXJlZCBzdGF0aWMgdHJlZSBhbmQgbm90IGluc2lkZSB2LWZvciwKICAvLyB3ZSBjYW4gcmV1c2UgdGhlIHNhbWUgdHJlZS4KCiAgaWYgKHRyZWUgJiYgIWlzSW5Gb3IpIHsKICAgIHJldHVybiB0cmVlOwogIH0gLy8gb3RoZXJ3aXNlLCByZW5kZXIgYSBmcmVzaCB0cmVlLgoKCiAgdHJlZSA9IGNhY2hlZFtpbmRleF0gPSB0aGlzLiRvcHRpb25zLnN0YXRpY1JlbmRlckZuc1tpbmRleF0uY2FsbCh0aGlzLl9yZW5kZXJQcm94eSwgbnVsbCwgdGhpcyAvLyBmb3IgcmVuZGVyIGZucyBnZW5lcmF0ZWQgZm9yIGZ1bmN0aW9uYWwgY29tcG9uZW50IHRlbXBsYXRlcwogICk7CiAgbWFya1N0YXRpYyh0cmVlLCAiX19zdGF0aWNfXyIgKyBpbmRleCwgZmFsc2UpOwogIHJldHVybiB0cmVlOwp9Ci8qKgogKiBSdW50aW1lIGhlbHBlciBmb3Igdi1vbmNlLgogKiBFZmZlY3RpdmVseSBpdCBtZWFucyBtYXJraW5nIHRoZSBub2RlIGFzIHN0YXRpYyB3aXRoIGEgdW5pcXVlIGtleS4KICovCgoKZnVuY3Rpb24gbWFya09uY2UodHJlZSwgaW5kZXgsIGtleSkgewogIG1hcmtTdGF0aWModHJlZSwgIl9fb25jZV9fIiArIGluZGV4ICsgKGtleSA/ICJfIiArIGtleSA6ICIiKSwgdHJ1ZSk7CiAgcmV0dXJuIHRyZWU7Cn0KCmZ1bmN0aW9uIG1hcmtTdGF0aWModHJlZSwga2V5LCBpc09uY2UpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh0cmVlKSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0cmVlW2ldICYmIHR5cGVvZiB0cmVlW2ldICE9PSAnc3RyaW5nJykgewogICAgICAgIG1hcmtTdGF0aWNOb2RlKHRyZWVbaV0sIGtleSArICJfIiArIGksIGlzT25jZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbWFya1N0YXRpY05vZGUodHJlZSwga2V5LCBpc09uY2UpOwogIH0KfQoKZnVuY3Rpb24gbWFya1N0YXRpY05vZGUobm9kZSwga2V5LCBpc09uY2UpIHsKICBub2RlLmlzU3RhdGljID0gdHJ1ZTsKICBub2RlLmtleSA9IGtleTsKICBub2RlLmlzT25jZSA9IGlzT25jZTsKfQovKiAgKi8KCgpmdW5jdGlvbiBiaW5kT2JqZWN0TGlzdGVuZXJzKGRhdGEsIHZhbHVlKSB7CiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoIWlzUGxhaW5PYmplY3QodmFsdWUpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2Fybigndi1vbiB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IHZhbHVlJywgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgb24gPSBkYXRhLm9uID0gZGF0YS5vbiA/IGV4dGVuZCh7fSwgZGF0YS5vbikgOiB7fTsKCiAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICAgIHZhciBleGlzdGluZyA9IG9uW2tleV07CiAgICAgICAgdmFyIG91cnMgPSB2YWx1ZVtrZXldOwogICAgICAgIG9uW2tleV0gPSBleGlzdGluZyA/IFtdLmNvbmNhdChleGlzdGluZywgb3VycykgOiBvdXJzOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZGF0YTsKfQovKiAgKi8KCgpmdW5jdGlvbiByZXNvbHZlU2NvcGVkU2xvdHMoZm5zLCAvLyBzZWUgZmxvdy92bm9kZQpyZXMsIC8vIHRoZSBmb2xsb3dpbmcgYXJlIGFkZGVkIGluIDIuNgpoYXNEeW5hbWljS2V5cywgY29udGVudEhhc2hLZXkpIHsKICByZXMgPSByZXMgfHwgewogICAgJHN0YWJsZTogIWhhc0R5bmFtaWNLZXlzCiAgfTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBmbnMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBzbG90ID0gZm5zW2ldOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHNsb3QpKSB7CiAgICAgIHJlc29sdmVTY29wZWRTbG90cyhzbG90LCByZXMsIGhhc0R5bmFtaWNLZXlzKTsKICAgIH0gZWxzZSBpZiAoc2xvdCkgewogICAgICAvLyBtYXJrZXIgZm9yIHJldmVyc2UgcHJveHlpbmcgdi1zbG90IHdpdGhvdXQgc2NvcGUgb24gdGhpcy4kc2xvdHMKICAgICAgaWYgKHNsb3QucHJveHkpIHsKICAgICAgICBzbG90LmZuLnByb3h5ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgcmVzW3Nsb3Qua2V5XSA9IHNsb3QuZm47CiAgICB9CiAgfQoKICBpZiAoY29udGVudEhhc2hLZXkpIHsKICAgIHJlcy4ka2V5ID0gY29udGVudEhhc2hLZXk7CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGJpbmREeW5hbWljS2V5cyhiYXNlT2JqLCB2YWx1ZXMpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkgKz0gMikgewogICAgdmFyIGtleSA9IHZhbHVlc1tpXTsKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5KSB7CiAgICAgIGJhc2VPYmpbdmFsdWVzW2ldXSA9IHZhbHVlc1tpICsgMV07CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYga2V5ICE9PSAnJyAmJiBrZXkgIT09IG51bGwpIHsKICAgICAgLy8gbnVsbCBpcyBhIHNwZWNpYWwgdmFsdWUgZm9yIGV4cGxpY2l0bHkgcmVtb3ZpbmcgYSBiaW5kaW5nCiAgICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIGR5bmFtaWMgZGlyZWN0aXZlIGFyZ3VtZW50IChleHBlY3RlZCBzdHJpbmcgb3IgbnVsbCk6ICIgKyBrZXksIHRoaXMpOwogICAgfQogIH0KCiAgcmV0dXJuIGJhc2VPYmo7Cn0gLy8gaGVscGVyIHRvIGR5bmFtaWNhbGx5IGFwcGVuZCBtb2RpZmllciBydW50aW1lIG1hcmtlcnMgdG8gZXZlbnQgbmFtZXMuCi8vIGVuc3VyZSBvbmx5IGFwcGVuZCB3aGVuIHZhbHVlIGlzIGFscmVhZHkgc3RyaW5nLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBjYXN0Ci8vIHRvIHN0cmluZyBhbmQgY2F1c2UgdGhlIHR5cGUgY2hlY2sgdG8gbWlzcy4KCgpmdW5jdGlvbiBwcmVwZW5kTW9kaWZpZXIodmFsdWUsIHN5bWJvbCkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gc3ltYm9sICsgdmFsdWUgOiB2YWx1ZTsKfQovKiAgKi8KCgpmdW5jdGlvbiBpbnN0YWxsUmVuZGVySGVscGVycyh0YXJnZXQpIHsKICB0YXJnZXQuX28gPSBtYXJrT25jZTsKICB0YXJnZXQuX24gPSB0b051bWJlcjsKICB0YXJnZXQuX3MgPSB0b1N0cmluZzsKICB0YXJnZXQuX2wgPSByZW5kZXJMaXN0OwogIHRhcmdldC5fdCA9IHJlbmRlclNsb3Q7CiAgdGFyZ2V0Ll9xID0gbG9vc2VFcXVhbDsKICB0YXJnZXQuX2kgPSBsb29zZUluZGV4T2Y7CiAgdGFyZ2V0Ll9tID0gcmVuZGVyU3RhdGljOwogIHRhcmdldC5fZiA9IHJlc29sdmVGaWx0ZXI7CiAgdGFyZ2V0Ll9rID0gY2hlY2tLZXlDb2RlczsKICB0YXJnZXQuX2IgPSBiaW5kT2JqZWN0UHJvcHM7CiAgdGFyZ2V0Ll92ID0gY3JlYXRlVGV4dFZOb2RlOwogIHRhcmdldC5fZSA9IGNyZWF0ZUVtcHR5Vk5vZGU7CiAgdGFyZ2V0Ll91ID0gcmVzb2x2ZVNjb3BlZFNsb3RzOwogIHRhcmdldC5fZyA9IGJpbmRPYmplY3RMaXN0ZW5lcnM7CiAgdGFyZ2V0Ll9kID0gYmluZER5bmFtaWNLZXlzOwogIHRhcmdldC5fcCA9IHByZXBlbmRNb2RpZmllcjsKfQovKiAgKi8KCgpmdW5jdGlvbiBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dChkYXRhLCBwcm9wcywgY2hpbGRyZW4sIHBhcmVudCwgQ3RvcikgewogIHZhciB0aGlzJDEgPSB0aGlzOwogIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOyAvLyBlbnN1cmUgdGhlIGNyZWF0ZUVsZW1lbnQgZnVuY3Rpb24gaW4gZnVuY3Rpb25hbCBjb21wb25lbnRzCiAgLy8gZ2V0cyBhIHVuaXF1ZSBjb250ZXh0IC0gdGhpcyBpcyBuZWNlc3NhcnkgZm9yIGNvcnJlY3QgbmFtZWQgc2xvdCBjaGVjawoKICB2YXIgY29udGV4dFZtOwoKICBpZiAoaGFzT3duKHBhcmVudCwgJ191aWQnKSkgewogICAgY29udGV4dFZtID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQpOyAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICBjb250ZXh0Vm0uX29yaWdpbmFsID0gcGFyZW50OwogIH0gZWxzZSB7CiAgICAvLyB0aGUgY29udGV4dCB2bSBwYXNzZWQgaW4gaXMgYSBmdW5jdGlvbmFsIGNvbnRleHQgYXMgd2VsbC4KICAgIC8vIGluIHRoaXMgY2FzZSB3ZSB3YW50IHRvIG1ha2Ugc3VyZSB3ZSBhcmUgYWJsZSB0byBnZXQgYSBob2xkIHRvIHRoZQogICAgLy8gcmVhbCBjb250ZXh0IGluc3RhbmNlLgogICAgY29udGV4dFZtID0gcGFyZW50OyAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICBwYXJlbnQgPSBwYXJlbnQuX29yaWdpbmFsOwogIH0KCiAgdmFyIGlzQ29tcGlsZWQgPSBpc1RydWUob3B0aW9ucy5fY29tcGlsZWQpOwogIHZhciBuZWVkTm9ybWFsaXphdGlvbiA9ICFpc0NvbXBpbGVkOwogIHRoaXMuZGF0YSA9IGRhdGE7CiAgdGhpcy5wcm9wcyA9IHByb3BzOwogIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICB0aGlzLmxpc3RlbmVycyA9IGRhdGEub24gfHwgZW1wdHlPYmplY3Q7CiAgdGhpcy5pbmplY3Rpb25zID0gcmVzb2x2ZUluamVjdChvcHRpb25zLmluamVjdCwgcGFyZW50KTsKCiAgdGhpcy5zbG90cyA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcyQxLiRzbG90cykgewogICAgICBub3JtYWxpemVTY29wZWRTbG90cyhkYXRhLnNjb3BlZFNsb3RzLCB0aGlzJDEuJHNsb3RzID0gcmVzb2x2ZVNsb3RzKGNoaWxkcmVuLCBwYXJlbnQpKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcyQxLiRzbG90czsKICB9OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3Njb3BlZFNsb3RzJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gbm9ybWFsaXplU2NvcGVkU2xvdHMoZGF0YS5zY29wZWRTbG90cywgdGhpcy5zbG90cygpKTsKICAgIH0KICB9KTsgLy8gc3VwcG9ydCBmb3IgY29tcGlsZWQgZnVuY3Rpb25hbCB0ZW1wbGF0ZQoKICBpZiAoaXNDb21waWxlZCkgewogICAgLy8gZXhwb3NpbmcgJG9wdGlvbnMgZm9yIHJlbmRlclN0YXRpYygpCiAgICB0aGlzLiRvcHRpb25zID0gb3B0aW9uczsgLy8gcHJlLXJlc29sdmUgc2xvdHMgZm9yIHJlbmRlclNsb3QoKQoKICAgIHRoaXMuJHNsb3RzID0gdGhpcy5zbG90cygpOwogICAgdGhpcy4kc2NvcGVkU2xvdHMgPSBub3JtYWxpemVTY29wZWRTbG90cyhkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLiRzbG90cyk7CiAgfQoKICBpZiAob3B0aW9ucy5fc2NvcGVJZCkgewogICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgIHZhciB2bm9kZSA9IGNyZWF0ZUVsZW1lbnQoY29udGV4dFZtLCBhLCBiLCBjLCBkLCBuZWVkTm9ybWFsaXphdGlvbik7CgogICAgICBpZiAodm5vZGUgJiYgIUFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgICAgdm5vZGUuZm5TY29wZUlkID0gb3B0aW9ucy5fc2NvcGVJZDsKICAgICAgICB2bm9kZS5mbkNvbnRleHQgPSBwYXJlbnQ7CiAgICAgIH0KCiAgICAgIHJldHVybiB2bm9kZTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHRoaXMuX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICByZXR1cm4gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKICAgIH07CiAgfQp9CgppbnN0YWxsUmVuZGVySGVscGVycyhGdW5jdGlvbmFsUmVuZGVyQ29udGV4dC5wcm90b3R5cGUpOwoKZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25hbENvbXBvbmVudChDdG9yLCBwcm9wc0RhdGEsIGRhdGEsIGNvbnRleHRWbSwgY2hpbGRyZW4pIHsKICB2YXIgb3B0aW9ucyA9IEN0b3Iub3B0aW9uczsKICB2YXIgcHJvcHMgPSB7fTsKICB2YXIgcHJvcE9wdGlvbnMgPSBvcHRpb25zLnByb3BzOwoKICBpZiAoaXNEZWYocHJvcE9wdGlvbnMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcE9wdGlvbnMpIHsKICAgICAgcHJvcHNba2V5XSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEgfHwgZW1wdHlPYmplY3QpOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoaXNEZWYoZGF0YS5hdHRycykpIHsKICAgICAgbWVyZ2VQcm9wcyhwcm9wcywgZGF0YS5hdHRycyk7CiAgICB9CgogICAgaWYgKGlzRGVmKGRhdGEucHJvcHMpKSB7CiAgICAgIG1lcmdlUHJvcHMocHJvcHMsIGRhdGEucHJvcHMpOwogICAgfQogIH0KCiAgdmFyIHJlbmRlckNvbnRleHQgPSBuZXcgRnVuY3Rpb25hbFJlbmRlckNvbnRleHQoZGF0YSwgcHJvcHMsIGNoaWxkcmVuLCBjb250ZXh0Vm0sIEN0b3IpOwogIHZhciB2bm9kZSA9IG9wdGlvbnMucmVuZGVyLmNhbGwobnVsbCwgcmVuZGVyQ29udGV4dC5fYywgcmVuZGVyQ29udGV4dCk7CgogIGlmICh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICByZXR1cm4gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZSwgZGF0YSwgcmVuZGVyQ29udGV4dC5wYXJlbnQsIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpOwogIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgIHZhciB2bm9kZXMgPSBub3JtYWxpemVDaGlsZHJlbih2bm9kZSkgfHwgW107CiAgICB2YXIgcmVzID0gbmV3IEFycmF5KHZub2Rlcy5sZW5ndGgpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc1tpXSA9IGNsb25lQW5kTWFya0Z1bmN0aW9uYWxSZXN1bHQodm5vZGVzW2ldLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCk7CiAgICB9CgogICAgcmV0dXJuIHJlczsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lQW5kTWFya0Z1bmN0aW9uYWxSZXN1bHQodm5vZGUsIGRhdGEsIGNvbnRleHRWbSwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCkgewogIC8vICM3ODE3IGNsb25lIG5vZGUgYmVmb3JlIHNldHRpbmcgZm5Db250ZXh0LCBvdGhlcndpc2UgaWYgdGhlIG5vZGUgaXMgcmV1c2VkCiAgLy8gKGUuZy4gaXQgd2FzIGZyb20gYSBjYWNoZWQgbm9ybWFsIHNsb3QpIHRoZSBmbkNvbnRleHQgY2F1c2VzIG5hbWVkIHNsb3RzCiAgLy8gdGhhdCBzaG91bGQgbm90IGJlIG1hdGNoZWQgdG8gbWF0Y2guCiAgdmFyIGNsb25lID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgY2xvbmUuZm5Db250ZXh0ID0gY29udGV4dFZtOwogIGNsb25lLmZuT3B0aW9ucyA9IG9wdGlvbnM7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAoY2xvbmUuZGV2dG9vbHNNZXRhID0gY2xvbmUuZGV2dG9vbHNNZXRhIHx8IHt9KS5yZW5kZXJDb250ZXh0ID0gcmVuZGVyQ29udGV4dDsKICB9CgogIGlmIChkYXRhLnNsb3QpIHsKICAgIChjbG9uZS5kYXRhIHx8IChjbG9uZS5kYXRhID0ge30pKS5zbG90ID0gZGF0YS5zbG90OwogIH0KCiAgcmV0dXJuIGNsb25lOwp9CgpmdW5jdGlvbiBtZXJnZVByb3BzKHRvLCBmcm9tKSB7CiAgZm9yICh2YXIga2V5IGluIGZyb20pIHsKICAgIHRvW2NhbWVsaXplKGtleSldID0gZnJvbVtrZXldOwogIH0KfQovKiAgKi8KCi8qICAqLwoKLyogICovCgovKiAgKi8KLy8gaW5saW5lIGhvb2tzIHRvIGJlIGludm9rZWQgb24gY29tcG9uZW50IFZOb2RlcyBkdXJpbmcgcGF0Y2gKCgp2YXIgY29tcG9uZW50Vk5vZGVIb29rcyA9IHsKICBpbml0OiBmdW5jdGlvbiBpbml0KHZub2RlLCBoeWRyYXRpbmcpIHsKICAgIGlmICh2bm9kZS5jb21wb25lbnRJbnN0YW5jZSAmJiAhdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX2lzRGVzdHJveWVkICYmIHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgIC8vIGtlcHQtYWxpdmUgY29tcG9uZW50cywgdHJlYXQgYXMgYSBwYXRjaAogICAgICB2YXIgbW91bnRlZE5vZGUgPSB2bm9kZTsgLy8gd29yayBhcm91bmQgZmxvdwoKICAgICAgY29tcG9uZW50Vk5vZGVIb29rcy5wcmVwYXRjaChtb3VudGVkTm9kZSwgbW91bnRlZE5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNoaWxkID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKHZub2RlLCBhY3RpdmVJbnN0YW5jZSk7CiAgICAgIGNoaWxkLiRtb3VudChoeWRyYXRpbmcgPyB2bm9kZS5lbG0gOiB1bmRlZmluZWQsIGh5ZHJhdGluZyk7CiAgICB9CiAgfSwKICBwcmVwYXRjaDogZnVuY3Rpb24gcHJlcGF0Y2gob2xkVm5vZGUsIHZub2RlKSB7CiAgICB2YXIgb3B0aW9ucyA9IHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgICB2YXIgY2hpbGQgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IG9sZFZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgdXBkYXRlQ2hpbGRDb21wb25lbnQoY2hpbGQsIG9wdGlvbnMucHJvcHNEYXRhLCAvLyB1cGRhdGVkIHByb3BzCiAgICBvcHRpb25zLmxpc3RlbmVycywgLy8gdXBkYXRlZCBsaXN0ZW5lcnMKICAgIHZub2RlLCAvLyBuZXcgcGFyZW50IHZub2RlCiAgICBvcHRpb25zLmNoaWxkcmVuIC8vIG5ldyBjaGlsZHJlbgogICAgKTsKICB9LAogIGluc2VydDogZnVuY3Rpb24gaW5zZXJ0KHZub2RlKSB7CiAgICB2YXIgY29udGV4dCA9IHZub2RlLmNvbnRleHQ7CiAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKCiAgICBpZiAoIWNvbXBvbmVudEluc3RhbmNlLl9pc01vdW50ZWQpIHsKICAgICAgY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCA9IHRydWU7CiAgICAgIGNhbGxIb29rKGNvbXBvbmVudEluc3RhbmNlLCAnbW91bnRlZCcpOwogICAgfQoKICAgIGlmICh2bm9kZS5kYXRhLmtlZXBBbGl2ZSkgewogICAgICBpZiAoY29udGV4dC5faXNNb3VudGVkKSB7CiAgICAgICAgLy8gdnVlLXJvdXRlciMxMjEyCiAgICAgICAgLy8gRHVyaW5nIHVwZGF0ZXMsIGEga2VwdC1hbGl2ZSBjb21wb25lbnQncyBjaGlsZCBjb21wb25lbnRzIG1heQogICAgICAgIC8vIGNoYW5nZSwgc28gZGlyZWN0bHkgd2Fsa2luZyB0aGUgdHJlZSBoZXJlIG1heSBjYWxsIGFjdGl2YXRlZCBob29rcwogICAgICAgIC8vIG9uIGluY29ycmVjdCBjaGlsZHJlbi4gSW5zdGVhZCB3ZSBwdXNoIHRoZW0gaW50byBhIHF1ZXVlIHdoaWNoIHdpbGwKICAgICAgICAvLyBiZSBwcm9jZXNzZWQgYWZ0ZXIgdGhlIHdob2xlIHBhdGNoIHByb2Nlc3MgZW5kZWQuCiAgICAgICAgcXVldWVBY3RpdmF0ZWRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UpOwogICAgICB9IGVsc2UgewogICAgICAgIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUKICAgICAgICAvKiBkaXJlY3QgKi8KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfSwKICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KHZub2RlKSB7CiAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKCiAgICBpZiAoIWNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCkgewogICAgICBpZiAoIXZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUKICAgICAgICAvKiBkaXJlY3QgKi8KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgaG9va3NUb01lcmdlID0gT2JqZWN0LmtleXMoY29tcG9uZW50Vk5vZGVIb29rcyk7CgpmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQoQ3RvciwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZykgewogIGlmIChpc1VuZGVmKEN0b3IpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYmFzZUN0b3IgPSBjb250ZXh0LiRvcHRpb25zLl9iYXNlOyAvLyBwbGFpbiBvcHRpb25zIG9iamVjdDogdHVybiBpdCBpbnRvIGEgY29uc3RydWN0b3IKCiAgaWYgKGlzT2JqZWN0KEN0b3IpKSB7CiAgICBDdG9yID0gYmFzZUN0b3IuZXh0ZW5kKEN0b3IpOwogIH0gLy8gaWYgYXQgdGhpcyBzdGFnZSBpdCdzIG5vdCBhIGNvbnN0cnVjdG9yIG9yIGFuIGFzeW5jIGNvbXBvbmVudCBmYWN0b3J5LAogIC8vIHJlamVjdC4KCgogIGlmICh0eXBlb2YgQ3RvciAhPT0gJ2Z1bmN0aW9uJykgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgd2FybigiSW52YWxpZCBDb21wb25lbnQgZGVmaW5pdGlvbjogIiArIFN0cmluZyhDdG9yKSwgY29udGV4dCk7CiAgICB9CgogICAgcmV0dXJuOwogIH0gLy8gYXN5bmMgY29tcG9uZW50CgoKICB2YXIgYXN5bmNGYWN0b3J5OwoKICBpZiAoaXNVbmRlZihDdG9yLmNpZCkpIHsKICAgIGFzeW5jRmFjdG9yeSA9IEN0b3I7CiAgICBDdG9yID0gcmVzb2x2ZUFzeW5jQ29tcG9uZW50KGFzeW5jRmFjdG9yeSwgYmFzZUN0b3IpOwoKICAgIGlmIChDdG9yID09PSB1bmRlZmluZWQpIHsKICAgICAgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgbm9kZSBmb3IgYXN5bmMgY29tcG9uZW50LCB3aGljaCBpcyByZW5kZXJlZAogICAgICAvLyBhcyBhIGNvbW1lbnQgbm9kZSBidXQgcHJlc2VydmVzIGFsbCB0aGUgcmF3IGluZm9ybWF0aW9uIGZvciB0aGUgbm9kZS4KICAgICAgLy8gdGhlIGluZm9ybWF0aW9uIHdpbGwgYmUgdXNlZCBmb3IgYXN5bmMgc2VydmVyLXJlbmRlcmluZyBhbmQgaHlkcmF0aW9uLgogICAgICByZXR1cm4gY3JlYXRlQXN5bmNQbGFjZWhvbGRlcihhc3luY0ZhY3RvcnksIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgfQogIH0KCiAgZGF0YSA9IGRhdGEgfHwge307IC8vIHJlc29sdmUgY29uc3RydWN0b3Igb3B0aW9ucyBpbiBjYXNlIGdsb2JhbCBtaXhpbnMgYXJlIGFwcGxpZWQgYWZ0ZXIKICAvLyBjb21wb25lbnQgY29uc3RydWN0b3IgY3JlYXRpb24KCiAgcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yKTsgLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGRhdGEgaW50byBwcm9wcyAmIGV2ZW50cwoKICBpZiAoaXNEZWYoZGF0YS5tb2RlbCkpIHsKICAgIHRyYW5zZm9ybU1vZGVsKEN0b3Iub3B0aW9ucywgZGF0YSk7CiAgfSAvLyBleHRyYWN0IHByb3BzCgoKICB2YXIgcHJvcHNEYXRhID0gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YShkYXRhLCBDdG9yLCB0YWcpOyAvLyBmdW5jdGlvbmFsIGNvbXBvbmVudAoKICBpZiAoaXNUcnVlKEN0b3Iub3B0aW9ucy5mdW5jdGlvbmFsKSkgewogICAgcmV0dXJuIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbik7CiAgfSAvLyBleHRyYWN0IGxpc3RlbmVycywgc2luY2UgdGhlc2UgbmVlZHMgdG8gYmUgdHJlYXRlZCBhcwogIC8vIGNoaWxkIGNvbXBvbmVudCBsaXN0ZW5lcnMgaW5zdGVhZCBvZiBET00gbGlzdGVuZXJzCgoKICB2YXIgbGlzdGVuZXJzID0gZGF0YS5vbjsgLy8gcmVwbGFjZSB3aXRoIGxpc3RlbmVycyB3aXRoIC5uYXRpdmUgbW9kaWZpZXIKICAvLyBzbyBpdCBnZXRzIHByb2Nlc3NlZCBkdXJpbmcgcGFyZW50IGNvbXBvbmVudCBwYXRjaC4KCiAgZGF0YS5vbiA9IGRhdGEubmF0aXZlT247CgogIGlmIChpc1RydWUoQ3Rvci5vcHRpb25zWyJhYnN0cmFjdCJdKSkgewogICAgLy8gYWJzdHJhY3QgY29tcG9uZW50cyBkbyBub3Qga2VlcCBhbnl0aGluZwogICAgLy8gb3RoZXIgdGhhbiBwcm9wcyAmIGxpc3RlbmVycyAmIHNsb3QKICAgIC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgIHZhciBzbG90ID0gZGF0YS5zbG90OwogICAgZGF0YSA9IHt9OwoKICAgIGlmIChzbG90KSB7CiAgICAgIGRhdGEuc2xvdCA9IHNsb3Q7CiAgICB9CiAgfSAvLyBpbnN0YWxsIGNvbXBvbmVudCBtYW5hZ2VtZW50IGhvb2tzIG9udG8gdGhlIHBsYWNlaG9sZGVyIG5vZGUKCgogIGluc3RhbGxDb21wb25lbnRIb29rcyhkYXRhKTsgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgdm5vZGUKCiAgdmFyIG5hbWUgPSBDdG9yLm9wdGlvbnMubmFtZSB8fCB0YWc7CiAgdmFyIHZub2RlID0gbmV3IFZOb2RlKCJ2dWUtY29tcG9uZW50LSIgKyBDdG9yLmNpZCArIChuYW1lID8gIi0iICsgbmFtZSA6ICcnKSwgZGF0YSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGV4dCwgewogICAgQ3RvcjogQ3RvciwKICAgIHByb3BzRGF0YTogcHJvcHNEYXRhLAogICAgbGlzdGVuZXJzOiBsaXN0ZW5lcnMsCiAgICB0YWc6IHRhZywKICAgIGNoaWxkcmVuOiBjaGlsZHJlbgogIH0sIGFzeW5jRmFjdG9yeSk7CiAgcmV0dXJuIHZub2RlOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKCAvLyB3ZSBrbm93IGl0J3MgTW91bnRlZENvbXBvbmVudFZOb2RlIGJ1dCBmbG93IGRvZXNuJ3QKdm5vZGUsIC8vIGFjdGl2ZUluc3RhbmNlIGluIGxpZmVjeWNsZSBzdGF0ZQpwYXJlbnQpIHsKICB2YXIgb3B0aW9ucyA9IHsKICAgIF9pc0NvbXBvbmVudDogdHJ1ZSwKICAgIF9wYXJlbnRWbm9kZTogdm5vZGUsCiAgICBwYXJlbnQ6IHBhcmVudAogIH07IC8vIGNoZWNrIGlubGluZS10ZW1wbGF0ZSByZW5kZXIgZnVuY3Rpb25zCgogIHZhciBpbmxpbmVUZW1wbGF0ZSA9IHZub2RlLmRhdGEuaW5saW5lVGVtcGxhdGU7CgogIGlmIChpc0RlZihpbmxpbmVUZW1wbGF0ZSkpIHsKICAgIG9wdGlvbnMucmVuZGVyID0gaW5saW5lVGVtcGxhdGUucmVuZGVyOwogICAgb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnMgPSBpbmxpbmVUZW1wbGF0ZS5zdGF0aWNSZW5kZXJGbnM7CiAgfQoKICByZXR1cm4gbmV3IHZub2RlLmNvbXBvbmVudE9wdGlvbnMuQ3RvcihvcHRpb25zKTsKfQoKZnVuY3Rpb24gaW5zdGFsbENvbXBvbmVudEhvb2tzKGRhdGEpIHsKICB2YXIgaG9va3MgPSBkYXRhLmhvb2sgfHwgKGRhdGEuaG9vayA9IHt9KTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rc1RvTWVyZ2UubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrZXkgPSBob29rc1RvTWVyZ2VbaV07CiAgICB2YXIgZXhpc3RpbmcgPSBob29rc1trZXldOwogICAgdmFyIHRvTWVyZ2UgPSBjb21wb25lbnRWTm9kZUhvb2tzW2tleV07CgogICAgaWYgKGV4aXN0aW5nICE9PSB0b01lcmdlICYmICEoZXhpc3RpbmcgJiYgZXhpc3RpbmcuX21lcmdlZCkpIHsKICAgICAgaG9va3Nba2V5XSA9IGV4aXN0aW5nID8gbWVyZ2VIb29rJDEodG9NZXJnZSwgZXhpc3RpbmcpIDogdG9NZXJnZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIG1lcmdlSG9vayQxKGYxLCBmMikgewogIHZhciBtZXJnZWQgPSBmdW5jdGlvbiBtZXJnZWQoYSwgYikgewogICAgLy8gZmxvdyBjb21wbGFpbnMgYWJvdXQgZXh0cmEgYXJncyB3aGljaCBpcyB3aHkgd2UgdXNlIGFueQogICAgZjEoYSwgYik7CiAgICBmMihhLCBiKTsKICB9OwoKICBtZXJnZWQuX21lcmdlZCA9IHRydWU7CiAgcmV0dXJuIG1lcmdlZDsKfSAvLyB0cmFuc2Zvcm0gY29tcG9uZW50IHYtbW9kZWwgaW5mbyAodmFsdWUgYW5kIGNhbGxiYWNrKSBpbnRvCi8vIHByb3AgYW5kIGV2ZW50IGhhbmRsZXIgcmVzcGVjdGl2ZWx5LgoKCmZ1bmN0aW9uIHRyYW5zZm9ybU1vZGVsKG9wdGlvbnMsIGRhdGEpIHsKICB2YXIgcHJvcCA9IG9wdGlvbnMubW9kZWwgJiYgb3B0aW9ucy5tb2RlbC5wcm9wIHx8ICd2YWx1ZSc7CiAgdmFyIGV2ZW50ID0gb3B0aW9ucy5tb2RlbCAmJiBvcHRpb25zLm1vZGVsLmV2ZW50IHx8ICdpbnB1dCc7CiAgKGRhdGEuYXR0cnMgfHwgKGRhdGEuYXR0cnMgPSB7fSkpW3Byb3BdID0gZGF0YS5tb2RlbC52YWx1ZTsKICB2YXIgb24gPSBkYXRhLm9uIHx8IChkYXRhLm9uID0ge30pOwogIHZhciBleGlzdGluZyA9IG9uW2V2ZW50XTsKICB2YXIgY2FsbGJhY2sgPSBkYXRhLm1vZGVsLmNhbGxiYWNrOwoKICBpZiAoaXNEZWYoZXhpc3RpbmcpKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShleGlzdGluZykgPyBleGlzdGluZy5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEgOiBleGlzdGluZyAhPT0gY2FsbGJhY2spIHsKICAgICAgb25bZXZlbnRdID0gW2NhbGxiYWNrXS5jb25jYXQoZXhpc3RpbmcpOwogICAgfQogIH0gZWxzZSB7CiAgICBvbltldmVudF0gPSBjYWxsYmFjazsKICB9Cn0KLyogICovCgoKdmFyIFNJTVBMRV9OT1JNQUxJWkUgPSAxOwp2YXIgQUxXQVlTX05PUk1BTElaRSA9IDI7IC8vIHdyYXBwZXIgZnVuY3Rpb24gZm9yIHByb3ZpZGluZyBhIG1vcmUgZmxleGlibGUgaW50ZXJmYWNlCi8vIHdpdGhvdXQgZ2V0dGluZyB5ZWxsZWQgYXQgYnkgZmxvdwoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSwgYWx3YXlzTm9ybWFsaXplKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgfHwgaXNQcmltaXRpdmUoZGF0YSkpIHsKICAgIG5vcm1hbGl6YXRpb25UeXBlID0gY2hpbGRyZW47CiAgICBjaGlsZHJlbiA9IGRhdGE7CiAgICBkYXRhID0gdW5kZWZpbmVkOwogIH0KCiAgaWYgKGlzVHJ1ZShhbHdheXNOb3JtYWxpemUpKSB7CiAgICBub3JtYWxpemF0aW9uVHlwZSA9IEFMV0FZU19OT1JNQUxJWkU7CiAgfQoKICByZXR1cm4gX2NyZWF0ZUVsZW1lbnQoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUpOwp9CgpmdW5jdGlvbiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSkgewogIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihkYXRhLl9fb2JfXykpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiQXZvaWQgdXNpbmcgb2JzZXJ2ZWQgZGF0YSBvYmplY3QgYXMgdm5vZGUgZGF0YTogIiArIEpTT04uc3RyaW5naWZ5KGRhdGEpICsgIlxuIiArICdBbHdheXMgY3JlYXRlIGZyZXNoIHZub2RlIGRhdGEgb2JqZWN0cyBpbiBlYWNoIHJlbmRlciEnLCBjb250ZXh0KTsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfSAvLyBvYmplY3Qgc3ludGF4IGluIHYtYmluZAoKCiAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuaXMpKSB7CiAgICB0YWcgPSBkYXRhLmlzOwogIH0KCiAgaWYgKCF0YWcpIHsKICAgIC8vIGluIGNhc2Ugb2YgY29tcG9uZW50IDppcyBzZXQgdG8gZmFsc3kgdmFsdWUKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfSAvLyB3YXJuIGFnYWluc3Qgbm9uLXByaW1pdGl2ZSBrZXkKCgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEua2V5KSAmJiAhaXNQcmltaXRpdmUoZGF0YS5rZXkpKSB7CiAgICB7CiAgICAgIHdhcm4oJ0F2b2lkIHVzaW5nIG5vbi1wcmltaXRpdmUgdmFsdWUgYXMga2V5LCAnICsgJ3VzZSBzdHJpbmcvbnVtYmVyIHZhbHVlIGluc3RlYWQuJywgY29udGV4dCk7CiAgICB9CiAgfSAvLyBzdXBwb3J0IHNpbmdsZSBmdW5jdGlvbiBjaGlsZHJlbiBhcyBkZWZhdWx0IHNjb3BlZCBzbG90CgoKICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikgJiYgdHlwZW9mIGNoaWxkcmVuWzBdID09PSAnZnVuY3Rpb24nKSB7CiAgICBkYXRhID0gZGF0YSB8fCB7fTsKICAgIGRhdGEuc2NvcGVkU2xvdHMgPSB7CiAgICAgICJkZWZhdWx0IjogY2hpbGRyZW5bMF0KICAgIH07CiAgICBjaGlsZHJlbi5sZW5ndGggPSAwOwogIH0KCiAgaWYgKG5vcm1hbGl6YXRpb25UeXBlID09PSBBTFdBWVNfTk9STUFMSVpFKSB7CiAgICBjaGlsZHJlbiA9IG5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKTsKICB9IGVsc2UgaWYgKG5vcm1hbGl6YXRpb25UeXBlID09PSBTSU1QTEVfTk9STUFMSVpFKSB7CiAgICBjaGlsZHJlbiA9IHNpbXBsZU5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKTsKICB9CgogIHZhciB2bm9kZSwgbnM7CgogIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgdmFyIEN0b3I7CiAgICBucyA9IGNvbnRleHQuJHZub2RlICYmIGNvbnRleHQuJHZub2RlLm5zIHx8IGNvbmZpZy5nZXRUYWdOYW1lc3BhY2UodGFnKTsKCiAgICBpZiAoY29uZmlnLmlzUmVzZXJ2ZWRUYWcodGFnKSkgewogICAgICAvLyBwbGF0Zm9ybSBidWlsdC1pbiBlbGVtZW50cwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc0RlZihkYXRhKSAmJiBpc0RlZihkYXRhLm5hdGl2ZU9uKSAmJiBkYXRhLnRhZyAhPT0gJ2NvbXBvbmVudCcpIHsKICAgICAgICB3YXJuKCJUaGUgLm5hdGl2ZSBtb2RpZmllciBmb3Igdi1vbiBpcyBvbmx5IHZhbGlkIG9uIGNvbXBvbmVudHMgYnV0IGl0IHdhcyB1c2VkIG9uIDwiICsgdGFnICsgIj4uIiwgY29udGV4dCk7CiAgICAgIH0KCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKGNvbmZpZy5wYXJzZVBsYXRmb3JtVGFnTmFtZSh0YWcpLCBkYXRhLCBjaGlsZHJlbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmICgoIWRhdGEgfHwgIWRhdGEucHJlKSAmJiBpc0RlZihDdG9yID0gcmVzb2x2ZUFzc2V0KGNvbnRleHQuJG9wdGlvbnMsICdjb21wb25lbnRzJywgdGFnKSkpIHsKICAgICAgLy8gY29tcG9uZW50CiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdW5rbm93biBvciB1bmxpc3RlZCBuYW1lc3BhY2VkIGVsZW1lbnRzCiAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgIC8vIHBhcmVudCBub3JtYWxpemVzIGNoaWxkcmVuCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKHRhZywgZGF0YSwgY2hpbGRyZW4sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0KTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gZGlyZWN0IGNvbXBvbmVudCBvcHRpb25zIC8gY29uc3RydWN0b3IKICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIGlmIChpc0RlZih2bm9kZSkpIHsKICAgIGlmIChpc0RlZihucykpIHsKICAgICAgYXBwbHlOUyh2bm9kZSwgbnMpOwogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKTsKICAgIH0KCiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseU5TKHZub2RlLCBucywgZm9yY2UpIHsKICB2bm9kZS5ucyA9IG5zOwoKICBpZiAodm5vZGUudGFnID09PSAnZm9yZWlnbk9iamVjdCcpIHsKICAgIC8vIHVzZSBkZWZhdWx0IG5hbWVzcGFjZSBpbnNpZGUgZm9yZWlnbk9iamVjdAogICAgbnMgPSB1bmRlZmluZWQ7CiAgICBmb3JjZSA9IHRydWU7CiAgfQoKICBpZiAoaXNEZWYodm5vZGUuY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jaGlsZHJlbltpXTsKCiAgICAgIGlmIChpc0RlZihjaGlsZC50YWcpICYmIChpc1VuZGVmKGNoaWxkLm5zKSB8fCBpc1RydWUoZm9yY2UpICYmIGNoaWxkLnRhZyAhPT0gJ3N2ZycpKSB7CiAgICAgICAgYXBwbHlOUyhjaGlsZCwgbnMsIGZvcmNlKTsKICAgICAgfQogICAgfQogIH0KfSAvLyByZWYgIzUzMTgKLy8gbmVjZXNzYXJ5IHRvIGVuc3VyZSBwYXJlbnQgcmUtcmVuZGVyIHdoZW4gZGVlcCBiaW5kaW5ncyBsaWtlIDpzdHlsZSBhbmQKLy8gOmNsYXNzIGFyZSB1c2VkIG9uIHNsb3Qgbm9kZXMKCgpmdW5jdGlvbiByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKSB7CiAgaWYgKGlzT2JqZWN0KGRhdGEuc3R5bGUpKSB7CiAgICB0cmF2ZXJzZShkYXRhLnN0eWxlKTsKICB9CgogIGlmIChpc09iamVjdChkYXRhWyJjbGFzcyJdKSkgewogICAgdHJhdmVyc2UoZGF0YVsiY2xhc3MiXSk7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRSZW5kZXIodm0pIHsKICB2bS5fdm5vZGUgPSBudWxsOyAvLyB0aGUgcm9vdCBvZiB0aGUgY2hpbGQgdHJlZQoKICB2bS5fc3RhdGljVHJlZXMgPSBudWxsOyAvLyB2LW9uY2UgY2FjaGVkIHRyZWVzCgogIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgdmFyIHBhcmVudFZub2RlID0gdm0uJHZub2RlID0gb3B0aW9ucy5fcGFyZW50Vm5vZGU7IC8vIHRoZSBwbGFjZWhvbGRlciBub2RlIGluIHBhcmVudCB0cmVlCgogIHZhciByZW5kZXJDb250ZXh0ID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuY29udGV4dDsKICB2bS4kc2xvdHMgPSByZXNvbHZlU2xvdHMob3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4sIHJlbmRlckNvbnRleHQpOwogIHZtLiRzY29wZWRTbG90cyA9IGVtcHR5T2JqZWN0OyAvLyBiaW5kIHRoZSBjcmVhdGVFbGVtZW50IGZuIHRvIHRoaXMgaW5zdGFuY2UKICAvLyBzbyB0aGF0IHdlIGdldCBwcm9wZXIgcmVuZGVyIGNvbnRleHQgaW5zaWRlIGl0LgogIC8vIGFyZ3Mgb3JkZXI6IHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUKICAvLyBpbnRlcm5hbCB2ZXJzaW9uIGlzIHVzZWQgYnkgcmVuZGVyIGZ1bmN0aW9ucyBjb21waWxlZCBmcm9tIHRlbXBsYXRlcwoKICB2bS5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCh2bSwgYSwgYiwgYywgZCwgZmFsc2UpOwogIH07IC8vIG5vcm1hbGl6YXRpb24gaXMgYWx3YXlzIGFwcGxpZWQgZm9yIHRoZSBwdWJsaWMgdmVyc2lvbiwgdXNlZCBpbgogIC8vIHVzZXItd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zLgoKCiAgdm0uJGNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQodm0sIGEsIGIsIGMsIGQsIHRydWUpOwogIH07IC8vICRhdHRycyAmICRsaXN0ZW5lcnMgYXJlIGV4cG9zZWQgZm9yIGVhc2llciBIT0MgY3JlYXRpb24uCiAgLy8gdGhleSBuZWVkIHRvIGJlIHJlYWN0aXZlIHNvIHRoYXQgSE9DcyB1c2luZyB0aGVtIGFyZSBhbHdheXMgdXBkYXRlZAoKCiAgdmFyIHBhcmVudERhdGEgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5kYXRhOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRhdHRycycsIHBhcmVudERhdGEgJiYgcGFyZW50RGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ICYmIHdhcm4oIiRhdHRycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICB9LCB0cnVlKTsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ICYmIHdhcm4oIiRsaXN0ZW5lcnMgaXMgcmVhZG9ubHkuIiwgdm0pOwogICAgfSwgdHJ1ZSk7CiAgfSBlbHNlIHsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGF0dHJzJywgcGFyZW50RGF0YSAmJiBwYXJlbnREYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0LCBudWxsLCB0cnVlKTsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgbnVsbCwgdHJ1ZSk7CiAgfQp9Cgp2YXIgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gbnVsbDsKCmZ1bmN0aW9uIHJlbmRlck1peGluKFZ1ZSkgewogIC8vIGluc3RhbGwgcnVudGltZSBjb252ZW5pZW5jZSBoZWxwZXJzCiAgaW5zdGFsbFJlbmRlckhlbHBlcnMoVnVlLnByb3RvdHlwZSk7CgogIFZ1ZS5wcm90b3R5cGUuJG5leHRUaWNrID0gZnVuY3Rpb24gKGZuKSB7CiAgICByZXR1cm4gbmV4dFRpY2soZm4sIHRoaXMpOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuX3JlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcmVmID0gdm0uJG9wdGlvbnM7CiAgICB2YXIgcmVuZGVyID0gcmVmLnJlbmRlcjsKICAgIHZhciBfcGFyZW50Vm5vZGUgPSByZWYuX3BhcmVudFZub2RlOwoKICAgIGlmIChfcGFyZW50Vm5vZGUpIHsKICAgICAgdm0uJHNjb3BlZFNsb3RzID0gbm9ybWFsaXplU2NvcGVkU2xvdHMoX3BhcmVudFZub2RlLmRhdGEuc2NvcGVkU2xvdHMsIHZtLiRzbG90cywgdm0uJHNjb3BlZFNsb3RzKTsKICAgIH0gLy8gc2V0IHBhcmVudCB2bm9kZS4gdGhpcyBhbGxvd3MgcmVuZGVyIGZ1bmN0aW9ucyB0byBoYXZlIGFjY2VzcwogICAgLy8gdG8gdGhlIGRhdGEgb24gdGhlIHBsYWNlaG9sZGVyIG5vZGUuCgoKICAgIHZtLiR2bm9kZSA9IF9wYXJlbnRWbm9kZTsgLy8gcmVuZGVyIHNlbGYKCiAgICB2YXIgdm5vZGU7CgogICAgdHJ5IHsKICAgICAgLy8gVGhlcmUncyBubyBuZWVkIHRvIG1haW50YWluIGEgc3RhY2sgYmVjYXVzZSBhbGwgcmVuZGVyIGZucyBhcmUgY2FsbGVkCiAgICAgIC8vIHNlcGFyYXRlbHkgZnJvbSBvbmUgYW5vdGhlci4gTmVzdGVkIGNvbXBvbmVudCdzIHJlbmRlciBmbnMgYXJlIGNhbGxlZAogICAgICAvLyB3aGVuIHBhcmVudCBjb21wb25lbnQgaXMgcGF0Y2hlZC4KICAgICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gdm07CiAgICAgIHZub2RlID0gcmVuZGVyLmNhbGwodm0uX3JlbmRlclByb3h5LCB2bS4kY3JlYXRlRWxlbWVudCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAicmVuZGVyIik7IC8vIHJldHVybiBlcnJvciByZW5kZXIgcmVzdWx0LAogICAgICAvLyBvciBwcmV2aW91cyB2bm9kZSB0byBwcmV2ZW50IHJlbmRlciBlcnJvciBjYXVzaW5nIGJsYW5rIGNvbXBvbmVudAoKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHZtLiRvcHRpb25zLnJlbmRlckVycm9yKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZub2RlID0gdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50LCBlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlckVycm9yIik7CiAgICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CiAgICB9IC8vIGlmIHRoZSByZXR1cm5lZCBhcnJheSBjb250YWlucyBvbmx5IGEgc2luZ2xlIG5vZGUsIGFsbG93IGl0CgoKICAgIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSAmJiB2bm9kZS5sZW5ndGggPT09IDEpIHsKICAgICAgdm5vZGUgPSB2bm9kZVswXTsKICAgIH0gLy8gcmV0dXJuIGVtcHR5IHZub2RlIGluIGNhc2UgdGhlIHJlbmRlciBmdW5jdGlvbiBlcnJvcmVkIG91dAoKCiAgICBpZiAoISh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgICAgIHdhcm4oJ011bHRpcGxlIHJvb3Qgbm9kZXMgcmV0dXJuZWQgZnJvbSByZW5kZXIgZnVuY3Rpb24uIFJlbmRlciBmdW5jdGlvbiAnICsgJ3Nob3VsZCByZXR1cm4gYSBzaW5nbGUgcm9vdCBub2RlLicsIHZtKTsKICAgICAgfQoKICAgICAgdm5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgICB9IC8vIHNldCBwYXJlbnQKCgogICAgdm5vZGUucGFyZW50ID0gX3BhcmVudFZub2RlOwogICAgcmV0dXJuIHZub2RlOwogIH07Cn0KLyogICovCgoKZnVuY3Rpb24gZW5zdXJlQ3Rvcihjb21wLCBiYXNlKSB7CiAgaWYgKGNvbXAuX19lc01vZHVsZSB8fCBoYXNTeW1ib2wgJiYgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykgewogICAgY29tcCA9IGNvbXBbImRlZmF1bHQiXTsKICB9CgogIHJldHVybiBpc09iamVjdChjb21wKSA/IGJhc2UuZXh0ZW5kKGNvbXApIDogY29tcDsKfQoKZnVuY3Rpb24gY3JlYXRlQXN5bmNQbGFjZWhvbGRlcihmYWN0b3J5LCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKSB7CiAgdmFyIG5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgbm9kZS5hc3luY0ZhY3RvcnkgPSBmYWN0b3J5OwogIG5vZGUuYXN5bmNNZXRhID0gewogICAgZGF0YTogZGF0YSwKICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICBjaGlsZHJlbjogY2hpbGRyZW4sCiAgICB0YWc6IHRhZwogIH07CiAgcmV0dXJuIG5vZGU7Cn0KCmZ1bmN0aW9uIHJlc29sdmVBc3luY0NvbXBvbmVudChmYWN0b3J5LCBiYXNlQ3RvcikgewogIGlmIChpc1RydWUoZmFjdG9yeS5lcnJvcikgJiYgaXNEZWYoZmFjdG9yeS5lcnJvckNvbXApKSB7CiAgICByZXR1cm4gZmFjdG9yeS5lcnJvckNvbXA7CiAgfQoKICBpZiAoaXNEZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgIHJldHVybiBmYWN0b3J5LnJlc29sdmVkOwogIH0KCiAgdmFyIG93bmVyID0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlOwoKICBpZiAob3duZXIgJiYgaXNEZWYoZmFjdG9yeS5vd25lcnMpICYmIGZhY3Rvcnkub3duZXJzLmluZGV4T2Yob3duZXIpID09PSAtMSkgewogICAgLy8gYWxyZWFkeSBwZW5kaW5nCiAgICBmYWN0b3J5Lm93bmVycy5wdXNoKG93bmVyKTsKICB9CgogIGlmIChpc1RydWUoZmFjdG9yeS5sb2FkaW5nKSAmJiBpc0RlZihmYWN0b3J5LmxvYWRpbmdDb21wKSkgewogICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZ0NvbXA7CiAgfQoKICBpZiAob3duZXIgJiYgIWlzRGVmKGZhY3Rvcnkub3duZXJzKSkgewogICAgdmFyIG93bmVycyA9IGZhY3Rvcnkub3duZXJzID0gW293bmVyXTsKICAgIHZhciBzeW5jID0gdHJ1ZTsKICAgIHZhciB0aW1lckxvYWRpbmcgPSBudWxsOwogICAgdmFyIHRpbWVyVGltZW91dCA9IG51bGw7CiAgICBvd25lci4kb24oJ2hvb2s6ZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVtb3ZlKG93bmVycywgb3duZXIpOwogICAgfSk7CgogICAgdmFyIGZvcmNlUmVuZGVyID0gZnVuY3Rpb24gZm9yY2VSZW5kZXIocmVuZGVyQ29tcGxldGVkKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb3duZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG93bmVyc1tpXS4kZm9yY2VVcGRhdGUoKTsKICAgICAgfQoKICAgICAgaWYgKHJlbmRlckNvbXBsZXRlZCkgewogICAgICAgIG93bmVycy5sZW5ndGggPSAwOwoKICAgICAgICBpZiAodGltZXJMb2FkaW5nICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJMb2FkaW5nKTsKICAgICAgICAgIHRpbWVyTG9hZGluZyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodGltZXJUaW1lb3V0ICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJUaW1lb3V0KTsKICAgICAgICAgIHRpbWVyVGltZW91dCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciByZXNvbHZlID0gb25jZShmdW5jdGlvbiAocmVzKSB7CiAgICAgIC8vIGNhY2hlIHJlc29sdmVkCiAgICAgIGZhY3RvcnkucmVzb2x2ZWQgPSBlbnN1cmVDdG9yKHJlcywgYmFzZUN0b3IpOyAvLyBpbnZva2UgY2FsbGJhY2tzIG9ubHkgaWYgdGhpcyBpcyBub3QgYSBzeW5jaHJvbm91cyByZXNvbHZlCiAgICAgIC8vIChhc3luYyByZXNvbHZlcyBhcmUgc2hpbW1lZCBhcyBzeW5jaHJvbm91cyBkdXJpbmcgU1NSKQoKICAgICAgaWYgKCFzeW5jKSB7CiAgICAgICAgZm9yY2VSZW5kZXIodHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3duZXJzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlamVjdCA9IG9uY2UoZnVuY3Rpb24gKHJlYXNvbikgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkZhaWxlZCB0byByZXNvbHZlIGFzeW5jIGNvbXBvbmVudDogIiArIFN0cmluZyhmYWN0b3J5KSArIChyZWFzb24gPyAiXG5SZWFzb246ICIgKyByZWFzb24gOiAnJykpOwoKICAgICAgaWYgKGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgICAgIGZhY3RvcnkuZXJyb3IgPSB0cnVlOwogICAgICAgIGZvcmNlUmVuZGVyKHRydWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXMgPSBmYWN0b3J5KHJlc29sdmUsIHJlamVjdCk7CgogICAgaWYgKGlzT2JqZWN0KHJlcykpIHsKICAgICAgaWYgKGlzUHJvbWlzZShyZXMpKSB7CiAgICAgICAgLy8gKCkgPT4gUHJvbWlzZQogICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgICByZXMudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1Byb21pc2UocmVzLmNvbXBvbmVudCkpIHsKICAgICAgICByZXMuY29tcG9uZW50LnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKCiAgICAgICAgaWYgKGlzRGVmKHJlcy5lcnJvcikpIHsKICAgICAgICAgIGZhY3RvcnkuZXJyb3JDb21wID0gZW5zdXJlQ3RvcihyZXMuZXJyb3IsIGJhc2VDdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0RlZihyZXMubG9hZGluZykpIHsKICAgICAgICAgIGZhY3RvcnkubG9hZGluZ0NvbXAgPSBlbnN1cmVDdG9yKHJlcy5sb2FkaW5nLCBiYXNlQ3Rvcik7CgogICAgICAgICAgaWYgKHJlcy5kZWxheSA9PT0gMCkgewogICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGltZXJMb2FkaW5nID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGltZXJMb2FkaW5nID0gbnVsbDsKCiAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkgJiYgaXNVbmRlZihmYWN0b3J5LmVycm9yKSkgewogICAgICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZvcmNlUmVuZGVyKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHJlcy5kZWxheSB8fCAyMDApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKHJlcy50aW1lb3V0KSkgewogICAgICAgICAgdGltZXJUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRpbWVyVGltZW91dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgICAgIHJlamVjdChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gInRpbWVvdXQgKCIgKyByZXMudGltZW91dCArICJtcykiIDogbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHJlcy50aW1lb3V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzeW5jID0gZmFsc2U7IC8vIHJldHVybiBpbiBjYXNlIHJlc29sdmVkIHN5bmNocm9ub3VzbHkKCiAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nID8gZmFjdG9yeS5sb2FkaW5nQ29tcCA6IGZhY3RvcnkucmVzb2x2ZWQ7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoY2hpbGRyZW4pIHsKICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGMgPSBjaGlsZHJlbltpXTsKCiAgICAgIGlmIChpc0RlZihjKSAmJiAoaXNEZWYoYy5jb21wb25lbnRPcHRpb25zKSB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYykpKSB7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0KICAgIH0KICB9Cn0KLyogICovCgovKiAgKi8KCgpmdW5jdGlvbiBpbml0RXZlbnRzKHZtKSB7CiAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdm0uX2hhc0hvb2tFdmVudCA9IGZhbHNlOyAvLyBpbml0IHBhcmVudCBhdHRhY2hlZCBldmVudHMKCiAgdmFyIGxpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CgogIGlmIChsaXN0ZW5lcnMpIHsKICAgIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzKTsKICB9Cn0KCnZhciB0YXJnZXQ7CgpmdW5jdGlvbiBhZGQoZXZlbnQsIGZuKSB7CiAgdGFyZ2V0LiRvbihldmVudCwgZm4pOwp9CgpmdW5jdGlvbiByZW1vdmUkMShldmVudCwgZm4pIHsKICB0YXJnZXQuJG9mZihldmVudCwgZm4pOwp9CgpmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlcihldmVudCwgZm4pIHsKICB2YXIgX3RhcmdldCA9IHRhcmdldDsKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgIF90YXJnZXQuJG9mZihldmVudCwgb25jZUhhbmRsZXIpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMpIHsKICB0YXJnZXQgPSB2bTsKICB1cGRhdGVMaXN0ZW5lcnMobGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMgfHwge30sIGFkZCwgcmVtb3ZlJDEsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bSk7CiAgdGFyZ2V0ID0gdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBldmVudHNNaXhpbihWdWUpIHsKICB2YXIgaG9va1JFID0gL15ob29rOi87CgogIFZ1ZS5wcm90b3R5cGUuJG9uID0gZnVuY3Rpb24gKGV2ZW50LCBmbikgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2bS4kb24oZXZlbnRbaV0sIGZuKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgKHZtLl9ldmVudHNbZXZlbnRdIHx8ICh2bS5fZXZlbnRzW2V2ZW50XSA9IFtdKSkucHVzaChmbik7IC8vIG9wdGltaXplIGhvb2s6ZXZlbnQgY29zdCBieSB1c2luZyBhIGJvb2xlYW4gZmxhZyBtYXJrZWQgYXQgcmVnaXN0cmF0aW9uCiAgICAgIC8vIGluc3RlYWQgb2YgYSBoYXNoIGxvb2t1cAoKICAgICAgaWYgKGhvb2tSRS50ZXN0KGV2ZW50KSkgewogICAgICAgIHZtLl9oYXNIb29rRXZlbnQgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJG9uY2UgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGZ1bmN0aW9uIG9uKCkgewogICAgICB2bS4kb2ZmKGV2ZW50LCBvbik7CiAgICAgIGZuLmFwcGx5KHZtLCBhcmd1bWVudHMpOwogICAgfQoKICAgIG9uLmZuID0gZm47CiAgICB2bS4kb24oZXZlbnQsIG9uKTsKICAgIHJldHVybiB2bTsKICB9OwoKICBWdWUucHJvdG90eXBlLiRvZmYgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOyAvLyBhbGwKCiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gYXJyYXkgb2YgZXZlbnRzCgoKICAgIGlmIChBcnJheS5pc0FycmF5KGV2ZW50KSkgewogICAgICBmb3IgKHZhciBpJDEgPSAwLCBsID0gZXZlbnQubGVuZ3RoOyBpJDEgPCBsOyBpJDErKykgewogICAgICAgIHZtLiRvZmYoZXZlbnRbaSQxXSwgZm4pOwogICAgICB9CgogICAgICByZXR1cm4gdm07CiAgICB9IC8vIHNwZWNpZmljIGV2ZW50CgoKICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKCiAgICBpZiAoIWNicykgewogICAgICByZXR1cm4gdm07CiAgICB9CgogICAgaWYgKCFmbikgewogICAgICB2bS5fZXZlbnRzW2V2ZW50XSA9IG51bGw7CiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gc3BlY2lmaWMgaGFuZGxlcgoKCiAgICB2YXIgY2I7CiAgICB2YXIgaSA9IGNicy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICBjYiA9IGNic1tpXTsKCiAgICAgIGlmIChjYiA9PT0gZm4gfHwgY2IuZm4gPT09IGZuKSB7CiAgICAgICAgY2JzLnNwbGljZShpLCAxKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2bTsKICB9OwoKICBWdWUucHJvdG90eXBlLiRlbWl0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHZhciBsb3dlckNhc2VFdmVudCA9IGV2ZW50LnRvTG93ZXJDYXNlKCk7CgogICAgICBpZiAobG93ZXJDYXNlRXZlbnQgIT09IGV2ZW50ICYmIHZtLl9ldmVudHNbbG93ZXJDYXNlRXZlbnRdKSB7CiAgICAgICAgdGlwKCJFdmVudCBcIiIgKyBsb3dlckNhc2VFdmVudCArICJcIiBpcyBlbWl0dGVkIGluIGNvbXBvbmVudCAiICsgZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkgKyAiIGJ1dCB0aGUgaGFuZGxlciBpcyByZWdpc3RlcmVkIGZvciBcIiIgKyBldmVudCArICJcIi4gIiArICJOb3RlIHRoYXQgSFRNTCBhdHRyaWJ1dGVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlIGFuZCB5b3UgY2Fubm90IHVzZSAiICsgInYtb24gdG8gbGlzdGVuIHRvIGNhbWVsQ2FzZSBldmVudHMgd2hlbiB1c2luZyBpbi1ET00gdGVtcGxhdGVzLiAiICsgIllvdSBzaG91bGQgcHJvYmFibHkgdXNlIFwiIiArIGh5cGhlbmF0ZShldmVudCkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBldmVudCArICJcIi4iKTsKICAgICAgfQogICAgfQoKICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKCiAgICBpZiAoY2JzKSB7CiAgICAgIGNicyA9IGNicy5sZW5ndGggPiAxID8gdG9BcnJheShjYnMpIDogY2JzOwogICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzLCAxKTsKICAgICAgdmFyIGluZm8gPSAiZXZlbnQgaGFuZGxlciBmb3IgXCIiICsgZXZlbnQgKyAiXCIiOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjYnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoY2JzW2ldLCB2bSwgYXJncywgdm0sIGluZm8pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07Cn0KLyogICovCgoKdmFyIGFjdGl2ZUluc3RhbmNlID0gbnVsbDsKdmFyIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwoKZnVuY3Rpb24gc2V0QWN0aXZlSW5zdGFuY2Uodm0pIHsKICB2YXIgcHJldkFjdGl2ZUluc3RhbmNlID0gYWN0aXZlSW5zdGFuY2U7CiAgYWN0aXZlSW5zdGFuY2UgPSB2bTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgYWN0aXZlSW5zdGFuY2UgPSBwcmV2QWN0aXZlSW5zdGFuY2U7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdExpZmVjeWNsZSh2bSkgewogIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7IC8vIGxvY2F0ZSBmaXJzdCBub24tYWJzdHJhY3QgcGFyZW50CgogIHZhciBwYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKCiAgaWYgKHBhcmVudCAmJiAhb3B0aW9uc1siYWJzdHJhY3QiXSkgewogICAgd2hpbGUgKHBhcmVudC4kb3B0aW9uc1siYWJzdHJhY3QiXSAmJiBwYXJlbnQuJHBhcmVudCkgewogICAgICBwYXJlbnQgPSBwYXJlbnQuJHBhcmVudDsKICAgIH0KCiAgICBwYXJlbnQuJGNoaWxkcmVuLnB1c2godm0pOwogIH0KCiAgdm0uJHBhcmVudCA9IHBhcmVudDsKICB2bS4kcm9vdCA9IHBhcmVudCA/IHBhcmVudC4kcm9vdCA6IHZtOwogIHZtLiRjaGlsZHJlbiA9IFtdOwogIHZtLiRyZWZzID0ge307CiAgdm0uX3dhdGNoZXIgPSBudWxsOwogIHZtLl9pbmFjdGl2ZSA9IG51bGw7CiAgdm0uX2RpcmVjdEluYWN0aXZlID0gZmFsc2U7CiAgdm0uX2lzTW91bnRlZCA9IGZhbHNlOwogIHZtLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGxpZmVjeWNsZU1peGluKFZ1ZSkgewogIFZ1ZS5wcm90b3R5cGUuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgdmFyIHByZXZFbCA9IHZtLiRlbDsKICAgIHZhciBwcmV2Vm5vZGUgPSB2bS5fdm5vZGU7CiAgICB2YXIgcmVzdG9yZUFjdGl2ZUluc3RhbmNlID0gc2V0QWN0aXZlSW5zdGFuY2Uodm0pOwogICAgdm0uX3Zub2RlID0gdm5vZGU7IC8vIFZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fIGlzIGluamVjdGVkIGluIGVudHJ5IHBvaW50cwogICAgLy8gYmFzZWQgb24gdGhlIHJlbmRlcmluZyBiYWNrZW5kIHVzZWQuCgogICAgaWYgKCFwcmV2Vm5vZGUpIHsKICAgICAgLy8gaW5pdGlhbCByZW5kZXIKICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHZtLiRlbCwgdm5vZGUsIGh5ZHJhdGluZywgZmFsc2UKICAgICAgLyogcmVtb3ZlT25seSAqLwogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgLy8gdXBkYXRlcwogICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18ocHJldlZub2RlLCB2bm9kZSk7CiAgICB9CgogICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7IC8vIHVwZGF0ZSBfX3Z1ZV9fIHJlZmVyZW5jZQoKICAgIGlmIChwcmV2RWwpIHsKICAgICAgcHJldkVsLl9fdnVlX18gPSBudWxsOwogICAgfQoKICAgIGlmICh2bS4kZWwpIHsKICAgICAgdm0uJGVsLl9fdnVlX18gPSB2bTsKICAgIH0gLy8gaWYgcGFyZW50IGlzIGFuIEhPQywgdXBkYXRlIGl0cyAkZWwgYXMgd2VsbAoKCiAgICBpZiAodm0uJHZub2RlICYmIHZtLiRwYXJlbnQgJiYgdm0uJHZub2RlID09PSB2bS4kcGFyZW50Ll92bm9kZSkgewogICAgICB2bS4kcGFyZW50LiRlbCA9IHZtLiRlbDsKICAgIH0gLy8gdXBkYXRlZCBob29rIGlzIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyIHRvIGVuc3VyZSB0aGF0IGNoaWxkcmVuIGFyZQogICAgLy8gdXBkYXRlZCBpbiBhIHBhcmVudCdzIHVwZGF0ZWQgaG9vay4KCiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kZm9yY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlci51cGRhdGUoKTsKICAgIH0KICB9OwoKICBWdWUucHJvdG90eXBlLiRkZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAodm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlRGVzdHJveScpOwogICAgdm0uX2lzQmVpbmdEZXN0cm95ZWQgPSB0cnVlOyAvLyByZW1vdmUgc2VsZiBmcm9tIHBhcmVudAoKICAgIHZhciBwYXJlbnQgPSB2bS4kcGFyZW50OwoKICAgIGlmIChwYXJlbnQgJiYgIXBhcmVudC5faXNCZWluZ0Rlc3Ryb3llZCAmJiAhdm0uJG9wdGlvbnNbImFic3RyYWN0Il0pIHsKICAgICAgcmVtb3ZlKHBhcmVudC4kY2hpbGRyZW4sIHZtKTsKICAgIH0gLy8gdGVhcmRvd24gd2F0Y2hlcnMKCgogICAgaWYgKHZtLl93YXRjaGVyKSB7CiAgICAgIHZtLl93YXRjaGVyLnRlYXJkb3duKCk7CiAgICB9CgogICAgdmFyIGkgPSB2bS5fd2F0Y2hlcnMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdm0uX3dhdGNoZXJzW2ldLnRlYXJkb3duKCk7CiAgICB9IC8vIHJlbW92ZSByZWZlcmVuY2UgZnJvbSBkYXRhIG9iCiAgICAvLyBmcm96ZW4gb2JqZWN0IG1heSBub3QgaGF2ZSBvYnNlcnZlci4KCgogICAgaWYgKHZtLl9kYXRhLl9fb2JfXykgewogICAgICB2bS5fZGF0YS5fX29iX18udm1Db3VudC0tOwogICAgfSAvLyBjYWxsIHRoZSBsYXN0IGhvb2suLi4KCgogICAgdm0uX2lzRGVzdHJveWVkID0gdHJ1ZTsgLy8gaW52b2tlIGRlc3Ryb3kgaG9va3Mgb24gY3VycmVudCByZW5kZXJlZCB0cmVlCgogICAgdm0uX19wYXRjaF9fKHZtLl92bm9kZSwgbnVsbCk7IC8vIGZpcmUgZGVzdHJveWVkIGhvb2sKCgogICAgY2FsbEhvb2sodm0sICdkZXN0cm95ZWQnKTsgLy8gdHVybiBvZmYgYWxsIGluc3RhbmNlIGxpc3RlbmVycy4KCiAgICB2bS4kb2ZmKCk7IC8vIHJlbW92ZSBfX3Z1ZV9fIHJlZmVyZW5jZQoKICAgIGlmICh2bS4kZWwpIHsKICAgICAgdm0uJGVsLl9fdnVlX18gPSBudWxsOwogICAgfSAvLyByZWxlYXNlIGNpcmN1bGFyIHJlZmVyZW5jZSAoIzY3NTkpCgoKICAgIGlmICh2bS4kdm5vZGUpIHsKICAgICAgdm0uJHZub2RlLnBhcmVudCA9IG51bGw7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gbW91bnRDb21wb25lbnQodm0sIGVsLCBoeWRyYXRpbmcpIHsKICB2bS4kZWwgPSBlbDsKCiAgaWYgKCF2bS4kb3B0aW9ucy5yZW5kZXIpIHsKICAgIHZtLiRvcHRpb25zLnJlbmRlciA9IGNyZWF0ZUVtcHR5Vk5vZGU7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICh2bS4kb3B0aW9ucy50ZW1wbGF0ZSAmJiB2bS4kb3B0aW9ucy50ZW1wbGF0ZS5jaGFyQXQoMCkgIT09ICcjJyB8fCB2bS4kb3B0aW9ucy5lbCB8fCBlbCkgewogICAgICAgIHdhcm4oJ1lvdSBhcmUgdXNpbmcgdGhlIHJ1bnRpbWUtb25seSBidWlsZCBvZiBWdWUgd2hlcmUgdGhlIHRlbXBsYXRlICcgKyAnY29tcGlsZXIgaXMgbm90IGF2YWlsYWJsZS4gRWl0aGVyIHByZS1jb21waWxlIHRoZSB0ZW1wbGF0ZXMgaW50byAnICsgJ3JlbmRlciBmdW5jdGlvbnMsIG9yIHVzZSB0aGUgY29tcGlsZXItaW5jbHVkZWQgYnVpbGQuJywgdm0pOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oJ0ZhaWxlZCB0byBtb3VudCBjb21wb25lbnQ6IHRlbXBsYXRlIG9yIHJlbmRlciBmdW5jdGlvbiBub3QgZGVmaW5lZC4nLCB2bSk7CiAgICAgIH0KICAgIH0KICB9CgogIGNhbGxIb29rKHZtLCAnYmVmb3JlTW91bnQnKTsKICB2YXIgdXBkYXRlQ29tcG9uZW50OwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgdXBkYXRlQ29tcG9uZW50ID0gZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50KCkgewogICAgICB2YXIgbmFtZSA9IHZtLl9uYW1lOwogICAgICB2YXIgaWQgPSB2bS5fdWlkOwogICAgICB2YXIgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6IiArIGlkOwogICAgICB2YXIgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiICsgaWQ7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwoKICAgICAgdmFyIHZub2RlID0gdm0uX3JlbmRlcigpOwoKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIiArIG5hbWUgKyAiIHJlbmRlciIsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKCiAgICAgIHZtLl91cGRhdGUodm5vZGUsIGh5ZHJhdGluZyk7CgogICAgICBtYXJrKGVuZFRhZyk7CiAgICAgIG1lYXN1cmUoInZ1ZSAiICsgbmFtZSArICIgcGF0Y2giLCBzdGFydFRhZywgZW5kVGFnKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudCgpIHsKICAgICAgdm0uX3VwZGF0ZSh2bS5fcmVuZGVyKCksIGh5ZHJhdGluZyk7CiAgICB9OwogIH0gLy8gd2Ugc2V0IHRoaXMgdG8gdm0uX3dhdGNoZXIgaW5zaWRlIHRoZSB3YXRjaGVyJ3MgY29uc3RydWN0b3IKICAvLyBzaW5jZSB0aGUgd2F0Y2hlcidzIGluaXRpYWwgcGF0Y2ggbWF5IGNhbGwgJGZvcmNlVXBkYXRlIChlLmcuIGluc2lkZSBjaGlsZAogIC8vIGNvbXBvbmVudCdzIG1vdW50ZWQgaG9vayksIHdoaWNoIHJlbGllcyBvbiB2bS5fd2F0Y2hlciBiZWluZyBhbHJlYWR5IGRlZmluZWQKCgogIG5ldyBXYXRjaGVyKHZtLCB1cGRhdGVDb21wb25lbnQsIG5vb3AsIHsKICAgIGJlZm9yZTogZnVuY3Rpb24gYmVmb3JlKCkgewogICAgICBpZiAodm0uX2lzTW91bnRlZCAmJiAhdm0uX2lzRGVzdHJveWVkKSB7CiAgICAgICAgY2FsbEhvb2sodm0sICdiZWZvcmVVcGRhdGUnKTsKICAgICAgfQogICAgfQogIH0sIHRydWUKICAvKiBpc1JlbmRlcldhdGNoZXIgKi8KICApOwogIGh5ZHJhdGluZyA9IGZhbHNlOyAvLyBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlLCBjYWxsIG1vdW50ZWQgb24gc2VsZgogIC8vIG1vdW50ZWQgaXMgY2FsbGVkIGZvciByZW5kZXItY3JlYXRlZCBjaGlsZCBjb21wb25lbnRzIGluIGl0cyBpbnNlcnRlZCBob29rCgogIGlmICh2bS4kdm5vZGUgPT0gbnVsbCkgewogICAgdm0uX2lzTW91bnRlZCA9IHRydWU7CiAgICBjYWxsSG9vayh2bSwgJ21vdW50ZWQnKTsKICB9CgogIHJldHVybiB2bTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hpbGRDb21wb25lbnQodm0sIHByb3BzRGF0YSwgbGlzdGVuZXJzLCBwYXJlbnRWbm9kZSwgcmVuZGVyQ2hpbGRyZW4pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gdHJ1ZTsKICB9IC8vIGRldGVybWluZSB3aGV0aGVyIGNvbXBvbmVudCBoYXMgc2xvdCBjaGlsZHJlbgogIC8vIHdlIG5lZWQgdG8gZG8gdGhpcyBiZWZvcmUgb3ZlcndyaXRpbmcgJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuLgogIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBkeW5hbWljIHNjb3BlZFNsb3RzIChoYW5kLXdyaXR0ZW4gb3IgY29tcGlsZWQgYnV0IHdpdGgKICAvLyBkeW5hbWljIHNsb3QgbmFtZXMpLiBTdGF0aWMgc2NvcGVkIHNsb3RzIGNvbXBpbGVkIGZyb20gdGVtcGxhdGUgaGFzIHRoZQogIC8vICIkc3RhYmxlIiBtYXJrZXIuCgoKICB2YXIgbmV3U2NvcGVkU2xvdHMgPSBwYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzOwogIHZhciBvbGRTY29wZWRTbG90cyA9IHZtLiRzY29wZWRTbG90czsKICB2YXIgaGFzRHluYW1pY1Njb3BlZFNsb3QgPSAhIShuZXdTY29wZWRTbG90cyAmJiAhbmV3U2NvcGVkU2xvdHMuJHN0YWJsZSB8fCBvbGRTY29wZWRTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYgIW9sZFNjb3BlZFNsb3RzLiRzdGFibGUgfHwgbmV3U2NvcGVkU2xvdHMgJiYgdm0uJHNjb3BlZFNsb3RzLiRrZXkgIT09IG5ld1Njb3BlZFNsb3RzLiRrZXkgfHwgIW5ld1Njb3BlZFNsb3RzICYmIHZtLiRzY29wZWRTbG90cy4ka2V5KTsgLy8gQW55IHN0YXRpYyBzbG90IGNoaWxkcmVuIGZyb20gdGhlIHBhcmVudCBtYXkgaGF2ZSBjaGFuZ2VkIGR1cmluZyBwYXJlbnQncwogIC8vIHVwZGF0ZS4gRHluYW1pYyBzY29wZWQgc2xvdHMgbWF5IGFsc28gaGF2ZSBjaGFuZ2VkLiBJbiBzdWNoIGNhc2VzLCBhIGZvcmNlZAogIC8vIHVwZGF0ZSBpcyBuZWNlc3NhcnkgdG8gZW5zdXJlIGNvcnJlY3RuZXNzLgoKICB2YXIgbmVlZHNGb3JjZVVwZGF0ZSA9ICEhKHJlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBuZXcgc3RhdGljIHNsb3RzCiAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBvbGQgc3RhdGljIHNsb3RzCiAgaGFzRHluYW1pY1Njb3BlZFNsb3QpOwogIHZtLiRvcHRpb25zLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogIHZtLiR2bm9kZSA9IHBhcmVudFZub2RlOyAvLyB1cGRhdGUgdm0ncyBwbGFjZWhvbGRlciBub2RlIHdpdGhvdXQgcmUtcmVuZGVyCgogIGlmICh2bS5fdm5vZGUpIHsKICAgIC8vIHVwZGF0ZSBjaGlsZCB0cmVlJ3MgcGFyZW50CiAgICB2bS5fdm5vZGUucGFyZW50ID0gcGFyZW50Vm5vZGU7CiAgfQoKICB2bS4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4gPSByZW5kZXJDaGlsZHJlbjsgLy8gdXBkYXRlICRhdHRycyBhbmQgJGxpc3RlbmVycyBoYXNoCiAgLy8gdGhlc2UgYXJlIGFsc28gcmVhY3RpdmUgc28gdGhleSBtYXkgdHJpZ2dlciBjaGlsZCB1cGRhdGUgaWYgdGhlIGNoaWxkCiAgLy8gdXNlZCB0aGVtIGR1cmluZyByZW5kZXIKCiAgdm0uJGF0dHJzID0gcGFyZW50Vm5vZGUuZGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdDsKICB2bS4kbGlzdGVuZXJzID0gbGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0OyAvLyB1cGRhdGUgcHJvcHMKCiAgaWYgKHByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wcykgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICAgIHZhciBwcm9wcyA9IHZtLl9wcm9wczsKICAgIHZhciBwcm9wS2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyB8fCBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wS2V5c1tpXTsKICAgICAgdmFyIHByb3BPcHRpb25zID0gdm0uJG9wdGlvbnMucHJvcHM7IC8vIHd0ZiBmbG93PwoKICAgICAgcHJvcHNba2V5XSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgIH0KCiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7IC8vIGtlZXAgYSBjb3B5IG9mIHJhdyBwcm9wc0RhdGEKCiAgICB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgPSBwcm9wc0RhdGE7CiAgfSAvLyB1cGRhdGUgbGlzdGVuZXJzCgoKICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3Q7CiAgdmFyIG9sZExpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CiAgdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyA9IGxpc3RlbmVyczsKICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgb2xkTGlzdGVuZXJzKTsgLy8gcmVzb2x2ZSBzbG90cyArIGZvcmNlIHVwZGF0ZSBpZiBoYXMgY2hpbGRyZW4KCiAgaWYgKG5lZWRzRm9yY2VVcGRhdGUpIHsKICAgIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhyZW5kZXJDaGlsZHJlbiwgcGFyZW50Vm5vZGUuY29udGV4dCk7CiAgICB2bS4kZm9yY2VVcGRhdGUoKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSBmYWxzZTsKICB9Cn0KCmZ1bmN0aW9uIGlzSW5JbmFjdGl2ZVRyZWUodm0pIHsKICB3aGlsZSAodm0gJiYgKHZtID0gdm0uJHBhcmVudCkpIHsKICAgIGlmICh2bS5faW5hY3RpdmUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQoKICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0sIGRpcmVjdCkgewogIGlmIChkaXJlY3QpIHsKICAgIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IGZhbHNlOwoKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfSBlbHNlIGlmICh2bS5fZGlyZWN0SW5hY3RpdmUpIHsKICAgIHJldHVybjsKICB9CgogIGlmICh2bS5faW5hY3RpdmUgfHwgdm0uX2luYWN0aXZlID09PSBudWxsKSB7CiAgICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CgogICAgY2FsbEhvb2sodm0sICdhY3RpdmF0ZWQnKTsKICB9Cn0KCmZ1bmN0aW9uIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bSwgZGlyZWN0KSB7CiAgaWYgKGRpcmVjdCkgewogICAgdm0uX2RpcmVjdEluYWN0aXZlID0gdHJ1ZTsKCiAgICBpZiAoaXNJbkluYWN0aXZlVHJlZSh2bSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogIH0KCiAgaWYgKCF2bS5faW5hY3RpdmUpIHsKICAgIHZtLl9pbmFjdGl2ZSA9IHRydWU7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bS4kY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CgogICAgY2FsbEhvb2sodm0sICdkZWFjdGl2YXRlZCcpOwogIH0KfQoKZnVuY3Rpb24gY2FsbEhvb2sodm0sIGhvb2spIHsKICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgbGlmZWN5Y2xlIGhvb2tzCiAgcHVzaFRhcmdldCgpOwogIHZhciBoYW5kbGVycyA9IHZtLiRvcHRpb25zW2hvb2tdOwogIHZhciBpbmZvID0gaG9vayArICIgaG9vayI7CgogIGlmIChoYW5kbGVycykgewogICAgZm9yICh2YXIgaSA9IDAsIGogPSBoYW5kbGVycy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoaGFuZGxlcnNbaV0sIHZtLCBudWxsLCB2bSwgaW5mbyk7CiAgICB9CiAgfQoKICBpZiAodm0uX2hhc0hvb2tFdmVudCkgewogICAgdm0uJGVtaXQoJ2hvb2s6JyArIGhvb2spOwogIH0KCiAgcG9wVGFyZ2V0KCk7Cn0KLyogICovCgoKdmFyIE1BWF9VUERBVEVfQ09VTlQgPSAxMDA7CnZhciBxdWV1ZSA9IFtdOwp2YXIgYWN0aXZhdGVkQ2hpbGRyZW4gPSBbXTsKdmFyIGhhcyA9IHt9Owp2YXIgY2lyY3VsYXIgPSB7fTsKdmFyIHdhaXRpbmcgPSBmYWxzZTsKdmFyIGZsdXNoaW5nID0gZmFsc2U7CnZhciBpbmRleCA9IDA7Ci8qKgogKiBSZXNldCB0aGUgc2NoZWR1bGVyJ3Mgc3RhdGUuCiAqLwoKZnVuY3Rpb24gcmVzZXRTY2hlZHVsZXJTdGF0ZSgpIHsKICBpbmRleCA9IHF1ZXVlLmxlbmd0aCA9IGFjdGl2YXRlZENoaWxkcmVuLmxlbmd0aCA9IDA7CiAgaGFzID0ge307CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjaXJjdWxhciA9IHt9OwogIH0KCiAgd2FpdGluZyA9IGZsdXNoaW5nID0gZmFsc2U7Cn0gLy8gQXN5bmMgZWRnZSBjYXNlICM2NTY2IHJlcXVpcmVzIHNhdmluZyB0aGUgdGltZXN0YW1wIHdoZW4gZXZlbnQgbGlzdGVuZXJzIGFyZQovLyBhdHRhY2hlZC4gSG93ZXZlciwgY2FsbGluZyBwZXJmb3JtYW5jZS5ub3coKSBoYXMgYSBwZXJmIG92ZXJoZWFkIGVzcGVjaWFsbHkKLy8gaWYgdGhlIHBhZ2UgaGFzIHRob3VzYW5kcyBvZiBldmVudCBsaXN0ZW5lcnMuIEluc3RlYWQsIHdlIHRha2UgYSB0aW1lc3RhbXAKLy8gZXZlcnkgdGltZSB0aGUgc2NoZWR1bGVyIGZsdXNoZXMgYW5kIHVzZSB0aGF0IGZvciBhbGwgZXZlbnQgbGlzdGVuZXJzCi8vIGF0dGFjaGVkIGR1cmluZyB0aGF0IGZsdXNoLgoKCnZhciBjdXJyZW50Rmx1c2hUaW1lc3RhbXAgPSAwOyAvLyBBc3luYyBlZGdlIGNhc2UgZml4IHJlcXVpcmVzIHN0b3JpbmcgYW4gZXZlbnQgbGlzdGVuZXIncyBhdHRhY2ggdGltZXN0YW1wLgoKdmFyIGdldE5vdyA9IERhdGUubm93OyAvLyBEZXRlcm1pbmUgd2hhdCBldmVudCB0aW1lc3RhbXAgdGhlIGJyb3dzZXIgaXMgdXNpbmcuIEFubm95aW5nbHksIHRoZQovLyB0aW1lc3RhbXAgY2FuIGVpdGhlciBiZSBoaS1yZXMgKHJlbGF0aXZlIHRvIHBhZ2UgbG9hZCkgb3IgbG93LXJlcwovLyAocmVsYXRpdmUgdG8gVU5JWCBlcG9jaCksIHNvIGluIG9yZGVyIHRvIGNvbXBhcmUgdGltZSB3ZSBoYXZlIHRvIHVzZSB0aGUKLy8gc2FtZSB0aW1lc3RhbXAgdHlwZSB3aGVuIHNhdmluZyB0aGUgZmx1c2ggdGltZXN0YW1wLgovLyBBbGwgSUUgdmVyc2lvbnMgdXNlIGxvdy1yZXMgZXZlbnQgdGltZXN0YW1wcywgYW5kIGhhdmUgcHJvYmxlbWF0aWMgY2xvY2sKLy8gaW1wbGVtZW50YXRpb25zICgjOTYzMikKCmlmIChpbkJyb3dzZXIgJiYgIWlzSUUpIHsKICB2YXIgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2U7CgogIGlmIChwZXJmb3JtYW5jZSAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nICYmIGdldE5vdygpID4gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50JykudGltZVN0YW1wKSB7CiAgICAvLyBpZiB0aGUgZXZlbnQgdGltZXN0YW1wLCBhbHRob3VnaCBldmFsdWF0ZWQgQUZURVIgdGhlIERhdGUubm93KCksIGlzCiAgICAvLyBzbWFsbGVyIHRoYW4gaXQsIGl0IG1lYW5zIHRoZSBldmVudCBpcyB1c2luZyBhIGhpLXJlcyB0aW1lc3RhbXAsCiAgICAvLyBhbmQgd2UgbmVlZCB0byB1c2UgdGhlIGhpLXJlcyB2ZXJzaW9uIGZvciBldmVudCBsaXN0ZW5lciB0aW1lc3RhbXBzIGFzCiAgICAvLyB3ZWxsLgogICAgZ2V0Tm93ID0gZnVuY3Rpb24gZ2V0Tm93KCkgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9OwogIH0KfQovKioKICogRmx1c2ggYm90aCBxdWV1ZXMgYW5kIHJ1biB0aGUgd2F0Y2hlcnMuCiAqLwoKCmZ1bmN0aW9uIGZsdXNoU2NoZWR1bGVyUXVldWUoKSB7CiAgY3VycmVudEZsdXNoVGltZXN0YW1wID0gZ2V0Tm93KCk7CiAgZmx1c2hpbmcgPSB0cnVlOwogIHZhciB3YXRjaGVyLCBpZDsgLy8gU29ydCBxdWV1ZSBiZWZvcmUgZmx1c2guCiAgLy8gVGhpcyBlbnN1cmVzIHRoYXQ6CiAgLy8gMS4gQ29tcG9uZW50cyBhcmUgdXBkYXRlZCBmcm9tIHBhcmVudCB0byBjaGlsZC4gKGJlY2F1c2UgcGFyZW50IGlzIGFsd2F5cwogIC8vICAgIGNyZWF0ZWQgYmVmb3JlIHRoZSBjaGlsZCkKICAvLyAyLiBBIGNvbXBvbmVudCdzIHVzZXIgd2F0Y2hlcnMgYXJlIHJ1biBiZWZvcmUgaXRzIHJlbmRlciB3YXRjaGVyIChiZWNhdXNlCiAgLy8gICAgdXNlciB3YXRjaGVycyBhcmUgY3JlYXRlZCBiZWZvcmUgdGhlIHJlbmRlciB3YXRjaGVyKQogIC8vIDMuIElmIGEgY29tcG9uZW50IGlzIGRlc3Ryb3llZCBkdXJpbmcgYSBwYXJlbnQgY29tcG9uZW50J3Mgd2F0Y2hlciBydW4sCiAgLy8gICAgaXRzIHdhdGNoZXJzIGNhbiBiZSBza2lwcGVkLgoKICBxdWV1ZS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gYS5pZCAtIGIuaWQ7CiAgfSk7IC8vIGRvIG5vdCBjYWNoZSBsZW5ndGggYmVjYXVzZSBtb3JlIHdhdGNoZXJzIG1pZ2h0IGJlIHB1c2hlZAogIC8vIGFzIHdlIHJ1biBleGlzdGluZyB3YXRjaGVycwoKICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBxdWV1ZS5sZW5ndGg7IGluZGV4KyspIHsKICAgIHdhdGNoZXIgPSBxdWV1ZVtpbmRleF07CgogICAgaWYgKHdhdGNoZXIuYmVmb3JlKSB7CiAgICAgIHdhdGNoZXIuYmVmb3JlKCk7CiAgICB9CgogICAgaWQgPSB3YXRjaGVyLmlkOwogICAgaGFzW2lkXSA9IG51bGw7CiAgICB3YXRjaGVyLnJ1bigpOyAvLyBpbiBkZXYgYnVpbGQsIGNoZWNrIGFuZCBzdG9wIGNpcmN1bGFyIHVwZGF0ZXMuCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaGFzW2lkXSAhPSBudWxsKSB7CiAgICAgIGNpcmN1bGFyW2lkXSA9IChjaXJjdWxhcltpZF0gfHwgMCkgKyAxOwoKICAgICAgaWYgKGNpcmN1bGFyW2lkXSA+IE1BWF9VUERBVEVfQ09VTlQpIHsKICAgICAgICB3YXJuKCdZb3UgbWF5IGhhdmUgYW4gaW5maW5pdGUgdXBkYXRlIGxvb3AgJyArICh3YXRjaGVyLnVzZXIgPyAiaW4gd2F0Y2hlciB3aXRoIGV4cHJlc3Npb24gXCIiICsgd2F0Y2hlci5leHByZXNzaW9uICsgIlwiIiA6ICJpbiBhIGNvbXBvbmVudCByZW5kZXIgZnVuY3Rpb24uIiksIHdhdGNoZXIudm0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSAvLyBrZWVwIGNvcGllcyBvZiBwb3N0IHF1ZXVlcyBiZWZvcmUgcmVzZXR0aW5nIHN0YXRlCgoKICB2YXIgYWN0aXZhdGVkUXVldWUgPSBhY3RpdmF0ZWRDaGlsZHJlbi5zbGljZSgpOwogIHZhciB1cGRhdGVkUXVldWUgPSBxdWV1ZS5zbGljZSgpOwogIHJlc2V0U2NoZWR1bGVyU3RhdGUoKTsgLy8gY2FsbCBjb21wb25lbnQgdXBkYXRlZCBhbmQgYWN0aXZhdGVkIGhvb2tzCgogIGNhbGxBY3RpdmF0ZWRIb29rcyhhY3RpdmF0ZWRRdWV1ZSk7CiAgY2FsbFVwZGF0ZWRIb29rcyh1cGRhdGVkUXVldWUpOyAvLyBkZXZ0b29sIGhvb2sKCiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChkZXZ0b29scyAmJiBjb25maWcuZGV2dG9vbHMpIHsKICAgIGRldnRvb2xzLmVtaXQoJ2ZsdXNoJyk7CiAgfQp9CgpmdW5jdGlvbiBjYWxsVXBkYXRlZEhvb2tzKHF1ZXVlKSB7CiAgdmFyIGkgPSBxdWV1ZS5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciB3YXRjaGVyID0gcXVldWVbaV07CiAgICB2YXIgdm0gPSB3YXRjaGVyLnZtOwoKICAgIGlmICh2bS5fd2F0Y2hlciA9PT0gd2F0Y2hlciAmJiB2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgY2FsbEhvb2sodm0sICd1cGRhdGVkJyk7CiAgICB9CiAgfQp9Ci8qKgogKiBRdWV1ZSBhIGtlcHQtYWxpdmUgY29tcG9uZW50IHRoYXQgd2FzIGFjdGl2YXRlZCBkdXJpbmcgcGF0Y2guCiAqIFRoZSBxdWV1ZSB3aWxsIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgZW50aXJlIHRyZWUgaGFzIGJlZW4gcGF0Y2hlZC4KICovCgoKZnVuY3Rpb24gcXVldWVBY3RpdmF0ZWRDb21wb25lbnQodm0pIHsKICAvLyBzZXR0aW5nIF9pbmFjdGl2ZSB0byBmYWxzZSBoZXJlIHNvIHRoYXQgYSByZW5kZXIgZnVuY3Rpb24gY2FuCiAgLy8gcmVseSBvbiBjaGVja2luZyB3aGV0aGVyIGl0J3MgaW4gYW4gaW5hY3RpdmUgdHJlZSAoZS5nLiByb3V0ZXItdmlldykKICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKICBhY3RpdmF0ZWRDaGlsZHJlbi5wdXNoKHZtKTsKfQoKZnVuY3Rpb24gY2FsbEFjdGl2YXRlZEhvb2tzKHF1ZXVlKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgcXVldWVbaV0uX2luYWN0aXZlID0gdHJ1ZTsKICAgIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQocXVldWVbaV0sIHRydWUKICAgIC8qIHRydWUgKi8KICAgICk7CiAgfQp9Ci8qKgogKiBQdXNoIGEgd2F0Y2hlciBpbnRvIHRoZSB3YXRjaGVyIHF1ZXVlLgogKiBKb2JzIHdpdGggZHVwbGljYXRlIElEcyB3aWxsIGJlIHNraXBwZWQgdW5sZXNzIGl0J3MKICogcHVzaGVkIHdoZW4gdGhlIHF1ZXVlIGlzIGJlaW5nIGZsdXNoZWQuCiAqLwoKCmZ1bmN0aW9uIHF1ZXVlV2F0Y2hlcih3YXRjaGVyKSB7CiAgdmFyIGlkID0gd2F0Y2hlci5pZDsKCiAgaWYgKGhhc1tpZF0gPT0gbnVsbCkgewogICAgaGFzW2lkXSA9IHRydWU7CgogICAgaWYgKCFmbHVzaGluZykgewogICAgICBxdWV1ZS5wdXNoKHdhdGNoZXIpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYWxyZWFkeSBmbHVzaGluZywgc3BsaWNlIHRoZSB3YXRjaGVyIGJhc2VkIG9uIGl0cyBpZAogICAgICAvLyBpZiBhbHJlYWR5IHBhc3QgaXRzIGlkLCBpdCB3aWxsIGJlIHJ1biBuZXh0IGltbWVkaWF0ZWx5LgogICAgICB2YXIgaSA9IHF1ZXVlLmxlbmd0aCAtIDE7CgogICAgICB3aGlsZSAoaSA+IGluZGV4ICYmIHF1ZXVlW2ldLmlkID4gd2F0Y2hlci5pZCkgewogICAgICAgIGktLTsKICAgICAgfQoKICAgICAgcXVldWUuc3BsaWNlKGkgKyAxLCAwLCB3YXRjaGVyKTsKICAgIH0gLy8gcXVldWUgdGhlIGZsdXNoCgoKICAgIGlmICghd2FpdGluZykgewogICAgICB3YWl0aW5nID0gdHJ1ZTsKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb25maWcuYXN5bmMpIHsKICAgICAgICBmbHVzaFNjaGVkdWxlclF1ZXVlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBuZXh0VGljayhmbHVzaFNjaGVkdWxlclF1ZXVlKTsKICAgIH0KICB9Cn0KLyogICovCgoKdmFyIHVpZCQyID0gMDsKLyoqCiAqIEEgd2F0Y2hlciBwYXJzZXMgYW4gZXhwcmVzc2lvbiwgY29sbGVjdHMgZGVwZW5kZW5jaWVzLAogKiBhbmQgZmlyZXMgY2FsbGJhY2sgd2hlbiB0aGUgZXhwcmVzc2lvbiB2YWx1ZSBjaGFuZ2VzLgogKiBUaGlzIGlzIHVzZWQgZm9yIGJvdGggdGhlICR3YXRjaCgpIGFwaSBhbmQgZGlyZWN0aXZlcy4KICovCgp2YXIgV2F0Y2hlciA9IGZ1bmN0aW9uIFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zLCBpc1JlbmRlcldhdGNoZXIpIHsKICB0aGlzLnZtID0gdm07CgogIGlmIChpc1JlbmRlcldhdGNoZXIpIHsKICAgIHZtLl93YXRjaGVyID0gdGhpczsKICB9CgogIHZtLl93YXRjaGVycy5wdXNoKHRoaXMpOyAvLyBvcHRpb25zCgoKICBpZiAob3B0aW9ucykgewogICAgdGhpcy5kZWVwID0gISFvcHRpb25zLmRlZXA7CiAgICB0aGlzLnVzZXIgPSAhIW9wdGlvbnMudXNlcjsKICAgIHRoaXMubGF6eSA9ICEhb3B0aW9ucy5sYXp5OwogICAgdGhpcy5zeW5jID0gISFvcHRpb25zLnN5bmM7CiAgICB0aGlzLmJlZm9yZSA9IG9wdGlvbnMuYmVmb3JlOwogIH0gZWxzZSB7CiAgICB0aGlzLmRlZXAgPSB0aGlzLnVzZXIgPSB0aGlzLmxhenkgPSB0aGlzLnN5bmMgPSBmYWxzZTsKICB9CgogIHRoaXMuY2IgPSBjYjsKICB0aGlzLmlkID0gKyt1aWQkMjsgLy8gdWlkIGZvciBiYXRjaGluZwoKICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgdGhpcy5kaXJ0eSA9IHRoaXMubGF6eTsgLy8gZm9yIGxhenkgd2F0Y2hlcnMKCiAgdGhpcy5kZXBzID0gW107CiAgdGhpcy5uZXdEZXBzID0gW107CiAgdGhpcy5kZXBJZHMgPSBuZXcgX1NldCgpOwogIHRoaXMubmV3RGVwSWRzID0gbmV3IF9TZXQoKTsKICB0aGlzLmV4cHJlc3Npb24gPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gZXhwT3JGbi50b1N0cmluZygpIDogJyc7IC8vIHBhcnNlIGV4cHJlc3Npb24gZm9yIGdldHRlcgoKICBpZiAodHlwZW9mIGV4cE9yRm4gPT09ICdmdW5jdGlvbicpIHsKICAgIHRoaXMuZ2V0dGVyID0gZXhwT3JGbjsKICB9IGVsc2UgewogICAgdGhpcy5nZXR0ZXIgPSBwYXJzZVBhdGgoZXhwT3JGbik7CgogICAgaWYgKCF0aGlzLmdldHRlcikgewogICAgICB0aGlzLmdldHRlciA9IG5vb3A7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiRmFpbGVkIHdhdGNoaW5nIHBhdGg6IFwiIiArIGV4cE9yRm4gKyAiXCIgIiArICdXYXRjaGVyIG9ubHkgYWNjZXB0cyBzaW1wbGUgZG90LWRlbGltaXRlZCBwYXRocy4gJyArICdGb3IgZnVsbCBjb250cm9sLCB1c2UgYSBmdW5jdGlvbiBpbnN0ZWFkLicsIHZtKTsKICAgIH0KICB9CgogIHRoaXMudmFsdWUgPSB0aGlzLmxhenkgPyB1bmRlZmluZWQgOiB0aGlzLmdldCgpOwp9OwovKioKICogRXZhbHVhdGUgdGhlIGdldHRlciwgYW5kIHJlLWNvbGxlY3QgZGVwZW5kZW5jaWVzLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoKSB7CiAgcHVzaFRhcmdldCh0aGlzKTsKICB2YXIgdmFsdWU7CiAgdmFyIHZtID0gdGhpcy52bTsKCiAgdHJ5IHsKICAgIHZhbHVlID0gdGhpcy5nZXR0ZXIuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJnZXR0ZXIgZm9yIHdhdGNoZXIgXCIiICsgdGhpcy5leHByZXNzaW9uICsgIlwiIik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlOwogICAgfQogIH0gZmluYWxseSB7CiAgICAvLyAidG91Y2giIGV2ZXJ5IHByb3BlcnR5IHNvIHRoZXkgYXJlIGFsbCB0cmFja2VkIGFzCiAgICAvLyBkZXBlbmRlbmNpZXMgZm9yIGRlZXAgd2F0Y2hpbmcKICAgIGlmICh0aGlzLmRlZXApIHsKICAgICAgdHJhdmVyc2UodmFsdWUpOwogICAgfQoKICAgIHBvcFRhcmdldCgpOwogICAgdGhpcy5jbGVhbnVwRGVwcygpOwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwovKioKICogQWRkIGEgZGVwZW5kZW5jeSB0byB0aGlzIGRpcmVjdGl2ZS4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuYWRkRGVwID0gZnVuY3Rpb24gYWRkRGVwKGRlcCkgewogIHZhciBpZCA9IGRlcC5pZDsKCiAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoaWQpKSB7CiAgICB0aGlzLm5ld0RlcElkcy5hZGQoaWQpOwogICAgdGhpcy5uZXdEZXBzLnB1c2goZGVwKTsKCiAgICBpZiAoIXRoaXMuZGVwSWRzLmhhcyhpZCkpIHsKICAgICAgZGVwLmFkZFN1Yih0aGlzKTsKICAgIH0KICB9Cn07Ci8qKgogKiBDbGVhbiB1cCBmb3IgZGVwZW5kZW5jeSBjb2xsZWN0aW9uLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5jbGVhbnVwRGVwcyA9IGZ1bmN0aW9uIGNsZWFudXBEZXBzKCkgewogIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdmFyIGRlcCA9IHRoaXMuZGVwc1tpXTsKCiAgICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhkZXAuaWQpKSB7CiAgICAgIGRlcC5yZW1vdmVTdWIodGhpcyk7CiAgICB9CiAgfQoKICB2YXIgdG1wID0gdGhpcy5kZXBJZHM7CiAgdGhpcy5kZXBJZHMgPSB0aGlzLm5ld0RlcElkczsKICB0aGlzLm5ld0RlcElkcyA9IHRtcDsKICB0aGlzLm5ld0RlcElkcy5jbGVhcigpOwogIHRtcCA9IHRoaXMuZGVwczsKICB0aGlzLmRlcHMgPSB0aGlzLm5ld0RlcHM7CiAgdGhpcy5uZXdEZXBzID0gdG1wOwogIHRoaXMubmV3RGVwcy5sZW5ndGggPSAwOwp9OwovKioKICogU3Vic2NyaWJlciBpbnRlcmZhY2UuCiAqIFdpbGwgYmUgY2FsbGVkIHdoZW4gYSBkZXBlbmRlbmN5IGNoYW5nZXMuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogIGlmICh0aGlzLmxhenkpIHsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwogIH0gZWxzZSBpZiAodGhpcy5zeW5jKSB7CiAgICB0aGlzLnJ1bigpOwogIH0gZWxzZSB7CiAgICBxdWV1ZVdhdGNoZXIodGhpcyk7CiAgfQp9OwovKioKICogU2NoZWR1bGVyIGpvYiBpbnRlcmZhY2UuCiAqIFdpbGwgYmUgY2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIHJ1bigpIHsKICBpZiAodGhpcy5hY3RpdmUpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CgogICAgaWYgKHZhbHVlICE9PSB0aGlzLnZhbHVlIHx8IC8vIERlZXAgd2F0Y2hlcnMgYW5kIHdhdGNoZXJzIG9uIE9iamVjdC9BcnJheXMgc2hvdWxkIGZpcmUgZXZlbgogICAgLy8gd2hlbiB0aGUgdmFsdWUgaXMgdGhlIHNhbWUsIGJlY2F1c2UgdGhlIHZhbHVlIG1heQogICAgLy8gaGF2ZSBtdXRhdGVkLgogICAgaXNPYmplY3QodmFsdWUpIHx8IHRoaXMuZGVlcCkgewogICAgICAvLyBzZXQgbmV3IHZhbHVlCiAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMudmFsdWU7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCiAgICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgICB2YXIgaW5mbyA9ICJjYWxsYmFjayBmb3Igd2F0Y2hlciBcIiIgKyB0aGlzLmV4cHJlc3Npb24gKyAiXCIiOwogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKHRoaXMuY2IsIHRoaXMudm0sIFt2YWx1ZSwgb2xkVmFsdWVdLCB0aGlzLnZtLCBpbmZvKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNiLmNhbGwodGhpcy52bSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgfQogICAgfQogIH0KfTsKLyoqCiAqIEV2YWx1YXRlIHRoZSB2YWx1ZSBvZiB0aGUgd2F0Y2hlci4KICogVGhpcyBvbmx5IGdldHMgY2FsbGVkIGZvciBsYXp5IHdhdGNoZXJzLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogIHRoaXMudmFsdWUgPSB0aGlzLmdldCgpOwogIHRoaXMuZGlydHkgPSBmYWxzZTsKfTsKLyoqCiAqIERlcGVuZCBvbiBhbGwgZGVwcyBjb2xsZWN0ZWQgYnkgdGhpcyB3YXRjaGVyLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiBkZXBlbmQoKSB7CiAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICB0aGlzLmRlcHNbaV0uZGVwZW5kKCk7CiAgfQp9OwovKioKICogUmVtb3ZlIHNlbGYgZnJvbSBhbGwgZGVwZW5kZW5jaWVzJyBzdWJzY3JpYmVyIGxpc3QuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gdGVhcmRvd24oKSB7CiAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAvLyByZW1vdmUgc2VsZiBmcm9tIHZtJ3Mgd2F0Y2hlciBsaXN0CiAgICAvLyB0aGlzIGlzIGEgc29tZXdoYXQgZXhwZW5zaXZlIG9wZXJhdGlvbiBzbyB3ZSBza2lwIGl0CiAgICAvLyBpZiB0aGUgdm0gaXMgYmVpbmcgZGVzdHJveWVkLgogICAgaWYgKCF0aGlzLnZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgIHJlbW92ZSh0aGlzLnZtLl93YXRjaGVycywgdGhpcyk7CiAgICB9CgogICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdGhpcy5kZXBzW2ldLnJlbW92ZVN1Yih0aGlzKTsKICAgIH0KCiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogIH0KfTsKLyogICovCgoKdmFyIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbiA9IHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICBnZXQ6IG5vb3AsCiAgc2V0OiBub29wCn07CgpmdW5jdGlvbiBwcm94eSh0YXJnZXQsIHNvdXJjZUtleSwga2V5KSB7CiAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IGZ1bmN0aW9uIHByb3h5R2V0dGVyKCkgewogICAgcmV0dXJuIHRoaXNbc291cmNlS2V5XVtrZXldOwogIH07CgogIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBmdW5jdGlvbiBwcm94eVNldHRlcih2YWwpIHsKICAgIHRoaXNbc291cmNlS2V5XVtrZXldID0gdmFsOwogIH07CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uKTsKfQoKZnVuY3Rpb24gaW5pdFN0YXRlKHZtKSB7CiAgdm0uX3dhdGNoZXJzID0gW107CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9uczsKCiAgaWYgKG9wdHMucHJvcHMpIHsKICAgIGluaXRQcm9wcyh2bSwgb3B0cy5wcm9wcyk7CiAgfQoKICBpZiAob3B0cy5tZXRob2RzKSB7CiAgICBpbml0TWV0aG9kcyh2bSwgb3B0cy5tZXRob2RzKTsKICB9CgogIGlmIChvcHRzLmRhdGEpIHsKICAgIGluaXREYXRhKHZtKTsKICB9IGVsc2UgewogICAgb2JzZXJ2ZSh2bS5fZGF0YSA9IHt9LCB0cnVlCiAgICAvKiBhc1Jvb3REYXRhICovCiAgICApOwogIH0KCiAgaWYgKG9wdHMuY29tcHV0ZWQpIHsKICAgIGluaXRDb21wdXRlZCh2bSwgb3B0cy5jb21wdXRlZCk7CiAgfQoKICBpZiAob3B0cy53YXRjaCAmJiBvcHRzLndhdGNoICE9PSBuYXRpdmVXYXRjaCkgewogICAgaW5pdFdhdGNoKHZtLCBvcHRzLndhdGNoKTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRQcm9wcyh2bSwgcHJvcHNPcHRpb25zKSB7CiAgdmFyIHByb3BzRGF0YSA9IHZtLiRvcHRpb25zLnByb3BzRGF0YSB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bS5fcHJvcHMgPSB7fTsgLy8gY2FjaGUgcHJvcCBrZXlzIHNvIHRoYXQgZnV0dXJlIHByb3BzIHVwZGF0ZXMgY2FuIGl0ZXJhdGUgdXNpbmcgQXJyYXkKICAvLyBpbnN0ZWFkIG9mIGR5bmFtaWMgb2JqZWN0IGtleSBlbnVtZXJhdGlvbi4KCiAgdmFyIGtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgPSBbXTsKICB2YXIgaXNSb290ID0gIXZtLiRwYXJlbnQ7IC8vIHJvb3QgaW5zdGFuY2UgcHJvcHMgc2hvdWxkIGJlIGNvbnZlcnRlZAoKICBpZiAoIWlzUm9vdCkgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICB9CgogIHZhciBsb29wID0gZnVuY3Rpb24gbG9vcChrZXkpIHsKICAgIGtleXMucHVzaChrZXkpOwogICAgdmFyIHZhbHVlID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcHNPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgIGlmIChpc1Jlc2VydmVkQXR0cmlidXRlKGh5cGhlbmF0ZWRLZXkpIHx8IGNvbmZpZy5pc1Jlc2VydmVkQXR0cihoeXBoZW5hdGVkS2V5KSkgewogICAgICAgIHdhcm4oIlwiIiArIGh5cGhlbmF0ZWRLZXkgKyAiXCIgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUgYW5kIGNhbm5vdCBiZSB1c2VkIGFzIGNvbXBvbmVudCBwcm9wLiIsIHZtKTsKICAgICAgfQoKICAgICAgZGVmaW5lUmVhY3RpdmUkJDEocHJvcHMsIGtleSwgdmFsdWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWlzUm9vdCAmJiAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50KSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhIHByb3AgZGlyZWN0bHkgc2luY2UgdGhlIHZhbHVlIHdpbGwgYmUgIiArICJvdmVyd3JpdHRlbiB3aGVuZXZlciB0aGUgcGFyZW50IGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgIkluc3RlYWQsIHVzZSBhIGRhdGEgb3IgY29tcHV0ZWQgcHJvcGVydHkgYmFzZWQgb24gdGhlIHByb3AncyAiICsgInZhbHVlLiBQcm9wIGJlaW5nIG11dGF0ZWQ6IFwiIiArIGtleSArICJcIiIsIHZtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZGVmaW5lUmVhY3RpdmUkJDEocHJvcHMsIGtleSwgdmFsdWUpOwogICAgfSAvLyBzdGF0aWMgcHJvcHMgYXJlIGFscmVhZHkgcHJveGllZCBvbiB0aGUgY29tcG9uZW50J3MgcHJvdG90eXBlCiAgICAvLyBkdXJpbmcgVnVlLmV4dGVuZCgpLiBXZSBvbmx5IG5lZWQgdG8gcHJveHkgcHJvcHMgZGVmaW5lZCBhdAogICAgLy8gaW5zdGFudGlhdGlvbiBoZXJlLgoKCiAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgIHByb3h5KHZtLCAiX3Byb3BzIiwga2V5KTsKICAgIH0KICB9OwoKICBmb3IgKHZhciBrZXkgaW4gcHJvcHNPcHRpb25zKSB7CiAgICBsb29wKGtleSk7CiAgfQoKICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhKHZtKSB7CiAgdmFyIGRhdGEgPSB2bS4kb3B0aW9ucy5kYXRhOwogIGRhdGEgPSB2bS5fZGF0YSA9IHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nID8gZ2V0RGF0YShkYXRhLCB2bSkgOiBkYXRhIHx8IHt9OwoKICBpZiAoIWlzUGxhaW5PYmplY3QoZGF0YSkpIHsKICAgIGRhdGEgPSB7fTsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignZGF0YSBmdW5jdGlvbnMgc2hvdWxkIHJldHVybiBhbiBvYmplY3Q6XG4nICsgJ2h0dHBzOi8vdnVlanMub3JnL3YyL2d1aWRlL2NvbXBvbmVudHMuaHRtbCNkYXRhLU11c3QtQmUtYS1GdW5jdGlvbicsIHZtKTsKICB9IC8vIHByb3h5IGRhdGEgb24gaW5zdGFuY2UKCgogIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZGF0YSk7CiAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CiAgdmFyIG1ldGhvZHMgPSB2bS4kb3B0aW9ucy5tZXRob2RzOwogIHZhciBpID0ga2V5cy5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChtZXRob2RzICYmIGhhc093bihtZXRob2RzLCBrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBkYXRhIHByb3BlcnR5LiIsIHZtKTsKICAgICAgfQogICAgfQoKICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJUaGUgZGF0YSBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgaXMgYWxyZWFkeSBkZWNsYXJlZCBhcyBhIHByb3AuICIgKyAiVXNlIHByb3AgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkLiIsIHZtKTsKICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICBwcm94eSh2bSwgIl9kYXRhIiwga2V5KTsKICAgIH0KICB9IC8vIG9ic2VydmUgZGF0YQoKCiAgb2JzZXJ2ZShkYXRhLCB0cnVlCiAgLyogYXNSb290RGF0YSAqLwogICk7Cn0KCmZ1bmN0aW9uIGdldERhdGEoZGF0YSwgdm0pIHsKICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgZGF0YSBnZXR0ZXJzCiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgcmV0dXJuIGRhdGEuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZGF0YSgpIik7CiAgICByZXR1cm4ge307CiAgfSBmaW5hbGx5IHsKICAgIHBvcFRhcmdldCgpOwogIH0KfQoKdmFyIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMgPSB7CiAgbGF6eTogdHJ1ZQp9OwoKZnVuY3Rpb24gaW5pdENvbXB1dGVkKHZtLCBjb21wdXRlZCkgewogIC8vICRmbG93LWRpc2FibGUtbGluZQogIHZhciB3YXRjaGVycyA9IHZtLl9jb21wdXRlZFdhdGNoZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsgLy8gY29tcHV0ZWQgcHJvcGVydGllcyBhcmUganVzdCBnZXR0ZXJzIGR1cmluZyBTU1IKCiAgdmFyIGlzU1NSID0gaXNTZXJ2ZXJSZW5kZXJpbmcoKTsKCiAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICB2YXIgdXNlckRlZiA9IGNvbXB1dGVkW2tleV07CiAgICB2YXIgZ2V0dGVyID0gdHlwZW9mIHVzZXJEZWYgPT09ICdmdW5jdGlvbicgPyB1c2VyRGVmIDogdXNlckRlZi5nZXQ7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgZ2V0dGVyID09IG51bGwpIHsKICAgICAgd2FybigiR2V0dGVyIGlzIG1pc3NpbmcgZm9yIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIi4iLCB2bSk7CiAgICB9CgogICAgaWYgKCFpc1NTUikgewogICAgICAvLyBjcmVhdGUgaW50ZXJuYWwgd2F0Y2hlciBmb3IgdGhlIGNvbXB1dGVkIHByb3BlcnR5LgogICAgICB3YXRjaGVyc1trZXldID0gbmV3IFdhdGNoZXIodm0sIGdldHRlciB8fCBub29wLCBub29wLCBjb21wdXRlZFdhdGNoZXJPcHRpb25zKTsKICAgIH0gLy8gY29tcG9uZW50LWRlZmluZWQgY29tcHV0ZWQgcHJvcGVydGllcyBhcmUgYWxyZWFkeSBkZWZpbmVkIG9uIHRoZQogICAgLy8gY29tcG9uZW50IHByb3RvdHlwZS4gV2Ugb25seSBuZWVkIHRvIGRlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGRlZmluZWQKICAgIC8vIGF0IGluc3RhbnRpYXRpb24gaGVyZS4KCgogICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICBkZWZpbmVDb21wdXRlZCh2bSwga2V5LCB1c2VyRGVmKTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAoa2V5IGluIHZtLiRkYXRhKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgaW4gZGF0YS4iLCB2bSk7CiAgICAgIH0gZWxzZSBpZiAodm0uJG9wdGlvbnMucHJvcHMgJiYga2V5IGluIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBwcm9wLiIsIHZtKTsKICAgICAgfSBlbHNlIGlmICh2bS4kb3B0aW9ucy5tZXRob2RzICYmIGtleSBpbiB2bS4kb3B0aW9ucy5tZXRob2RzKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBtZXRob2QuIiwgdm0pOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVDb21wdXRlZCh0YXJnZXQsIGtleSwgdXNlckRlZikgewogIHZhciBzaG91bGRDYWNoZSA9ICFpc1NlcnZlclJlbmRlcmluZygpOwoKICBpZiAodHlwZW9mIHVzZXJEZWYgPT09ICdmdW5jdGlvbicpIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBzaG91bGRDYWNoZSA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgOiBjcmVhdGVHZXR0ZXJJbnZva2VyKHVzZXJEZWYpOwogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IG5vb3A7CiAgfSBlbHNlIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSB1c2VyRGVmLmdldCA/IHNob3VsZENhY2hlICYmIHVzZXJEZWYuY2FjaGUgIT09IGZhbHNlID8gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KSA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZi5nZXQpIDogbm9vcDsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSB1c2VyRGVmLnNldCB8fCBub29wOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9PT0gbm9vcCkgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiQ29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIHdhcyBhc3NpZ25lZCB0byBidXQgaXQgaGFzIG5vIHNldHRlci4iLCB0aGlzKTsKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgewogIHJldHVybiBmdW5jdGlvbiBjb21wdXRlZEdldHRlcigpIHsKICAgIHZhciB3YXRjaGVyID0gdGhpcy5fY29tcHV0ZWRXYXRjaGVycyAmJiB0aGlzLl9jb21wdXRlZFdhdGNoZXJzW2tleV07CgogICAgaWYgKHdhdGNoZXIpIHsKICAgICAgaWYgKHdhdGNoZXIuZGlydHkpIHsKICAgICAgICB3YXRjaGVyLmV2YWx1YXRlKCk7CiAgICAgIH0KCiAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgd2F0Y2hlci5kZXBlbmQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdhdGNoZXIudmFsdWU7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlR2V0dGVySW52b2tlcihmbikgewogIHJldHVybiBmdW5jdGlvbiBjb21wdXRlZEdldHRlcigpIHsKICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIHRoaXMpOwogIH07Cn0KCmZ1bmN0aW9uIGluaXRNZXRob2RzKHZtLCBtZXRob2RzKSB7CiAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CgogIGZvciAodmFyIGtleSBpbiBtZXRob2RzKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAodHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIHR5cGUgXCIiICsgX3R5cGVvZihtZXRob2RzW2tleV0pICsgIlwiIGluIHRoZSBjb21wb25lbnQgZGVmaW5pdGlvbi4gIiArICJEaWQgeW91IHJlZmVyZW5jZSB0aGUgZnVuY3Rpb24gY29ycmVjdGx5PyIsIHZtKTsKICAgICAgfQoKICAgICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFzIGEgcHJvcC4iLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChrZXkgaW4gdm0gJiYgaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBjb25mbGljdHMgd2l0aCBhbiBleGlzdGluZyBWdWUgaW5zdGFuY2UgbWV0aG9kLiAiICsgIkF2b2lkIGRlZmluaW5nIGNvbXBvbmVudCBtZXRob2RzIHRoYXQgc3RhcnQgd2l0aCBfIG9yICQuIik7CiAgICAgIH0KICAgIH0KCiAgICB2bVtrZXldID0gdHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJyA/IG5vb3AgOiBiaW5kKG1ldGhvZHNba2V5XSwgdm0pOwogIH0KfQoKZnVuY3Rpb24gaW5pdFdhdGNoKHZtLCB3YXRjaCkgewogIGZvciAodmFyIGtleSBpbiB3YXRjaCkgewogICAgdmFyIGhhbmRsZXIgPSB3YXRjaFtrZXldOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGhhbmRsZXIpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlci5sZW5ndGg7IGkrKykgewogICAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcltpXSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcik7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVXYXRjaGVyKHZtLCBleHBPckZuLCBoYW5kbGVyLCBvcHRpb25zKSB7CiAgaWYgKGlzUGxhaW5PYmplY3QoaGFuZGxlcikpIHsKICAgIG9wdGlvbnMgPSBoYW5kbGVyOwogICAgaGFuZGxlciA9IGhhbmRsZXIuaGFuZGxlcjsKICB9CgogIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ3N0cmluZycpIHsKICAgIGhhbmRsZXIgPSB2bVtoYW5kbGVyXTsKICB9CgogIHJldHVybiB2bS4kd2F0Y2goZXhwT3JGbiwgaGFuZGxlciwgb3B0aW9ucyk7Cn0KCmZ1bmN0aW9uIHN0YXRlTWl4aW4oVnVlKSB7CiAgLy8gZmxvdyBzb21laG93IGhhcyBwcm9ibGVtcyB3aXRoIGRpcmVjdGx5IGRlY2xhcmVkIGRlZmluaXRpb24gb2JqZWN0CiAgLy8gd2hlbiB1c2luZyBPYmplY3QuZGVmaW5lUHJvcGVydHksIHNvIHdlIGhhdmUgdG8gcHJvY2VkdXJhbGx5IGJ1aWxkIHVwCiAgLy8gdGhlIG9iamVjdCBoZXJlLgogIHZhciBkYXRhRGVmID0ge307CgogIGRhdGFEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgfTsKCiAgdmFyIHByb3BzRGVmID0ge307CgogIHByb3BzRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9wcm9wczsKICB9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgZGF0YURlZi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oJ0F2b2lkIHJlcGxhY2luZyBpbnN0YW5jZSByb290ICRkYXRhLiAnICsgJ1VzZSBuZXN0ZWQgZGF0YSBwcm9wZXJ0aWVzIGluc3RlYWQuJywgdGhpcyk7CiAgICB9OwoKICAgIHByb3BzRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiJHByb3BzIGlzIHJlYWRvbmx5LiIsIHRoaXMpOwogICAgfTsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGRhdGEnLCBkYXRhRGVmKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRwcm9wcycsIHByb3BzRGVmKTsKICBWdWUucHJvdG90eXBlLiRzZXQgPSBzZXQ7CiAgVnVlLnByb3RvdHlwZS4kZGVsZXRlID0gZGVsOwoKICBWdWUucHJvdG90eXBlLiR3YXRjaCA9IGZ1bmN0aW9uIChleHBPckZuLCBjYiwgb3B0aW9ucykgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAoaXNQbGFpbk9iamVjdChjYikpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKICAgIH0KCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMudXNlciA9IHRydWU7CiAgICB2YXIgd2F0Y2hlciA9IG5ldyBXYXRjaGVyKHZtLCBleHBPckZuLCBjYiwgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMuaW1tZWRpYXRlKSB7CiAgICAgIHZhciBpbmZvID0gImNhbGxiYWNrIGZvciBpbW1lZGlhdGUgd2F0Y2hlciBcIiIgKyB3YXRjaGVyLmV4cHJlc3Npb24gKyAiXCIiOwogICAgICBwdXNoVGFyZ2V0KCk7CiAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNiLCB2bSwgW3dhdGNoZXIudmFsdWVdLCB2bSwgaW5mbyk7CiAgICAgIHBvcFRhcmdldCgpOwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiB1bndhdGNoRm4oKSB7CiAgICAgIHdhdGNoZXIudGVhcmRvd24oKTsKICAgIH07CiAgfTsKfQovKiAgKi8KCgp2YXIgdWlkJDMgPSAwOwoKZnVuY3Rpb24gaW5pdE1peGluKFZ1ZSkgewogIFZ1ZS5wcm90b3R5cGUuX2luaXQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdmFyIHZtID0gdGhpczsgLy8gYSB1aWQKCiAgICB2bS5fdWlkID0gdWlkJDMrKzsKICAgIHZhciBzdGFydFRhZywgZW5kVGFnOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6IiArIHZtLl91aWQ7CiAgICAgIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6IiArIHZtLl91aWQ7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwogICAgfSAvLyBhIGZsYWcgdG8gYXZvaWQgdGhpcyBiZWluZyBvYnNlcnZlZAoKCiAgICB2bS5faXNWdWUgPSB0cnVlOyAvLyBtZXJnZSBvcHRpb25zCgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5faXNDb21wb25lbnQpIHsKICAgICAgLy8gb3B0aW1pemUgaW50ZXJuYWwgY29tcG9uZW50IGluc3RhbnRpYXRpb24KICAgICAgLy8gc2luY2UgZHluYW1pYyBvcHRpb25zIG1lcmdpbmcgaXMgcHJldHR5IHNsb3csIGFuZCBub25lIG9mIHRoZQogICAgICAvLyBpbnRlcm5hbCBjb21wb25lbnQgb3B0aW9ucyBuZWVkcyBzcGVjaWFsIHRyZWF0bWVudC4KICAgICAgaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLiRvcHRpb25zID0gbWVyZ2VPcHRpb25zKHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnModm0uY29uc3RydWN0b3IpLCBvcHRpb25zIHx8IHt9LCB2bSk7CiAgICB9CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpbml0UHJveHkodm0pOwogICAgfSBlbHNlIHsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gdm07CiAgICB9IC8vIGV4cG9zZSByZWFsIHNlbGYKCgogICAgdm0uX3NlbGYgPSB2bTsKICAgIGluaXRMaWZlY3ljbGUodm0pOwogICAgaW5pdEV2ZW50cyh2bSk7CiAgICBpbml0UmVuZGVyKHZtKTsKICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlQ3JlYXRlJyk7CiAgICBpbml0SW5qZWN0aW9ucyh2bSk7IC8vIHJlc29sdmUgaW5qZWN0aW9ucyBiZWZvcmUgZGF0YS9wcm9wcwoKICAgIGluaXRTdGF0ZSh2bSk7CiAgICBpbml0UHJvdmlkZSh2bSk7IC8vIHJlc29sdmUgcHJvdmlkZSBhZnRlciBkYXRhL3Byb3BzCgogICAgY2FsbEhvb2sodm0sICdjcmVhdGVkJyk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICB2bS5fbmFtZSA9IGZvcm1hdENvbXBvbmVudE5hbWUodm0sIGZhbHNlKTsKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIiArIHZtLl9uYW1lICsgIiBpbml0Iiwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9CgogICAgaWYgKHZtLiRvcHRpb25zLmVsKSB7CiAgICAgIHZtLiRtb3VudCh2bS4kb3B0aW9ucy5lbCk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKSB7CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9ucyA9IE9iamVjdC5jcmVhdGUodm0uY29uc3RydWN0b3Iub3B0aW9ucyk7IC8vIGRvaW5nIHRoaXMgYmVjYXVzZSBpdCdzIGZhc3RlciB0aGFuIGR5bmFtaWMgZW51bWVyYXRpb24uCgogIHZhciBwYXJlbnRWbm9kZSA9IG9wdGlvbnMuX3BhcmVudFZub2RlOwogIG9wdHMucGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CiAgb3B0cy5fcGFyZW50Vm5vZGUgPSBwYXJlbnRWbm9kZTsKICB2YXIgdm5vZGVDb21wb25lbnRPcHRpb25zID0gcGFyZW50Vm5vZGUuY29tcG9uZW50T3B0aW9uczsKICBvcHRzLnByb3BzRGF0YSA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGE7CiAgb3B0cy5fcGFyZW50TGlzdGVuZXJzID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmxpc3RlbmVyczsKICBvcHRzLl9yZW5kZXJDaGlsZHJlbiA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5jaGlsZHJlbjsKICBvcHRzLl9jb21wb25lbnRUYWcgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMudGFnOwoKICBpZiAob3B0aW9ucy5yZW5kZXIpIHsKICAgIG9wdHMucmVuZGVyID0gb3B0aW9ucy5yZW5kZXI7CiAgICBvcHRzLnN0YXRpY1JlbmRlckZucyA9IG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CgogIGlmIChDdG9yWyJzdXBlciJdKSB7CiAgICB2YXIgc3VwZXJPcHRpb25zID0gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yWyJzdXBlciJdKTsKICAgIHZhciBjYWNoZWRTdXBlck9wdGlvbnMgPSBDdG9yLnN1cGVyT3B0aW9uczsKCiAgICBpZiAoc3VwZXJPcHRpb25zICE9PSBjYWNoZWRTdXBlck9wdGlvbnMpIHsKICAgICAgLy8gc3VwZXIgb3B0aW9uIGNoYW5nZWQsCiAgICAgIC8vIG5lZWQgdG8gcmVzb2x2ZSBuZXcgb3B0aW9ucy4KICAgICAgQ3Rvci5zdXBlck9wdGlvbnMgPSBzdXBlck9wdGlvbnM7IC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBhbnkgbGF0ZS1tb2RpZmllZC9hdHRhY2hlZCBvcHRpb25zICgjNDk3NikKCiAgICAgIHZhciBtb2RpZmllZE9wdGlvbnMgPSByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpOyAvLyB1cGRhdGUgYmFzZSBleHRlbmQgb3B0aW9ucwoKICAgICAgaWYgKG1vZGlmaWVkT3B0aW9ucykgewogICAgICAgIGV4dGVuZChDdG9yLmV4dGVuZE9wdGlvbnMsIG1vZGlmaWVkT3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoc3VwZXJPcHRpb25zLCBDdG9yLmV4dGVuZE9wdGlvbnMpOwoKICAgICAgaWYgKG9wdGlvbnMubmFtZSkgewogICAgICAgIG9wdGlvbnMuY29tcG9uZW50c1tvcHRpb25zLm5hbWVdID0gQ3RvcjsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIG9wdGlvbnM7Cn0KCmZ1bmN0aW9uIHJlc29sdmVNb2RpZmllZE9wdGlvbnMoQ3RvcikgewogIHZhciBtb2RpZmllZDsKICB2YXIgbGF0ZXN0ID0gQ3Rvci5vcHRpb25zOwogIHZhciBzZWFsZWQgPSBDdG9yLnNlYWxlZE9wdGlvbnM7CgogIGZvciAodmFyIGtleSBpbiBsYXRlc3QpIHsKICAgIGlmIChsYXRlc3Rba2V5XSAhPT0gc2VhbGVkW2tleV0pIHsKICAgICAgaWYgKCFtb2RpZmllZCkgewogICAgICAgIG1vZGlmaWVkID0ge307CiAgICAgIH0KCiAgICAgIG1vZGlmaWVkW2tleV0gPSBsYXRlc3Rba2V5XTsKICAgIH0KICB9CgogIHJldHVybiBtb2RpZmllZDsKfQoKZnVuY3Rpb24gVnVlKG9wdGlvbnMpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhKHRoaXMgaW5zdGFuY2VvZiBWdWUpKSB7CiAgICB3YXJuKCdWdWUgaXMgYSBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkJyk7CiAgfQoKICB0aGlzLl9pbml0KG9wdGlvbnMpOwp9Cgppbml0TWl4aW4oVnVlKTsKc3RhdGVNaXhpbihWdWUpOwpldmVudHNNaXhpbihWdWUpOwpsaWZlY3ljbGVNaXhpbihWdWUpOwpyZW5kZXJNaXhpbihWdWUpOwovKiAgKi8KCmZ1bmN0aW9uIGluaXRVc2UoVnVlKSB7CiAgVnVlLnVzZSA9IGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgIHZhciBpbnN0YWxsZWRQbHVnaW5zID0gdGhpcy5faW5zdGFsbGVkUGx1Z2lucyB8fCAodGhpcy5faW5zdGFsbGVkUGx1Z2lucyA9IFtdKTsKCiAgICBpZiAoaW5zdGFsbGVkUGx1Z2lucy5pbmRleE9mKHBsdWdpbikgPiAtMSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0gLy8gYWRkaXRpb25hbCBwYXJhbWV0ZXJzCgoKICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgYXJncy51bnNoaWZ0KHRoaXMpOwoKICAgIGlmICh0eXBlb2YgcGx1Z2luLmluc3RhbGwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcGx1Z2luLmluc3RhbGwuYXBwbHkocGx1Z2luLCBhcmdzKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBwbHVnaW4uYXBwbHkobnVsbCwgYXJncyk7CiAgICB9CgogICAgaW5zdGFsbGVkUGx1Z2lucy5wdXNoKHBsdWdpbik7CiAgICByZXR1cm4gdGhpczsKICB9Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRNaXhpbiQxKFZ1ZSkgewogIFZ1ZS5taXhpbiA9IGZ1bmN0aW9uIChtaXhpbikgewogICAgdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHRoaXMub3B0aW9ucywgbWl4aW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0RXh0ZW5kKFZ1ZSkgewogIC8qKgogICAqIEVhY2ggaW5zdGFuY2UgY29uc3RydWN0b3IsIGluY2x1ZGluZyBWdWUsIGhhcyBhIHVuaXF1ZQogICAqIGNpZC4gVGhpcyBlbmFibGVzIHVzIHRvIGNyZWF0ZSB3cmFwcGVkICJjaGlsZAogICAqIGNvbnN0cnVjdG9ycyIgZm9yIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UgYW5kIGNhY2hlIHRoZW0uCiAgICovCiAgVnVlLmNpZCA9IDA7CiAgdmFyIGNpZCA9IDE7CiAgLyoqCiAgICogQ2xhc3MgaW5oZXJpdGFuY2UKICAgKi8KCiAgVnVlLmV4dGVuZCA9IGZ1bmN0aW9uIChleHRlbmRPcHRpb25zKSB7CiAgICBleHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9ucyB8fCB7fTsKICAgIHZhciBTdXBlciA9IHRoaXM7CiAgICB2YXIgU3VwZXJJZCA9IFN1cGVyLmNpZDsKICAgIHZhciBjYWNoZWRDdG9ycyA9IGV4dGVuZE9wdGlvbnMuX0N0b3IgfHwgKGV4dGVuZE9wdGlvbnMuX0N0b3IgPSB7fSk7CgogICAgaWYgKGNhY2hlZEN0b3JzW1N1cGVySWRdKSB7CiAgICAgIHJldHVybiBjYWNoZWRDdG9yc1tTdXBlcklkXTsKICAgIH0KCiAgICB2YXIgbmFtZSA9IGV4dGVuZE9wdGlvbnMubmFtZSB8fCBTdXBlci5vcHRpb25zLm5hbWU7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbmFtZSkgewogICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSk7CiAgICB9CgogICAgdmFyIFN1YiA9IGZ1bmN0aW9uIFZ1ZUNvbXBvbmVudChvcHRpb25zKSB7CiAgICAgIHRoaXMuX2luaXQob3B0aW9ucyk7CiAgICB9OwoKICAgIFN1Yi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN1cGVyLnByb3RvdHlwZSk7CiAgICBTdWIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3ViOwogICAgU3ViLmNpZCA9IGNpZCsrOwogICAgU3ViLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoU3VwZXIub3B0aW9ucywgZXh0ZW5kT3B0aW9ucyk7CiAgICBTdWJbJ3N1cGVyJ10gPSBTdXBlcjsgLy8gRm9yIHByb3BzIGFuZCBjb21wdXRlZCBwcm9wZXJ0aWVzLCB3ZSBkZWZpbmUgdGhlIHByb3h5IGdldHRlcnMgb24KICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAvLyBhdm9pZHMgT2JqZWN0LmRlZmluZVByb3BlcnR5IGNhbGxzIGZvciBlYWNoIGluc3RhbmNlIGNyZWF0ZWQuCgogICAgaWYgKFN1Yi5vcHRpb25zLnByb3BzKSB7CiAgICAgIGluaXRQcm9wcyQxKFN1Yik7CiAgICB9CgogICAgaWYgKFN1Yi5vcHRpb25zLmNvbXB1dGVkKSB7CiAgICAgIGluaXRDb21wdXRlZCQxKFN1Yik7CiAgICB9IC8vIGFsbG93IGZ1cnRoZXIgZXh0ZW5zaW9uL21peGluL3BsdWdpbiB1c2FnZQoKCiAgICBTdWIuZXh0ZW5kID0gU3VwZXIuZXh0ZW5kOwogICAgU3ViLm1peGluID0gU3VwZXIubWl4aW47CiAgICBTdWIudXNlID0gU3VwZXIudXNlOyAvLyBjcmVhdGUgYXNzZXQgcmVnaXN0ZXJzLCBzbyBleHRlbmRlZCBjbGFzc2VzCiAgICAvLyBjYW4gaGF2ZSB0aGVpciBwcml2YXRlIGFzc2V0cyB0b28uCgogICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICBTdWJbdHlwZV0gPSBTdXBlclt0eXBlXTsKICAgIH0pOyAvLyBlbmFibGUgcmVjdXJzaXZlIHNlbGYtbG9va3VwCgogICAgaWYgKG5hbWUpIHsKICAgICAgU3ViLm9wdGlvbnMuY29tcG9uZW50c1tuYW1lXSA9IFN1YjsKICAgIH0gLy8ga2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgc3VwZXIgb3B0aW9ucyBhdCBleHRlbnNpb24gdGltZS4KICAgIC8vIGxhdGVyIGF0IGluc3RhbnRpYXRpb24gd2UgY2FuIGNoZWNrIGlmIFN1cGVyJ3Mgb3B0aW9ucyBoYXZlCiAgICAvLyBiZWVuIHVwZGF0ZWQuCgoKICAgIFN1Yi5zdXBlck9wdGlvbnMgPSBTdXBlci5vcHRpb25zOwogICAgU3ViLmV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zOwogICAgU3ViLnNlYWxlZE9wdGlvbnMgPSBleHRlbmQoe30sIFN1Yi5vcHRpb25zKTsgLy8gY2FjaGUgY29uc3RydWN0b3IKCiAgICBjYWNoZWRDdG9yc1tTdXBlcklkXSA9IFN1YjsKICAgIHJldHVybiBTdWI7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdFByb3BzJDEoQ29tcCkgewogIHZhciBwcm9wcyA9IENvbXAub3B0aW9ucy5wcm9wczsKCiAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0Q29tcHV0ZWQkMShDb21wKSB7CiAgdmFyIGNvbXB1dGVkID0gQ29tcC5vcHRpb25zLmNvbXB1dGVkOwoKICBmb3IgKHZhciBrZXkgaW4gY29tcHV0ZWQpIHsKICAgIGRlZmluZUNvbXB1dGVkKENvbXAucHJvdG90eXBlLCBrZXksIGNvbXB1dGVkW2tleV0pOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0QXNzZXRSZWdpc3RlcnMoVnVlKSB7CiAgLyoqCiAgICogQ3JlYXRlIGFzc2V0IHJlZ2lzdHJhdGlvbiBtZXRob2RzLgogICAqLwogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIFZ1ZVt0eXBlXSA9IGZ1bmN0aW9uIChpZCwgZGVmaW5pdGlvbikgewogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlID09PSAnY29tcG9uZW50JykgewogICAgICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKGlkKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnY29tcG9uZW50JyAmJiBpc1BsYWluT2JqZWN0KGRlZmluaXRpb24pKSB7CiAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICBkZWZpbml0aW9uID0gdGhpcy5vcHRpb25zLl9iYXNlLmV4dGVuZChkZWZpbml0aW9uKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnZGlyZWN0aXZlJyAmJiB0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgZGVmaW5pdGlvbiA9IHsKICAgICAgICAgICAgYmluZDogZGVmaW5pdGlvbiwKICAgICAgICAgICAgdXBkYXRlOiBkZWZpbml0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXSA9IGRlZmluaXRpb247CiAgICAgICAgcmV0dXJuIGRlZmluaXRpb247CiAgICAgIH0KICAgIH07CiAgfSk7Cn0KLyogICovCgoKZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShvcHRzKSB7CiAgcmV0dXJuIG9wdHMgJiYgKG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcpOwp9CgpmdW5jdGlvbiBtYXRjaGVzKHBhdHRlcm4sIG5hbWUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgcmV0dXJuIHBhdHRlcm4uaW5kZXhPZihuYW1lKSA+IC0xOwogIH0gZWxzZSBpZiAodHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gcGF0dGVybi5zcGxpdCgnLCcpLmluZGV4T2YobmFtZSkgPiAtMTsKICB9IGVsc2UgaWYgKGlzUmVnRXhwKHBhdHRlcm4pKSB7CiAgICByZXR1cm4gcGF0dGVybi50ZXN0KG5hbWUpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBwcnVuZUNhY2hlKGtlZXBBbGl2ZUluc3RhbmNlLCBmaWx0ZXIpIHsKICB2YXIgY2FjaGUgPSBrZWVwQWxpdmVJbnN0YW5jZS5jYWNoZTsKICB2YXIga2V5cyA9IGtlZXBBbGl2ZUluc3RhbmNlLmtleXM7CiAgdmFyIF92bm9kZSA9IGtlZXBBbGl2ZUluc3RhbmNlLl92bm9kZTsKCiAgZm9yICh2YXIga2V5IGluIGNhY2hlKSB7CiAgICB2YXIgZW50cnkgPSBjYWNoZVtrZXldOwoKICAgIGlmIChlbnRyeSkgewogICAgICB2YXIgbmFtZSA9IGVudHJ5Lm5hbWU7CgogICAgICBpZiAobmFtZSAmJiAhZmlsdGVyKG5hbWUpKSB7CiAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIF92bm9kZSk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHBydW5lQ2FjaGVFbnRyeShjYWNoZSwga2V5LCBrZXlzLCBjdXJyZW50KSB7CiAgdmFyIGVudHJ5ID0gY2FjaGVba2V5XTsKCiAgaWYgKGVudHJ5ICYmICghY3VycmVudCB8fCBlbnRyeS50YWcgIT09IGN1cnJlbnQudGFnKSkgewogICAgZW50cnkuY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICB9CgogIGNhY2hlW2tleV0gPSBudWxsOwogIHJlbW92ZShrZXlzLCBrZXkpOwp9Cgp2YXIgcGF0dGVyblR5cGVzID0gW1N0cmluZywgUmVnRXhwLCBBcnJheV07CnZhciBLZWVwQWxpdmUgPSB7CiAgbmFtZTogJ2tlZXAtYWxpdmUnLAogICJhYnN0cmFjdCI6IHRydWUsCiAgcHJvcHM6IHsKICAgIGluY2x1ZGU6IHBhdHRlcm5UeXBlcywKICAgIGV4Y2x1ZGU6IHBhdHRlcm5UeXBlcywKICAgIG1heDogW1N0cmluZywgTnVtYmVyXQogIH0sCiAgbWV0aG9kczogewogICAgY2FjaGVWTm9kZTogZnVuY3Rpb24gY2FjaGVWTm9kZSgpIHsKICAgICAgdmFyIHJlZiA9IHRoaXM7CiAgICAgIHZhciBjYWNoZSA9IHJlZi5jYWNoZTsKICAgICAgdmFyIGtleXMgPSByZWYua2V5czsKICAgICAgdmFyIHZub2RlVG9DYWNoZSA9IHJlZi52bm9kZVRvQ2FjaGU7CiAgICAgIHZhciBrZXlUb0NhY2hlID0gcmVmLmtleVRvQ2FjaGU7CgogICAgICBpZiAodm5vZGVUb0NhY2hlKSB7CiAgICAgICAgdmFyIHRhZyA9IHZub2RlVG9DYWNoZS50YWc7CiAgICAgICAgdmFyIGNvbXBvbmVudEluc3RhbmNlID0gdm5vZGVUb0NhY2hlLmNvbXBvbmVudEluc3RhbmNlOwogICAgICAgIHZhciBjb21wb25lbnRPcHRpb25zID0gdm5vZGVUb0NhY2hlLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgICAgY2FjaGVba2V5VG9DYWNoZV0gPSB7CiAgICAgICAgICBuYW1lOiBnZXRDb21wb25lbnROYW1lKGNvbXBvbmVudE9wdGlvbnMpLAogICAgICAgICAgdGFnOiB0YWcsCiAgICAgICAgICBjb21wb25lbnRJbnN0YW5jZTogY29tcG9uZW50SW5zdGFuY2UKICAgICAgICB9OwogICAgICAgIGtleXMucHVzaChrZXlUb0NhY2hlKTsgLy8gcHJ1bmUgb2xkZXN0IGVudHJ5CgogICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXlzWzBdLCBrZXlzLCB0aGlzLl92bm9kZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnZub2RlVG9DYWNoZSA9IG51bGw7CiAgICAgIH0KICAgIH0KICB9LAogIGNyZWF0ZWQ6IGZ1bmN0aW9uIGNyZWF0ZWQoKSB7CiAgICB0aGlzLmNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMua2V5cyA9IFtdOwogIH0sCiAgZGVzdHJveWVkOiBmdW5jdGlvbiBkZXN0cm95ZWQoKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jYWNoZSkgewogICAgICBwcnVuZUNhY2hlRW50cnkodGhpcy5jYWNoZSwga2V5LCB0aGlzLmtleXMpOwogICAgfQogIH0sCiAgbW91bnRlZDogZnVuY3Rpb24gbW91bnRlZCgpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdGhpcy5jYWNoZVZOb2RlKCk7CiAgICB0aGlzLiR3YXRjaCgnaW5jbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgcHJ1bmVDYWNoZSh0aGlzJDEsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuJHdhdGNoKCdleGNsdWRlJywgZnVuY3Rpb24gKHZhbCkgewogICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gIW1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICB9LAogIHVwZGF0ZWQ6IGZ1bmN0aW9uIHVwZGF0ZWQoKSB7CiAgICB0aGlzLmNhY2hlVk5vZGUoKTsKICB9LAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgdmFyIHNsb3QgPSB0aGlzLiRzbG90c1siZGVmYXVsdCJdOwogICAgdmFyIHZub2RlID0gZ2V0Rmlyc3RDb21wb25lbnRDaGlsZChzbG90KTsKICAgIHZhciBjb21wb25lbnRPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKCiAgICBpZiAoY29tcG9uZW50T3B0aW9ucykgewogICAgICAvLyBjaGVjayBwYXR0ZXJuCiAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShjb21wb25lbnRPcHRpb25zKTsKICAgICAgdmFyIHJlZiA9IHRoaXM7CiAgICAgIHZhciBpbmNsdWRlID0gcmVmLmluY2x1ZGU7CiAgICAgIHZhciBleGNsdWRlID0gcmVmLmV4Y2x1ZGU7CgogICAgICBpZiAoIC8vIG5vdCBpbmNsdWRlZAogICAgICBpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkgfHwgLy8gZXhjbHVkZWQKICAgICAgZXhjbHVkZSAmJiBuYW1lICYmIG1hdGNoZXMoZXhjbHVkZSwgbmFtZSkpIHsKICAgICAgICByZXR1cm4gdm5vZGU7CiAgICAgIH0KCiAgICAgIHZhciByZWYkMSA9IHRoaXM7CiAgICAgIHZhciBjYWNoZSA9IHJlZiQxLmNhY2hlOwogICAgICB2YXIga2V5cyA9IHJlZiQxLmtleXM7CiAgICAgIHZhciBrZXkgPSB2bm9kZS5rZXkgPT0gbnVsbCAvLyBzYW1lIGNvbnN0cnVjdG9yIG1heSBnZXQgcmVnaXN0ZXJlZCBhcyBkaWZmZXJlbnQgbG9jYWwgY29tcG9uZW50cwogICAgICAvLyBzbyBjaWQgYWxvbmUgaXMgbm90IGVub3VnaCAoIzMyNjkpCiAgICAgID8gY29tcG9uZW50T3B0aW9ucy5DdG9yLmNpZCArIChjb21wb25lbnRPcHRpb25zLnRhZyA/ICI6OiIgKyBjb21wb25lbnRPcHRpb25zLnRhZyA6ICcnKSA6IHZub2RlLmtleTsKCiAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjYWNoZVtrZXldLmNvbXBvbmVudEluc3RhbmNlOyAvLyBtYWtlIGN1cnJlbnQga2V5IGZyZXNoZXN0CgogICAgICAgIHJlbW92ZShrZXlzLCBrZXkpOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRlbGF5IHNldHRpbmcgdGhlIGNhY2hlIHVudGlsIHVwZGF0ZQogICAgICAgIHRoaXMudm5vZGVUb0NhY2hlID0gdm5vZGU7CiAgICAgICAgdGhpcy5rZXlUb0NhY2hlID0ga2V5OwogICAgICB9CgogICAgICB2bm9kZS5kYXRhLmtlZXBBbGl2ZSA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHZub2RlIHx8IHNsb3QgJiYgc2xvdFswXTsKICB9Cn07CnZhciBidWlsdEluQ29tcG9uZW50cyA9IHsKICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQp9OwovKiAgKi8KCmZ1bmN0aW9uIGluaXRHbG9iYWxBUEkoVnVlKSB7CiAgLy8gY29uZmlnCiAgdmFyIGNvbmZpZ0RlZiA9IHt9OwoKICBjb25maWdEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbmZpZzsKICB9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgY29uZmlnRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybignRG8gbm90IHJlcGxhY2UgdGhlIFZ1ZS5jb25maWcgb2JqZWN0LCBzZXQgaW5kaXZpZHVhbCBmaWVsZHMgaW5zdGVhZC4nKTsKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnY29uZmlnJywgY29uZmlnRGVmKTsgLy8gZXhwb3NlZCB1dGlsIG1ldGhvZHMuCiAgLy8gTk9URTogdGhlc2UgYXJlIG5vdCBjb25zaWRlcmVkIHBhcnQgb2YgdGhlIHB1YmxpYyBBUEkgLSBhdm9pZCByZWx5aW5nIG9uCiAgLy8gdGhlbSB1bmxlc3MgeW91IGFyZSBhd2FyZSBvZiB0aGUgcmlzay4KCiAgVnVlLnV0aWwgPSB7CiAgICB3YXJuOiB3YXJuLAogICAgZXh0ZW5kOiBleHRlbmQsCiAgICBtZXJnZU9wdGlvbnM6IG1lcmdlT3B0aW9ucywKICAgIGRlZmluZVJlYWN0aXZlOiBkZWZpbmVSZWFjdGl2ZSQkMQogIH07CiAgVnVlLnNldCA9IHNldDsKICBWdWVbImRlbGV0ZSJdID0gZGVsOwogIFZ1ZS5uZXh0VGljayA9IG5leHRUaWNrOyAvLyAyLjYgZXhwbGljaXQgb2JzZXJ2YWJsZSBBUEkKCiAgVnVlLm9ic2VydmFibGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBvYnNlcnZlKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIFZ1ZS5vcHRpb25zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICBWdWUub3B0aW9uc1t0eXBlICsgJ3MnXSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfSk7IC8vIHRoaXMgaXMgdXNlZCB0byBpZGVudGlmeSB0aGUgImJhc2UiIGNvbnN0cnVjdG9yIHRvIGV4dGVuZCBhbGwgcGxhaW4tb2JqZWN0CiAgLy8gY29tcG9uZW50cyB3aXRoIGluIFdlZXgncyBtdWx0aS1pbnN0YW5jZSBzY2VuYXJpb3MuCgogIFZ1ZS5vcHRpb25zLl9iYXNlID0gVnVlOwogIGV4dGVuZChWdWUub3B0aW9ucy5jb21wb25lbnRzLCBidWlsdEluQ29tcG9uZW50cyk7CiAgaW5pdFVzZShWdWUpOwogIGluaXRNaXhpbiQxKFZ1ZSk7CiAgaW5pdEV4dGVuZChWdWUpOwogIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpOwp9Cgppbml0R2xvYmFsQVBJKFZ1ZSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGlzU2VydmVyJywgewogIGdldDogaXNTZXJ2ZXJSZW5kZXJpbmcKfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHNzckNvbnRleHQnLCB7CiAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgcmV0dXJuIHRoaXMuJHZub2RlICYmIHRoaXMuJHZub2RlLnNzckNvbnRleHQ7CiAgfQp9KTsgLy8gZXhwb3NlIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0IGZvciBzc3IgcnVudGltZSBoZWxwZXIgaW5zdGFsbGF0aW9uCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnRnVuY3Rpb25hbFJlbmRlckNvbnRleHQnLCB7CiAgdmFsdWU6IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0Cn0pOwpWdWUudmVyc2lvbiA9ICcyLjYuMTQnOwovKiAgKi8KLy8gdGhlc2UgYXJlIHJlc2VydmVkIGZvciB3ZWIgYmVjYXVzZSB0aGV5IGFyZSBkaXJlY3RseSBjb21waWxlZCBhd2F5Ci8vIGR1cmluZyB0ZW1wbGF0ZSBjb21waWxhdGlvbgoKdmFyIGlzUmVzZXJ2ZWRBdHRyID0gbWFrZU1hcCgnc3R5bGUsY2xhc3MnKTsgLy8gYXR0cmlidXRlcyB0aGF0IHNob3VsZCBiZSB1c2luZyBwcm9wcyBmb3IgYmluZGluZwoKdmFyIGFjY2VwdFZhbHVlID0gbWFrZU1hcCgnaW5wdXQsdGV4dGFyZWEsb3B0aW9uLHNlbGVjdCxwcm9ncmVzcycpOwoKdmFyIG11c3RVc2VQcm9wID0gZnVuY3Rpb24gbXVzdFVzZVByb3AodGFnLCB0eXBlLCBhdHRyKSB7CiAgcmV0dXJuIGF0dHIgPT09ICd2YWx1ZScgJiYgYWNjZXB0VmFsdWUodGFnKSAmJiB0eXBlICE9PSAnYnV0dG9uJyB8fCBhdHRyID09PSAnc2VsZWN0ZWQnICYmIHRhZyA9PT0gJ29wdGlvbicgfHwgYXR0ciA9PT0gJ2NoZWNrZWQnICYmIHRhZyA9PT0gJ2lucHV0JyB8fCBhdHRyID09PSAnbXV0ZWQnICYmIHRhZyA9PT0gJ3ZpZGVvJzsKfTsKCnZhciBpc0VudW1lcmF0ZWRBdHRyID0gbWFrZU1hcCgnY29udGVudGVkaXRhYmxlLGRyYWdnYWJsZSxzcGVsbGNoZWNrJyk7CnZhciBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUgPSBtYWtlTWFwKCdldmVudHMsY2FyZXQsdHlwaW5nLHBsYWludGV4dC1vbmx5Jyk7Cgp2YXIgY29udmVydEVudW1lcmF0ZWRWYWx1ZSA9IGZ1bmN0aW9uIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkgewogIHJldHVybiBpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJyA/ICdmYWxzZScgLy8gYWxsb3cgYXJiaXRyYXJ5IHN0cmluZyB2YWx1ZSBmb3IgY29udGVudGVkaXRhYmxlCiAgOiBrZXkgPT09ICdjb250ZW50ZWRpdGFibGUnICYmIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSh2YWx1ZSkgPyB2YWx1ZSA6ICd0cnVlJzsKfTsKCnZhciBpc0Jvb2xlYW5BdHRyID0gbWFrZU1hcCgnYWxsb3dmdWxsc2NyZWVuLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjaGVja2VkLGNvbXBhY3QsY29udHJvbHMsZGVjbGFyZSwnICsgJ2RlZmF1bHQsZGVmYXVsdGNoZWNrZWQsZGVmYXVsdG11dGVkLGRlZmF1bHRzZWxlY3RlZCxkZWZlcixkaXNhYmxlZCwnICsgJ2VuYWJsZWQsZm9ybW5vdmFsaWRhdGUsaGlkZGVuLGluZGV0ZXJtaW5hdGUsaW5lcnQsaXNtYXAsaXRlbXNjb3BlLGxvb3AsbXVsdGlwbGUsJyArICdtdXRlZCxub2hyZWYsbm9yZXNpemUsbm9zaGFkZSxub3ZhbGlkYXRlLG5vd3JhcCxvcGVuLHBhdXNlb25leGl0LHJlYWRvbmx5LCcgKyAncmVxdWlyZWQscmV2ZXJzZWQsc2NvcGVkLHNlYW1sZXNzLHNlbGVjdGVkLHNvcnRhYmxlLCcgKyAndHJ1ZXNwZWVkLHR5cGVtdXN0bWF0Y2gsdmlzaWJsZScpOwp2YXIgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKCnZhciBpc1hsaW5rID0gZnVuY3Rpb24gaXNYbGluayhuYW1lKSB7CiAgcmV0dXJuIG5hbWUuY2hhckF0KDUpID09PSAnOicgJiYgbmFtZS5zbGljZSgwLCA1KSA9PT0gJ3hsaW5rJzsKfTsKCnZhciBnZXRYbGlua1Byb3AgPSBmdW5jdGlvbiBnZXRYbGlua1Byb3AobmFtZSkgewogIHJldHVybiBpc1hsaW5rKG5hbWUpID8gbmFtZS5zbGljZSg2LCBuYW1lLmxlbmd0aCkgOiAnJzsKfTsKCnZhciBpc0ZhbHN5QXR0clZhbHVlID0gZnVuY3Rpb24gaXNGYWxzeUF0dHJWYWx1ZSh2YWwpIHsKICByZXR1cm4gdmFsID09IG51bGwgfHwgdmFsID09PSBmYWxzZTsKfTsKLyogICovCgoKZnVuY3Rpb24gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgcGFyZW50Tm9kZSA9IHZub2RlOwogIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKCiAgd2hpbGUgKGlzRGVmKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CgogICAgaWYgKGNoaWxkTm9kZSAmJiBjaGlsZE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoY2hpbGROb2RlLmRhdGEsIGRhdGEpOwogICAgfQogIH0KCiAgd2hpbGUgKGlzRGVmKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkpIHsKICAgIGlmIChwYXJlbnROb2RlICYmIHBhcmVudE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoZGF0YSwgcGFyZW50Tm9kZS5kYXRhKTsKICAgIH0KICB9CgogIHJldHVybiByZW5kZXJDbGFzcyhkYXRhLnN0YXRpY0NsYXNzLCBkYXRhWyJjbGFzcyJdKTsKfQoKZnVuY3Rpb24gbWVyZ2VDbGFzc0RhdGEoY2hpbGQsIHBhcmVudCkgewogIHJldHVybiB7CiAgICBzdGF0aWNDbGFzczogY29uY2F0KGNoaWxkLnN0YXRpY0NsYXNzLCBwYXJlbnQuc3RhdGljQ2xhc3MpLAogICAgImNsYXNzIjogaXNEZWYoY2hpbGRbImNsYXNzIl0pID8gW2NoaWxkWyJjbGFzcyJdLCBwYXJlbnRbImNsYXNzIl1dIDogcGFyZW50WyJjbGFzcyJdCiAgfTsKfQoKZnVuY3Rpb24gcmVuZGVyQ2xhc3Moc3RhdGljQ2xhc3MsIGR5bmFtaWNDbGFzcykgewogIGlmIChpc0RlZihzdGF0aWNDbGFzcykgfHwgaXNEZWYoZHluYW1pY0NsYXNzKSkgewogICAgcmV0dXJuIGNvbmNhdChzdGF0aWNDbGFzcywgc3RyaW5naWZ5Q2xhc3MoZHluYW1pY0NsYXNzKSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gJyc7Cn0KCmZ1bmN0aW9uIGNvbmNhdChhLCBiKSB7CiAgcmV0dXJuIGEgPyBiID8gYSArICcgJyArIGIgOiBhIDogYiB8fCAnJzsKfQoKZnVuY3Rpb24gc3RyaW5naWZ5Q2xhc3ModmFsdWUpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIHJldHVybiBzdHJpbmdpZnlBcnJheSh2YWx1ZSk7CiAgfQoKICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5T2JqZWN0KHZhbHVlKTsKICB9CgogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gJyc7Cn0KCmZ1bmN0aW9uIHN0cmluZ2lmeUFycmF5KHZhbHVlKSB7CiAgdmFyIHJlcyA9ICcnOwogIHZhciBzdHJpbmdpZmllZDsKCiAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmIChpc0RlZihzdHJpbmdpZmllZCA9IHN0cmluZ2lmeUNsYXNzKHZhbHVlW2ldKSkgJiYgc3RyaW5naWZpZWQgIT09ICcnKSB7CiAgICAgIGlmIChyZXMpIHsKICAgICAgICByZXMgKz0gJyAnOwogICAgICB9CgogICAgICByZXMgKz0gc3RyaW5naWZpZWQ7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlPYmplY3QodmFsdWUpIHsKICB2YXIgcmVzID0gJyc7CgogIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgaWYgKHZhbHVlW2tleV0pIHsKICAgICAgaWYgKHJlcykgewogICAgICAgIHJlcyArPSAnICc7CiAgICAgIH0KCiAgICAgIHJlcyArPSBrZXk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCnZhciBuYW1lc3BhY2VNYXAgPSB7CiAgc3ZnOiAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLAogIG1hdGg6ICdodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MJwp9Owp2YXIgaXNIVE1MVGFnID0gbWFrZU1hcCgnaHRtbCxib2R5LGJhc2UsaGVhZCxsaW5rLG1ldGEsc3R5bGUsdGl0bGUsJyArICdhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sJyArICdkaXYsZGQsZGwsZHQsZmlnY2FwdGlvbixmaWd1cmUscGljdHVyZSxocixpbWcsbGksbWFpbixvbCxwLHByZSx1bCwnICsgJ2EsYixhYmJyLGJkaSxiZG8sYnIsY2l0ZSxjb2RlLGRhdGEsZGZuLGVtLGksa2JkLG1hcmsscSxycCxydCxydGMscnVieSwnICsgJ3Msc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLCcgKyAnZW1iZWQsb2JqZWN0LHBhcmFtLHNvdXJjZSxjYW52YXMsc2NyaXB0LG5vc2NyaXB0LGRlbCxpbnMsJyArICdjYXB0aW9uLGNvbCxjb2xncm91cCx0YWJsZSx0aGVhZCx0Ym9keSx0ZCx0aCx0ciwnICsgJ2J1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sJyArICdvdXRwdXQscHJvZ3Jlc3Msc2VsZWN0LHRleHRhcmVhLCcgKyAnZGV0YWlscyxkaWFsb2csbWVudSxtZW51aXRlbSxzdW1tYXJ5LCcgKyAnY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCcpOyAvLyB0aGlzIG1hcCBpcyBpbnRlbnRpb25hbGx5IHNlbGVjdGl2ZSwgb25seSBjb3ZlcmluZyBTVkcgZWxlbWVudHMgdGhhdCBtYXkKLy8gY29udGFpbiBjaGlsZCBlbGVtZW50cy4KCnZhciBpc1NWRyA9IG1ha2VNYXAoJ3N2ZyxhbmltYXRlLGNpcmNsZSxjbGlwcGF0aCxjdXJzb3IsZGVmcyxkZXNjLGVsbGlwc2UsZmlsdGVyLGZvbnQtZmFjZSwnICsgJ2ZvcmVpZ25vYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKyAncG9seWdvbixwb2x5bGluZSxyZWN0LHN3aXRjaCxzeW1ib2wsdGV4dCx0ZXh0cGF0aCx0c3Bhbix1c2UsdmlldycsIHRydWUpOwoKdmFyIGlzUmVzZXJ2ZWRUYWcgPSBmdW5jdGlvbiBpc1Jlc2VydmVkVGFnKHRhZykgewogIHJldHVybiBpc0hUTUxUYWcodGFnKSB8fCBpc1NWRyh0YWcpOwp9OwoKZnVuY3Rpb24gZ2V0VGFnTmFtZXNwYWNlKHRhZykgewogIGlmIChpc1NWRyh0YWcpKSB7CiAgICByZXR1cm4gJ3N2Zyc7CiAgfSAvLyBiYXNpYyBzdXBwb3J0IGZvciBNYXRoTUwKICAvLyBub3RlIGl0IGRvZXNuJ3Qgc3VwcG9ydCBvdGhlciBNYXRoTUwgZWxlbWVudHMgYmVpbmcgY29tcG9uZW50IHJvb3RzCgoKICBpZiAodGFnID09PSAnbWF0aCcpIHsKICAgIHJldHVybiAnbWF0aCc7CiAgfQp9Cgp2YXIgdW5rbm93bkVsZW1lbnRDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgpmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50KHRhZykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICghaW5Ccm93c2VyKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGlmIChpc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHRhZyA9IHRhZy50b0xvd2VyQ2FzZSgpOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAodW5rbm93bkVsZW1lbnRDYWNoZVt0YWddICE9IG51bGwpIHsKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ107CiAgfQoKICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7CgogIGlmICh0YWcuaW5kZXhPZignLScpID4gLTEpIHsKICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI4MjEwMzY0LzEwNzAyNDQKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxVbmtub3duRWxlbWVudCB8fCBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxFbGVtZW50OwogIH0gZWxzZSB7CiAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddID0gL0hUTUxVbmtub3duRWxlbWVudC8udGVzdChlbC50b1N0cmluZygpKTsKICB9Cn0KCnZhciBpc1RleHRJbnB1dFR5cGUgPSBtYWtlTWFwKCd0ZXh0LG51bWJlcixwYXNzd29yZCxzZWFyY2gsZW1haWwsdGVsLHVybCcpOwovKiAgKi8KCi8qKgogKiBRdWVyeSBhbiBlbGVtZW50IHNlbGVjdG9yIGlmIGl0J3Mgbm90IGFuIGVsZW1lbnQgYWxyZWFkeS4KICovCgpmdW5jdGlvbiBxdWVyeShlbCkgewogIGlmICh0eXBlb2YgZWwgPT09ICdzdHJpbmcnKSB7CiAgICB2YXIgc2VsZWN0ZWQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGVsKTsKCiAgICBpZiAoIXNlbGVjdGVkKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignQ2Fubm90IGZpbmQgZWxlbWVudDogJyArIGVsKTsKICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgfQoKICAgIHJldHVybiBzZWxlY3RlZDsKICB9IGVsc2UgewogICAgcmV0dXJuIGVsOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEodGFnTmFtZSwgdm5vZGUpIHsKICB2YXIgZWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKCiAgaWYgKHRhZ05hbWUgIT09ICdzZWxlY3QnKSB7CiAgICByZXR1cm4gZWxtOwogIH0gLy8gZmFsc2Ugb3IgbnVsbCB3aWxsIHJlbW92ZSB0aGUgYXR0cmlidXRlIGJ1dCB1bmRlZmluZWQgd2lsbCBub3QKCgogIGlmICh2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEuYXR0cnMgJiYgdm5vZGUuZGF0YS5hdHRycy5tdWx0aXBsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBlbG0uc2V0QXR0cmlidXRlKCdtdWx0aXBsZScsICdtdWx0aXBsZScpOwogIH0KCiAgcmV0dXJuIGVsbTsKfQoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZSwgdGFnTmFtZSkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlTWFwW25hbWVzcGFjZV0sIHRhZ05hbWUpOwp9CgpmdW5jdGlvbiBjcmVhdGVUZXh0Tm9kZSh0ZXh0KSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21tZW50KHRleHQpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0ZXh0KTsKfQoKZnVuY3Rpb24gaW5zZXJ0QmVmb3JlKHBhcmVudE5vZGUsIG5ld05vZGUsIHJlZmVyZW5jZU5vZGUpIHsKICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdOb2RlLCByZWZlcmVuY2VOb2RlKTsKfQoKZnVuY3Rpb24gcmVtb3ZlQ2hpbGQobm9kZSwgY2hpbGQpIHsKICBub2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKfQoKZnVuY3Rpb24gYXBwZW5kQ2hpbGQobm9kZSwgY2hpbGQpIHsKICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKfQoKZnVuY3Rpb24gcGFyZW50Tm9kZShub2RlKSB7CiAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZTsKfQoKZnVuY3Rpb24gbmV4dFNpYmxpbmcobm9kZSkgewogIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwp9CgpmdW5jdGlvbiB0YWdOYW1lKG5vZGUpIHsKICByZXR1cm4gbm9kZS50YWdOYW1lOwp9CgpmdW5jdGlvbiBzZXRUZXh0Q29udGVudChub2RlLCB0ZXh0KSB7CiAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7Cn0KCmZ1bmN0aW9uIHNldFN0eWxlU2NvcGUobm9kZSwgc2NvcGVJZCkgewogIG5vZGUuc2V0QXR0cmlidXRlKHNjb3BlSWQsICcnKTsKfQoKdmFyIG5vZGVPcHMgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CiAgY3JlYXRlRWxlbWVudDogY3JlYXRlRWxlbWVudCQxLAogIGNyZWF0ZUVsZW1lbnROUzogY3JlYXRlRWxlbWVudE5TLAogIGNyZWF0ZVRleHROb2RlOiBjcmVhdGVUZXh0Tm9kZSwKICBjcmVhdGVDb21tZW50OiBjcmVhdGVDb21tZW50LAogIGluc2VydEJlZm9yZTogaW5zZXJ0QmVmb3JlLAogIHJlbW92ZUNoaWxkOiByZW1vdmVDaGlsZCwKICBhcHBlbmRDaGlsZDogYXBwZW5kQ2hpbGQsCiAgcGFyZW50Tm9kZTogcGFyZW50Tm9kZSwKICBuZXh0U2libGluZzogbmV4dFNpYmxpbmcsCiAgdGFnTmFtZTogdGFnTmFtZSwKICBzZXRUZXh0Q29udGVudDogc2V0VGV4dENvbnRlbnQsCiAgc2V0U3R5bGVTY29wZTogc2V0U3R5bGVTY29wZQp9KTsKLyogICovCgp2YXIgcmVmID0gewogIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKF8sIHZub2RlKSB7CiAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvbGRWbm9kZSwgdm5vZGUpIHsKICAgIGlmIChvbGRWbm9kZS5kYXRhLnJlZiAhPT0gdm5vZGUuZGF0YS5yZWYpIHsKICAgICAgcmVnaXN0ZXJSZWYob2xkVm5vZGUsIHRydWUpOwogICAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgICB9CiAgfSwKICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KHZub2RlKSB7CiAgICByZWdpc3RlclJlZih2bm9kZSwgdHJ1ZSk7CiAgfQp9OwoKZnVuY3Rpb24gcmVnaXN0ZXJSZWYodm5vZGUsIGlzUmVtb3ZhbCkgewogIHZhciBrZXkgPSB2bm9kZS5kYXRhLnJlZjsKCiAgaWYgKCFpc0RlZihrZXkpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdm0gPSB2bm9kZS5jb250ZXh0OwogIHZhciByZWYgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSB8fCB2bm9kZS5lbG07CiAgdmFyIHJlZnMgPSB2bS4kcmVmczsKCiAgaWYgKGlzUmVtb3ZhbCkgewogICAgaWYgKEFycmF5LmlzQXJyYXkocmVmc1trZXldKSkgewogICAgICByZW1vdmUocmVmc1trZXldLCByZWYpOwogICAgfSBlbHNlIGlmIChyZWZzW2tleV0gPT09IHJlZikgewogICAgICByZWZzW2tleV0gPSB1bmRlZmluZWQ7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmICh2bm9kZS5kYXRhLnJlZkluRm9yKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZWZzW2tleV0pKSB7CiAgICAgICAgcmVmc1trZXldID0gW3JlZl07CiAgICAgIH0gZWxzZSBpZiAocmVmc1trZXldLmluZGV4T2YocmVmKSA8IDApIHsKICAgICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgICByZWZzW2tleV0ucHVzaChyZWYpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZWZzW2tleV0gPSByZWY7CiAgICB9CiAgfQp9Ci8qKgogKiBWaXJ0dWFsIERPTSBwYXRjaGluZyBhbGdvcml0aG0gYmFzZWQgb24gU25hYmJkb20gYnkKICogU2ltb24gRnJpaXMgVmluZHVtIChAcGFsZGVwaW5kKQogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UKICogaHR0cHM6Ly9naXRodWIuY29tL3BhbGRlcGluZC9zbmFiYmRvbS9ibG9iL21hc3Rlci9MSUNFTlNFCiAqCiAqIG1vZGlmaWVkIGJ5IEV2YW4gWW91IChAeXl4OTkwODAzKQogKgogKiBOb3QgdHlwZS1jaGVja2luZyB0aGlzIGJlY2F1c2UgdGhpcyBmaWxlIGlzIHBlcmYtY3JpdGljYWwgYW5kIHRoZSBjb3N0CiAqIG9mIG1ha2luZyBmbG93IHVuZGVyc3RhbmQgaXQgaXMgbm90IHdvcnRoIGl0LgogKi8KCgp2YXIgZW1wdHlOb2RlID0gbmV3IFZOb2RlKCcnLCB7fSwgW10pOwp2YXIgaG9va3MgPSBbJ2NyZWF0ZScsICdhY3RpdmF0ZScsICd1cGRhdGUnLCAncmVtb3ZlJywgJ2Rlc3Ryb3knXTsKCmZ1bmN0aW9uIHNhbWVWbm9kZShhLCBiKSB7CiAgcmV0dXJuIGEua2V5ID09PSBiLmtleSAmJiBhLmFzeW5jRmFjdG9yeSA9PT0gYi5hc3luY0ZhY3RvcnkgJiYgKGEudGFnID09PSBiLnRhZyAmJiBhLmlzQ29tbWVudCA9PT0gYi5pc0NvbW1lbnQgJiYgaXNEZWYoYS5kYXRhKSA9PT0gaXNEZWYoYi5kYXRhKSAmJiBzYW1lSW5wdXRUeXBlKGEsIGIpIHx8IGlzVHJ1ZShhLmlzQXN5bmNQbGFjZWhvbGRlcikgJiYgaXNVbmRlZihiLmFzeW5jRmFjdG9yeS5lcnJvcikpOwp9CgpmdW5jdGlvbiBzYW1lSW5wdXRUeXBlKGEsIGIpIHsKICBpZiAoYS50YWcgIT09ICdpbnB1dCcpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIGk7CiAgdmFyIHR5cGVBID0gaXNEZWYoaSA9IGEuZGF0YSkgJiYgaXNEZWYoaSA9IGkuYXR0cnMpICYmIGkudHlwZTsKICB2YXIgdHlwZUIgPSBpc0RlZihpID0gYi5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogIHJldHVybiB0eXBlQSA9PT0gdHlwZUIgfHwgaXNUZXh0SW5wdXRUeXBlKHR5cGVBKSAmJiBpc1RleHRJbnB1dFR5cGUodHlwZUIpOwp9CgpmdW5jdGlvbiBjcmVhdGVLZXlUb09sZElkeChjaGlsZHJlbiwgYmVnaW5JZHgsIGVuZElkeCkgewogIHZhciBpLCBrZXk7CiAgdmFyIG1hcCA9IHt9OwoKICBmb3IgKGkgPSBiZWdpbklkeDsgaSA8PSBlbmRJZHg7ICsraSkgewogICAga2V5ID0gY2hpbGRyZW5baV0ua2V5OwoKICAgIGlmIChpc0RlZihrZXkpKSB7CiAgICAgIG1hcFtrZXldID0gaTsKICAgIH0KICB9CgogIHJldHVybiBtYXA7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVBhdGNoRnVuY3Rpb24oYmFja2VuZCkgewogIHZhciBpLCBqOwogIHZhciBjYnMgPSB7fTsKICB2YXIgbW9kdWxlcyA9IGJhY2tlbmQubW9kdWxlczsKICB2YXIgbm9kZU9wcyA9IGJhY2tlbmQubm9kZU9wczsKCiAgZm9yIChpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgKytpKSB7CiAgICBjYnNbaG9va3NbaV1dID0gW107CgogICAgZm9yIChqID0gMDsgaiA8IG1vZHVsZXMubGVuZ3RoOyArK2opIHsKICAgICAgaWYgKGlzRGVmKG1vZHVsZXNbal1baG9va3NbaV1dKSkgewogICAgICAgIGNic1tob29rc1tpXV0ucHVzaChtb2R1bGVzW2pdW2hvb2tzW2ldXSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGVtcHR5Tm9kZUF0KGVsbSkgewogICAgcmV0dXJuIG5ldyBWTm9kZShub2RlT3BzLnRhZ05hbWUoZWxtKS50b0xvd2VyQ2FzZSgpLCB7fSwgW10sIHVuZGVmaW5lZCwgZWxtKTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVJtQ2IoY2hpbGRFbG0sIGxpc3RlbmVycykgewogICAgZnVuY3Rpb24gcmVtb3ZlJCQxKCkgewogICAgICBpZiAoLS1yZW1vdmUkJDEubGlzdGVuZXJzID09PSAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZShjaGlsZEVsbSk7CiAgICAgIH0KICAgIH0KCiAgICByZW1vdmUkJDEubGlzdGVuZXJzID0gbGlzdGVuZXJzOwogICAgcmV0dXJuIHJlbW92ZSQkMTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZU5vZGUoZWwpIHsKICAgIHZhciBwYXJlbnQgPSBub2RlT3BzLnBhcmVudE5vZGUoZWwpOyAvLyBlbGVtZW50IG1heSBoYXZlIGFscmVhZHkgYmVlbiByZW1vdmVkIGR1ZSB0byB2LWh0bWwgLyB2LXRleHQKCiAgICBpZiAoaXNEZWYocGFyZW50KSkgewogICAgICBub2RlT3BzLnJlbW92ZUNoaWxkKHBhcmVudCwgZWwpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgaW5WUHJlKSB7CiAgICByZXR1cm4gIWluVlByZSAmJiAhdm5vZGUubnMgJiYgIShjb25maWcuaWdub3JlZEVsZW1lbnRzLmxlbmd0aCAmJiBjb25maWcuaWdub3JlZEVsZW1lbnRzLnNvbWUoZnVuY3Rpb24gKGlnbm9yZSkgewogICAgICByZXR1cm4gaXNSZWdFeHAoaWdub3JlKSA/IGlnbm9yZS50ZXN0KHZub2RlLnRhZykgOiBpZ25vcmUgPT09IHZub2RlLnRhZzsKICAgIH0pKSAmJiBjb25maWcuaXNVbmtub3duRWxlbWVudCh2bm9kZS50YWcpOwogIH0KCiAgdmFyIGNyZWF0aW5nRWxtSW5WUHJlID0gMDsKCiAgZnVuY3Rpb24gY3JlYXRlRWxtKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtLCBuZXN0ZWQsIG93bmVyQXJyYXksIGluZGV4KSB7CiAgICBpZiAoaXNEZWYodm5vZGUuZWxtKSAmJiBpc0RlZihvd25lckFycmF5KSkgewogICAgICAvLyBUaGlzIHZub2RlIHdhcyB1c2VkIGluIGEgcHJldmlvdXMgcmVuZGVyIQogICAgICAvLyBub3cgaXQncyB1c2VkIGFzIGEgbmV3IG5vZGUsIG92ZXJ3cml0aW5nIGl0cyBlbG0gd291bGQgY2F1c2UKICAgICAgLy8gcG90ZW50aWFsIHBhdGNoIGVycm9ycyBkb3duIHRoZSByb2FkIHdoZW4gaXQncyB1c2VkIGFzIGFuIGluc2VydGlvbgogICAgICAvLyByZWZlcmVuY2Ugbm9kZS4gSW5zdGVhZCwgd2UgY2xvbmUgdGhlIG5vZGUgb24tZGVtYW5kIGJlZm9yZSBjcmVhdGluZwogICAgICAvLyBhc3NvY2lhdGVkIERPTSBlbGVtZW50IGZvciBpdC4KICAgICAgdm5vZGUgPSBvd25lckFycmF5W2luZGV4XSA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgfQoKICAgIHZub2RlLmlzUm9vdEluc2VydCA9ICFuZXN0ZWQ7IC8vIGZvciB0cmFuc2l0aW9uIGVudGVyIGNoZWNrCgogICAgaWYgKGNyZWF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICAgIHZhciBjaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgdmFyIHRhZyA9IHZub2RlLnRhZzsKCiAgICBpZiAoaXNEZWYodGFnKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEucHJlKSB7CiAgICAgICAgICBjcmVhdGluZ0VsbUluVlByZSsrOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzVW5rbm93bkVsZW1lbnQkJDEodm5vZGUsIGNyZWF0aW5nRWxtSW5WUHJlKSkgewogICAgICAgICAgd2FybignVW5rbm93biBjdXN0b20gZWxlbWVudDogPCcgKyB0YWcgKyAnPiAtIGRpZCB5b3UgJyArICdyZWdpc3RlciB0aGUgY29tcG9uZW50IGNvcnJlY3RseT8gRm9yIHJlY3Vyc2l2ZSBjb21wb25lbnRzLCAnICsgJ21ha2Ugc3VyZSB0byBwcm92aWRlIHRoZSAibmFtZSIgb3B0aW9uLicsIHZub2RlLmNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdm5vZGUuZWxtID0gdm5vZGUubnMgPyBub2RlT3BzLmNyZWF0ZUVsZW1lbnROUyh2bm9kZS5ucywgdGFnKSA6IG5vZGVPcHMuY3JlYXRlRWxlbWVudCh0YWcsIHZub2RlKTsKICAgICAgc2V0U2NvcGUodm5vZGUpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICAgIHsKICAgICAgICBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSk7CgogICAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgfQoKICAgICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICAgIH0KCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICBjcmVhdGluZ0VsbUluVlByZS0tOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgIHZub2RlLmVsbSA9IG5vZGVPcHMuY3JlYXRlQ29tbWVudCh2bm9kZS50ZXh0KTsKICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgfSBlbHNlIHsKICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVUZXh0Tm9kZSh2bm9kZS50ZXh0KTsKICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSB7CiAgICB2YXIgaSA9IHZub2RlLmRhdGE7CgogICAgaWYgKGlzRGVmKGkpKSB7CiAgICAgIHZhciBpc1JlYWN0aXZhdGVkID0gaXNEZWYodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGkua2VlcEFsaXZlOwoKICAgICAgaWYgKGlzRGVmKGkgPSBpLmhvb2spICYmIGlzRGVmKGkgPSBpLmluaXQpKSB7CiAgICAgICAgaSh2bm9kZSwgZmFsc2UKICAgICAgICAvKiBoeWRyYXRpbmcgKi8KICAgICAgICApOwogICAgICB9IC8vIGFmdGVyIGNhbGxpbmcgdGhlIGluaXQgaG9vaywgaWYgdGhlIHZub2RlIGlzIGEgY2hpbGQgY29tcG9uZW50CiAgICAgIC8vIGl0IHNob3VsZCd2ZSBjcmVhdGVkIGEgY2hpbGQgaW5zdGFuY2UgYW5kIG1vdW50ZWQgaXQuIHRoZSBjaGlsZAogICAgICAvLyBjb21wb25lbnQgYWxzbyBoYXMgc2V0IHRoZSBwbGFjZWhvbGRlciB2bm9kZSdzIGVsbS4KICAgICAgLy8gaW4gdGhhdCBjYXNlIHdlIGNhbiBqdXN0IHJldHVybiB0aGUgZWxlbWVudCBhbmQgYmUgZG9uZS4KCgogICAgICBpZiAoaXNEZWYodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgICAgaW5pdENvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CgogICAgICAgIGlmIChpc1RydWUoaXNSZWFjdGl2YXRlZCkpIHsKICAgICAgICAgIHJlYWN0aXZhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgaWYgKGlzRGVmKHZub2RlLmRhdGEucGVuZGluZ0luc2VydCkpIHsKICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2guYXBwbHkoaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQpOwogICAgICB2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQgPSBudWxsOwogICAgfQoKICAgIHZub2RlLmVsbSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlLiRlbDsKCiAgICBpZiAoaXNQYXRjaGFibGUodm5vZGUpKSB7CiAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICBzZXRTY29wZSh2bm9kZSk7CiAgICB9IGVsc2UgewogICAgICAvLyBlbXB0eSBjb21wb25lbnQgcm9vdC4KICAgICAgLy8gc2tpcCBhbGwgZWxlbWVudC1yZWxhdGVkIG1vZHVsZXMgZXhjZXB0IGZvciByZWYgKCMzNDU1KQogICAgICByZWdpc3RlclJlZih2bm9kZSk7IC8vIG1ha2Ugc3VyZSB0byBpbnZva2UgdGhlIGluc2VydCBob29rCgogICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaCh2bm9kZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSB7CiAgICB2YXIgaTsgLy8gaGFjayBmb3IgIzQzMzk6IGEgcmVhY3RpdmF0ZWQgY29tcG9uZW50IHdpdGggaW5uZXIgdHJhbnNpdGlvbgogICAgLy8gZG9lcyBub3QgdHJpZ2dlciBiZWNhdXNlIHRoZSBpbm5lciBub2RlJ3MgY3JlYXRlZCBob29rcyBhcmUgbm90IGNhbGxlZAogICAgLy8gYWdhaW4uIEl0J3Mgbm90IGlkZWFsIHRvIGludm9sdmUgbW9kdWxlLXNwZWNpZmljIGxvZ2ljIGluIGhlcmUgYnV0CiAgICAvLyB0aGVyZSBkb2Vzbid0IHNlZW0gdG8gYmUgYSBiZXR0ZXIgd2F5IHRvIGRvIGl0LgoKICAgIHZhciBpbm5lck5vZGUgPSB2bm9kZTsKCiAgICB3aGlsZSAoaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgIGlubmVyTm9kZSA9IGlubmVyTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CgogICAgICBpZiAoaXNEZWYoaSA9IGlubmVyTm9kZS5kYXRhKSAmJiBpc0RlZihpID0gaS50cmFuc2l0aW9uKSkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMuYWN0aXZhdGUubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNicy5hY3RpdmF0ZVtpXShlbXB0eU5vZGUsIGlubmVyTm9kZSk7CiAgICAgICAgfQoKICAgICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaChpbm5lck5vZGUpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9IC8vIHVubGlrZSBhIG5ld2x5IGNyZWF0ZWQgY29tcG9uZW50LAogICAgLy8gYSByZWFjdGl2YXRlZCBrZWVwLWFsaXZlIGNvbXBvbmVudCBkb2Vzbid0IGluc2VydCBpdHNlbGYKCgogICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogIH0KCiAgZnVuY3Rpb24gaW5zZXJ0KHBhcmVudCwgZWxtLCByZWYkJDEpIHsKICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgIGlmIChpc0RlZihyZWYkJDEpKSB7CiAgICAgICAgaWYgKG5vZGVPcHMucGFyZW50Tm9kZShyZWYkJDEpID09PSBwYXJlbnQpIHsKICAgICAgICAgIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudCwgZWxtLCByZWYkJDEpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHBhcmVudCwgZWxtKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhjaGlsZHJlbik7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyArK2kpIHsKICAgICAgICBjcmVhdGVFbG0oY2hpbGRyZW5baV0sIGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZWxtLCBudWxsLCB0cnVlLCBjaGlsZHJlbiwgaSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUodm5vZGUudGV4dCkpIHsKICAgICAgbm9kZU9wcy5hcHBlbmRDaGlsZCh2bm9kZS5lbG0sIG5vZGVPcHMuY3JlYXRlVGV4dE5vZGUoU3RyaW5nKHZub2RlLnRleHQpKSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1BhdGNoYWJsZSh2bm9kZSkgewogICAgd2hpbGUgKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgIHZub2RlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwogICAgfQoKICAgIHJldHVybiBpc0RlZih2bm9kZS50YWcpOwogIH0KCiAgZnVuY3Rpb24gaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2JzLmNyZWF0ZS5sZW5ndGg7ICsraSQxKSB7CiAgICAgIGNicy5jcmVhdGVbaSQxXShlbXB0eU5vZGUsIHZub2RlKTsKICAgIH0KCiAgICBpID0gdm5vZGUuZGF0YS5ob29rOyAvLyBSZXVzZSB2YXJpYWJsZQoKICAgIGlmIChpc0RlZihpKSkgewogICAgICBpZiAoaXNEZWYoaS5jcmVhdGUpKSB7CiAgICAgICAgaS5jcmVhdGUoZW1wdHlOb2RlLCB2bm9kZSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpLmluc2VydCkpIHsKICAgICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaCh2bm9kZSk7CiAgICAgIH0KICAgIH0KICB9IC8vIHNldCBzY29wZSBpZCBhdHRyaWJ1dGUgZm9yIHNjb3BlZCBDU1MuCiAgLy8gdGhpcyBpcyBpbXBsZW1lbnRlZCBhcyBhIHNwZWNpYWwgY2FzZSB0byBhdm9pZCB0aGUgb3ZlcmhlYWQKICAvLyBvZiBnb2luZyB0aHJvdWdoIHRoZSBub3JtYWwgYXR0cmlidXRlIHBhdGNoaW5nIHByb2Nlc3MuCgoKICBmdW5jdGlvbiBzZXRTY29wZSh2bm9kZSkgewogICAgdmFyIGk7CgogICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5mblNjb3BlSWQpKSB7CiAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGFuY2VzdG9yID0gdm5vZGU7CgogICAgICB3aGlsZSAoYW5jZXN0b3IpIHsKICAgICAgICBpZiAoaXNEZWYoaSA9IGFuY2VzdG9yLmNvbnRleHQpICYmIGlzRGVmKGkgPSBpLiRvcHRpb25zLl9zY29wZUlkKSkgewogICAgICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICAgICAgfQoKICAgICAgICBhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudDsKICAgICAgfQogICAgfSAvLyBmb3Igc2xvdCBjb250ZW50IHRoZXkgc2hvdWxkIGFsc28gZ2V0IHRoZSBzY29wZUlkIGZyb20gdGhlIGhvc3QgaW5zdGFuY2UuCgoKICAgIGlmIChpc0RlZihpID0gYWN0aXZlSW5zdGFuY2UpICYmIGkgIT09IHZub2RlLmNvbnRleHQgJiYgaSAhPT0gdm5vZGUuZm5Db250ZXh0ICYmIGlzRGVmKGkgPSBpLiRvcHRpb25zLl9zY29wZUlkKSkgewogICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFkZFZub2RlcyhwYXJlbnRFbG0sIHJlZkVsbSwgdm5vZGVzLCBzdGFydElkeCwgZW5kSWR4LCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGZvciAoOyBzdGFydElkeCA8PSBlbmRJZHg7ICsrc3RhcnRJZHgpIHsKICAgICAgY3JlYXRlRWxtKHZub2Rlc1tzdGFydElkeF0sIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIGZhbHNlLCB2bm9kZXMsIHN0YXJ0SWR4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGludm9rZURlc3Ryb3lIb29rKHZub2RlKSB7CiAgICB2YXIgaSwgajsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKCiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLmRlc3Ryb3kpKSB7CiAgICAgICAgaSh2bm9kZSk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMuZGVzdHJveS5sZW5ndGg7ICsraSkgewogICAgICAgIGNicy5kZXN0cm95W2ldKHZub2RlKTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlZihpID0gdm5vZGUuY2hpbGRyZW4pKSB7CiAgICAgIGZvciAoaiA9IDA7IGogPCB2bm9kZS5jaGlsZHJlbi5sZW5ndGg7ICsraikgewogICAgICAgIGludm9rZURlc3Ryb3lIb29rKHZub2RlLmNoaWxkcmVuW2pdKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVm5vZGVzKHZub2Rlcywgc3RhcnRJZHgsIGVuZElkeCkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICB2YXIgY2ggPSB2bm9kZXNbc3RhcnRJZHhdOwoKICAgICAgaWYgKGlzRGVmKGNoKSkgewogICAgICAgIGlmIChpc0RlZihjaC50YWcpKSB7CiAgICAgICAgICByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKGNoKTsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKGNoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVGV4dCBub2RlCiAgICAgICAgICByZW1vdmVOb2RlKGNoLmVsbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKHZub2RlLCBybSkgewogICAgaWYgKGlzRGVmKHJtKSB8fCBpc0RlZih2bm9kZS5kYXRhKSkgewogICAgICB2YXIgaTsKICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKCiAgICAgIGlmIChpc0RlZihybSkpIHsKICAgICAgICAvLyB3ZSBoYXZlIGEgcmVjdXJzaXZlbHkgcGFzc2VkIGRvd24gcm0gY2FsbGJhY2sKICAgICAgICAvLyBpbmNyZWFzZSB0aGUgbGlzdGVuZXJzIGNvdW50CiAgICAgICAgcm0ubGlzdGVuZXJzICs9IGxpc3RlbmVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkaXJlY3RseSByZW1vdmluZwogICAgICAgIHJtID0gY3JlYXRlUm1DYih2bm9kZS5lbG0sIGxpc3RlbmVycyk7CiAgICAgIH0gLy8gcmVjdXJzaXZlbHkgaW52b2tlIGhvb2tzIG9uIGNoaWxkIGNvbXBvbmVudCByb290IG5vZGUKCgogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpc0RlZihpID0gaS5fdm5vZGUpICYmIGlzRGVmKGkuZGF0YSkpIHsKICAgICAgICByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKGksIHJtKTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5yZW1vdmUubGVuZ3RoOyArK2kpIHsKICAgICAgICBjYnMucmVtb3ZlW2ldKHZub2RlLCBybSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5yZW1vdmUpKSB7CiAgICAgICAgaSh2bm9kZSwgcm0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJtKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlbW92ZU5vZGUodm5vZGUuZWxtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUNoaWxkcmVuKHBhcmVudEVsbSwgb2xkQ2gsIG5ld0NoLCBpbnNlcnRlZFZub2RlUXVldWUsIHJlbW92ZU9ubHkpIHsKICAgIHZhciBvbGRTdGFydElkeCA9IDA7CiAgICB2YXIgbmV3U3RhcnRJZHggPSAwOwogICAgdmFyIG9sZEVuZElkeCA9IG9sZENoLmxlbmd0aCAtIDE7CiAgICB2YXIgb2xkU3RhcnRWbm9kZSA9IG9sZENoWzBdOwogICAgdmFyIG9sZEVuZFZub2RlID0gb2xkQ2hbb2xkRW5kSWR4XTsKICAgIHZhciBuZXdFbmRJZHggPSBuZXdDaC5sZW5ndGggLSAxOwogICAgdmFyIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFswXTsKICAgIHZhciBuZXdFbmRWbm9kZSA9IG5ld0NoW25ld0VuZElkeF07CiAgICB2YXIgb2xkS2V5VG9JZHgsIGlkeEluT2xkLCB2bm9kZVRvTW92ZSwgcmVmRWxtOyAvLyByZW1vdmVPbmx5IGlzIGEgc3BlY2lhbCBmbGFnIHVzZWQgb25seSBieSA8dHJhbnNpdGlvbi1ncm91cD4KICAgIC8vIHRvIGVuc3VyZSByZW1vdmVkIGVsZW1lbnRzIHN0YXkgaW4gY29ycmVjdCByZWxhdGl2ZSBwb3NpdGlvbnMKICAgIC8vIGR1cmluZyBsZWF2aW5nIHRyYW5zaXRpb25zCgogICAgdmFyIGNhbk1vdmUgPSAhcmVtb3ZlT25seTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBjaGVja0R1cGxpY2F0ZUtleXMobmV3Q2gpOwogICAgfQoKICAgIHdoaWxlIChvbGRTdGFydElkeCA8PSBvbGRFbmRJZHggJiYgbmV3U3RhcnRJZHggPD0gbmV3RW5kSWR4KSB7CiAgICAgIGlmIChpc1VuZGVmKG9sZFN0YXJ0Vm5vZGUpKSB7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOyAvLyBWbm9kZSBoYXMgYmVlbiBtb3ZlZCBsZWZ0CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGRFbmRWbm9kZSkpIHsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICBwYXRjaFZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUpKSB7CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgbmV3RW5kVm5vZGUgPSBuZXdDaFstLW5ld0VuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld0VuZFZub2RlKSkgewogICAgICAgIC8vIFZub2RlIG1vdmVkIHJpZ2h0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3RW5kSWR4KTsKICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRW5kVm5vZGUuZWxtKSk7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgIG5ld0VuZFZub2RlID0gbmV3Q2hbLS1uZXdFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAvLyBWbm9kZSBtb3ZlZCBsZWZ0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCBvbGRFbmRWbm9kZS5lbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtKTsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzVW5kZWYob2xkS2V5VG9JZHgpKSB7CiAgICAgICAgICBvbGRLZXlUb0lkeCA9IGNyZWF0ZUtleVRvT2xkSWR4KG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgICAgICB9CgogICAgICAgIGlkeEluT2xkID0gaXNEZWYobmV3U3RhcnRWbm9kZS5rZXkpID8gb2xkS2V5VG9JZHhbbmV3U3RhcnRWbm9kZS5rZXldIDogZmluZElkeEluT2xkKG5ld1N0YXJ0Vm5vZGUsIG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKCiAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7CiAgICAgICAgICAvLyBOZXcgZWxlbWVudAogICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZub2RlVG9Nb3ZlID0gb2xkQ2hbaWR4SW5PbGRdOwoKICAgICAgICAgIGlmIChzYW1lVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgICAgIHBhdGNoVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICAgICAgb2xkQ2hbaWR4SW5PbGRdID0gdW5kZWZpbmVkOwogICAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgdm5vZGVUb01vdmUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzYW1lIGtleSBidXQgZGlmZmVyZW50IGVsZW1lbnQuIHRyZWF0IGFzIG5ldyBlbGVtZW50CiAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9CiAgICB9CgogICAgaWYgKG9sZFN0YXJ0SWR4ID4gb2xkRW5kSWR4KSB7CiAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCBuZXdDaCwgbmV3U3RhcnRJZHgsIG5ld0VuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSBpZiAobmV3U3RhcnRJZHggPiBuZXdFbmRJZHgpIHsKICAgICAgcmVtb3ZlVm5vZGVzKG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRHVwbGljYXRlS2V5cyhjaGlsZHJlbikgewogICAgdmFyIHNlZW5LZXlzID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgdm5vZGUgPSBjaGlsZHJlbltpXTsKICAgICAgdmFyIGtleSA9IHZub2RlLmtleTsKCiAgICAgIGlmIChpc0RlZihrZXkpKSB7CiAgICAgICAgaWYgKHNlZW5LZXlzW2tleV0pIHsKICAgICAgICAgIHdhcm4oIkR1cGxpY2F0ZSBrZXlzIGRldGVjdGVkOiAnIiArIGtleSArICInLiBUaGlzIG1heSBjYXVzZSBhbiB1cGRhdGUgZXJyb3IuIiwgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlZW5LZXlzW2tleV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZElkeEluT2xkKG5vZGUsIG9sZENoLCBzdGFydCwgZW5kKSB7CiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICB2YXIgYyA9IG9sZENoW2ldOwoKICAgICAgaWYgKGlzRGVmKGMpICYmIHNhbWVWbm9kZShub2RlLCBjKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwYXRjaFZub2RlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBvd25lckFycmF5LCBpbmRleCwgcmVtb3ZlT25seSkgewogICAgaWYgKG9sZFZub2RlID09PSB2bm9kZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgLy8gY2xvbmUgcmV1c2VkIHZub2RlCiAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgIH0KCiAgICB2YXIgZWxtID0gdm5vZGUuZWxtID0gb2xkVm5vZGUuZWxtOwoKICAgIGlmIChpc1RydWUob2xkVm5vZGUuaXNBc3luY1BsYWNlaG9sZGVyKSkgewogICAgICBpZiAoaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgIGh5ZHJhdGUob2xkVm5vZGUuZWxtLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9IC8vIHJldXNlIGVsZW1lbnQgZm9yIHN0YXRpYyB0cmVlcy4KICAgIC8vIG5vdGUgd2Ugb25seSBkbyB0aGlzIGlmIHRoZSB2bm9kZSBpcyBjbG9uZWQgLQogICAgLy8gaWYgdGhlIG5ldyBub2RlIGlzIG5vdCBjbG9uZWQgaXQgbWVhbnMgdGhlIHJlbmRlciBmdW5jdGlvbnMgaGF2ZSBiZWVuCiAgICAvLyByZXNldCBieSB0aGUgaG90LXJlbG9hZC1hcGkgYW5kIHdlIG5lZWQgdG8gZG8gYSBwcm9wZXIgcmUtcmVuZGVyLgoKCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzU3RhdGljKSAmJiBpc1RydWUob2xkVm5vZGUuaXNTdGF0aWMpICYmIHZub2RlLmtleSA9PT0gb2xkVm5vZGUua2V5ICYmIChpc1RydWUodm5vZGUuaXNDbG9uZWQpIHx8IGlzVHJ1ZSh2bm9kZS5pc09uY2UpKSkgewogICAgICB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IG9sZFZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGk7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CgogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnByZXBhdGNoKSkgewogICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICB9CgogICAgdmFyIG9sZENoID0gb2xkVm5vZGUuY2hpbGRyZW47CiAgICB2YXIgY2ggPSB2bm9kZS5jaGlsZHJlbjsKCiAgICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNQYXRjaGFibGUodm5vZGUpKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMudXBkYXRlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgY2JzLnVwZGF0ZVtpXShvbGRWbm9kZSwgdm5vZGUpOwogICAgICB9CgogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkudXBkYXRlKSkgewogICAgICAgIGkob2xkVm5vZGUsIHZub2RlKTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc1VuZGVmKHZub2RlLnRleHQpKSB7CiAgICAgIGlmIChpc0RlZihvbGRDaCkgJiYgaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKG9sZENoICE9PSBjaCkgewogICAgICAgICAgdXBkYXRlQ2hpbGRyZW4oZWxtLCBvbGRDaCwgY2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzRGVmKGNoKSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2gpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7CiAgICAgICAgICBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgJycpOwogICAgICAgIH0KCiAgICAgICAgYWRkVm5vZGVzKGVsbSwgbnVsbCwgY2gsIDAsIGNoLmxlbmd0aCAtIDEsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkQ2gpKSB7CiAgICAgICAgcmVtb3ZlVm5vZGVzKG9sZENoLCAwLCBvbGRDaC5sZW5ndGggLSAxKTsKICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRWbm9kZS50ZXh0KSkgewogICAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCAnJyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAob2xkVm5vZGUudGV4dCAhPT0gdm5vZGUudGV4dCkgewogICAgICBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgdm5vZGUudGV4dCk7CiAgICB9CgogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5wb3N0cGF0Y2gpKSB7CiAgICAgICAgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBxdWV1ZSwgaW5pdGlhbCkgewogICAgLy8gZGVsYXkgaW5zZXJ0IGhvb2tzIGZvciBjb21wb25lbnQgcm9vdCBub2RlcywgaW52b2tlIHRoZW0gYWZ0ZXIgdGhlCiAgICAvLyBlbGVtZW50IGlzIHJlYWxseSBpbnNlcnRlZAogICAgaWYgKGlzVHJ1ZShpbml0aWFsKSAmJiBpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgIHZub2RlLnBhcmVudC5kYXRhLnBlbmRpbmdJbnNlcnQgPSBxdWV1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyArK2kpIHsKICAgICAgICBxdWV1ZVtpXS5kYXRhLmhvb2suaW5zZXJ0KHF1ZXVlW2ldKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIGh5ZHJhdGlvbkJhaWxlZCA9IGZhbHNlOyAvLyBsaXN0IG9mIG1vZHVsZXMgdGhhdCBjYW4gc2tpcCBjcmVhdGUgaG9vayBkdXJpbmcgaHlkcmF0aW9uIGJlY2F1c2UgdGhleQogIC8vIGFyZSBhbHJlYWR5IHJlbmRlcmVkIG9uIHRoZSBjbGllbnQgb3IgaGFzIG5vIG5lZWQgZm9yIGluaXRpYWxpemF0aW9uCiAgLy8gTm90ZTogc3R5bGUgaXMgZXhjbHVkZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gaW5pdGlhbCBjbG9uZSBmb3IgZnV0dXJlCiAgLy8gZGVlcCB1cGRhdGVzICgjNzA2MykuCgogIHZhciBpc1JlbmRlcmVkTW9kdWxlID0gbWFrZU1hcCgnYXR0cnMsY2xhc3Msc3RhdGljQ2xhc3Msc3RhdGljU3R5bGUsa2V5Jyk7IC8vIE5vdGU6IHRoaXMgaXMgYSBicm93c2VyLW9ubHkgZnVuY3Rpb24gc28gd2UgY2FuIGFzc3VtZSBlbG1zIGFyZSBET00gbm9kZXMuCgogIGZ1bmN0aW9uIGh5ZHJhdGUoZWxtLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpblZQcmUpIHsKICAgIHZhciBpOwogICAgdmFyIHRhZyA9IHZub2RlLnRhZzsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICAgIHZhciBjaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgaW5WUHJlID0gaW5WUHJlIHx8IGRhdGEgJiYgZGF0YS5wcmU7CiAgICB2bm9kZS5lbG0gPSBlbG07CgogICAgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpICYmIGlzRGVmKHZub2RlLmFzeW5jRmFjdG9yeSkpIHsKICAgICAgdm5vZGUuaXNBc3luY1BsYWNlaG9sZGVyID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IC8vIGFzc2VydCBub2RlIG1hdGNoCgoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmICghYXNzZXJ0Tm9kZU1hdGNoKGVsbSwgdm5vZGUsIGluVlByZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLmluaXQpKSB7CiAgICAgICAgaSh2bm9kZSwgdHJ1ZQogICAgICAgIC8qIGh5ZHJhdGluZyAqLwogICAgICAgICk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgICAgLy8gY2hpbGQgY29tcG9uZW50LiBpdCBzaG91bGQgaGF2ZSBoeWRyYXRlZCBpdHMgb3duIHRyZWUuCiAgICAgICAgaW5pdENvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlZih0YWcpKSB7CiAgICAgIGlmIChpc0RlZihjaGlsZHJlbikpIHsKICAgICAgICAvLyBlbXB0eSBlbGVtZW50LCBhbGxvdyBjbGllbnQgdG8gcGljayB1cCBhbmQgcG9wdWxhdGUgY2hpbGRyZW4KICAgICAgICBpZiAoIWVsbS5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAgIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gdi1odG1sIGFuZCBkb21Qcm9wczogaW5uZXJIVE1MCiAgICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEpICYmIGlzRGVmKGkgPSBpLmRvbVByb3BzKSAmJiBpc0RlZihpID0gaS5pbm5lckhUTUwpKSB7CiAgICAgICAgICAgIGlmIChpICE9PSBlbG0uaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmICFoeWRyYXRpb25CYWlsZWQpIHsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignc2VydmVyIGlubmVySFRNTDogJywgaSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2NsaWVudCBpbm5lckhUTUw6ICcsIGVsbS5pbm5lckhUTUwpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBpdGVyYXRlIGFuZCBjb21wYXJlIGNoaWxkcmVuIGxpc3RzCiAgICAgICAgICAgIHZhciBjaGlsZHJlbk1hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsbS5maXJzdENoaWxkOwoKICAgICAgICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2hpbGRyZW4ubGVuZ3RoOyBpJDErKykgewogICAgICAgICAgICAgIGlmICghY2hpbGROb2RlIHx8ICFoeWRyYXRlKGNoaWxkTm9kZSwgY2hpbGRyZW5baSQxXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpblZQcmUpKSB7CiAgICAgICAgICAgICAgICBjaGlsZHJlbk1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfSAvLyBpZiBjaGlsZE5vZGUgaXMgbm90IG51bGwsIGl0IG1lYW5zIHRoZSBhY3R1YWwgY2hpbGROb2RlcyBsaXN0IGlzCiAgICAgICAgICAgIC8vIGxvbmdlciB0aGFuIHRoZSB2aXJ0dWFsIGNoaWxkcmVuIGxpc3QuCgoKICAgICAgICAgICAgaWYgKCFjaGlsZHJlbk1hdGNoIHx8IGNoaWxkTm9kZSkgewogICAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiAhaHlkcmF0aW9uQmFpbGVkKSB7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25CYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdQYXJlbnQ6ICcsIGVsbSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ01pc21hdGNoaW5nIGNoaWxkTm9kZXMgdnMuIFZOb2RlczogJywgZWxtLmNoaWxkTm9kZXMsIGNoaWxkcmVuKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgdmFyIGZ1bGxJbnZva2UgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgIGlmICghaXNSZW5kZXJlZE1vZHVsZShrZXkpKSB7CiAgICAgICAgICAgIGZ1bGxJbnZva2UgPSB0cnVlOwogICAgICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWZ1bGxJbnZva2UgJiYgZGF0YVsnY2xhc3MnXSkgewogICAgICAgICAgLy8gZW5zdXJlIGNvbGxlY3RpbmcgZGVwcyBmb3IgZGVlcCBjbGFzcyBiaW5kaW5ncyBmb3IgZnV0dXJlIHVwZGF0ZXMKICAgICAgICAgIHRyYXZlcnNlKGRhdGFbJ2NsYXNzJ10pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChlbG0uZGF0YSAhPT0gdm5vZGUudGV4dCkgewogICAgICBlbG0uZGF0YSA9IHZub2RlLnRleHQ7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBhc3NlcnROb2RlTWF0Y2gobm9kZSwgdm5vZGUsIGluVlByZSkgewogICAgaWYgKGlzRGVmKHZub2RlLnRhZykpIHsKICAgICAgcmV0dXJuIHZub2RlLnRhZy5pbmRleE9mKCd2dWUtY29tcG9uZW50JykgPT09IDAgfHwgIWlzVW5rbm93bkVsZW1lbnQkJDEodm5vZGUsIGluVlByZSkgJiYgdm5vZGUudGFnLnRvTG93ZXJDYXNlKCkgPT09IChub2RlLnRhZ05hbWUgJiYgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09ICh2bm9kZS5pc0NvbW1lbnQgPyA4IDogMyk7CiAgICB9CiAgfQoKICByZXR1cm4gZnVuY3Rpb24gcGF0Y2gob2xkVm5vZGUsIHZub2RlLCBoeWRyYXRpbmcsIHJlbW92ZU9ubHkpIHsKICAgIGlmIChpc1VuZGVmKHZub2RlKSkgewogICAgICBpZiAoaXNEZWYob2xkVm5vZGUpKSB7CiAgICAgICAgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGlzSW5pdGlhbFBhdGNoID0gZmFsc2U7CiAgICB2YXIgaW5zZXJ0ZWRWbm9kZVF1ZXVlID0gW107CgogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUpKSB7CiAgICAgIC8vIGVtcHR5IG1vdW50IChsaWtlbHkgYXMgY29tcG9uZW50KSwgY3JlYXRlIG5ldyByb290IGVsZW1lbnQKICAgICAgaXNJbml0aWFsUGF0Y2ggPSB0cnVlOwogICAgICBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgaXNSZWFsRWxlbWVudCA9IGlzRGVmKG9sZFZub2RlLm5vZGVUeXBlKTsKCiAgICAgIGlmICghaXNSZWFsRWxlbWVudCAmJiBzYW1lVm5vZGUob2xkVm5vZGUsIHZub2RlKSkgewogICAgICAgIC8vIHBhdGNoIGV4aXN0aW5nIHJvb3Qgbm9kZQogICAgICAgIHBhdGNoVm5vZGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG51bGwsIG51bGwsIHJlbW92ZU9ubHkpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1JlYWxFbGVtZW50KSB7CiAgICAgICAgICAvLyBtb3VudGluZyB0byBhIHJlYWwgZWxlbWVudAogICAgICAgICAgLy8gY2hlY2sgaWYgdGhpcyBpcyBzZXJ2ZXItcmVuZGVyZWQgY29udGVudCBhbmQgaWYgd2UgY2FuIHBlcmZvcm0KICAgICAgICAgIC8vIGEgc3VjY2Vzc2Z1bCBoeWRyYXRpb24uCiAgICAgICAgICBpZiAob2xkVm5vZGUubm9kZVR5cGUgPT09IDEgJiYgb2xkVm5vZGUuaGFzQXR0cmlidXRlKFNTUl9BVFRSKSkgewogICAgICAgICAgICBvbGRWbm9kZS5yZW1vdmVBdHRyaWJ1dGUoU1NSX0FUVFIpOwogICAgICAgICAgICBoeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc1RydWUoaHlkcmF0aW5nKSkgewogICAgICAgICAgICBpZiAoaHlkcmF0ZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkpIHsKICAgICAgICAgICAgICBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHRydWUpOwogICAgICAgICAgICAgIHJldHVybiBvbGRWbm9kZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICAgICAgd2FybignVGhlIGNsaWVudC1zaWRlIHJlbmRlcmVkIHZpcnR1YWwgRE9NIHRyZWUgaXMgbm90IG1hdGNoaW5nICcgKyAnc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSBpbmNvcnJlY3QgJyArICdIVE1MIG1hcmt1cCwgZm9yIGV4YW1wbGUgbmVzdGluZyBibG9jay1sZXZlbCBlbGVtZW50cyBpbnNpZGUgJyArICc8cD4sIG9yIG1pc3NpbmcgPHRib2R5Pi4gQmFpbGluZyBoeWRyYXRpb24gYW5kIHBlcmZvcm1pbmcgJyArICdmdWxsIGNsaWVudC1zaWRlIHJlbmRlci4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSAvLyBlaXRoZXIgbm90IHNlcnZlci1yZW5kZXJlZCwgb3IgaHlkcmF0aW9uIGZhaWxlZC4KICAgICAgICAgIC8vIGNyZWF0ZSBhbiBlbXB0eSBub2RlIGFuZCByZXBsYWNlIGl0CgoKICAgICAgICAgIG9sZFZub2RlID0gZW1wdHlOb2RlQXQob2xkVm5vZGUpOwogICAgICAgIH0gLy8gcmVwbGFjaW5nIGV4aXN0aW5nIGVsZW1lbnQKCgogICAgICAgIHZhciBvbGRFbG0gPSBvbGRWbm9kZS5lbG07CiAgICAgICAgdmFyIHBhcmVudEVsbSA9IG5vZGVPcHMucGFyZW50Tm9kZShvbGRFbG0pOyAvLyBjcmVhdGUgbmV3IG5vZGUKCiAgICAgICAgY3JlYXRlRWxtKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIC8vIGV4dHJlbWVseSByYXJlIGVkZ2UgY2FzZTogZG8gbm90IGluc2VydCBpZiBvbGQgZWxlbWVudCBpcyBpbiBhCiAgICAgICAgLy8gbGVhdmluZyB0cmFuc2l0aW9uLiBPbmx5IGhhcHBlbnMgd2hlbiBjb21iaW5pbmcgdHJhbnNpdGlvbiArCiAgICAgICAgLy8ga2VlcC1hbGl2ZSArIEhPQ3MuICgjNDU5MCkKICAgICAgICBvbGRFbG0uX2xlYXZlQ2IgPyBudWxsIDogcGFyZW50RWxtLCBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVsbSkpOyAvLyB1cGRhdGUgcGFyZW50IHBsYWNlaG9sZGVyIG5vZGUgZWxlbWVudCwgcmVjdXJzaXZlbHkKCiAgICAgICAgaWYgKGlzRGVmKHZub2RlLnBhcmVudCkpIHsKICAgICAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlLnBhcmVudDsKICAgICAgICAgIHZhciBwYXRjaGFibGUgPSBpc1BhdGNoYWJsZSh2bm9kZSk7CgogICAgICAgICAgd2hpbGUgKGFuY2VzdG9yKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBjYnMuZGVzdHJveVtpXShhbmNlc3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFuY2VzdG9yLmVsbSA9IHZub2RlLmVsbTsKCiAgICAgICAgICAgIGlmIChwYXRjaGFibGUpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBjYnMuY3JlYXRlLmxlbmd0aDsgKytpJDEpIHsKICAgICAgICAgICAgICAgIGNicy5jcmVhdGVbaSQxXShlbXB0eU5vZGUsIGFuY2VzdG9yKTsKICAgICAgICAgICAgICB9IC8vICM2NTEzCiAgICAgICAgICAgICAgLy8gaW52b2tlIGluc2VydCBob29rcyB0aGF0IG1heSBoYXZlIGJlZW4gbWVyZ2VkIGJ5IGNyZWF0ZSBob29rcy4KICAgICAgICAgICAgICAvLyBlLmcuIGZvciBkaXJlY3RpdmVzIHRoYXQgdXNlcyB0aGUgImluc2VydGVkIiBob29rLgoKCiAgICAgICAgICAgICAgdmFyIGluc2VydCA9IGFuY2VzdG9yLmRhdGEuaG9vay5pbnNlcnQ7CgogICAgICAgICAgICAgIGlmIChpbnNlcnQubWVyZ2VkKSB7CiAgICAgICAgICAgICAgICAvLyBzdGFydCBhdCBpbmRleCAxIHRvIGF2b2lkIHJlLWludm9raW5nIGNvbXBvbmVudCBtb3VudGVkIGhvb2sKICAgICAgICAgICAgICAgIGZvciAodmFyIGkkMiA9IDE7IGkkMiA8IGluc2VydC5mbnMubGVuZ3RoOyBpJDIrKykgewogICAgICAgICAgICAgICAgICBpbnNlcnQuZm5zW2kkMl0oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVnaXN0ZXJSZWYoYW5jZXN0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudDsKICAgICAgICAgIH0KICAgICAgICB9IC8vIGRlc3Ryb3kgb2xkIG5vZGUKCgogICAgICAgIGlmIChpc0RlZihwYXJlbnRFbG0pKSB7CiAgICAgICAgICByZW1vdmVWbm9kZXMoW29sZFZub2RlXSwgMCwgMCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRWbm9kZS50YWcpKSB7CiAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhvbGRWbm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpc0luaXRpYWxQYXRjaCk7CiAgICByZXR1cm4gdm5vZGUuZWxtOwogIH07Cn0KLyogICovCgoKdmFyIGRpcmVjdGl2ZXMgPSB7CiAgY3JlYXRlOiB1cGRhdGVEaXJlY3RpdmVzLAogIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICBkZXN0cm95OiBmdW5jdGlvbiB1bmJpbmREaXJlY3RpdmVzKHZub2RlKSB7CiAgICB1cGRhdGVEaXJlY3RpdmVzKHZub2RlLCBlbXB0eU5vZGUpOwogIH0KfTsKCmZ1bmN0aW9uIHVwZGF0ZURpcmVjdGl2ZXMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcyB8fCB2bm9kZS5kYXRhLmRpcmVjdGl2ZXMpIHsKICAgIF91cGRhdGUob2xkVm5vZGUsIHZub2RlKTsKICB9Cn0KCmZ1bmN0aW9uIF91cGRhdGUob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIGlzQ3JlYXRlID0gb2xkVm5vZGUgPT09IGVtcHR5Tm9kZTsKICB2YXIgaXNEZXN0cm95ID0gdm5vZGUgPT09IGVtcHR5Tm9kZTsKICB2YXIgb2xkRGlycyA9IG5vcm1hbGl6ZURpcmVjdGl2ZXMkMShvbGRWbm9kZS5kYXRhLmRpcmVjdGl2ZXMsIG9sZFZub2RlLmNvbnRleHQpOwogIHZhciBuZXdEaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyQxKHZub2RlLmRhdGEuZGlyZWN0aXZlcywgdm5vZGUuY29udGV4dCk7CiAgdmFyIGRpcnNXaXRoSW5zZXJ0ID0gW107CiAgdmFyIGRpcnNXaXRoUG9zdHBhdGNoID0gW107CiAgdmFyIGtleSwgb2xkRGlyLCBkaXI7CgogIGZvciAoa2V5IGluIG5ld0RpcnMpIHsKICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgIGRpciA9IG5ld0RpcnNba2V5XTsKCiAgICBpZiAoIW9sZERpcikgewogICAgICAvLyBuZXcgZGlyZWN0aXZlLCBiaW5kCiAgICAgIGNhbGxIb29rJDEoZGlyLCAnYmluZCcsIHZub2RlLCBvbGRWbm9kZSk7CgogICAgICBpZiAoZGlyLmRlZiAmJiBkaXIuZGVmLmluc2VydGVkKSB7CiAgICAgICAgZGlyc1dpdGhJbnNlcnQucHVzaChkaXIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBleGlzdGluZyBkaXJlY3RpdmUsIHVwZGF0ZQogICAgICBkaXIub2xkVmFsdWUgPSBvbGREaXIudmFsdWU7CiAgICAgIGRpci5vbGRBcmcgPSBvbGREaXIuYXJnOwogICAgICBjYWxsSG9vayQxKGRpciwgJ3VwZGF0ZScsIHZub2RlLCBvbGRWbm9kZSk7CgogICAgICBpZiAoZGlyLmRlZiAmJiBkaXIuZGVmLmNvbXBvbmVudFVwZGF0ZWQpIHsKICAgICAgICBkaXJzV2l0aFBvc3RwYXRjaC5wdXNoKGRpcik7CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChkaXJzV2l0aEluc2VydC5sZW5ndGgpIHsKICAgIHZhciBjYWxsSW5zZXJ0ID0gZnVuY3Rpb24gY2FsbEluc2VydCgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aEluc2VydC5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxIb29rJDEoZGlyc1dpdGhJbnNlcnRbaV0sICdpbnNlcnRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIH0KICAgIH07CgogICAgaWYgKGlzQ3JlYXRlKSB7CiAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgY2FsbEluc2VydCk7CiAgICB9IGVsc2UgewogICAgICBjYWxsSW5zZXJ0KCk7CiAgICB9CiAgfQoKICBpZiAoZGlyc1dpdGhQb3N0cGF0Y2gubGVuZ3RoKSB7CiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aFBvc3RwYXRjaC5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxIb29rJDEoZGlyc1dpdGhQb3N0cGF0Y2hbaV0sICdjb21wb25lbnRVcGRhdGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAoIWlzQ3JlYXRlKSB7CiAgICBmb3IgKGtleSBpbiBvbGREaXJzKSB7CiAgICAgIGlmICghbmV3RGlyc1trZXldKSB7CiAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgIGNhbGxIb29rJDEob2xkRGlyc1trZXldLCAndW5iaW5kJywgb2xkVm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgICB9CiAgICB9CiAgfQp9Cgp2YXIgZW1wdHlNb2RpZmllcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKZnVuY3Rpb24gbm9ybWFsaXplRGlyZWN0aXZlcyQxKGRpcnMsIHZtKSB7CiAgdmFyIHJlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogIGlmICghZGlycykgewogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICByZXR1cm4gcmVzOwogIH0KCiAgdmFyIGksIGRpcjsKCiAgZm9yIChpID0gMDsgaSA8IGRpcnMubGVuZ3RoOyBpKyspIHsKICAgIGRpciA9IGRpcnNbaV07CgogICAgaWYgKCFkaXIubW9kaWZpZXJzKSB7CiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICBkaXIubW9kaWZpZXJzID0gZW1wdHlNb2RpZmllcnM7CiAgICB9CgogICAgcmVzW2dldFJhd0Rpck5hbWUoZGlyKV0gPSBkaXI7CiAgICBkaXIuZGVmID0gcmVzb2x2ZUFzc2V0KHZtLiRvcHRpb25zLCAnZGlyZWN0aXZlcycsIGRpci5uYW1lLCB0cnVlKTsKICB9IC8vICRmbG93LWRpc2FibGUtbGluZQoKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2V0UmF3RGlyTmFtZShkaXIpIHsKICByZXR1cm4gZGlyLnJhd05hbWUgfHwgZGlyLm5hbWUgKyAiLiIgKyBPYmplY3Qua2V5cyhkaXIubW9kaWZpZXJzIHx8IHt9KS5qb2luKCcuJyk7Cn0KCmZ1bmN0aW9uIGNhbGxIb29rJDEoZGlyLCBob29rLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSkgewogIHZhciBmbiA9IGRpci5kZWYgJiYgZGlyLmRlZltob29rXTsKCiAgaWYgKGZuKSB7CiAgICB0cnkgewogICAgICBmbih2bm9kZS5lbG0sIGRpciwgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBoYW5kbGVFcnJvcihlLCB2bm9kZS5jb250ZXh0LCAiZGlyZWN0aXZlICIgKyBkaXIubmFtZSArICIgIiArIGhvb2sgKyAiIGhvb2siKTsKICAgIH0KICB9Cn0KCnZhciBiYXNlTW9kdWxlcyA9IFtyZWYsIGRpcmVjdGl2ZXNdOwovKiAgKi8KCmZ1bmN0aW9uIHVwZGF0ZUF0dHJzKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBvcHRzID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKCiAgaWYgKGlzRGVmKG9wdHMpICYmIG9wdHMuQ3Rvci5vcHRpb25zLmluaGVyaXRBdHRycyA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKICB9CgogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuYXR0cnMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5hdHRycykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBrZXksIGN1ciwgb2xkOwogIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgdmFyIG9sZEF0dHJzID0gb2xkVm5vZGUuZGF0YS5hdHRycyB8fCB7fTsKICB2YXIgYXR0cnMgPSB2bm9kZS5kYXRhLmF0dHJzIHx8IHt9OyAvLyBjbG9uZSBvYnNlcnZlZCBvYmplY3RzLCBhcyB0aGUgdXNlciBwcm9iYWJseSB3YW50cyB0byBtdXRhdGUgaXQKCiAgaWYgKGlzRGVmKGF0dHJzLl9fb2JfXykpIHsKICAgIGF0dHJzID0gdm5vZGUuZGF0YS5hdHRycyA9IGV4dGVuZCh7fSwgYXR0cnMpOwogIH0KCiAgZm9yIChrZXkgaW4gYXR0cnMpIHsKICAgIGN1ciA9IGF0dHJzW2tleV07CiAgICBvbGQgPSBvbGRBdHRyc1trZXldOwoKICAgIGlmIChvbGQgIT09IGN1cikgewogICAgICBzZXRBdHRyKGVsbSwga2V5LCBjdXIsIHZub2RlLmRhdGEucHJlKTsKICAgIH0KICB9IC8vICM0MzkxOiBpbiBJRTksIHNldHRpbmcgdHlwZSBjYW4gcmVzZXQgdmFsdWUgZm9yIGlucHV0W3R5cGU9cmFkaW9dCiAgLy8gIzY2NjY6IElFL0VkZ2UgZm9yY2VzIHByb2dyZXNzIHZhbHVlIGRvd24gdG8gMSBiZWZvcmUgc2V0dGluZyBhIG1heAoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmICgoaXNJRSB8fCBpc0VkZ2UpICYmIGF0dHJzLnZhbHVlICE9PSBvbGRBdHRycy52YWx1ZSkgewogICAgc2V0QXR0cihlbG0sICd2YWx1ZScsIGF0dHJzLnZhbHVlKTsKICB9CgogIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICBpZiAoaXNVbmRlZihhdHRyc1trZXldKSkgewogICAgICBpZiAoaXNYbGluayhrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgfSBlbHNlIGlmICghaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRBdHRyKGVsLCBrZXksIHZhbHVlLCBpc0luUHJlKSB7CiAgaWYgKGlzSW5QcmUgfHwgZWwudGFnTmFtZS5pbmRleE9mKCctJykgPiAtMSkgewogICAgYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpOwogIH0gZWxzZSBpZiAoaXNCb29sZWFuQXR0cihrZXkpKSB7CiAgICAvLyBzZXQgYXR0cmlidXRlIGZvciBibGFuayB2YWx1ZQogICAgLy8gZS5nLiA8b3B0aW9uIGRpc2FibGVkPlNlbGVjdCBvbmU8L29wdGlvbj4KICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRlY2huaWNhbGx5IGFsbG93ZnVsbHNjcmVlbiBpcyBhIGJvb2xlYW4gYXR0cmlidXRlIGZvciA8aWZyYW1lPiwKICAgICAgLy8gYnV0IEZsYXNoIGV4cGVjdHMgYSB2YWx1ZSBvZiAidHJ1ZSIgd2hlbiB1c2VkIG9uIDxlbWJlZD4gdGFnCiAgICAgIHZhbHVlID0ga2V5ID09PSAnYWxsb3dmdWxsc2NyZWVuJyAmJiBlbC50YWdOYW1lID09PSAnRU1CRUQnID8gJ3RydWUnIDoga2V5OwogICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkpOwogIH0gZWxzZSBpZiAoaXNYbGluayhrZXkpKSB7CiAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywgZ2V0WGxpbmtQcm9wKGtleSkpOwogICAgfSBlbHNlIHsKICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywga2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKTsKICB9Cn0KCmZ1bmN0aW9uIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKSB7CiAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICB9IGVsc2UgewogICAgLy8gIzcxMzg6IElFMTAgJiAxMSBmaXJlcyBpbnB1dCBldmVudCB3aGVuIHNldHRpbmcgcGxhY2Vob2xkZXIgb24KICAgIC8vIDx0ZXh0YXJlYT4uLi4gYmxvY2sgdGhlIGZpcnN0IGlucHV0IGV2ZW50IGFuZCByZW1vdmUgdGhlIGJsb2NrZXIKICAgIC8vIGltbWVkaWF0ZWx5LgoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzSUUgJiYgIWlzSUU5ICYmIGVsLnRhZ05hbWUgPT09ICdURVhUQVJFQScgJiYga2V5ID09PSAncGxhY2Vob2xkZXInICYmIHZhbHVlICE9PSAnJyAmJiAhZWwuX19pZXBoKSB7CiAgICAgIHZhciBibG9ja2VyID0gZnVuY3Rpb24gYmxvY2tlcihlKSB7CiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXIpOwogICAgICB9OwoKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyKTsgLy8gJGZsb3ctZGlzYWJsZS1saW5lCgogICAgICBlbC5fX2llcGggPSB0cnVlOwogICAgICAvKiBJRSBwbGFjZWhvbGRlciBwYXRjaGVkICovCiAgICB9CgogICAgZWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogIH0KfQoKdmFyIGF0dHJzID0gewogIGNyZWF0ZTogdXBkYXRlQXR0cnMsCiAgdXBkYXRlOiB1cGRhdGVBdHRycwp9OwovKiAgKi8KCmZ1bmN0aW9uIHVwZGF0ZUNsYXNzKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwoKICBpZiAoaXNVbmRlZihkYXRhLnN0YXRpY0NsYXNzKSAmJiBpc1VuZGVmKGRhdGFbImNsYXNzIl0pICYmIChpc1VuZGVmKG9sZERhdGEpIHx8IGlzVW5kZWYob2xkRGF0YS5zdGF0aWNDbGFzcykgJiYgaXNVbmRlZihvbGREYXRhWyJjbGFzcyJdKSkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjbHMgPSBnZW5DbGFzc0ZvclZub2RlKHZub2RlKTsgLy8gaGFuZGxlIHRyYW5zaXRpb24gY2xhc3NlcwoKICB2YXIgdHJhbnNpdGlvbkNsYXNzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzOwoKICBpZiAoaXNEZWYodHJhbnNpdGlvbkNsYXNzKSkgewogICAgY2xzID0gY29uY2F0KGNscywgc3RyaW5naWZ5Q2xhc3ModHJhbnNpdGlvbkNsYXNzKSk7CiAgfSAvLyBzZXQgdGhlIGNsYXNzCgoKICBpZiAoY2xzICE9PSBlbC5fcHJldkNsYXNzKSB7CiAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY2xzKTsKICAgIGVsLl9wcmV2Q2xhc3MgPSBjbHM7CiAgfQp9Cgp2YXIga2xhc3MgPSB7CiAgY3JlYXRlOiB1cGRhdGVDbGFzcywKICB1cGRhdGU6IHVwZGF0ZUNsYXNzCn07Ci8qICAqLwoKLyogICovCgovKiAgKi8KCi8qICAqLwovLyBpbiBzb21lIGNhc2VzLCB0aGUgZXZlbnQgdXNlZCBoYXMgdG8gYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lCi8vIHNvIHdlIHVzZWQgc29tZSByZXNlcnZlZCB0b2tlbnMgZHVyaW5nIGNvbXBpbGUuCgp2YXIgUkFOR0VfVE9LRU4gPSAnX19yJzsKdmFyIENIRUNLQk9YX1JBRElPX1RPS0VOID0gJ19fYyc7Ci8qICAqLwovLyBub3JtYWxpemUgdi1tb2RlbCBldmVudCB0b2tlbnMgdGhhdCBjYW4gb25seSBiZSBkZXRlcm1pbmVkIGF0IHJ1bnRpbWUuCi8vIGl0J3MgaW1wb3J0YW50IHRvIHBsYWNlIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgaW4gdGhlIGFycmF5IGJlY2F1c2UKLy8gdGhlIHdob2xlIHBvaW50IGlzIGVuc3VyaW5nIHRoZSB2LW1vZGVsIGNhbGxiYWNrIGdldHMgY2FsbGVkIGJlZm9yZQovLyB1c2VyLWF0dGFjaGVkIGhhbmRsZXJzLgoKZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKG9uKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGlzRGVmKG9uW1JBTkdFX1RPS0VOXSkpIHsKICAgIC8vIElFIGlucHV0W3R5cGU9cmFuZ2VdIG9ubHkgc3VwcG9ydHMgYGNoYW5nZWAgZXZlbnQKICAgIHZhciBldmVudCA9IGlzSUUgPyAnY2hhbmdlJyA6ICdpbnB1dCc7CiAgICBvbltldmVudF0gPSBbXS5jb25jYXQob25bUkFOR0VfVE9LRU5dLCBvbltldmVudF0gfHwgW10pOwogICAgZGVsZXRlIG9uW1JBTkdFX1RPS0VOXTsKICB9IC8vIFRoaXMgd2FzIG9yaWdpbmFsbHkgaW50ZW5kZWQgdG8gZml4ICM0NTIxIGJ1dCBubyBsb25nZXIgbmVjZXNzYXJ5CiAgLy8gYWZ0ZXIgMi41LiBLZWVwaW5nIGl0IGZvciBiYWNrd2FyZHMgY29tcGF0IHdpdGggZ2VuZXJhdGVkIGNvZGUgZnJvbSA8IDIuNAoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihvbltDSEVDS0JPWF9SQURJT19UT0tFTl0pKSB7CiAgICBvbi5jaGFuZ2UgPSBbXS5jb25jYXQob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dLCBvbi5jaGFuZ2UgfHwgW10pOwogICAgZGVsZXRlIG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXTsKICB9Cn0KCnZhciB0YXJnZXQkMTsKCmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyJDEoZXZlbnQsIGhhbmRsZXIsIGNhcHR1cmUpIHsKICB2YXIgX3RhcmdldCA9IHRhcmdldCQxOyAvLyBzYXZlIGN1cnJlbnQgdGFyZ2V0IGVsZW1lbnQgaW4gY2xvc3VyZQoKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gaGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwoKICAgIGlmIChyZXMgIT09IG51bGwpIHsKICAgICAgcmVtb3ZlJDIoZXZlbnQsIG9uY2VIYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KTsKICAgIH0KICB9Owp9IC8vICM5NDQ2OiBGaXJlZm94IDw9IDUzIChpbiBwYXJ0aWN1bGFyLCBFU1IgNTIpIGhhcyBpbmNvcnJlY3QgRXZlbnQudGltZVN0YW1wCi8vIGltcGxlbWVudGF0aW9uIGFuZCBkb2VzIG5vdCBmaXJlIG1pY3JvdGFza3MgaW4gYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbiwgc28KLy8gc2FmZSB0byBleGNsdWRlLgoKCnZhciB1c2VNaWNyb3Rhc2tGaXggPSBpc1VzaW5nTWljcm9UYXNrICYmICEoaXNGRiAmJiBOdW1iZXIoaXNGRlsxXSkgPD0gNTMpOwoKZnVuY3Rpb24gYWRkJDEobmFtZSwgaGFuZGxlciwgY2FwdHVyZSwgcGFzc2l2ZSkgewogIC8vIGFzeW5jIGVkZ2UgY2FzZSAjNjU2NjogaW5uZXIgY2xpY2sgZXZlbnQgdHJpZ2dlcnMgcGF0Y2gsIGV2ZW50IGhhbmRsZXIKICAvLyBhdHRhY2hlZCB0byBvdXRlciBlbGVtZW50IGR1cmluZyBwYXRjaCwgYW5kIHRyaWdnZXJlZCBhZ2Fpbi4gVGhpcwogIC8vIGhhcHBlbnMgYmVjYXVzZSBicm93c2VycyBmaXJlIG1pY3JvdGFzayB0aWNrcyBiZXR3ZWVuIGV2ZW50IHByb3BhZ2F0aW9uLgogIC8vIHRoZSBzb2x1dGlvbiBpcyBzaW1wbGU6IHdlIHNhdmUgdGhlIHRpbWVzdGFtcCB3aGVuIGEgaGFuZGxlciBpcyBhdHRhY2hlZCwKICAvLyBhbmQgdGhlIGhhbmRsZXIgd291bGQgb25seSBmaXJlIGlmIHRoZSBldmVudCBwYXNzZWQgdG8gaXQgd2FzIGZpcmVkCiAgLy8gQUZURVIgaXQgd2FzIGF0dGFjaGVkLgogIGlmICh1c2VNaWNyb3Rhc2tGaXgpIHsKICAgIHZhciBhdHRhY2hlZFRpbWVzdGFtcCA9IGN1cnJlbnRGbHVzaFRpbWVzdGFtcDsKICAgIHZhciBvcmlnaW5hbCA9IGhhbmRsZXI7CgogICAgaGFuZGxlciA9IG9yaWdpbmFsLl93cmFwcGVyID0gZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCAvLyBubyBidWJibGluZywgc2hvdWxkIGFsd2F5cyBmaXJlLgogICAgICAvLyB0aGlzIGlzIGp1c3QgYSBzYWZldHkgbmV0IGluIGNhc2UgZXZlbnQudGltZVN0YW1wIGlzIHVucmVsaWFibGUgaW4KICAgICAgLy8gY2VydGFpbiB3ZWlyZCBlbnZpcm9ubWVudHMuLi4KICAgICAgZS50YXJnZXQgPT09IGUuY3VycmVudFRhcmdldCB8fCAvLyBldmVudCBpcyBmaXJlZCBhZnRlciBoYW5kbGVyIGF0dGFjaG1lbnQKICAgICAgZS50aW1lU3RhbXAgPj0gYXR0YWNoZWRUaW1lc3RhbXAgfHwgLy8gYmFpbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgaGF2ZSBidWdneSBldmVudC50aW1lU3RhbXAgaW1wbGVtZW50YXRpb25zCiAgICAgIC8vICM5NDYyIGlPUyA5IGJ1ZzogZXZlbnQudGltZVN0YW1wIGlzIDAgYWZ0ZXIgaGlzdG9yeS5wdXNoU3RhdGUKICAgICAgLy8gIzk2ODEgUXRXZWJFbmdpbmUgZXZlbnQudGltZVN0YW1wIGlzIG5lZ2F0aXZlIHZhbHVlCiAgICAgIGUudGltZVN0YW1wIDw9IDAgfHwgLy8gIzk0NDggYmFpbCBpZiBldmVudCBpcyBmaXJlZCBpbiBhbm90aGVyIGRvY3VtZW50IGluIGEgbXVsdGktcGFnZQogICAgICAvLyBlbGVjdHJvbi9udy5qcyBhcHAsIHNpbmNlIGV2ZW50LnRpbWVTdGFtcCB3aWxsIGJlIHVzaW5nIGEgZGlmZmVyZW50CiAgICAgIC8vIHN0YXJ0aW5nIHJlZmVyZW5jZQogICAgICBlLnRhcmdldC5vd25lckRvY3VtZW50ICE9PSBkb2N1bWVudCkgewogICAgICAgIHJldHVybiBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgdGFyZ2V0JDEuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBoYW5kbGVyLCBzdXBwb3J0c1Bhc3NpdmUgPyB7CiAgICBjYXB0dXJlOiBjYXB0dXJlLAogICAgcGFzc2l2ZTogcGFzc2l2ZQogIH0gOiBjYXB0dXJlKTsKfQoKZnVuY3Rpb24gcmVtb3ZlJDIobmFtZSwgaGFuZGxlciwgY2FwdHVyZSwgX3RhcmdldCkgewogIChfdGFyZ2V0IHx8IHRhcmdldCQxKS5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGhhbmRsZXIuX3dyYXBwZXIgfHwgaGFuZGxlciwgY2FwdHVyZSk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZURPTUxpc3RlbmVycyhvbGRWbm9kZSwgdm5vZGUpIHsKICBpZiAoaXNVbmRlZihvbGRWbm9kZS5kYXRhLm9uKSAmJiBpc1VuZGVmKHZub2RlLmRhdGEub24pKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb24gPSB2bm9kZS5kYXRhLm9uIHx8IHt9OwogIHZhciBvbGRPbiA9IG9sZFZub2RlLmRhdGEub24gfHwge307CiAgdGFyZ2V0JDEgPSB2bm9kZS5lbG07CiAgbm9ybWFsaXplRXZlbnRzKG9uKTsKICB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQkMSwgcmVtb3ZlJDIsIGNyZWF0ZU9uY2VIYW5kbGVyJDEsIHZub2RlLmNvbnRleHQpOwogIHRhcmdldCQxID0gdW5kZWZpbmVkOwp9Cgp2YXIgZXZlbnRzID0gewogIGNyZWF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogIHVwZGF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzCn07Ci8qICAqLwoKdmFyIHN2Z0NvbnRhaW5lcjsKCmZ1bmN0aW9uIHVwZGF0ZURPTVByb3BzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuZG9tUHJvcHMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5kb21Qcm9wcykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBrZXksIGN1cjsKICB2YXIgZWxtID0gdm5vZGUuZWxtOwogIHZhciBvbGRQcm9wcyA9IG9sZFZub2RlLmRhdGEuZG9tUHJvcHMgfHwge307CiAgdmFyIHByb3BzID0gdm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CgogIGlmIChpc0RlZihwcm9wcy5fX29iX18pKSB7CiAgICBwcm9wcyA9IHZub2RlLmRhdGEuZG9tUHJvcHMgPSBleHRlbmQoe30sIHByb3BzKTsKICB9CgogIGZvciAoa2V5IGluIG9sZFByb3BzKSB7CiAgICBpZiAoIShrZXkgaW4gcHJvcHMpKSB7CiAgICAgIGVsbVtrZXldID0gJyc7CiAgICB9CiAgfQoKICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgY3VyID0gcHJvcHNba2V5XTsgLy8gaWdub3JlIGNoaWxkcmVuIGlmIHRoZSBub2RlIGhhcyB0ZXh0Q29udGVudCBvciBpbm5lckhUTUwsCiAgICAvLyBhcyB0aGVzZSB3aWxsIHRocm93IGF3YXkgZXhpc3RpbmcgRE9NIG5vZGVzIGFuZCBjYXVzZSByZW1vdmFsIGVycm9ycwogICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKCiAgICBpZiAoa2V5ID09PSAndGV4dENvbnRlbnQnIHx8IGtleSA9PT0gJ2lubmVySFRNTCcpIHsKICAgICAgaWYgKHZub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgICAgfQoKICAgICAgaWYgKGN1ciA9PT0gb2xkUHJvcHNba2V5XSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9IC8vICM2NjAxIHdvcmsgYXJvdW5kIENocm9tZSB2ZXJzaW9uIDw9IDU1IGJ1ZyB3aGVyZSBzaW5nbGUgdGV4dE5vZGUKICAgICAgLy8gcmVwbGFjZWQgYnkgaW5uZXJIVE1ML3RleHRDb250ZW50IHJldGFpbnMgaXRzIHBhcmVudE5vZGUgcHJvcGVydHkKCgogICAgICBpZiAoZWxtLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgZWxtLnJlbW92ZUNoaWxkKGVsbS5jaGlsZE5vZGVzWzBdKTsKICAgICAgfQogICAgfQoKICAgIGlmIChrZXkgPT09ICd2YWx1ZScgJiYgZWxtLnRhZ05hbWUgIT09ICdQUk9HUkVTUycpIHsKICAgICAgLy8gc3RvcmUgdmFsdWUgYXMgX3ZhbHVlIGFzIHdlbGwgc2luY2UKICAgICAgLy8gbm9uLXN0cmluZyB2YWx1ZXMgd2lsbCBiZSBzdHJpbmdpZmllZAogICAgICBlbG0uX3ZhbHVlID0gY3VyOyAvLyBhdm9pZCByZXNldHRpbmcgY3Vyc29yIHBvc2l0aW9uIHdoZW4gdmFsdWUgaXMgdGhlIHNhbWUKCiAgICAgIHZhciBzdHJDdXIgPSBpc1VuZGVmKGN1cikgPyAnJyA6IFN0cmluZyhjdXIpOwoKICAgICAgaWYgKHNob3VsZFVwZGF0ZVZhbHVlKGVsbSwgc3RyQ3VyKSkgewogICAgICAgIGVsbS52YWx1ZSA9IHN0ckN1cjsKICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT09ICdpbm5lckhUTUwnICYmIGlzU1ZHKGVsbS50YWdOYW1lKSAmJiBpc1VuZGVmKGVsbS5pbm5lckhUTUwpKSB7CiAgICAgIC8vIElFIGRvZXNuJ3Qgc3VwcG9ydCBpbm5lckhUTUwgZm9yIFNWRyBlbGVtZW50cwogICAgICBzdmdDb250YWluZXIgPSBzdmdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHN2Z0NvbnRhaW5lci5pbm5lckhUTUwgPSAiPHN2Zz4iICsgY3VyICsgIjwvc3ZnPiI7CiAgICAgIHZhciBzdmcgPSBzdmdDb250YWluZXIuZmlyc3RDaGlsZDsKCiAgICAgIHdoaWxlIChlbG0uZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uZmlyc3RDaGlsZCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChzdmcuZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5hcHBlbmRDaGlsZChzdmcuZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIC8vIHNraXAgdGhlIHVwZGF0ZSBpZiBvbGQgYW5kIG5ldyBWRE9NIHN0YXRlIGlzIHRoZSBzYW1lLgogICAgLy8gYHZhbHVlYCBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgYmVjYXVzZSB0aGUgRE9NIHZhbHVlIG1heSBiZSB0ZW1wb3JhcmlseQogICAgLy8gb3V0IG9mIHN5bmMgd2l0aCBWRE9NIHN0YXRlIGR1ZSB0byBmb2N1cywgY29tcG9zaXRpb24gYW5kIG1vZGlmaWVycy4KICAgIC8vIFRoaXMgICM0NTIxIGJ5IHNraXBwaW5nIHRoZSB1bm5lY2Vzc2FyeSBgY2hlY2tlZGAgdXBkYXRlLgogICAgY3VyICE9PSBvbGRQcm9wc1trZXldKSB7CiAgICAgIC8vIHNvbWUgcHJvcGVydHkgdXBkYXRlcyBjYW4gdGhyb3cKICAgICAgLy8gZS5nLiBgdmFsdWVgIG9uIDxwcm9ncmVzcz4gdy8gbm9uLWZpbml0ZSB2YWx1ZQogICAgICB0cnkgewogICAgICAgIGVsbVtrZXldID0gY3VyOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfQogIH0KfSAvLyBjaGVjayBwbGF0Zm9ybXMvd2ViL3V0aWwvYXR0cnMuanMgYWNjZXB0VmFsdWUKCgpmdW5jdGlvbiBzaG91bGRVcGRhdGVWYWx1ZShlbG0sIGNoZWNrVmFsKSB7CiAgcmV0dXJuICFlbG0uY29tcG9zaW5nICYmIChlbG0udGFnTmFtZSA9PT0gJ09QVElPTicgfHwgaXNOb3RJbkZvY3VzQW5kRGlydHkoZWxtLCBjaGVja1ZhbCkgfHwgaXNEaXJ0eVdpdGhNb2RpZmllcnMoZWxtLCBjaGVja1ZhbCkpOwp9CgpmdW5jdGlvbiBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB7CiAgLy8gcmV0dXJuIHRydWUgd2hlbiB0ZXh0Ym94ICgubnVtYmVyIGFuZCAudHJpbSkgbG9zZXMgZm9jdXMgYW5kIGl0cyB2YWx1ZSBpcwogIC8vIG5vdCBlcXVhbCB0byB0aGUgdXBkYXRlZCB2YWx1ZQogIHZhciBub3RJbkZvY3VzID0gdHJ1ZTsgLy8gIzYxNTcKICAvLyB3b3JrIGFyb3VuZCBJRSBidWcgd2hlbiBhY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpbiBhbiBpZnJhbWUKCiAgdHJ5IHsKICAgIG5vdEluRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBlbG07CiAgfSBjYXRjaCAoZSkge30KCiAgcmV0dXJuIG5vdEluRm9jdXMgJiYgZWxtLnZhbHVlICE9PSBjaGVja1ZhbDsKfQoKZnVuY3Rpb24gaXNEaXJ0eVdpdGhNb2RpZmllcnMoZWxtLCBuZXdWYWwpIHsKICB2YXIgdmFsdWUgPSBlbG0udmFsdWU7CiAgdmFyIG1vZGlmaWVycyA9IGVsbS5fdk1vZGlmaWVyczsgLy8gaW5qZWN0ZWQgYnkgdi1tb2RlbCBydW50aW1lCgogIGlmIChpc0RlZihtb2RpZmllcnMpKSB7CiAgICBpZiAobW9kaWZpZXJzLm51bWJlcikgewogICAgICByZXR1cm4gdG9OdW1iZXIodmFsdWUpICE9PSB0b051bWJlcihuZXdWYWwpOwogICAgfQoKICAgIGlmIChtb2RpZmllcnMudHJpbSkgewogICAgICByZXR1cm4gdmFsdWUudHJpbSgpICE9PSBuZXdWYWwudHJpbSgpOwogICAgfQogIH0KCiAgcmV0dXJuIHZhbHVlICE9PSBuZXdWYWw7Cn0KCnZhciBkb21Qcm9wcyA9IHsKICBjcmVhdGU6IHVwZGF0ZURPTVByb3BzLAogIHVwZGF0ZTogdXBkYXRlRE9NUHJvcHMKfTsKLyogICovCgp2YXIgcGFyc2VTdHlsZVRleHQgPSBjYWNoZWQoZnVuY3Rpb24gKGNzc1RleHQpIHsKICB2YXIgcmVzID0ge307CiAgdmFyIGxpc3REZWxpbWl0ZXIgPSAvOyg/IVteKF0qXCkpL2c7CiAgdmFyIHByb3BlcnR5RGVsaW1pdGVyID0gLzooLispLzsKICBjc3NUZXh0LnNwbGl0KGxpc3REZWxpbWl0ZXIpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgIGlmIChpdGVtKSB7CiAgICAgIHZhciB0bXAgPSBpdGVtLnNwbGl0KHByb3BlcnR5RGVsaW1pdGVyKTsKICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJlc1t0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOwogICAgfQogIH0pOwogIHJldHVybiByZXM7Cn0pOyAvLyBtZXJnZSBzdGF0aWMgYW5kIGR5bmFtaWMgc3R5bGUgZGF0YSBvbiB0aGUgc2FtZSB2bm9kZQoKZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVEYXRhKGRhdGEpIHsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcoZGF0YS5zdHlsZSk7IC8vIHN0YXRpYyBzdHlsZSBpcyBwcmUtcHJvY2Vzc2VkIGludG8gYW4gb2JqZWN0IGR1cmluZyBjb21waWxhdGlvbgogIC8vIGFuZCBpcyBhbHdheXMgYSBmcmVzaCBvYmplY3QsIHNvIGl0J3Mgc2FmZSB0byBtZXJnZSBpbnRvIGl0CgogIHJldHVybiBkYXRhLnN0YXRpY1N0eWxlID8gZXh0ZW5kKGRhdGEuc3RhdGljU3R5bGUsIHN0eWxlKSA6IHN0eWxlOwp9IC8vIG5vcm1hbGl6ZSBwb3NzaWJsZSBhcnJheSAvIHN0cmluZyB2YWx1ZXMgaW50byBPYmplY3QKCgpmdW5jdGlvbiBub3JtYWxpemVTdHlsZUJpbmRpbmcoYmluZGluZ1N0eWxlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYmluZGluZ1N0eWxlKSkgewogICAgcmV0dXJuIHRvT2JqZWN0KGJpbmRpbmdTdHlsZSk7CiAgfQoKICBpZiAodHlwZW9mIGJpbmRpbmdTdHlsZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBwYXJzZVN0eWxlVGV4dChiaW5kaW5nU3R5bGUpOwogIH0KCiAgcmV0dXJuIGJpbmRpbmdTdHlsZTsKfQovKioKICogcGFyZW50IGNvbXBvbmVudCBzdHlsZSBzaG91bGQgYmUgYWZ0ZXIgY2hpbGQncwogKiBzbyB0aGF0IHBhcmVudCBjb21wb25lbnQncyBzdHlsZSBjb3VsZCBvdmVycmlkZSBpdAogKi8KCgpmdW5jdGlvbiBnZXRTdHlsZSh2bm9kZSwgY2hlY2tDaGlsZCkgewogIHZhciByZXMgPSB7fTsKICB2YXIgc3R5bGVEYXRhOwoKICBpZiAoY2hlY2tDaGlsZCkgewogICAgdmFyIGNoaWxkTm9kZSA9IHZub2RlOwoKICAgIHdoaWxlIChjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgY2hpbGROb2RlID0gY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEgJiYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YShjaGlsZE5vZGUuZGF0YSkpKSB7CiAgICAgICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YSh2bm9kZS5kYXRhKSkgewogICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICB9CgogIHZhciBwYXJlbnROb2RlID0gdm5vZGU7CgogIHdoaWxlIChwYXJlbnROb2RlID0gcGFyZW50Tm9kZS5wYXJlbnQpIHsKICAgIGlmIChwYXJlbnROb2RlLmRhdGEgJiYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YShwYXJlbnROb2RlLmRhdGEpKSkgewogICAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgp2YXIgY3NzVmFyUkUgPSAvXi0tLzsKdmFyIGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKCnZhciBzZXRQcm9wID0gZnVuY3Rpb24gc2V0UHJvcChlbCwgbmFtZSwgdmFsKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGNzc1ZhclJFLnRlc3QobmFtZSkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbCk7CiAgfSBlbHNlIGlmIChpbXBvcnRhbnRSRS50ZXN0KHZhbCkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KGh5cGhlbmF0ZShuYW1lKSwgdmFsLnJlcGxhY2UoaW1wb3J0YW50UkUsICcnKSwgJ2ltcG9ydGFudCcpOwogIH0gZWxzZSB7CiAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSBub3JtYWxpemUobmFtZSk7CgogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAvLyBTdXBwb3J0IHZhbHVlcyBhcnJheSBjcmVhdGVkIGJ5IGF1dG9wcmVmaXhlciwgZS5nLgogICAgICAvLyB7ZGlzcGxheTogWyItd2Via2l0LWJveCIsICItbXMtZmxleGJveCIsICJmbGV4Il19CiAgICAgIC8vIFNldCB0aGVtIG9uZSBieSBvbmUsIGFuZCB0aGUgYnJvd3NlciB3aWxsIG9ubHkgc2V0IHRob3NlIGl0IGNhbiByZWNvZ25pemUKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHZhbC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGVsLnN0eWxlW25vcm1hbGl6ZWROYW1lXSA9IHZhbFtpXTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsOwogICAgfQogIH0KfTsKCnZhciB2ZW5kb3JOYW1lcyA9IFsnV2Via2l0JywgJ01veicsICdtcyddOwp2YXIgZW1wdHlTdHlsZTsKdmFyIG5vcm1hbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAocHJvcCkgewogIGVtcHR5U3R5bGUgPSBlbXB0eVN0eWxlIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlOwogIHByb3AgPSBjYW1lbGl6ZShwcm9wKTsKCiAgaWYgKHByb3AgIT09ICdmaWx0ZXInICYmIHByb3AgaW4gZW1wdHlTdHlsZSkgewogICAgcmV0dXJuIHByb3A7CiAgfQoKICB2YXIgY2FwTmFtZSA9IHByb3AuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnNsaWNlKDEpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHZlbmRvck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgbmFtZSA9IHZlbmRvck5hbWVzW2ldICsgY2FwTmFtZTsKCiAgICBpZiAobmFtZSBpbiBlbXB0eVN0eWxlKSB7CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH0KfSk7CgpmdW5jdGlvbiB1cGRhdGVTdHlsZShvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwoKICBpZiAoaXNVbmRlZihkYXRhLnN0YXRpY1N0eWxlKSAmJiBpc1VuZGVmKGRhdGEuc3R5bGUpICYmIGlzVW5kZWYob2xkRGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihvbGREYXRhLnN0eWxlKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGN1ciwgbmFtZTsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgdmFyIG9sZFN0YXRpY1N0eWxlID0gb2xkRGF0YS5zdGF0aWNTdHlsZTsKICB2YXIgb2xkU3R5bGVCaW5kaW5nID0gb2xkRGF0YS5ub3JtYWxpemVkU3R5bGUgfHwgb2xkRGF0YS5zdHlsZSB8fCB7fTsgLy8gaWYgc3RhdGljIHN0eWxlIGV4aXN0cywgc3R5bGViaW5kaW5nIGFscmVhZHkgbWVyZ2VkIGludG8gaXQgd2hlbiBkb2luZyBub3JtYWxpemVTdHlsZURhdGEKCiAgdmFyIG9sZFN0eWxlID0gb2xkU3RhdGljU3R5bGUgfHwgb2xkU3R5bGVCaW5kaW5nOwogIHZhciBzdHlsZSA9IG5vcm1hbGl6ZVN0eWxlQmluZGluZyh2bm9kZS5kYXRhLnN0eWxlKSB8fCB7fTsgLy8gc3RvcmUgbm9ybWFsaXplZCBzdHlsZSB1bmRlciBhIGRpZmZlcmVudCBrZXkgZm9yIG5leHQgZGlmZgogIC8vIG1ha2Ugc3VyZSB0byBjbG9uZSBpdCBpZiBpdCdzIHJlYWN0aXZlLCBzaW5jZSB0aGUgdXNlciBsaWtlbHkgd2FudHMKICAvLyB0byBtdXRhdGUgaXQuCgogIHZub2RlLmRhdGEubm9ybWFsaXplZFN0eWxlID0gaXNEZWYoc3R5bGUuX19vYl9fKSA/IGV4dGVuZCh7fSwgc3R5bGUpIDogc3R5bGU7CiAgdmFyIG5ld1N0eWxlID0gZ2V0U3R5bGUodm5vZGUsIHRydWUpOwoKICBmb3IgKG5hbWUgaW4gb2xkU3R5bGUpIHsKICAgIGlmIChpc1VuZGVmKG5ld1N0eWxlW25hbWVdKSkgewogICAgICBzZXRQcm9wKGVsLCBuYW1lLCAnJyk7CiAgICB9CiAgfQoKICBmb3IgKG5hbWUgaW4gbmV3U3R5bGUpIHsKICAgIGN1ciA9IG5ld1N0eWxlW25hbWVdOwoKICAgIGlmIChjdXIgIT09IG9sZFN0eWxlW25hbWVdKSB7CiAgICAgIC8vIGllOSBzZXR0aW5nIHRvIG51bGwgaGFzIG5vIGVmZmVjdCwgbXVzdCB1c2UgZW1wdHkgc3RyaW5nCiAgICAgIHNldFByb3AoZWwsIG5hbWUsIGN1ciA9PSBudWxsID8gJycgOiBjdXIpOwogICAgfQogIH0KfQoKdmFyIHN0eWxlID0gewogIGNyZWF0ZTogdXBkYXRlU3R5bGUsCiAgdXBkYXRlOiB1cGRhdGVTdHlsZQp9OwovKiAgKi8KCnZhciB3aGl0ZXNwYWNlUkUgPSAvXHMrLzsKLyoqCiAqIEFkZCBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbgogKiBTVkcgZWxlbWVudHMgaW4gSUUKICovCgpmdW5jdGlvbiBhZGRDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5hZGQoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbHMpOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgY3VyID0gIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICI7CgogICAgaWYgKGN1ci5pbmRleE9mKCcgJyArIGNscyArICcgJykgPCAwKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoY3VyICsgY2xzKS50cmltKCkpOwogICAgfQogIH0KfQovKioKICogUmVtb3ZlIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAqIFNWRyBlbGVtZW50cyBpbiBJRQogKi8KCgpmdW5jdGlvbiByZW1vdmVDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5yZW1vdmUoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbHMpOwogICAgfQoKICAgIGlmICghZWwuY2xhc3NMaXN0Lmxlbmd0aCkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjdXIgPSAiICIgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIjsKICAgIHZhciB0YXIgPSAnICcgKyBjbHMgKyAnICc7CgogICAgd2hpbGUgKGN1ci5pbmRleE9mKHRhcikgPj0gMCkgewogICAgICBjdXIgPSBjdXIucmVwbGFjZSh0YXIsICcgJyk7CiAgICB9CgogICAgY3VyID0gY3VyLnRyaW0oKTsKCiAgICBpZiAoY3VyKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjdXIpOwogICAgfSBlbHNlIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpOwogICAgfQogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiByZXNvbHZlVHJhbnNpdGlvbihkZWYkJDEpIHsKICBpZiAoIWRlZiQkMSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKF90eXBlb2YoZGVmJCQxKSA9PT0gJ29iamVjdCcpIHsKICAgIHZhciByZXMgPSB7fTsKCiAgICBpZiAoZGVmJCQxLmNzcyAhPT0gZmFsc2UpIHsKICAgICAgZXh0ZW5kKHJlcywgYXV0b0Nzc1RyYW5zaXRpb24oZGVmJCQxLm5hbWUgfHwgJ3YnKSk7CiAgICB9CgogICAgZXh0ZW5kKHJlcywgZGVmJCQxKTsKICAgIHJldHVybiByZXM7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmJCQxID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIGF1dG9Dc3NUcmFuc2l0aW9uKGRlZiQkMSk7CiAgfQp9Cgp2YXIgYXV0b0Nzc1RyYW5zaXRpb24gPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICByZXR1cm4gewogICAgZW50ZXJDbGFzczogbmFtZSArICItZW50ZXIiLAogICAgZW50ZXJUb0NsYXNzOiBuYW1lICsgIi1lbnRlci10byIsCiAgICBlbnRlckFjdGl2ZUNsYXNzOiBuYW1lICsgIi1lbnRlci1hY3RpdmUiLAogICAgbGVhdmVDbGFzczogbmFtZSArICItbGVhdmUiLAogICAgbGVhdmVUb0NsYXNzOiBuYW1lICsgIi1sZWF2ZS10byIsCiAgICBsZWF2ZUFjdGl2ZUNsYXNzOiBuYW1lICsgIi1sZWF2ZS1hY3RpdmUiCiAgfTsKfSk7CnZhciBoYXNUcmFuc2l0aW9uID0gaW5Ccm93c2VyICYmICFpc0lFOTsKdmFyIFRSQU5TSVRJT04gPSAndHJhbnNpdGlvbic7CnZhciBBTklNQVRJT04gPSAnYW5pbWF0aW9uJzsgLy8gVHJhbnNpdGlvbiBwcm9wZXJ0eS9ldmVudCBzbmlmZmluZwoKdmFyIHRyYW5zaXRpb25Qcm9wID0gJ3RyYW5zaXRpb24nOwp2YXIgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3RyYW5zaXRpb25lbmQnOwp2YXIgYW5pbWF0aW9uUHJvcCA9ICdhbmltYXRpb24nOwp2YXIgYW5pbWF0aW9uRW5kRXZlbnQgPSAnYW5pbWF0aW9uZW5kJzsKCmlmIChoYXNUcmFuc2l0aW9uKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHdpbmRvdy5vbnRyYW5zaXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXR0cmFuc2l0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgIHRyYW5zaXRpb25Qcm9wID0gJ1dlYmtpdFRyYW5zaXRpb24nOwogICAgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQnOwogIH0KCiAgaWYgKHdpbmRvdy5vbmFuaW1hdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICBhbmltYXRpb25Qcm9wID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICBhbmltYXRpb25FbmRFdmVudCA9ICd3ZWJraXRBbmltYXRpb25FbmQnOwogIH0KfSAvLyBiaW5kaW5nIHRvIHdpbmRvdyBpcyBuZWNlc3NhcnkgdG8gbWFrZSBob3QgcmVsb2FkIHdvcmsgaW4gSUUgaW4gc3RyaWN0IG1vZGUKCgp2YXIgcmFmID0gaW5Ccm93c2VyID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUuYmluZCh3aW5kb3cpIDogc2V0VGltZW91dCA6Ci8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCmZ1bmN0aW9uIChmbikgewogIHJldHVybiBmbigpOwp9OwoKZnVuY3Rpb24gbmV4dEZyYW1lKGZuKSB7CiAgcmFmKGZ1bmN0aW9uICgpIHsKICAgIHJhZihmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgdmFyIHRyYW5zaXRpb25DbGFzc2VzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzIHx8IChlbC5fdHJhbnNpdGlvbkNsYXNzZXMgPSBbXSk7CgogIGlmICh0cmFuc2l0aW9uQ2xhc3Nlcy5pbmRleE9mKGNscykgPCAwKSB7CiAgICB0cmFuc2l0aW9uQ2xhc3Nlcy5wdXNoKGNscyk7CiAgICBhZGRDbGFzcyhlbCwgY2xzKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgcmVtb3ZlKGVsLl90cmFuc2l0aW9uQ2xhc3NlcywgY2xzKTsKICB9CgogIHJlbW92ZUNsYXNzKGVsLCBjbHMpOwp9CgpmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgY2IpIHsKICB2YXIgcmVmID0gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSk7CiAgdmFyIHR5cGUgPSByZWYudHlwZTsKICB2YXIgdGltZW91dCA9IHJlZi50aW1lb3V0OwogIHZhciBwcm9wQ291bnQgPSByZWYucHJvcENvdW50OwoKICBpZiAoIXR5cGUpIHsKICAgIHJldHVybiBjYigpOwogIH0KCiAgdmFyIGV2ZW50ID0gdHlwZSA9PT0gVFJBTlNJVElPTiA/IHRyYW5zaXRpb25FbmRFdmVudCA6IGFuaW1hdGlvbkVuZEV2ZW50OwogIHZhciBlbmRlZCA9IDA7CgogIHZhciBlbmQgPSBmdW5jdGlvbiBlbmQoKSB7CiAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LCBvbkVuZCk7CiAgICBjYigpOwogIH07CgogIHZhciBvbkVuZCA9IGZ1bmN0aW9uIG9uRW5kKGUpIHsKICAgIGlmIChlLnRhcmdldCA9PT0gZWwpIHsKICAgICAgaWYgKCsrZW5kZWQgPj0gcHJvcENvdW50KSB7CiAgICAgICAgZW5kKCk7CiAgICAgIH0KICAgIH0KICB9OwoKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbmRlZCA8IHByb3BDb3VudCkgewogICAgICBlbmQoKTsKICAgIH0KICB9LCB0aW1lb3V0ICsgMSk7CiAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwp9Cgp2YXIgdHJhbnNmb3JtUkUgPSAvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS87CgpmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSB7CiAgdmFyIHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsgLy8gSlNET00gbWF5IHJldHVybiB1bmRlZmluZWQgZm9yIHRyYW5zaXRpb24gcHJvcGVydGllcwoKICB2YXIgdHJhbnNpdGlvbkRlbGF5cyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbnMgPSAoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgdmFyIGFuaW1hdGlvbkRlbGF5cyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgYW5pbWF0aW9uRHVyYXRpb25zID0gKHN0eWxlc1thbmltYXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CiAgdmFyIHR5cGU7CiAgdmFyIHRpbWVvdXQgPSAwOwogIHZhciBwcm9wQ291bnQgPSAwOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAoZXhwZWN0ZWRUeXBlID09PSBUUkFOU0lUSU9OKSB7CiAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgIHR5cGUgPSBUUkFOU0lUSU9OOwogICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgIHByb3BDb3VudCA9IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICB0eXBlID0gQU5JTUFUSU9OOwogICAgICB0aW1lb3V0ID0gYW5pbWF0aW9uVGltZW91dDsKICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgIH0KICB9IGVsc2UgewogICAgdGltZW91dCA9IE1hdGgubWF4KHRyYW5zaXRpb25UaW1lb3V0LCBhbmltYXRpb25UaW1lb3V0KTsKICAgIHR5cGUgPSB0aW1lb3V0ID4gMCA/IHRyYW5zaXRpb25UaW1lb3V0ID4gYW5pbWF0aW9uVGltZW91dCA/IFRSQU5TSVRJT04gOiBBTklNQVRJT04gOiBudWxsOwogICAgcHJvcENvdW50ID0gdHlwZSA/IHR5cGUgPT09IFRSQU5TSVRJT04gPyB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aCA6IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGggOiAwOwogIH0KCiAgdmFyIGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04gJiYgdHJhbnNmb3JtUkUudGVzdChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnUHJvcGVydHknXSk7CiAgcmV0dXJuIHsKICAgIHR5cGU6IHR5cGUsCiAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgcHJvcENvdW50OiBwcm9wQ291bnQsCiAgICBoYXNUcmFuc2Zvcm06IGhhc1RyYW5zZm9ybQogIH07Cn0KCmZ1bmN0aW9uIGdldFRpbWVvdXQoZGVsYXlzLCBkdXJhdGlvbnMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIHdoaWxlIChkZWxheXMubGVuZ3RoIDwgZHVyYXRpb25zLmxlbmd0aCkgewogICAgZGVsYXlzID0gZGVsYXlzLmNvbmNhdChkZWxheXMpOwogIH0KCiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGR1cmF0aW9ucy5tYXAoZnVuY3Rpb24gKGQsIGkpIHsKICAgIHJldHVybiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pOwogIH0pKTsKfSAvLyBPbGQgdmVyc2lvbnMgb2YgQ2hyb21pdW0gKGJlbG93IDYxLjAuMzE2My4xMDApIGZvcm1hdHMgZmxvYXRpbmcgcG9pbnRlciBudW1iZXJzCi8vIGluIGEgbG9jYWxlLWRlcGVuZGVudCB3YXksIHVzaW5nIGEgY29tbWEgaW5zdGVhZCBvZiBhIGRvdC4KLy8gSWYgY29tbWEgaXMgbm90IHJlcGxhY2VkIHdpdGggYSBkb3QsIHRoZSBpbnB1dCB3aWxsIGJlIHJvdW5kZWQgZG93biAoaS5lLiBhY3RpbmcKLy8gYXMgYSBmbG9vciBmdW5jdGlvbikgY2F1c2luZyB1bmV4cGVjdGVkIGJlaGF2aW9ycwoKCmZ1bmN0aW9uIHRvTXMocykgewogIHJldHVybiBOdW1iZXIocy5zbGljZSgwLCAtMSkucmVwbGFjZSgnLCcsICcuJykpICogMTAwMDsKfQovKiAgKi8KCgpmdW5jdGlvbiBlbnRlcih2bm9kZSwgdG9nZ2xlRGlzcGxheSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsgLy8gY2FsbCBsZWF2ZSBjYWxsYmFjayBub3cKCiAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgZWwuX2xlYXZlQ2IuY2FuY2VsbGVkID0gdHJ1ZTsKCiAgICBlbC5fbGVhdmVDYigpOwogIH0KCiAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwoKICBpZiAoaXNVbmRlZihkYXRhKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihlbC5fZW50ZXJDYikgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjc3MgPSBkYXRhLmNzczsKICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICB2YXIgZW50ZXJDbGFzcyA9IGRhdGEuZW50ZXJDbGFzczsKICB2YXIgZW50ZXJUb0NsYXNzID0gZGF0YS5lbnRlclRvQ2xhc3M7CiAgdmFyIGVudGVyQWN0aXZlQ2xhc3MgPSBkYXRhLmVudGVyQWN0aXZlQ2xhc3M7CiAgdmFyIGFwcGVhckNsYXNzID0gZGF0YS5hcHBlYXJDbGFzczsKICB2YXIgYXBwZWFyVG9DbGFzcyA9IGRhdGEuYXBwZWFyVG9DbGFzczsKICB2YXIgYXBwZWFyQWN0aXZlQ2xhc3MgPSBkYXRhLmFwcGVhckFjdGl2ZUNsYXNzOwogIHZhciBiZWZvcmVFbnRlciA9IGRhdGEuYmVmb3JlRW50ZXI7CiAgdmFyIGVudGVyID0gZGF0YS5lbnRlcjsKICB2YXIgYWZ0ZXJFbnRlciA9IGRhdGEuYWZ0ZXJFbnRlcjsKICB2YXIgZW50ZXJDYW5jZWxsZWQgPSBkYXRhLmVudGVyQ2FuY2VsbGVkOwogIHZhciBiZWZvcmVBcHBlYXIgPSBkYXRhLmJlZm9yZUFwcGVhcjsKICB2YXIgYXBwZWFyID0gZGF0YS5hcHBlYXI7CiAgdmFyIGFmdGVyQXBwZWFyID0gZGF0YS5hZnRlckFwcGVhcjsKICB2YXIgYXBwZWFyQ2FuY2VsbGVkID0gZGF0YS5hcHBlYXJDYW5jZWxsZWQ7CiAgdmFyIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsgLy8gYWN0aXZlSW5zdGFuY2Ugd2lsbCBhbHdheXMgYmUgdGhlIDx0cmFuc2l0aW9uPiBjb21wb25lbnQgbWFuYWdpbmcgdGhpcwogIC8vIHRyYW5zaXRpb24uIE9uZSBlZGdlIGNhc2UgdG8gY2hlY2sgaXMgd2hlbiB0aGUgPHRyYW5zaXRpb24+IGlzIHBsYWNlZAogIC8vIGFzIHRoZSByb290IG5vZGUgb2YgYSBjaGlsZCBjb21wb25lbnQuIEluIHRoYXQgY2FzZSB3ZSBuZWVkIHRvIGNoZWNrCiAgLy8gPHRyYW5zaXRpb24+J3MgcGFyZW50IGZvciBhcHBlYXIgY2hlY2suCgogIHZhciBjb250ZXh0ID0gYWN0aXZlSW5zdGFuY2U7CiAgdmFyIHRyYW5zaXRpb25Ob2RlID0gYWN0aXZlSW5zdGFuY2UuJHZub2RlOwoKICB3aGlsZSAodHJhbnNpdGlvbk5vZGUgJiYgdHJhbnNpdGlvbk5vZGUucGFyZW50KSB7CiAgICBjb250ZXh0ID0gdHJhbnNpdGlvbk5vZGUuY29udGV4dDsKICAgIHRyYW5zaXRpb25Ob2RlID0gdHJhbnNpdGlvbk5vZGUucGFyZW50OwogIH0KCiAgdmFyIGlzQXBwZWFyID0gIWNvbnRleHQuX2lzTW91bnRlZCB8fCAhdm5vZGUuaXNSb290SW5zZXJ0OwoKICBpZiAoaXNBcHBlYXIgJiYgIWFwcGVhciAmJiBhcHBlYXIgIT09ICcnKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc3RhcnRDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckNsYXNzID8gYXBwZWFyQ2xhc3MgOiBlbnRlckNsYXNzOwogIHZhciBhY3RpdmVDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckFjdGl2ZUNsYXNzID8gYXBwZWFyQWN0aXZlQ2xhc3MgOiBlbnRlckFjdGl2ZUNsYXNzOwogIHZhciB0b0NsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyVG9DbGFzcyA/IGFwcGVhclRvQ2xhc3MgOiBlbnRlclRvQ2xhc3M7CiAgdmFyIGJlZm9yZUVudGVySG9vayA9IGlzQXBwZWFyID8gYmVmb3JlQXBwZWFyIHx8IGJlZm9yZUVudGVyIDogYmVmb3JlRW50ZXI7CiAgdmFyIGVudGVySG9vayA9IGlzQXBwZWFyID8gdHlwZW9mIGFwcGVhciA9PT0gJ2Z1bmN0aW9uJyA/IGFwcGVhciA6IGVudGVyIDogZW50ZXI7CiAgdmFyIGFmdGVyRW50ZXJIb29rID0gaXNBcHBlYXIgPyBhZnRlckFwcGVhciB8fCBhZnRlckVudGVyIDogYWZ0ZXJFbnRlcjsKICB2YXIgZW50ZXJDYW5jZWxsZWRIb29rID0gaXNBcHBlYXIgPyBhcHBlYXJDYW5jZWxsZWQgfHwgZW50ZXJDYW5jZWxsZWQgOiBlbnRlckNhbmNlbGxlZDsKICB2YXIgZXhwbGljaXRFbnRlckR1cmF0aW9uID0gdG9OdW1iZXIoaXNPYmplY3QoZHVyYXRpb24pID8gZHVyYXRpb24uZW50ZXIgOiBkdXJhdGlvbik7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGV4cGxpY2l0RW50ZXJEdXJhdGlvbiAhPSBudWxsKSB7CiAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbiwgJ2VudGVyJywgdm5vZGUpOwogIH0KCiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZW50ZXJIb29rKTsKICB2YXIgY2IgPSBlbC5fZW50ZXJDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICB9CgogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgIH0KCiAgICAgIGVudGVyQ2FuY2VsbGVkSG9vayAmJiBlbnRlckNhbmNlbGxlZEhvb2soZWwpOwogICAgfSBlbHNlIHsKICAgICAgYWZ0ZXJFbnRlckhvb2sgJiYgYWZ0ZXJFbnRlckhvb2soZWwpOwogICAgfQoKICAgIGVsLl9lbnRlckNiID0gbnVsbDsKICB9KTsKCiAgaWYgKCF2bm9kZS5kYXRhLnNob3cpIHsKICAgIC8vIHJlbW92ZSBwZW5kaW5nIGxlYXZlIGVsZW1lbnQgb24gZW50ZXIgYnkgaW5qZWN0aW5nIGFuIGluc2VydCBob29rCiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ2luc2VydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudE5vZGU7CiAgICAgIHZhciBwZW5kaW5nTm9kZSA9IHBhcmVudCAmJiBwYXJlbnQuX3BlbmRpbmcgJiYgcGFyZW50Ll9wZW5kaW5nW3Zub2RlLmtleV07CgogICAgICBpZiAocGVuZGluZ05vZGUgJiYgcGVuZGluZ05vZGUudGFnID09PSB2bm9kZS50YWcgJiYgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKSB7CiAgICAgICAgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKCk7CiAgICAgIH0KCiAgICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICAgIH0pOwogIH0gLy8gc3RhcnQgZW50ZXIgdHJhbnNpdGlvbgoKCiAgYmVmb3JlRW50ZXJIb29rICYmIGJlZm9yZUVudGVySG9vayhlbCk7CgogIGlmIChleHBlY3RzQ1NTKSB7CiAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwogICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICBuZXh0RnJhbWUoZnVuY3Rpb24gKCkgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwoKICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHRvQ2xhc3MpOwoKICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRFbnRlckR1cmF0aW9uKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGNiLCBleHBsaWNpdEVudGVyRHVyYXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIGlmICh2bm9kZS5kYXRhLnNob3cpIHsKICAgIHRvZ2dsZURpc3BsYXkgJiYgdG9nZ2xlRGlzcGxheSgpOwogICAgZW50ZXJIb29rICYmIGVudGVySG9vayhlbCwgY2IpOwogIH0KCiAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICBjYigpOwogIH0KfQoKZnVuY3Rpb24gbGVhdmUodm5vZGUsIHJtKSB7CiAgdmFyIGVsID0gdm5vZGUuZWxtOyAvLyBjYWxsIGVudGVyIGNhbGxiYWNrIG5vdwoKICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpKSB7CiAgICBlbC5fZW50ZXJDYi5jYW5jZWxsZWQgPSB0cnVlOwoKICAgIGVsLl9lbnRlckNiKCk7CiAgfQoKICB2YXIgZGF0YSA9IHJlc29sdmVUcmFuc2l0aW9uKHZub2RlLmRhdGEudHJhbnNpdGlvbik7CgogIGlmIChpc1VuZGVmKGRhdGEpIHx8IGVsLm5vZGVUeXBlICE9PSAxKSB7CiAgICByZXR1cm4gcm0oKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoaXNEZWYoZWwuX2xlYXZlQ2IpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3NzID0gZGF0YS5jc3M7CiAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgdmFyIGxlYXZlQ2xhc3MgPSBkYXRhLmxlYXZlQ2xhc3M7CiAgdmFyIGxlYXZlVG9DbGFzcyA9IGRhdGEubGVhdmVUb0NsYXNzOwogIHZhciBsZWF2ZUFjdGl2ZUNsYXNzID0gZGF0YS5sZWF2ZUFjdGl2ZUNsYXNzOwogIHZhciBiZWZvcmVMZWF2ZSA9IGRhdGEuYmVmb3JlTGVhdmU7CiAgdmFyIGxlYXZlID0gZGF0YS5sZWF2ZTsKICB2YXIgYWZ0ZXJMZWF2ZSA9IGRhdGEuYWZ0ZXJMZWF2ZTsKICB2YXIgbGVhdmVDYW5jZWxsZWQgPSBkYXRhLmxlYXZlQ2FuY2VsbGVkOwogIHZhciBkZWxheUxlYXZlID0gZGF0YS5kZWxheUxlYXZlOwogIHZhciBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247CiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgobGVhdmUpOwogIHZhciBleHBsaWNpdExlYXZlRHVyYXRpb24gPSB0b051bWJlcihpc09iamVjdChkdXJhdGlvbikgPyBkdXJhdGlvbi5sZWF2ZSA6IGR1cmF0aW9uKTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdExlYXZlRHVyYXRpb24sICdsZWF2ZScsIHZub2RlKTsKICB9CgogIHZhciBjYiA9IGVsLl9sZWF2ZUNiID0gb25jZShmdW5jdGlvbiAoKSB7CiAgICBpZiAoZWwucGFyZW50Tm9kZSAmJiBlbC5wYXJlbnROb2RlLl9wZW5kaW5nKSB7CiAgICAgIGVsLnBhcmVudE5vZGUuX3BlbmRpbmdbdm5vZGUua2V5XSA9IG51bGw7CiAgICB9CgogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgfQoKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICB9CgogICAgICBsZWF2ZUNhbmNlbGxlZCAmJiBsZWF2ZUNhbmNlbGxlZChlbCk7CiAgICB9IGVsc2UgewogICAgICBybSgpOwogICAgICBhZnRlckxlYXZlICYmIGFmdGVyTGVhdmUoZWwpOwogICAgfQoKICAgIGVsLl9sZWF2ZUNiID0gbnVsbDsKICB9KTsKCiAgaWYgKGRlbGF5TGVhdmUpIHsKICAgIGRlbGF5TGVhdmUocGVyZm9ybUxlYXZlKTsKICB9IGVsc2UgewogICAgcGVyZm9ybUxlYXZlKCk7CiAgfQoKICBmdW5jdGlvbiBwZXJmb3JtTGVhdmUoKSB7CiAgICAvLyB0aGUgZGVsYXllZCBsZWF2ZSBtYXkgaGF2ZSBhbHJlYWR5IGJlZW4gY2FuY2VsbGVkCiAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gcmVjb3JkIGxlYXZpbmcgZWxlbWVudAoKCiAgICBpZiAoIXZub2RlLmRhdGEuc2hvdyAmJiBlbC5wYXJlbnROb2RlKSB7CiAgICAgIChlbC5wYXJlbnROb2RlLl9wZW5kaW5nIHx8IChlbC5wYXJlbnROb2RlLl9wZW5kaW5nID0ge30pKVt2bm9kZS5rZXldID0gdm5vZGU7CiAgICB9CgogICAgYmVmb3JlTGVhdmUgJiYgYmVmb3JlTGVhdmUoZWwpOwoKICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKCiAgICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVUb0NsYXNzKTsKCiAgICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdExlYXZlRHVyYXRpb24pKSB7CiAgICAgICAgICAgICAgc2V0VGltZW91dChjYiwgZXhwbGljaXRMZWF2ZUR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgbGVhdmUgJiYgbGVhdmUoZWwsIGNiKTsKCiAgICBpZiAoIWV4cGVjdHNDU1MgJiYgIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgY2IoKTsKICAgIH0KICB9Cn0gLy8gb25seSB1c2VkIGluIGRldiBtb2RlCgoKZnVuY3Rpb24gY2hlY2tEdXJhdGlvbih2YWwsIG5hbWUsIHZub2RlKSB7CiAgaWYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInKSB7CiAgICB3YXJuKCI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIiArIG5hbWUgKyAiIGR1cmF0aW9uIGlzIG5vdCBhIHZhbGlkIG51bWJlciAtICIgKyAiZ290ICIgKyBKU09OLnN0cmluZ2lmeSh2YWwpICsgIi4iLCB2bm9kZS5jb250ZXh0KTsKICB9IGVsc2UgaWYgKGlzTmFOKHZhbCkpIHsKICAgIHdhcm4oIjx0cmFuc2l0aW9uPiBleHBsaWNpdCAiICsgbmFtZSArICIgZHVyYXRpb24gaXMgTmFOIC0gIiArICd0aGUgZHVyYXRpb24gZXhwcmVzc2lvbiBtaWdodCBiZSBpbmNvcnJlY3QuJywgdm5vZGUuY29udGV4dCk7CiAgfQp9CgpmdW5jdGlvbiBpc1ZhbGlkRHVyYXRpb24odmFsKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdudW1iZXInICYmICFpc05hTih2YWwpOwp9Ci8qKgogKiBOb3JtYWxpemUgYSB0cmFuc2l0aW9uIGhvb2sncyBhcmd1bWVudCBsZW5ndGguIFRoZSBob29rIG1heSBiZToKICogLSBhIG1lcmdlZCBob29rIChpbnZva2VyKSB3aXRoIHRoZSBvcmlnaW5hbCBpbiAuZm5zCiAqIC0gYSB3cmFwcGVkIGNvbXBvbmVudCBtZXRob2QgKGNoZWNrIC5fbGVuZ3RoKQogKiAtIGEgcGxhaW4gZnVuY3Rpb24gKC5sZW5ndGgpCiAqLwoKCmZ1bmN0aW9uIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZm4pIHsKICBpZiAoaXNVbmRlZihmbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBpbnZva2VyRm5zID0gZm4uZm5zOwoKICBpZiAoaXNEZWYoaW52b2tlckZucykpIHsKICAgIC8vIGludm9rZXIKICAgIHJldHVybiBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKEFycmF5LmlzQXJyYXkoaW52b2tlckZucykgPyBpbnZva2VyRm5zWzBdIDogaW52b2tlckZucyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAoZm4uX2xlbmd0aCB8fCBmbi5sZW5ndGgpID4gMTsKICB9Cn0KCmZ1bmN0aW9uIF9lbnRlcihfLCB2bm9kZSkgewogIGlmICh2bm9kZS5kYXRhLnNob3cgIT09IHRydWUpIHsKICAgIGVudGVyKHZub2RlKTsKICB9Cn0KCnZhciB0cmFuc2l0aW9uID0gaW5Ccm93c2VyID8gewogIGNyZWF0ZTogX2VudGVyLAogIGFjdGl2YXRlOiBfZW50ZXIsCiAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUkJDEodm5vZGUsIHJtKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICBsZWF2ZSh2bm9kZSwgcm0pOwogICAgfSBlbHNlIHsKICAgICAgcm0oKTsKICAgIH0KICB9Cn0gOiB7fTsKdmFyIHBsYXRmb3JtTW9kdWxlcyA9IFthdHRycywga2xhc3MsIGV2ZW50cywgZG9tUHJvcHMsIHN0eWxlLCB0cmFuc2l0aW9uXTsKLyogICovCi8vIHRoZSBkaXJlY3RpdmUgbW9kdWxlIHNob3VsZCBiZSBhcHBsaWVkIGxhc3QsIGFmdGVyIGFsbAovLyBidWlsdC1pbiBtb2R1bGVzIGhhdmUgYmVlbiBhcHBsaWVkLgoKdmFyIG1vZHVsZXMgPSBwbGF0Zm9ybU1vZHVsZXMuY29uY2F0KGJhc2VNb2R1bGVzKTsKdmFyIHBhdGNoID0gY3JlYXRlUGF0Y2hGdW5jdGlvbih7CiAgbm9kZU9wczogbm9kZU9wcywKICBtb2R1bGVzOiBtb2R1bGVzCn0pOwovKioKICogTm90IHR5cGUgY2hlY2tpbmcgdGhpcyBmaWxlIGJlY2F1c2UgZmxvdyBkb2Vzbid0IGxpa2UgYXR0YWNoaW5nCiAqIHByb3BlcnRpZXMgdG8gRWxlbWVudHMuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIGlmICovCgppZiAoaXNJRTkpIHsKICAvLyBodHRwOi8vd3d3Lm1hdHRzNDExLmNvbS9wb3N0L2ludGVybmV0LWV4cGxvcmVyLTktb25pbnB1dC8KICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoKICAgIGlmIChlbCAmJiBlbC52bW9kZWwpIHsKICAgICAgdHJpZ2dlcihlbCwgJ2lucHV0Jyk7CiAgICB9CiAgfSk7Cn0KCnZhciBkaXJlY3RpdmUgPSB7CiAgaW5zZXJ0ZWQ6IGZ1bmN0aW9uIGluc2VydGVkKGVsLCBiaW5kaW5nLCB2bm9kZSwgb2xkVm5vZGUpIHsKICAgIGlmICh2bm9kZS50YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgIC8vICM2OTAzCiAgICAgIGlmIChvbGRWbm9kZS5lbG0gJiYgIW9sZFZub2RlLmVsbS5fdk9wdGlvbnMpIHsKICAgICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRpcmVjdGl2ZS5jb21wb25lbnRVcGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOwogICAgICB9CgogICAgICBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CiAgICB9IGVsc2UgaWYgKHZub2RlLnRhZyA9PT0gJ3RleHRhcmVhJyB8fCBpc1RleHRJbnB1dFR5cGUoZWwudHlwZSkpIHsKICAgICAgZWwuX3ZNb2RpZmllcnMgPSBiaW5kaW5nLm1vZGlmaWVyczsKCiAgICAgIGlmICghYmluZGluZy5tb2RpZmllcnMubGF6eSkgewogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uc3RhcnQnLCBvbkNvbXBvc2l0aW9uU3RhcnQpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uZW5kJywgb25Db21wb3NpdGlvbkVuZCk7IC8vIFNhZmFyaSA8IDEwLjIgJiBVSVdlYlZpZXcgZG9lc24ndCBmaXJlIGNvbXBvc2l0aW9uZW5kIHdoZW4KICAgICAgICAvLyBzd2l0Y2hpbmcgZm9jdXMgYmVmb3JlIGNvbmZpcm1pbmcgY29tcG9zaXRpb24gY2hvaWNlCiAgICAgICAgLy8gdGhpcyBhbHNvIGZpeGVzIHRoZSBpc3N1ZSB3aGVyZSBzb21lIGJyb3dzZXJzIGUuZy4gaU9TIENocm9tZQogICAgICAgIC8vIGZpcmVzICJjaGFuZ2UiIGluc3RlYWQgb2YgImlucHV0IiBvbiBhdXRvY29tcGxldGUuCgogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIG9uQ29tcG9zaXRpb25FbmQpOwogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgICAgICBpZiAoaXNJRTkpIHsKICAgICAgICAgIGVsLnZtb2RlbCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKICBjb21wb25lbnRVcGRhdGVkOiBmdW5jdGlvbiBjb21wb25lbnRVcGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgaWYgKHZub2RlLnRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOyAvLyBpbiBjYXNlIHRoZSBvcHRpb25zIHJlbmRlcmVkIGJ5IHYtZm9yIGhhdmUgY2hhbmdlZCwKICAgICAgLy8gaXQncyBwb3NzaWJsZSB0aGF0IHRoZSB2YWx1ZSBpcyBvdXQtb2Ytc3luYyB3aXRoIHRoZSByZW5kZXJlZCBvcHRpb25zLgogICAgICAvLyBkZXRlY3Qgc3VjaCBjYXNlcyBhbmQgZmlsdGVyIG91dCB2YWx1ZXMgdGhhdCBubyBsb25nZXIgaGFzIGEgbWF0Y2hpbmcKICAgICAgLy8gb3B0aW9uIGluIHRoZSBET00uCgogICAgICB2YXIgcHJldk9wdGlvbnMgPSBlbC5fdk9wdGlvbnM7CiAgICAgIHZhciBjdXJPcHRpb25zID0gZWwuX3ZPcHRpb25zID0gW10ubWFwLmNhbGwoZWwub3B0aW9ucywgZ2V0VmFsdWUpOwoKICAgICAgaWYgKGN1ck9wdGlvbnMuc29tZShmdW5jdGlvbiAobywgaSkgewogICAgICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCBwcmV2T3B0aW9uc1tpXSk7CiAgICAgIH0pKSB7CiAgICAgICAgLy8gdHJpZ2dlciBjaGFuZ2UgZXZlbnQgaWYKICAgICAgICAvLyBubyBtYXRjaGluZyBvcHRpb24gZm91bmQgZm9yIGF0IGxlYXN0IG9uZSB2YWx1ZQogICAgICAgIHZhciBuZWVkUmVzZXQgPSBlbC5tdWx0aXBsZSA/IGJpbmRpbmcudmFsdWUuc29tZShmdW5jdGlvbiAodikgewogICAgICAgICAgcmV0dXJuIGhhc05vTWF0Y2hpbmdPcHRpb24odiwgY3VyT3B0aW9ucyk7CiAgICAgICAgfSkgOiBiaW5kaW5nLnZhbHVlICE9PSBiaW5kaW5nLm9sZFZhbHVlICYmIGhhc05vTWF0Y2hpbmdPcHRpb24oYmluZGluZy52YWx1ZSwgY3VyT3B0aW9ucyk7CgogICAgICAgIGlmIChuZWVkUmVzZXQpIHsKICAgICAgICAgIHRyaWdnZXIoZWwsICdjaGFuZ2UnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChpc0lFIHx8IGlzRWRnZSkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgIH0sIDApOwogIH0KfQoKZnVuY3Rpb24gYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICB2YXIgdmFsdWUgPSBiaW5kaW5nLnZhbHVlOwogIHZhciBpc011bHRpcGxlID0gZWwubXVsdGlwbGU7CgogIGlmIChpc011bHRpcGxlICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCI8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw9XCIiICsgYmluZGluZy5leHByZXNzaW9uICsgIlwiPiAiICsgImV4cGVjdHMgYW4gQXJyYXkgdmFsdWUgZm9yIGl0cyBiaW5kaW5nLCBidXQgZ290ICIgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLnNsaWNlKDgsIC0xKSwgdm0pOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIHNlbGVjdGVkLCBvcHRpb247CgogIGZvciAodmFyIGkgPSAwLCBsID0gZWwub3B0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIG9wdGlvbiA9IGVsLm9wdGlvbnNbaV07CgogICAgaWYgKGlzTXVsdGlwbGUpIHsKICAgICAgc2VsZWN0ZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIGdldFZhbHVlKG9wdGlvbikpID4gLTE7CgogICAgICBpZiAob3B0aW9uLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHNlbGVjdGVkOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAobG9vc2VFcXVhbChnZXRWYWx1ZShvcHRpb24pLCB2YWx1ZSkpIHsKICAgICAgICBpZiAoZWwuc2VsZWN0ZWRJbmRleCAhPT0gaSkgewogICAgICAgICAgZWwuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CgogIGlmICghaXNNdWx0aXBsZSkgewogICAgZWwuc2VsZWN0ZWRJbmRleCA9IC0xOwogIH0KfQoKZnVuY3Rpb24gaGFzTm9NYXRjaGluZ09wdGlvbih2YWx1ZSwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmV2ZXJ5KGZ1bmN0aW9uIChvKSB7CiAgICByZXR1cm4gIWxvb3NlRXF1YWwobywgdmFsdWUpOwogIH0pOwp9CgpmdW5jdGlvbiBnZXRWYWx1ZShvcHRpb24pIHsKICByZXR1cm4gJ192YWx1ZScgaW4gb3B0aW9uID8gb3B0aW9uLl92YWx1ZSA6IG9wdGlvbi52YWx1ZTsKfQoKZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0KGUpIHsKICBlLnRhcmdldC5jb21wb3NpbmcgPSB0cnVlOwp9CgpmdW5jdGlvbiBvbkNvbXBvc2l0aW9uRW5kKGUpIHsKICAvLyBwcmV2ZW50IHRyaWdnZXJpbmcgYW4gaW5wdXQgZXZlbnQgZm9yIG5vIHJlYXNvbgogIGlmICghZS50YXJnZXQuY29tcG9zaW5nKSB7CiAgICByZXR1cm47CiAgfQoKICBlLnRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICB0cmlnZ2VyKGUudGFyZ2V0LCAnaW5wdXQnKTsKfQoKZnVuY3Rpb24gdHJpZ2dlcihlbCwgdHlwZSkgewogIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICBlLmluaXRFdmVudCh0eXBlLCB0cnVlLCB0cnVlKTsKICBlbC5kaXNwYXRjaEV2ZW50KGUpOwp9Ci8qICAqLwovLyByZWN1cnNpdmVseSBzZWFyY2ggZm9yIHBvc3NpYmxlIHRyYW5zaXRpb24gZGVmaW5lZCBpbnNpZGUgdGhlIGNvbXBvbmVudCByb290CgoKZnVuY3Rpb24gbG9jYXRlTm9kZSh2bm9kZSkgewogIHJldHVybiB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSAmJiAoIXZub2RlLmRhdGEgfHwgIXZub2RlLmRhdGEudHJhbnNpdGlvbikgPyBsb2NhdGVOb2RlKHZub2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSkgOiB2bm9kZTsKfQoKdmFyIHNob3cgPSB7CiAgYmluZDogZnVuY3Rpb24gYmluZChlbCwgcmVmLCB2bm9kZSkgewogICAgdmFyIHZhbHVlID0gcmVmLnZhbHVlOwogICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgIHZhciB0cmFuc2l0aW9uJCQxID0gdm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLnRyYW5zaXRpb247CiAgICB2YXIgb3JpZ2luYWxEaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5ID0gZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJycgOiBlbC5zdHlsZS5kaXNwbGF5OwoKICAgIGlmICh2YWx1ZSAmJiB0cmFuc2l0aW9uJCQxKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IG9yaWdpbmFsRGlzcGxheTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBvcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShlbCwgcmVmLCB2bm9kZSkgewogICAgdmFyIHZhbHVlID0gcmVmLnZhbHVlOwogICAgdmFyIG9sZFZhbHVlID0gcmVmLm9sZFZhbHVlOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKCF2YWx1ZSA9PT0gIW9sZFZhbHVlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgdmFyIHRyYW5zaXRpb24kJDEgPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKCiAgICBpZiAodHJhbnNpdGlvbiQkMSkgewogICAgICB2bm9kZS5kYXRhLnNob3cgPSB0cnVlOwoKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVhdmUodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZSA/IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA6ICdub25lJzsKICAgIH0KICB9LAogIHVuYmluZDogZnVuY3Rpb24gdW5iaW5kKGVsLCBiaW5kaW5nLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSkgewogICAgaWYgKCFpc0Rlc3Ryb3kpIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgIH0KICB9Cn07CnZhciBwbGF0Zm9ybURpcmVjdGl2ZXMgPSB7CiAgbW9kZWw6IGRpcmVjdGl2ZSwKICBzaG93OiBzaG93Cn07Ci8qICAqLwoKdmFyIHRyYW5zaXRpb25Qcm9wcyA9IHsKICBuYW1lOiBTdHJpbmcsCiAgYXBwZWFyOiBCb29sZWFuLAogIGNzczogQm9vbGVhbiwKICBtb2RlOiBTdHJpbmcsCiAgdHlwZTogU3RyaW5nLAogIGVudGVyQ2xhc3M6IFN0cmluZywKICBsZWF2ZUNsYXNzOiBTdHJpbmcsCiAgZW50ZXJUb0NsYXNzOiBTdHJpbmcsCiAgbGVhdmVUb0NsYXNzOiBTdHJpbmcsCiAgZW50ZXJBY3RpdmVDbGFzczogU3RyaW5nLAogIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywKICBhcHBlYXJDbGFzczogU3RyaW5nLAogIGFwcGVhckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogIGR1cmF0aW9uOiBbTnVtYmVyLCBTdHJpbmcsIE9iamVjdF0KfTsgLy8gaW4gY2FzZSB0aGUgY2hpbGQgaXMgYWxzbyBhbiBhYnN0cmFjdCBjb21wb25lbnQsIGUuZy4gPGtlZXAtYWxpdmU+Ci8vIHdlIHdhbnQgdG8gcmVjdXJzaXZlbHkgcmV0cmlldmUgdGhlIHJlYWwgY29tcG9uZW50IHRvIGJlIHJlbmRlcmVkCgpmdW5jdGlvbiBnZXRSZWFsQ2hpbGQodm5vZGUpIHsKICB2YXIgY29tcE9wdGlvbnMgPSB2bm9kZSAmJiB2bm9kZS5jb21wb25lbnRPcHRpb25zOwoKICBpZiAoY29tcE9wdGlvbnMgJiYgY29tcE9wdGlvbnMuQ3Rvci5vcHRpb25zWyJhYnN0cmFjdCJdKSB7CiAgICByZXR1cm4gZ2V0UmVhbENoaWxkKGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoY29tcE9wdGlvbnMuY2hpbGRyZW4pKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHZub2RlOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdFRyYW5zaXRpb25EYXRhKGNvbXApIHsKICB2YXIgZGF0YSA9IHt9OwogIHZhciBvcHRpb25zID0gY29tcC4kb3B0aW9uczsgLy8gcHJvcHMKCiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMucHJvcHNEYXRhKSB7CiAgICBkYXRhW2tleV0gPSBjb21wW2tleV07CiAgfSAvLyBldmVudHMuCiAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgYW5kIHBhc3MgdGhlbSBkaXJlY3RseSB0byB0aGUgdHJhbnNpdGlvbiBtZXRob2RzCgoKICB2YXIgbGlzdGVuZXJzID0gb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwoKICBmb3IgKHZhciBrZXkkMSBpbiBsaXN0ZW5lcnMpIHsKICAgIGRhdGFbY2FtZWxpemUoa2V5JDEpXSA9IGxpc3RlbmVyc1trZXkkMV07CiAgfQoKICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpIHsKICBpZiAoL1xkLWtlZXAtYWxpdmUkLy50ZXN0KHJhd0NoaWxkLnRhZykpIHsKICAgIHJldHVybiBoKCdrZWVwLWFsaXZlJywgewogICAgICBwcm9wczogcmF3Q2hpbGQuY29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGEKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gaGFzUGFyZW50VHJhbnNpdGlvbih2bm9kZSkgewogIHdoaWxlICh2bm9kZSA9IHZub2RlLnBhcmVudCkgewogICAgaWYgKHZub2RlLmRhdGEudHJhbnNpdGlvbikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgewogIHJldHVybiBvbGRDaGlsZC5rZXkgPT09IGNoaWxkLmtleSAmJiBvbGRDaGlsZC50YWcgPT09IGNoaWxkLnRhZzsKfQoKdmFyIGlzTm90VGV4dE5vZGUgPSBmdW5jdGlvbiBpc05vdFRleHROb2RlKGMpIHsKICByZXR1cm4gYy50YWcgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpOwp9OwoKdmFyIGlzVlNob3dEaXJlY3RpdmUgPSBmdW5jdGlvbiBpc1ZTaG93RGlyZWN0aXZlKGQpIHsKICByZXR1cm4gZC5uYW1lID09PSAnc2hvdyc7Cn07Cgp2YXIgVHJhbnNpdGlvbiA9IHsKICBuYW1lOiAndHJhbnNpdGlvbicsCiAgcHJvcHM6IHRyYW5zaXRpb25Qcm9wcywKICAiYWJzdHJhY3QiOiB0cnVlLAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKGgpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdmFyIGNoaWxkcmVuID0gdGhpcy4kc2xvdHNbImRlZmF1bHQiXTsKCiAgICBpZiAoIWNoaWxkcmVuKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gZmlsdGVyIG91dCB0ZXh0IG5vZGVzIChwb3NzaWJsZSB3aGl0ZXNwYWNlcykKCgogICAgY2hpbGRyZW4gPSBjaGlsZHJlbi5maWx0ZXIoaXNOb3RUZXh0Tm9kZSk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9IC8vIHdhcm4gbXVsdGlwbGUgZWxlbWVudHMKCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY2hpbGRyZW4ubGVuZ3RoID4gMSkgewogICAgICB3YXJuKCc8dHJhbnNpdGlvbj4gY2FuIG9ubHkgYmUgdXNlZCBvbiBhIHNpbmdsZSBlbGVtZW50LiBVc2UgJyArICc8dHJhbnNpdGlvbi1ncm91cD4gZm9yIGxpc3RzLicsIHRoaXMuJHBhcmVudCk7CiAgICB9CgogICAgdmFyIG1vZGUgPSB0aGlzLm1vZGU7IC8vIHdhcm4gaW52YWxpZCBtb2RlCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbW9kZSAmJiBtb2RlICE9PSAnaW4tb3V0JyAmJiBtb2RlICE9PSAnb3V0LWluJykgewogICAgICB3YXJuKCdpbnZhbGlkIDx0cmFuc2l0aW9uPiBtb2RlOiAnICsgbW9kZSwgdGhpcy4kcGFyZW50KTsKICAgIH0KCiAgICB2YXIgcmF3Q2hpbGQgPSBjaGlsZHJlblswXTsgLy8gaWYgdGhpcyBpcyBhIGNvbXBvbmVudCByb290IG5vZGUgYW5kIHRoZSBjb21wb25lbnQncwogICAgLy8gcGFyZW50IGNvbnRhaW5lciBub2RlIGFsc28gaGFzIHRyYW5zaXRpb24sIHNraXAuCgogICAgaWYgKGhhc1BhcmVudFRyYW5zaXRpb24odGhpcy4kdm5vZGUpKSB7CiAgICAgIHJldHVybiByYXdDaGlsZDsKICAgIH0gLy8gYXBwbHkgdHJhbnNpdGlvbiBkYXRhIHRvIGNoaWxkCiAgICAvLyB1c2UgZ2V0UmVhbENoaWxkKCkgdG8gaWdub3JlIGFic3RyYWN0IGNvbXBvbmVudHMgZS5nLiBrZWVwLWFsaXZlCgoKICAgIHZhciBjaGlsZCA9IGdldFJlYWxDaGlsZChyYXdDaGlsZCk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAoIWNoaWxkKSB7CiAgICAgIHJldHVybiByYXdDaGlsZDsKICAgIH0KCiAgICBpZiAodGhpcy5fbGVhdmluZykgewogICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpOwogICAgfSAvLyBlbnN1cmUgYSBrZXkgdGhhdCBpcyB1bmlxdWUgdG8gdGhlIHZub2RlIHR5cGUgYW5kIHRvIHRoaXMgdHJhbnNpdGlvbgogICAgLy8gY29tcG9uZW50IGluc3RhbmNlLiBUaGlzIGtleSB3aWxsIGJlIHVzZWQgdG8gcmVtb3ZlIHBlbmRpbmcgbGVhdmluZyBub2RlcwogICAgLy8gZHVyaW5nIGVudGVyaW5nLgoKCiAgICB2YXIgaWQgPSAiX190cmFuc2l0aW9uLSIgKyB0aGlzLl91aWQgKyAiLSI7CiAgICBjaGlsZC5rZXkgPSBjaGlsZC5rZXkgPT0gbnVsbCA/IGNoaWxkLmlzQ29tbWVudCA/IGlkICsgJ2NvbW1lbnQnIDogaWQgKyBjaGlsZC50YWcgOiBpc1ByaW1pdGl2ZShjaGlsZC5rZXkpID8gU3RyaW5nKGNoaWxkLmtleSkuaW5kZXhPZihpZCkgPT09IDAgPyBjaGlsZC5rZXkgOiBpZCArIGNoaWxkLmtleSA6IGNoaWxkLmtleTsKICAgIHZhciBkYXRhID0gKGNoaWxkLmRhdGEgfHwgKGNoaWxkLmRhdGEgPSB7fSkpLnRyYW5zaXRpb24gPSBleHRyYWN0VHJhbnNpdGlvbkRhdGEodGhpcyk7CiAgICB2YXIgb2xkUmF3Q2hpbGQgPSB0aGlzLl92bm9kZTsKICAgIHZhciBvbGRDaGlsZCA9IGdldFJlYWxDaGlsZChvbGRSYXdDaGlsZCk7IC8vIG1hcmsgdi1zaG93CiAgICAvLyBzbyB0aGF0IHRoZSB0cmFuc2l0aW9uIG1vZHVsZSBjYW4gaGFuZCBvdmVyIHRoZSBjb250cm9sIHRvIHRoZSBkaXJlY3RpdmUKCiAgICBpZiAoY2hpbGQuZGF0YS5kaXJlY3RpdmVzICYmIGNoaWxkLmRhdGEuZGlyZWN0aXZlcy5zb21lKGlzVlNob3dEaXJlY3RpdmUpKSB7CiAgICAgIGNoaWxkLmRhdGEuc2hvdyA9IHRydWU7CiAgICB9CgogICAgaWYgKG9sZENoaWxkICYmIG9sZENoaWxkLmRhdGEgJiYgIWlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgJiYgIWlzQXN5bmNQbGFjZWhvbGRlcihvbGRDaGlsZCkgJiYgLy8gIzY2ODcgY29tcG9uZW50IHJvb3QgaXMgYSBjb21tZW50IG5vZGUKICAgICEob2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UgJiYgb2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlLmlzQ29tbWVudCkpIHsKICAgICAgLy8gcmVwbGFjZSBvbGQgY2hpbGQgdHJhbnNpdGlvbiBkYXRhIHdpdGggZnJlc2ggb25lCiAgICAgIC8vIGltcG9ydGFudCBmb3IgZHluYW1pYyB0cmFuc2l0aW9ucyEKICAgICAgdmFyIG9sZERhdGEgPSBvbGRDaGlsZC5kYXRhLnRyYW5zaXRpb24gPSBleHRlbmQoe30sIGRhdGEpOyAvLyBoYW5kbGUgdHJhbnNpdGlvbiBtb2RlCgogICAgICBpZiAobW9kZSA9PT0gJ291dC1pbicpIHsKICAgICAgICAvLyByZXR1cm4gcGxhY2Vob2xkZXIgbm9kZSBhbmQgcXVldWUgdXBkYXRlIHdoZW4gbGVhdmUgZmluaXNoZXMKICAgICAgICB0aGlzLl9sZWF2aW5nID0gdHJ1ZTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnYWZ0ZXJMZWF2ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMkMS5fbGVhdmluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcyQxLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCk7CiAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2luLW91dCcpIHsKICAgICAgICBpZiAoaXNBc3luY1BsYWNlaG9sZGVyKGNoaWxkKSkgewogICAgICAgICAgcmV0dXJuIG9sZFJhd0NoaWxkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbGF5ZWRMZWF2ZTsKCiAgICAgICAgdmFyIHBlcmZvcm1MZWF2ZSA9IGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSgpIHsKICAgICAgICAgIGRlbGF5ZWRMZWF2ZSgpOwogICAgICAgIH07CgogICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdhZnRlckVudGVyJywgcGVyZm9ybUxlYXZlKTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnZW50ZXJDYW5jZWxsZWQnLCBwZXJmb3JtTGVhdmUpOwogICAgICAgIG1lcmdlVk5vZGVIb29rKG9sZERhdGEsICdkZWxheUxlYXZlJywgZnVuY3Rpb24gKGxlYXZlKSB7CiAgICAgICAgICBkZWxheWVkTGVhdmUgPSBsZWF2ZTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByYXdDaGlsZDsKICB9Cn07Ci8qICAqLwoKdmFyIHByb3BzID0gZXh0ZW5kKHsKICB0YWc6IFN0cmluZywKICBtb3ZlQ2xhc3M6IFN0cmluZwp9LCB0cmFuc2l0aW9uUHJvcHMpOwpkZWxldGUgcHJvcHMubW9kZTsKdmFyIFRyYW5zaXRpb25Hcm91cCA9IHsKICBwcm9wczogcHJvcHMsCiAgYmVmb3JlTW91bnQ6IGZ1bmN0aW9uIGJlZm9yZU1vdW50KCkgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgICB2YXIgdXBkYXRlID0gdGhpcy5fdXBkYXRlOwoKICAgIHRoaXMuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh0aGlzJDEpOyAvLyBmb3JjZSByZW1vdmluZyBwYXNzCgogICAgICB0aGlzJDEuX19wYXRjaF9fKHRoaXMkMS5fdm5vZGUsIHRoaXMkMS5rZXB0LCBmYWxzZSwgLy8gaHlkcmF0aW5nCiAgICAgIHRydWUgLy8gcmVtb3ZlT25seSAoIWltcG9ydGFudCwgYXZvaWRzIHVubmVjZXNzYXJ5IG1vdmVzKQogICAgICApOwoKICAgICAgdGhpcyQxLl92bm9kZSA9IHRoaXMkMS5rZXB0OwogICAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsKICAgICAgdXBkYXRlLmNhbGwodGhpcyQxLCB2bm9kZSwgaHlkcmF0aW5nKTsKICAgIH07CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihoKSB7CiAgICB2YXIgdGFnID0gdGhpcy50YWcgfHwgdGhpcy4kdm5vZGUuZGF0YS50YWcgfHwgJ3NwYW4nOwogICAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB2YXIgcHJldkNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgdmFyIHJhd0NoaWxkcmVuID0gdGhpcy4kc2xvdHNbImRlZmF1bHQiXSB8fCBbXTsKICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgIHZhciB0cmFuc2l0aW9uRGF0YSA9IGV4dHJhY3RUcmFuc2l0aW9uRGF0YSh0aGlzKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhd0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjID0gcmF3Q2hpbGRyZW5baV07CgogICAgICBpZiAoYy50YWcpIHsKICAgICAgICBpZiAoYy5rZXkgIT0gbnVsbCAmJiBTdHJpbmcoYy5rZXkpLmluZGV4T2YoJ19fdmxpc3QnKSAhPT0gMCkgewogICAgICAgICAgY2hpbGRyZW4ucHVzaChjKTsKICAgICAgICAgIG1hcFtjLmtleV0gPSBjOwogICAgICAgICAgKGMuZGF0YSB8fCAoYy5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gdHJhbnNpdGlvbkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB2YXIgb3B0cyA9IGMuY29tcG9uZW50T3B0aW9uczsKICAgICAgICAgIHZhciBuYW1lID0gb3B0cyA/IG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcgfHwgJycgOiBjLnRhZzsKICAgICAgICAgIHdhcm4oIjx0cmFuc2l0aW9uLWdyb3VwPiBjaGlsZHJlbiBtdXN0IGJlIGtleWVkOiA8IiArIG5hbWUgKyAiPiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChwcmV2Q2hpbGRyZW4pIHsKICAgICAgdmFyIGtlcHQgPSBbXTsKICAgICAgdmFyIHJlbW92ZWQgPSBbXTsKCiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IHByZXZDaGlsZHJlbi5sZW5ndGg7IGkkMSsrKSB7CiAgICAgICAgdmFyIGMkMSA9IHByZXZDaGlsZHJlbltpJDFdOwogICAgICAgIGMkMS5kYXRhLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICBjJDEuZGF0YS5wb3MgPSBjJDEuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICBpZiAobWFwW2MkMS5rZXldKSB7CiAgICAgICAgICBrZXB0LnB1c2goYyQxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZC5wdXNoKGMkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmtlcHQgPSBoKHRhZywgbnVsbCwga2VwdCk7CiAgICAgIHRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7CiAgICB9CgogICAgcmV0dXJuIGgodGFnLCBudWxsLCBjaGlsZHJlbik7CiAgfSwKICB1cGRhdGVkOiBmdW5jdGlvbiB1cGRhdGVkKCkgewogICAgdmFyIGNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW47CiAgICB2YXIgbW92ZUNsYXNzID0gdGhpcy5tb3ZlQ2xhc3MgfHwgKHRoaXMubmFtZSB8fCAndicpICsgJy1tb3ZlJzsKCiAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCB8fCAhdGhpcy5oYXNNb3ZlKGNoaWxkcmVuWzBdLmVsbSwgbW92ZUNsYXNzKSkgewogICAgICByZXR1cm47CiAgICB9IC8vIHdlIGRpdmlkZSB0aGUgd29yayBpbnRvIHRocmVlIGxvb3BzIHRvIGF2b2lkIG1peGluZyBET00gcmVhZHMgYW5kIHdyaXRlcwogICAgLy8gaW4gZWFjaCBpdGVyYXRpb24gLSB3aGljaCBoZWxwcyBwcmV2ZW50IGxheW91dCB0aHJhc2hpbmcuCgoKICAgIGNoaWxkcmVuLmZvckVhY2goY2FsbFBlbmRpbmdDYnMpOwogICAgY2hpbGRyZW4uZm9yRWFjaChyZWNvcmRQb3NpdGlvbik7CiAgICBjaGlsZHJlbi5mb3JFYWNoKGFwcGx5VHJhbnNsYXRpb24pOyAvLyBmb3JjZSByZWZsb3cgdG8gcHV0IGV2ZXJ5dGhpbmcgaW4gcG9zaXRpb24KICAgIC8vIGFzc2lnbiB0byB0aGlzIHRvIGF2b2lkIGJlaW5nIHJlbW92ZWQgaW4gdHJlZS1zaGFraW5nCiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICB0aGlzLl9yZWZsb3cgPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDsKICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgaWYgKGMuZGF0YS5tb3ZlZCkgewogICAgICAgIHZhciBlbCA9IGMuZWxtOwogICAgICAgIHZhciBzID0gZWwuc3R5bGU7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgIHMudHJhbnNmb3JtID0gcy5XZWJraXRUcmFuc2Zvcm0gPSBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcnOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBlbC5fbW92ZUNiID0gZnVuY3Rpb24gY2IoZSkgewogICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWUgfHwgL3RyYW5zZm9ybSQvLnRlc3QoZS5wcm9wZXJ0eU5hbWUpKSB7CiAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBjYik7CiAgICAgICAgICAgIGVsLl9tb3ZlQ2IgPSBudWxsOwogICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIG1vdmVDbGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgbWV0aG9kczogewogICAgaGFzTW92ZTogZnVuY3Rpb24gaGFzTW92ZShlbCwgbW92ZUNsYXNzKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoIWhhc1RyYW5zaXRpb24pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICAgICAgaWYgKHRoaXMuX2hhc01vdmUpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzTW92ZTsKICAgICAgfSAvLyBEZXRlY3Qgd2hldGhlciBhbiBlbGVtZW50IHdpdGggdGhlIG1vdmUgY2xhc3MgYXBwbGllZCBoYXMKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zLiBTaW5jZSB0aGUgZWxlbWVudCBtYXkgYmUgaW5zaWRlIGFuIGVudGVyaW5nCiAgICAgIC8vIHRyYW5zaXRpb24gYXQgdGhpcyB2ZXJ5IG1vbWVudCwgd2UgbWFrZSBhIGNsb25lIG9mIGl0IGFuZCByZW1vdmUKICAgICAgLy8gYWxsIG90aGVyIHRyYW5zaXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGVuc3VyZSBvbmx5IHRoZSBtb3ZlIGNsYXNzCiAgICAgIC8vIGlzIGFwcGxpZWQuCgoKICAgICAgdmFyIGNsb25lID0gZWwuY2xvbmVOb2RlKCk7CgogICAgICBpZiAoZWwuX3RyYW5zaXRpb25DbGFzc2VzKSB7CiAgICAgICAgZWwuX3RyYW5zaXRpb25DbGFzc2VzLmZvckVhY2goZnVuY3Rpb24gKGNscykgewogICAgICAgICAgcmVtb3ZlQ2xhc3MoY2xvbmUsIGNscyk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGFkZENsYXNzKGNsb25lLCBtb3ZlQ2xhc3MpOwogICAgICBjbG9uZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB0aGlzLiRlbC5hcHBlbmRDaGlsZChjbG9uZSk7CiAgICAgIHZhciBpbmZvID0gZ2V0VHJhbnNpdGlvbkluZm8oY2xvbmUpOwogICAgICB0aGlzLiRlbC5yZW1vdmVDaGlsZChjbG9uZSk7CiAgICAgIHJldHVybiB0aGlzLl9oYXNNb3ZlID0gaW5mby5oYXNUcmFuc2Zvcm07CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gY2FsbFBlbmRpbmdDYnMoYykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChjLmVsbS5fbW92ZUNiKSB7CiAgICBjLmVsbS5fbW92ZUNiKCk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGMuZWxtLl9lbnRlckNiKSB7CiAgICBjLmVsbS5fZW50ZXJDYigpOwogIH0KfQoKZnVuY3Rpb24gcmVjb3JkUG9zaXRpb24oYykgewogIGMuZGF0YS5uZXdQb3MgPSBjLmVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKfQoKZnVuY3Rpb24gYXBwbHlUcmFuc2xhdGlvbihjKSB7CiAgdmFyIG9sZFBvcyA9IGMuZGF0YS5wb3M7CiAgdmFyIG5ld1BvcyA9IGMuZGF0YS5uZXdQb3M7CiAgdmFyIGR4ID0gb2xkUG9zLmxlZnQgLSBuZXdQb3MubGVmdDsKICB2YXIgZHkgPSBvbGRQb3MudG9wIC0gbmV3UG9zLnRvcDsKCiAgaWYgKGR4IHx8IGR5KSB7CiAgICBjLmRhdGEubW92ZWQgPSB0cnVlOwogICAgdmFyIHMgPSBjLmVsbS5zdHlsZTsKICAgIHMudHJhbnNmb3JtID0gcy5XZWJraXRUcmFuc2Zvcm0gPSAidHJhbnNsYXRlKCIgKyBkeCArICJweCwiICsgZHkgKyAicHgpIjsKICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJzBzJzsKICB9Cn0KCnZhciBwbGF0Zm9ybUNvbXBvbmVudHMgPSB7CiAgVHJhbnNpdGlvbjogVHJhbnNpdGlvbiwKICBUcmFuc2l0aW9uR3JvdXA6IFRyYW5zaXRpb25Hcm91cAp9OwovKiAgKi8KLy8gaW5zdGFsbCBwbGF0Zm9ybSBzcGVjaWZpYyB1dGlscwoKVnVlLmNvbmZpZy5tdXN0VXNlUHJvcCA9IG11c3RVc2VQcm9wOwpWdWUuY29uZmlnLmlzUmVzZXJ2ZWRUYWcgPSBpc1Jlc2VydmVkVGFnOwpWdWUuY29uZmlnLmlzUmVzZXJ2ZWRBdHRyID0gaXNSZXNlcnZlZEF0dHI7ClZ1ZS5jb25maWcuZ2V0VGFnTmFtZXNwYWNlID0gZ2V0VGFnTmFtZXNwYWNlOwpWdWUuY29uZmlnLmlzVW5rbm93bkVsZW1lbnQgPSBpc1Vua25vd25FbGVtZW50OyAvLyBpbnN0YWxsIHBsYXRmb3JtIHJ1bnRpbWUgZGlyZWN0aXZlcyAmIGNvbXBvbmVudHMKCmV4dGVuZChWdWUub3B0aW9ucy5kaXJlY3RpdmVzLCBwbGF0Zm9ybURpcmVjdGl2ZXMpOwpleHRlbmQoVnVlLm9wdGlvbnMuY29tcG9uZW50cywgcGxhdGZvcm1Db21wb25lbnRzKTsgLy8gaW5zdGFsbCBwbGF0Zm9ybSBwYXRjaCBmdW5jdGlvbgoKVnVlLnByb3RvdHlwZS5fX3BhdGNoX18gPSBpbkJyb3dzZXIgPyBwYXRjaCA6IG5vb3A7IC8vIHB1YmxpYyBtb3VudCBtZXRob2QKClZ1ZS5wcm90b3R5cGUuJG1vdW50ID0gZnVuY3Rpb24gKGVsLCBoeWRyYXRpbmcpIHsKICBlbCA9IGVsICYmIGluQnJvd3NlciA/IHF1ZXJ5KGVsKSA6IHVuZGVmaW5lZDsKICByZXR1cm4gbW91bnRDb21wb25lbnQodGhpcywgZWwsIGh5ZHJhdGluZyk7Cn07IC8vIGRldnRvb2xzIGdsb2JhbCBob29rCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCmlmIChpbkJyb3dzZXIpIHsKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25maWcuZGV2dG9vbHMpIHsKICAgICAgaWYgKGRldnRvb2xzKSB7CiAgICAgICAgZGV2dG9vbHMuZW1pdCgnaW5pdCcsIFZ1ZSk7CiAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnKSB7CiAgICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAnaW5mbycgOiAnbG9nJ10oJ0Rvd25sb2FkIHRoZSBWdWUgRGV2dG9vbHMgZXh0ZW5zaW9uIGZvciBhIGJldHRlciBkZXZlbG9wbWVudCBleHBlcmllbmNlOlxuJyArICdodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlLWRldnRvb2xzJyk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnICYmIGNvbmZpZy5wcm9kdWN0aW9uVGlwICE9PSBmYWxzZSAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAnaW5mbycgOiAnbG9nJ10oIllvdSBhcmUgcnVubmluZyBWdWUgaW4gZGV2ZWxvcG1lbnQgbW9kZS5cbiIgKyAiTWFrZSBzdXJlIHRvIHR1cm4gb24gcHJvZHVjdGlvbiBtb2RlIHdoZW4gZGVwbG95aW5nIGZvciBwcm9kdWN0aW9uLlxuIiArICJTZWUgbW9yZSB0aXBzIGF0IGh0dHBzOi8vdnVlanMub3JnL2d1aWRlL2RlcGxveW1lbnQuaHRtbCIpOwogICAgfQogIH0sIDApOwp9Ci8qICAqLwoKCmV4cG9ydCBkZWZhdWx0IFZ1ZTs="},null]}